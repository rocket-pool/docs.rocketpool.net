import { Tab, Tabs } from "@rspress/core/theme";
import tuiEcContainerTag from "./images/tui-ec-container-tag.png";
import tuiCcContainerTag from "./images/tui-cc-container-tag.png";

# 检查更新

节点操作者的职责之一是确保系统安装了最新的安全补丁。
自动更新虽然方便,但可能会干扰节点操作,因此手动运行更新可能更可取。
无论哪种情况,**您必须确保机器定期打补丁!**

::: tip 注意
大多数情况下,更新不需要系统停机超过几分钟。
您可能担心这样的停机时间会对信标链余额产生负面影响。
请放心,离线这么短的时间的惩罚**完全可以忽略不计**。

您错过的每次证明都会使您受到略低于成功证明所赚取金额的惩罚。
根据经验,如果您离线一小时,在重新上线一小时后就会赚回来。

另请注意,短时间离线**绝对不可能**被*罚没*。
罚没仅在您攻击网络时发生,而离线维护不算攻击网络。

**请保持系统更新 - 不要担心停机惩罚!**
:::

## 更新操作系统

您应该经常检查操作系统的包管理器或更新服务,以确保快速应用任何新的重要安全补丁。
具体说明因每个操作系统而异,可以在系统文档中找到,但这里有一些示例。

<div className="p-3">
  <Tabs>
    <Tab label="Ubuntu">
      在终端中,输入以下内容:

      ```shell
      sudo apt update
      ```

      这将访问包服务器并检查是否有任何已安装的包有新版本可用。
      如果有可用更新,输出将如下所示:

      ```
      Fetched 3974 kB in 2s (1641 kB/s)
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      12 packages can be upgraded. Run 'apt list --upgradable' to see them.
      ```

      您可以使用以下命令安装更新:

      ```shell
      sudo apt dist-upgrade
      ```

      这将显示即将更新的包列表,如果总安装大小足够大,它将显示大小并提示您确认接受:

      ```
      12 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
      Need to get 51.3 MB of archives.
      After this operation, 52.2 kB of additional disk space will be used.
      Do you want to continue? [Y/n]
      ```

      确保您有足够的可用空间来执行此操作,然后按 `y` 和 `Enter` 开始更新过程。

      进度条完成并返回到终端提示符后,运行以下命令清理刚刚替换的包的任何旧版本:

      ```shell
      sudo apt autoremove
      ```

      接下来,检查系统是否需要重启:

      ```shell
      cat /var/run/reboot-required
      ```

      如果上述命令打印 `No such file or directory`,则不需要重启,您可以跳过下面的步骤。

      但是,如果命令打印 `*** System restart required ***`,那么您应该在能够重启时重启机器以完成更新的应用:

      ```shell
      sudo reboot
      ```

      Rocket Pool 将优雅地关闭,并在系统重启后自动启动。
    </Tab>
    <Tab label="MacOS">
      要更新 OS 包,请使用 UI 选择 `Apple -> Software Update`。

      要更新包本身,最简单的方法是在终端中通过 `homebrew`:

      ```shell
      brew update && brew upgrade
      ```
    </Tab>

  </Tabs>
</div>

## 更新 Smartnode 堆栈

Rocket Pool 偶尔会发布新版本的 Smartnode 堆栈。
更新可能包含 CLI 或 Rocket Pool Docker 容器的新版本,以及执行层和共识层客户端的新版本。

了解新版本的最一致方法是订阅 Rocket Pool Discord 服务器;它们将始终发布在发布频道中,您将收到通知。

::: warning 注意
请注意,运行 `apt update` 不会更新节点软件。
必须使用以下步骤手动完成。
:::

::: tip 提示
完成 Smartnode 升级后,Grafana 仪表板仍会指示有可用更新。
当系统下次自动检查更新时,它将在一天内自动清除。

如果您想在更新后立即清除它,只需运行:
`sudo apt update`
:::

::: tip 提示
如果您不知道您的 CPU 架构,可以运行以下命令来查找:

```shell
uname -m
```

此命令的输出将打印您的架构。
**请注意,`x86_64` 与 `x64` 和 `amd64` 相同。**
**请注意,`aarch64` 与 `arm64` 相同。**
:::

升级步骤取决于节点使用的模式。从以下选项中选择:

<div className="p-3">
  <Tabs>
    <Tab label="Linux(Docker 或混合模式)">
      停止 Rocket Pool 服务:

      ```shell
      rocketpool service stop
      ```

      下载新的 Smartnode CLI:

      对于 `x64` 系统(大多数普通机器):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
      ```

      对于 `arm64` 系统:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
      ```

      现在运行安装命令:

      ```shell
      rocketpool service install -d
      ```

      `-d` 标志告诉它忽略系统依赖项(如 Docker),因为您已经有它们了。

      如果您想查看更改内容,请打开设置管理器 - 审核页面将显示新内容:

      ```shell
      rocketpool service config
      ```

      完成后,再次启动 Rocket Pool:

      ```shell
      rocketpool service start
      ```

      最后,检查版本以确保 CLI 和 Smartnode 堆栈都是最新的:

      ```shell
      rocketpool service version
      ```

      输出应该是这样的:

      ```
      Your Smartnode is currently using the Hoodi Test Network.

      Rocket Pool client version: 1.5.0
      Rocket Pool service version: 1.5.0
      Selected Eth 1.0 client: Geth (Locally managed)
      Image: ethereum/client-go:v1.10.21
      Selected Eth 2.0 client: Lighthouse (Locally managed)
      Image: rocketpool/lighthouse:mevboost-5ee3bc5
      ```

      客户端和服务都应与新发布版本匹配。
    </Tab>
    <Tab label="Linux(原生模式)">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        这只会更新 Smartnode 堆栈本身 - **不会**更新执行层或共识层客户端。
        您必须手动执行此操作(请参见下面的下一部分)。
      </p>

      停止 Rocket Pool 服务:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      下载新的 Smartnode CLI 并备份旧的 CLI 和守护程序二进制文件,以防需要恢复它们:

      对于 `x64` 系统(大多数普通机器):

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      对于 `arm64` 系统:

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      如果您想查看更改内容,请打开设置管理器 - 审核页面将显示新内容:

      ```shell
      rp service config
      ```

      完成后,再次启动 Rocket Pool:

      ```shell
      sudo systemctl start rp-node rp-watchtower
      ```

      最后,检查版本以确保 CLI 和 Smartnode 堆栈都是最新的:

      ```
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      客户端和服务都应与新发布版本匹配。
    </Tab>
    <Tab label="macOS(Docker 或混合模式)">
      停止 Rocket Pool 服务:

      ```shell
      rocketpool service stop
      ```

      下载新的 Smartnode CLI:

      对于 `x64` 系统(大多数 Mac):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-amd64 -O /usr/local/bin/rocketpool
      ```

      对于 `arm64` 系统,例如带有 M1 的 Mac mini:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-arm64 -O /opt/homebrew/bin/rocketpool
      ```

      现在运行安装命令:

      ```shell
      rocketpool service install -d
      ```

      `-d` 标志告诉它忽略系统依赖项(如 Docker),因为您已经有它们了。

      如果您想查看更改内容,请打开设置管理器 - 审核页面将显示新内容:

      ```shell
      rocketpool service config
      ```

      完成后,再次启动 Rocket Pool:

      ```shell
      rocketpool service start
      ```

      最后,检查版本以确保 CLI 和 Smartnode 堆栈都是最新的:

      ```shell
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      客户端和服务都应与新发布版本匹配。

    </Tab>

  </Tabs>
</div>

## 手动更新执行层或共识层客户端

Smartnode 堆栈的每个新版本都将附带对执行层和共识层 Docker 容器的最新兼容版本的更新引用。
但是,在某些情况下,您可能希望在等待新的 Smartnode 堆栈发布之前升级其中一个客户端。
本节将向您展示如何做到这一点。

<div className="p-3">
  <Tabs>
    <Tab label="Docker 模式">
      在 Docker 模式下更新到新客户端版本很简单。

      首先打开设置管理器:

      ```shell
      rocketpool service config
      ```

      要更改执行层客户端版本,请转到 **Execution Client** 类别。
      修改 **Container Tag** 设置:

      <img src={tuiEcContainerTag} width="100%" height="auto"/>

      要更改共识层客户端版本,请转到 **Consensus Client** 类别。
      修改 **Beacon Node Container Tag** 设置:

      <img src={tuiCcContainerTag} width="100%" height="auto"/>

      对更改满意后,像往常一样保存并退出。
      Smartnode 将提供自动重启所有受影响的容器。
    </Tab>
    <Tab label="原生模式">
      首先,关闭您的执行层客户端、信标节点和/或验证者客户端服务,具体取决于您想要更新的内容。
      例如,关闭 Geth:

      ```shell
      sudo systemctl stop geth
      ```

      接下来,从客户端供应商下载最新的二进制版本(或从源代码构建),并用新的替换旧的二进制文件。
      我们建议您**将旧的二进制文件移动到备份位置**而不是覆盖它,以防新客户端出现问题。

      最后,再次启动客户端服务 - 例如,启动 Geth:

      ```shell
      sudo systemctl start geth
      ```

      升级后您应该密切关注日志脚本,以确保新客户端按预期工作。
    </Tab>

  </Tabs>
</div>
