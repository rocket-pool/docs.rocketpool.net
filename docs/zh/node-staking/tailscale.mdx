import tailscale_dashboard_client from "./images/tailscale-dashboard-client.png";
import tailscale_dashboard_servers from "./images/tailscale-dashboard-servers.png";

# 配置 Tailscale VPN 服务器

::: tip 注意
这是**可选的**。
如果你在家运行节点并希望从家庭网络外部连接到它，你才需要考虑本节。
:::

如果你想远程登录到你的家庭网络，例如在度假或出差时，最常见的途径是使用**虚拟专用网络**服务器。
这将允许你通过 SSH 连接到节点**并**从世界任何地方监视你的 Grafana 仪表板，所有这些都无需将 SSH 端口暴露给互联网。

许多 Rocket Pool 节点运营者使用 [Tailscale](https://tailscale.com/blog/how-tailscale-works/) 作为他们选择的 VPN 服务器。
Tailscale 是一个开源的 P2P VPN 隧道和托管端点发现服务。
它负责身份验证、发布以及在你的机器和节点之间建立端到端加密路径所需的 NAT 穿越，而无需将任何敏感流量发送到集中式服务器。
它是一个非常强大的工具。

我们将简要介绍它的基本配置，但请随时[查看他们的文档](https://tailscale.com/kb/start/)以获取更多详细信息。

## 设置 Tailscale

首先，创建一个免费的 [Tailscale 帐户](https://tailscale.com/)。
Tailscale 需要使用 SSO 身份提供商，例如 Google、GitHub、Okta、Microsoft 等。
有关详细信息，请访问[他们的 SSO 页面](https://tailscale.com/kb/1013/sso-providers/)。

建议你在选择的任何身份提供商上启用 2FA（双因素身份验证）以增加安全性。

接下来，按照[他们的入门指南](https://tailscale.com/kb/1017/install/)在你的**客户端**上安装 Tailscale - 你想要连接到网络的机器。
例如，这可能是笔记本电脑或手机。
**请注意，这_不是_你的 Rocket Pool 节点！**

完成后，你应该在 [Tailscale 仪表板](https://login.tailscale.com/admin/machines)上看到你的计算机"已连接"。

<img src={tailscale_dashboard_client} width="100%" height="auto" />

现在，在你的 **Rocket Pool 节点**上安装 Tailscale。
你可以在他们的网站上找到相关说明；例如，这里是 [Ubuntu 的安装说明](https://tailscale.com/kb/1039/install-ubuntu-2004/)。

::: warning 注意
如果你配置了 UFW，你还需要遵循 [UFW 配置说明](https://tailscale.com/kb/1077/secure-server-ubuntu-18-04/)。
:::

首先，**在你的 Rocket Pool 节点上**添加 Tailscale 的包签名密钥和存储库：

```shell
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
```

现在，**在你的 Rocket Pool 节点上**安装 Tailscale：

```shell
sudo apt-get update
sudo apt-get install tailscale
```

最后，**在你的 Rocket Pool 节点上**验证并将你的机器连接到 Tailscale 网络：

```shell
sudo tailscale up
```

你已连接！
你可以通过运行以下命令找到你的 Tailscale IPv4 地址：

```shell
tailscale ip -4
```

你现在应该在 [Tailscale 仪表板](https://login.tailscale.com/admin/machines)上看到添加了你的节点机器。
你还可以通过仪表板更改**节点机器**的名称，例如更改为 `rocketnode`。

<img src={tailscale_dashboard_servers} width="100%" height="auto" />

建议为节点机器[禁用密钥过期](https://tailscale.com/kb/1028/key-expiry)以防止需要定期重新验证。

::: tip 注意
如果你想使用诸如 rocketnode 之类的易记主机名访问节点，可以通过在 Tailscale 设置中启用 MagicDNS 来实现。
:::

你现在应该能够在客户端上 `exit` 到节点的 SSH 会话，并使用 `ssh your.user@rocketnode` 再次通过 Tailscale 通过 SSH 连接到节点。

::: warning 注意
如果你在首次配置**节点机器**时修改了 `/etc/ssh/sshd_config` 中的 SSH 端口，请改用 `ssh your.user@rocketnode -p <your port>`。

例如，如果你将 SSH 分配给端口 1234，你将执行：

```shell
ssh your.user@rocketnode -p 1234
```

:::

你现在还可以在 Web 浏览器中访问 `http://rocketnode:3100` 以从**客户端**访问你的 Grafana 仪表板。

如果你配置了 UFW，你现在可以添加一条规则来接受通过 Tailscale 的任何传入 SSH 连接。

::: danger 警告
以下步骤将修改你的防火墙规则。
\*\*在继续之前，你必须至少有 2 个到节点机器的 SSH 会话 - 一个用于修改配置和之后测试，另一个将保持登录状态作为备份，以防你的更改破坏 SSH，以便你可以恢复它们！
:::

**在节点机器上运行这些命令。**

允许访问通过 Talscale 的所有传入 ssh 连接。

```shell
sudo ufw allow in on tailscale0
```

你还可以删除从[启用防火墙](/zh/node-staking/securing-your-node#essential-enable-a-firewall)步骤添加的 SSH 端口访问权限，以完全锁定你的节点。
请注意，你**将无法**从本地网络登录，因为 tailscale 将成为唯一的登录方式。
仅在你对此感到满意时运行以下命令。

```shell
sudo ufw delete "22/tcp"
```

设置防火墙规则以限制所有非 Tailscale 连接后，重新启动 UFW 和 SSH：

```shell
sudo ufw reload
sudo service ssh restart
```

现在，确认一切按预期工作。
从你当前的 SSH 会话之一 `exit`（**但记得保持第二个会话打开作为备份**）。

接下来，使用 Tailscale IP 地址通过 SSH 连接到**节点机器**：

```shell
ssh your.user@rocketnode
```

如果成功，你做对了一切，现在可以在国外时安全地登录到你的家庭网络！

::: tip 提示
如果你之前在路由器中对节点的 SSH 端口进行了端口转发，现在可以将其删除。
:::
