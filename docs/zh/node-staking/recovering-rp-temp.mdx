import { Tab, Tabs } from "@rspress/core/theme";

# 导入/恢复现有钱包

如果您已经有一个想要用于节点的钱包,或者您正在恢复之前使用 Smartnode 创建的钱包,本指南将帮助您完成导入/恢复过程。

请从以下部分中选择适当的选项。

## 恢复 Smartnode 钱包

如果您使用 Smartnode 生成了节点钱包,并且只是在新机器上恢复它,过程非常简单。
确保您已经安装了 Smartnode 软件,然后在安装完成后只需运行以下命令:

```shell
rocketpool wallet recover
```

::: warning 注意
如果出于某种原因,您想要恢复钱包但*不想*恢复附加到节点 minipool 的任何验证器密钥,您可以指定 `-k` 标志以跳过重建过程:

```shell
rocketpool wallet recover -k
```

如果您不指定此标志,Smartnode 将尝试恢复您的 minipool 的验证器密钥;但是请注意,在执行客户端完成同步之前这将无法工作。
请查看其日志文件以查看何时完成;完成后,您可以运行此步骤。
:::

这将首先要求您输入一个密码来加密您的钱包。
之后,它将要求您输入**24 个词的助记词恢复短语**。
仔细输入——为了安全起见,它不会显示在屏幕上,在输入时很容易出错,所以请慢慢来。

完成后,您应该看到类似以下的输出:

```shell
$ rocketpool wallet recover

Please enter a password to secure your wallet with:

Please confirm your password:

Please enter your recovery mnemonic phrase:

Recovering node wallet...
The node wallet was successfully recovered.
Node account: <your wallet address>
No validator keys were found.
```

如果您没有看到任何错误,那么您的钱包和验证器将被恢复。

完成后,请确保使用以下命令重启验证器客户端(适用于 Docker 和混合模式用户):

```shell
docker restart rocketpool_validator
```

**原生模式**用户只需重启他们的验证器容器进程。

这将确保 VC 获取所有新恢复的验证器密钥。

## 将现有地址导入为节点钱包

如果您有一个想要用于节点的地址,但*没有*使用 Smartnode 创建它(例如,您使用 MetaMask 或硬件钱包创建它),那么这是要遵循的部分。

::: danger 警告
这样做后,您的地址将成为**热钱包**。
私钥将存储在您的节点机器上。

如果您导入的地址是冷钱包,例如硬件钱包,请注意**硬件钱包提供的保护将不再存在!**

如果您将此钱包用于*任何其他加密货币活动*,**您必须在将其导入到您的节点之前将其所有资金迁移到单独的地址(例如不同的硬件钱包)!只在此地址上留下足够的 ETH 用于节点的 gas 成本(通常 0.5 ETH 就足够了)。**

在将您的地址导入为节点钱包之前,请确保通过遵循[保护您的节点](./securing-your-node)指南中的步骤尽可能地保护您的机器。
:::

此功能仅在 Smartnode **v1.4.3 或更高版本**中可用。
如果您的版本较低,您需要先升级。

这是一个多步骤过程,因此请仔细遵循以下各节。

### 步骤 1:添加外部生成的验证器密钥

**如果您要导入的地址没有任何现有的 minipool,您可以跳过此步骤。**

如果您的地址已经注册为 Rocket Pool 节点钱包(例如通过 **Allnodes** 等服务)并且已经有活跃的 minipool,并且您想将它们与您的地址一起导入到 Smartnode 堆栈中,您需要为每个相应验证器提供私有密钥库文件。
这些文件将使用您自己选择的密码加密,因此您还需要每个文件的密码。

您需要从当前运行您的节点的服务获取这些文件以便导入它。
某些服务提供商可能能够在请求时检索这些文件。
如果您使用 Allnodes,您可以在初始设置过程中获取这些文件,但**除非您在 minipool 创建期间保存它们,否则以后将无法检索它们。**

选择您的安装模式并按照以下步骤操作。

<div className="p-3">
  <Tabs>
    <Tab label="Docker 和混合模式">
      首先,确保您已使用 `rocketpool service start` 启动了 Smartnode。
      这将创建一个特殊文件夹,可用于保存验证器的加密密钥库文件。

      默认情况下,该文件夹位于 `~/.rocketpool/data/custom-keys`。
      如果您自定义了安装或数据目录,请适当替换以找到 `custom-keys` 文件夹。

      使用文件浏览器或 `ls` 命令检查此文件夹是否存在。
      如果不存在,不用担心 - 只需使用以下命令创建文件夹:

      ```shell
      mkdir ~/.rocketpool/data/custom-keys
      ```
    </Tab>
    <Tab label="原生模式">
      在您的 Smartnode 的 `data` 文件夹内创建一个名为 `custom-keys` 的文件夹(例如,`/srv/rocketpool/data/custom-keys`)。
    </Tab>

  </Tabs>
</div>

接下来,将每个验证器密钥库文件放入此文件夹。
文件名称无关紧要,但它们必须是符合 [EIP-2335](https://eips.ethereum.org/EIPS/eip-2335#scrypt-test-vector) 格式的 JSON 文件。

在接下来的步骤中,Smartnode 将在此目录中查找您放置在这里的任何密钥库文件。

::: warning 注意
导入过程将*仅*查找附加到您要导入的地址注册的 minipool 的验证器密钥。
您**不能**使用此过程将其他验证器密钥(例如用于单独质押验证器)导入到由 Smartnode 堆栈管理的验证器客户端中。

如果您对此感兴趣,请参阅有关在[反向混合模式](./advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode)下运行的文档。
:::

### 步骤 2(可选):测试导入地址

如果您想测试恢复过程以确保您有正确的助记词和密码**而实际上不重新生成节点钱包的私钥或导入验证器密钥**,您可以使用以下命令:

```shell
rocketpool wallet test-recovery -a 0x1234abcd...
```

其中 `0x1234abcd...` 是您要导入的地址,以 `0x` 前缀开头。
**您需要您的助记词来导入您地址的私钥。**

::: tip 提示
如果出于某种原因,您想要恢复钱包但*不想*恢复 minipool 的任何验证器密钥,您可以指定 `-k` 标志以跳过验证器密钥恢复过程。
例如:

```shell
rocketpool wallet test-recovery -a 0x1234abcd... -k
```

:::

Smartnode 将自动搜索最流行的派生路径(例如 Ledger Live、MyEtherWallet、Trezor 和 Smartnode 堆栈使用的路径)和地址索引,以找到与您提供的地址对应的设置。

::: tip 提示
如果您有自定义派生路径,请使用 `-d` 标志指定它。
例如:

```shell
rocketpool wallet test-recovery -d "m/44'/60'/0'/%d"
```

对路径中可以迭代以使用不同索引的部分使用 `%d`。

如果您有自定义地址索引,请使用 `-i` 标志指定它。
例如,如果您的地址是标准派生路径上的第 6 个地址,您可以使用:

```shell
rocketpool wallet test-recovery -i 5
```

如果需要,您可以同时使用 `-d` 和 `-i` 标志。
:::

首先,您将被提示输入您的地址的助记词:

```
Please enter the number of words in your mnemonic phrase (24 by default):
24

Enter Word Number 1 of your mnemonic:
```

仔细输入,Smartnode 将开始搜索所有标准选项以找到它(除非您使用 `-d` 和/或 `-i` 标志明确指定它们)。

接下来,如果您在步骤 1 中有要导入的私有密钥库文件,您将被提示输入每个密钥库文件的密码:

```
It looks like you have some custom keystores for your minipool's validators.
You will be prompted for the passwords each one was encrypted with, so they can be loaded into the Validator Client that Rocket Pool manages for you.

Please enter the password that the keystore for <validator pubkey> was encrypted with:
```

它们将按**公钥**列表组织,**而不是文件名**。
确保您知道哪个文件对应哪个验证器公钥,以便输入正确的密码。

完成后,测试恢复过程将继续并报告它是成功还是失败:

```
Searching for the derivation path and index for wallet 0x1234abcd...
NOTE: this may take several minutes depending on how large your wallet's index is.
The node wallet was successfully recovered.
Derivation path: m/44'/60'/0'/0/%d
Wallet index:    0
Node account:    0x1234abcd...
Validator keys:
<validator pubkey>
```

以上表示测试恢复成功。

### 步骤 3:导入地址

::: danger 警告
如果您的地址是 Rocket Pool 节点,但*不是*由您自己的自托管 Smartnode 管理(例如由 **Allnodes** 等外部服务托管),**至关重要的是**在开始此导入过程**之前**与运行您节点的服务协调,并告知他们您想要迁移到自己的自托管系统。

您**必须确认**他们已关闭节点的验证,并**永远不会恢复它**,并使用区块链浏览器(如 [https://beaconcha.in](https://beaconcha.in))手动确认您的验证器不再进行证明。
您必须确认每个验证器已经错过**至少 2 次证明**,以确保您可以安全迁移。
否则,您将同时证明,**您的 MINIPOOL 将被罚没!**

Smartnode 将要求您确认在允许您继续导入过程之前已完成此操作。
:::

如果测试恢复成功,或者如果您跳过了它,您接下来将导入钱包并重新生成所有相关的密钥文件。
过程与上面完全相同,但使用 `recover` 命令而不是 `test-recovery` 命令:

```shell
rocketpool wallet recover -a 0x1234abcd...
```

运行此命令时,您将首先被提示输入一个密码来加密您导入的节点钱包。

```
Please enter a password to secure your wallet with:

Please confirm your password:
```

之后,助记词和自定义验证器密钥库密码提示将像以前一样继续。

输入所有这些信息后,Smartnode 将恢复您的地址和(如果未禁用)您的 minipool 的自定义验证器密钥:

```
Searching for the derivation path and index for wallet 0x1234abcd...
NOTE: this may take several minutes depending on how large your wallet's index is.
The node wallet was successfully recovered.
Derivation path: m/44'/60'/0'/0/%d
Wallet index:    0
Node account:    0x1234abcd...
Validator keys:
<validator pubkey>
```

您的地址的私钥现在将存储在 `data/wallet` 文件中(例如 `~/.rocketpool/data/wallet`),其密码将存储在 `data/password` 文件中(例如 `~/.rocketpool/data/password`)。

每个验证器的私钥将存储在 Smartnode 支持的每个共识客户端的 `data/validators` 文件夹中。

::: danger 注意
通过以这种方式导入地址,验证器密钥**不是**从您的节点钱包派生的,因此它们**不能**像普通节点钱包那样仅通过运行 `rocketpool wallet recover` 来恢复。

如果您需要再次恢复或导入此钱包,您将需要遵循相同的过程,这意味着**您需要将这些验证器私有密钥库及其密码备份到安全的地方。**

如果您丢失它们,**您将无法再恢复这些验证器密钥!**
:::

### 步骤 4:清理

此时,您现在可以删除 `data/custom-keys` 目录中的所有私有密钥库文件。
Smartnode 已经导入它们并为它们分配了随机密码,因此这些密钥库文件不再需要。

最后,确保您的 `data` 目录中**没有**名为 `custom-key-passwords` 的文件(例如 `~/.rocketpool/data/custom-key-passwords`)。
Smartnode 仅在恢复过程中构建此临时文件,并且无论恢复过程是否成功都会自动删除它;如果由于某种原因它未能删除它,它将在控制台输出中提醒您。
但是,过于谨慎总是没有坏处的。

## 下一步

导入或恢复节点钱包后,请按照[命令行界面简介](./cli-intro)指南中的下一步操作。
