import { Tab, Tabs } from "@rspress/core/theme";

# [Docker 模式] Redstone 更新和合并指南

本指南将介绍如果您使用 **Docker 模式**，为您的节点准备 Redstone 更新和合并所需了解的一切。

## 升级到 v1.5.0 之前需要做的事情

在升级到 Smartnode 的 v1.5.0 及更高版本之前，请按照以下检查清单确保您已做好准备:

### 切换到完整执行客户端

合并要求您运行自己的执行客户端，因此您将无法再使用像 Infura 或 Pocket 这样的远程提供商。
v1.5.0 将不再有它们，并且在您选择完整执行客户端之前不会让您启动堆栈。

由于这一变化，您应该在 v1.4 版本时切换到完整客户端，让它同步完成，然后再升级到 v1.5。

Docker 模式使切换客户端非常容易。
[本指南](../../node-staking/change-clients#changing-execution-clients)提供了该过程的演练。

## 升级到 v1.5.0

将 Smartnode 堆栈升级到 v1.5.0 与任何其他升级没有什么不同。
只需遵循[这里的正常说明](../../node-staking/updates#updating-the-smartnode-stack)。

## Smartnode 自动处理的事情

在 Docker 模式下，一旦您更新到 v1.5.0，Smartnode 将自动处理支持 Redstone 和合并所需的大部分更改。
以下是它将为您做的事情的简要列表，无需任何手动干预:

### 引擎 API

合并改变了执行客户端与共识客户端通信的方式。
不再使用基于旧的 HTTP 或 Websocket 的 RPC 系统，合并需要执行客户端公开的一个新系统，称为引擎 API。

这是一个特殊的连接，让共识客户端用权益证明替换旧的工作量证明挖矿系统；它是合并的核心。
它也是**经过身份验证的**，使用一个秘密令牌，因此只有您的共识客户端可以连接到您的执行客户端 - 其他任何东西都不能。

Smartnode 将自动处理在您的执行客户端和共识客户端上设置身份验证令牌和引擎 API。

### 您的费用接收者

**费用接收者**是执行层链上的地址，将接收您提出的区块的所有优先费用。
它是在验证器客户端首次启动时提供给它的设置。

当您升级到 v1.5 时，Smartnode 将处理将其设置为正确的地址，并将不断检查以确保您使用的是正确的地址，这样您就不会[意外受到惩罚](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)。

如果您选择加入[平滑池](./whats-new#smoothing-pool)，它将使其成为您的费用接收者。
如果您没有，它将使您的[费用分配器合约](./whats-new#fee-recipients-and-your-distributor)成为费用接收者。

### MEV-Boost

[MEV-boost](https://boost.flashbots.net/) 是 Flashbots 提供的系统，在合并后为权益证明验证器提供 MEV 奖励。
Rocket Pool 在 Smartnode 中内置了 MEV-Boost，并自动配置您的节点以使用它，因此您的提议获得最大的奖励。

## 升级后您应该做的事情

虽然 Smartnode 为您处理了大部分更改，但还有一些额外的事情您应该手动做:

### 确保成功升级

首先要做的是确保您的节点正常工作。
考虑采取以下步骤:

- 使用 `rocketpool service logs eth1`、`rocketpool service logs eth2`、`rocketpool service logs validator` 和 `rocketpool service logs node` 检查日志中的错误。
- 使用区块浏览器（例如您的 Grafana 仪表板和 [https://beaconcha.in](https://beaconcha.in)）确认您仍在正确证明
  - 请记住，如果您启用了 Doppelganger 保护，重启后您将错过一些证明。这是正常的！

### 设置备用节点

因为合并与像 Infura 和 Pocket 这样的远程提供商不兼容，当您的主要执行客户端离线时，您将失去使用它们作为备用执行客户端的能力。

Smartnode 仍然有提供备用执行客户端（现在还有备用共识客户端）的能力，但您现在需要使用您控制的执行客户端和共识客户端。

有关设置备用节点的更多信息，请参阅[备用节点指南](../../node-staking/fallback)。

### 初始化您的费用分配器

如果您不打算选择加入[平滑池](./whats-new#smoothing-pool)，并将所有优先费用和 MEV 奖励领取到您的[费用分配器合约](./whats-new#fee-recipients-and-your-distributor)，您最终将必须初始化它（在链上创建合约实例），以便从它向您的提款地址领取奖励。

这是一个相当便宜的操作，只需要做一次。

::: tip 提示
初始化您的费用分配器可以在**任何时候**完成。
您可以让奖励在其地址中长期累积，在您初始化它之前，您的余额将在初始化后保留。

我们建议您在 gas 价格较低时这样做，以最小化开销成本。

请注意，它**必须被初始化才能领取您的奖励。**
:::

### 选择加入平滑池

如果您计划立即利用[平滑池](./whats-new#smoothing-pool)，您应该在第一个 Redstone 奖励期结束之前选择加入，以最大化您的"资格"金额。

可以通过运行以下命令来选择加入:

```
rocketpool node join-smoothing-pool
```

### 领取奖励

Redstone 升级用[全新的奖励系统](./whats-new#new-rewards-system)替换了昂贵、有问题的旧奖励系统，该系统更便宜，支持 RPL 的自动重新质押（部分和全部金额），最重要的是 - **让您随时领取奖励**。

因为不再有领取奖励的时间限制，而且一次领取多个奖励间隔更便宜，所以 Smartnode 的自动奖励领取功能**已被删除**。
您现在可以通过以下命令领取奖励:

```
rocketpool node claim-rewards
```

这将显示您在从 Redstone 升级开始的所有奖励间隔中累积的所有奖励。

## 恢复到 v1.4.3

如果出于任何原因，某些事情不合您的意，您想恢复到以前的 Smartnode 版本，您可以轻松做到这一点。
Smartnode 在您升级时会自动备份您以前版本的设置，因此只需获取以前的版本（这里我们演示的是 **v1.4.3**）并用备份替换设置:

1. 停止服务:

```shell
rocketpool service stop
```

1. 下载 v1.4.3 CLI:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. 安装 v1.4.3 包:

```shell
rocketpool service install -d
```

1. 用 v1.4.3 备份配置替换您的旧配置:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. 验证您所有的旧设置现在都在使用:

```shell
rocketpool service config
```

1. 如果看起来不错，启动 Smartnode 堆栈:

```shell
rocketpool service start
```

全部完成！您现在回到了旧版本，并应该在启动服务后不久开始证明。

::: danger 警告
v1.4.3 已**弃用**，在部署 Redstone 更新后将不再可用。
如果您确实需要恢复到它，请计划在更新合约之前升级回 v1.5.0！
:::
