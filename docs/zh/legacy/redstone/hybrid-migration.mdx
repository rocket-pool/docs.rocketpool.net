import { Tab, Tabs } from "@rspress/core/theme";

# [混合模式] Redstone 更新和合并指南

本指南将涵盖您需要了解的所有内容,以便在使用**混合模式**时为您的节点准备 Redstone 更新和合并。

## 升级到 v1.5.0 之前要做的事情

在升级到 Smartnode 的 v1.5.0 及更高版本之前,请检查以下清单以确保您已准备好:

### 切换到完整执行客户端

合并要求您运行自己的执行客户端,因此您将无法再使用像 Infura 或 Pocket 这样的远程提供商。

由于此更改,如果您当前使用轻执行客户端,您应该在仍使用 v1.4 时切换到完整客户端,让它同步完成,然后升级到 v1.5。

### 确保 EC 和 CC 都是外部管理的

Smartnode 堆栈的早期版本允许您让一个客户端由本地管理,另一个由外部管理。
例如,您可以拥有 Smartnode 管理的执行客户端并将其连接到您外部管理的共识客户端。

从 v1.5 开始,不再支持此配置。
您必须切换到本地管理的执行客户端和共识客户端(也称为 [Docker 模式](./docker-migration.mdx)),或设置您自己管理的执行客户端和共识客户端。

::: tip 提示
如果您有兴趣让 Smartnode 维护自己的执行客户端和共识客户端,但希望保持对自己的验证器客户端的控制(例如,如果您有自己的单独质押验证器密钥附加到它),您可能需要考虑[反向混合模式](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode),它正是这样做的!
:::

### 设置 Engine API

合并改变了执行客户端与共识客户端的通信方式。
合并不再使用基于旧 HTTP 或 Websocket 的 RPC 系统,而是需要执行客户端公开的新系统,称为 Engine API。

这是一个特殊的连接,让共识客户端用权益证明替换旧的工作量证明挖矿系统;它是合并的核心。
它还使用秘密令牌进行**身份验证**,因此只有您的共识客户端可以连接到您的执行客户端 - 其他任何东西都不能。

由于您管理自己的执行客户端和共识客户端,您需要手动设置 Engine API。
如何执行此操作完全取决于您运行的客户端。

CoinCashew 有[一个很棒且简洁的指南](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators),介绍如何在执行客户端和共识客户端上设置 Engine API。
看一下那个,并通过确保它仍然正确证明来测试新配置,然后再升级。

一如既往,Rocket Pool 将管理自己的验证器客户端,因此您无需担心手动修改它。

## 升级到 v1.5.0

将 Smartnode 堆栈升级到 v1.5.0 与任何其他升级没有区别。
只需遵循[此处的正常说明](../../node-staking/updates#updating-the-smartnode-stack)。

## Smartnode 自动处理的事项

在混合模式下,一旦您更新到 v1.5.0,Smartnode 将自动处理支持 Redstone 所需的一些更改,但您需要在混合模式下手动处理其他更改。

以下是它将在无需任何手动干预的情况下为您执行的操作的简要列表:

### 您的费用接收者

**费用接收者**是执行层(eth1)链上的地址,将接收您提议的区块的所有优先费用。
这是在验证器客户端首次启动时提供给它的设置。

当您升级到 v1.5 时,Smartnode 将处理在其管理的验证器客户端上将其设置为正确的地址,并将不断检查以确保您使用正确的地址,这样您就不会[意外受到惩罚](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)。

如果您选择加入[平滑池](./whats-new#smoothing-pool),它将使其成为您的费用接收者。
如果您没有,它将使您的[费用分配器合约](./whats-new#fee-recipients-and-your-distributor)成为费用接收者。

## 升级后您应该做的事情

虽然 Smartnode 为您处理了大部分更改,但您仍应手动执行一些其他操作:

### 确保成功升级

首先要做的是确保您的节点正常工作。
考虑采取以下步骤:

- 使用 `rocketpool service logs validator` 和 `rocketpool service logs node` 检查日志中的错误。
- 使用区块浏览器(如您的 Grafana 仪表板和 [https://beaconcha.in](https://beaconcha.in))确认您仍在正确证明
  - 请记住,如果您启用了 Doppelganger 保护,重启后您将错过一些证明。这是正常的!

### 设置 MEV-Boost

[MEV-boost](https://boost.flashbots.net/) 是 Flashbots 提供的系统,用于在合并后向权益证明验证器提供 MEV 奖励。

**Rocket Pool 要求所有节点使用它以最大化回报,从而使协议与其他质押服务保持竞争力。**

您需要对信标节点/共识客户端进行一些调整以将其连接到 MEV-boost。

MEV-boost 目前在 Hoodi 或主网上不可用,因此您此时无需设置它。
当然,在此过渡期间,您不会因不使用它而受到惩罚。

一旦它可用,我们将宣布一个日期,届时必须安装并连接到您的节点。
Flashbots 将在那时提供您可以遵循的说明,我们将在此处链接到它们。

::: danger 注意
一旦我们宣布所有节点运营者必须启用 MEV-boost,您必须确保已正确安装并配置了信标节点!

不这样做将导致您的迷你池被[惩罚](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)。
:::

### 设置后备节点

由于合并与 Infura 和 Pocket 等远程提供商不兼容,当您的主执行客户端离线时,您将失去将它们用作后备执行客户端的能力。

Smartnode 仍然能够提供后备执行客户端(现在还有后备共识客户端),但您现在需要使用您控制的执行客户端和共识客户端。

有关设置后备节点的更多信息,请参阅[后备节点指南](../../node-staking/fallback)。

### 初始化您的费用分配器

如果您不打算选择加入[平滑池](./whats-new#smoothing-pool)并将所有优先费用和 MEV 奖励申领到您的[费用分配器合约](./whats-new#fee-recipients-and-your-distributor),您最终将必须初始化它(在链上创建合约实例),以便将奖励从其申领到您的提款地址。

这是一个相当便宜的操作,只需要做一次。

::: tip 提示
初始化您的费用分配器可以在**任何时候**完成。
您可以在初始化它之前让奖励在其地址中累积很长时间,初始化后您的余额将保留。

我们建议您在 gas 价格较低时这样做以最小化管理费用成本。

请注意,它**必须初始化才能申领您的奖励。**
:::

### 选择加入平滑池

如果您计划立即利用[平滑池](./whats-new#smoothing-pool),您应该在第一个 Redstone 奖励期结束前选择加入,以最大化您的"资格"金额。

可以通过运行以下命令来选择加入:

```shell
rocketpool node join-smoothing-pool
```

### 申领奖励

Redstone 升级用[全新系统](./whats-new#new-rewards-system)取代了昂贵且有问题的旧奖励系统,该系统更便宜,支持 RPL 的自动重新质押(部分和全额),最重要的是 - **让您随时申领奖励**。

由于申领奖励不再有时间限制,而且一次申领多个奖励间隔更便宜,Smartnode 的自动奖励申领功能**已被移除**。
您现在可以通过以下命令申领奖励:

```shell
rocketpool node claim-rewards
```

这将显示您从 Redstone 升级开始的所有奖励间隔中累积的所有奖励。

## 恢复到 v1.4.3

如果出于任何原因,某些内容不符合您的喜好,并且您想恢复到以前的 Smartnode 版本,您可以轻松做到这一点。
Smartnode 在升级时会自动备份您以前版本的设置,因此只需获取以前的版本(这里我们演示 **v1.4.3**)并用备份替换设置:

1. 停止服务:

```shell
rocketpool service stop
```

1. 下载 v1.4.3 CLI:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. 安装 v1.4.3 包:

```shell
rocketpool service install -d
```

1. 用 v1.4.3 备份配置替换旧配置:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. 验证所有旧设置现在正在使用:

```shell
rocketpool service config
```

1. 如果看起来不错,启动 Smartnode 堆栈:

```shell
rocketpool service start
```

完成!您现在回到了旧版本,应该在启动服务后不久开始证明。

::: danger 警告
v1.4.3 已**弃用**,在部署 Redstone 更新后将无法再使用。
如果您确实需要恢复到它,请计划在合约更新之前升级回 v1.5.0!
:::
