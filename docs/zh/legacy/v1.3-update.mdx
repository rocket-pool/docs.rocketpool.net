import { Tab, Tabs } from "@rspress/core/theme";

# 升级到 Smartnode v1.3.x

Smartnode 堆栈的 1.3.0 版本带来了一些用户应该注意的重要变化。
它们旨在显著改善您的节点运营者体验,并解决自 Rocket Pool 启动以来我们的用户请求的许多功能。

在本指南中,我们将引导您完成从旧版本的 Smartnode 迁移到 v1.3.x 及更高版本的过程。

## 配置文件变更

v1.3.0 在 Smartnode 配置管理方式上引入了一些重大变化。
如果您以前手动修改过 Smartnode 配置,则应注意以下变化:

- `config.yml` 文件已被删除。其所有信息现在直接烘焙到 Smartnode 堆栈中,因此用户不再会意外地以阻止 Smartnode 正常工作的方式修改文件。
  - 所有以前是其一部分的用户可配置参数现在都是新的 `service config` 终端 UI 中的设置。

- `settings.yml` 文件已被名为 `user-settings.yml` 的新文件取代。这包含 Smartnode 每个用户可配置部分的所有设置。
  - 此文件**不应直接修改**。应通过新的 `service config` 终端 UI 进行修改。

- `chains` 文件夹已被删除。用于启动执行客户端(ETH1)、信标节点和验证者客户端的脚本现在位于 `scripts` 文件夹中。

- `docker-compose` YAML 文件已被删除。每个容器现在在 `templates` 文件夹中都有自己的文件。在 `rocketpool service start` 时,这些模板将用您的设置填写并自动放入 `runtime` 文件夹。
  - 不建议修改模板或运行时文件。相反,请使用 `override` 文件夹中每个容器的**覆盖**文件填写您的容器自定义。这些文件将覆盖 `runtime` 中的 Docker 文件,因此您可以根据需要自定义它们。
  - `override` 中的文件**将在 Smartnode 升级和重新安装时保留**,因此您只需创建一次。
  - 如果您有兴趣通过此覆盖机制修改 `docker-compose` 文件,请参阅[此部分](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## 安装新版本

安装新版本应该感觉非常熟悉。

首先像往常一样停止服务并下载新的 CLI:

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">
      停止 Rocket Pool 服务:

      ```
      rocketpool service stop
      ```

      为您的系统下载新的 Smartnode CLI(从下面的选项卡中选择):

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            对于 `x64` 系统(大多数普通机器):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            对于 `arm64` 系统:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            对于 `x64` 系统(大多数 Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            对于 `arm64` 系统,例如带有 M1 的 Mac mini:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      现在运行安装命令:

      ```
      rocketpool service install -d
      ```

      `-d` 标志告诉它忽略系统依赖项,如 Docker,因为您已经拥有它们。

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">注意</p>
        从 v1.3.0 开始,您**不再需要指定要安装的网络!**
        新的 Smartnode 将知道您已经使用的网络,并且它将允许您使用新的终端 UI 动态更改网络。
      </p>
    </Tab>
    <Tab label="Native Mode">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        这只会更新 Smartnode 堆栈本身 - 它**不会**更新您的执行和共识客户端。
        您必须手动执行此操作(请参阅[手动更新指南](../node-staking/updates#manually-updating-the-eth1-or-eth2-client)以了解如何操作)。
      </p>

      停止 Rocket Pool 服务:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      下载新的 Smartnode CLI 和守护进程二进制文件:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            对于 `x64` 系统(大多数普通机器):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            对于 `arm64` 系统:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            对于 `x64` 系统(大多数 Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            对于 `arm64` 系统,例如带有 M1 的 Mac mini:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">注意</p>
        从 v1.3.0 开始,`config.yml` 已被删除。
        **您不再需要下载安装程序包并解压它。**
      </p>
      接下来,在 Smartnode 目录中创建一个名为 `old_config_backup` 的备份文件夹,并将旧配置文件移入其中(`config.yml` 和 `settings.yml`)。
      Smartnode 将使用这些将您的设置迁移到新系统。

      例如,如果您遵循 Native 设置指南并且您的 Smartnode 目录是 `/srv/rocketpool`:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      现在,修改 `rp-node` 的服务定义文件:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      将 `ExecStart` 行替换为以下内容:

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      请注意,`--config` 标志已被删除,`--settings` 现在指向 `user-settings.yml`。
      **不用担心此文件尚不存在;它将在下一步自动生成。**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        如果您是 Oracle DAO 成员,您_必须_对 `rp-watchtower` 服务重复上述过程。
      </p>

      最后,重新加载服务定义:

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

安装后,所有旧配置文件将被移动到 Smartnode 目录中名为 `old_config_backup` 的文件夹(默认为 `~/.rocketpool/old_config_backup`)。
如果您出于任何原因需要参考它们,可以在那里找到它们。

**如果您正在寻找从此备份恢复到 v1.2.4 的说明,请滚动到本页末尾的[恢复到之前的配置](#恢复到之前的配置)部分。**

## 使用终端 UI 配置 Smartnode

现在您已经安装了新的 CLI 和包,所有以前的设置都已保留并迁移到新系统。
在下一步中,您应该运行 `rocketpool service config`。
与此功能的以前版本相比,这将看起来非常不同;v1.3.0 引入了**终端 UI**:一个基于终端的动态用户界面,用于配置您的 Smartnode。

在迁移过程后启动 Docker 容器之前,您必须运行它以查看配置,验证所有更改是否已成功迁移,并更新您希望的任何其他设置。

当您首次运行它时,将显示此欢迎屏幕(如果您使用的是 **Docker 或 Hybrid 模式**):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip 注意
**Native 模式用户**将看到措辞略有不同的屏幕,说明 Smartnode 正在 Native 模式下运行。
:::

TUI 将从**向导**开始,它允许您快速轻松地更改 Smartnode 的最重要参数(例如客户端模式和选择)。

**当您遍历向导的每个页面时,所有以前的设置都应该已经突出显示,因此您不必凭记忆记住之前的配置是什么。**

:::warning 注意
**有关此向导的详细演练,请访问以下页面:**

- 对于 **Docker 模式**,请访问[新的 Docker 配置指南](../node-staking/config-docker)。

- **Hybrid 模式**用户:Hybrid 模式现在是 Smartnode 的**一流功能**,配置它比以前_容易得多_。请访问[新的 Docker 配置指南](../node-staking/config-docker)并遵循它。当提示您选择执行客户端模式和共识客户端模式时,相应地为它们选择**外部管理**。

- 对于 **Native 模式**,请访问[新的 Native 配置指南](../node-staking/config-native)。

:::

浏览此向导并确认所有设置都正确。

完成后,如果需要,您可以选择**在保存之前查看所有设置**。
这包括向导未涵盖的设置,例如 **RPL 声领 gas 阈值**或您的 **Geth 对等方的最大数量**等示例。

**主设置屏幕**(您也应该查看以确认您以前的设置)将如下所示(对于 Docker 和 Hybrid 模式用户):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip 注意
**Native 模式用户**将看到略有不同的屏幕,该屏幕对 Native 模式是唯一的,仅显示与之相关的设置。
:::

随意探索这个新 UI 并调整您认为合适的任何设置。
使用`箭头键`导航,然后按 `Enter` 进入类别或确认您对设置所做的任何更改。

完成编辑类别后按 `Esc` 返回此主屏幕。

当您准备保存更改并启动 Smartnode 堆栈时,只需按 `Tab` 向下移动到屏幕底部的按钮,选择 `Review Changes and Save`(通过箭头键使其变绿)。
按 `Enter` 进入**审查页面**,您可以在其中查看自上次运行 `rocketpool service config` 以来所做的所有更改。

确认所有更改都存在,然后再次按 `Enter` 保存它们。
屏幕将显示需要重新启动哪些容器才能应用更改,尽管由于您正在迁移,您已经关闭了容器,它们都将被重新启动。

## 启动 Smartnode 堆栈

保存配置后,终端将询问您是否要自动重新启动容器(除非您使用 Native 模式)。
如果您不能/不能允许它们自动启动,您可以使用以下命令手动启动它们:

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">```shell rocketpool service start ```</Tab>
    <Tab label="Native Mode">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

启动后,您可以验证一切是否按预期工作。

使用 `rocketpool service version` 命令检查您是否拥有正确版本的 Smartnode 和客户端容器:

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

使用 `rocketpool service logs eth1` 和 `rocketpool service logs eth2` 命令查看执行客户端(以前的 ETH1 客户端)和共识客户端(以前的 ETH2 客户端)的日志。
注意任何错误,如果遇到错误,[请访问我们的 Discord 服务器寻求帮助](https://discord.com/invite/rocketpool)。

## 恢复到之前的配置

如果出于任何原因,您需要恢复到 Smartnode 堆栈的 v1.2.4,不用担心!
您的所有旧配置文件都已保留在备份目录中,可以轻松检索以恢复您以前的设置。

从下面的选项卡中选择您使用的模式并按照说明操作。

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">
      首先,将 CLI 替换为您系统的 v1.2.4 CLI:
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            对于 `x64` 系统(大多数普通机器):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            对于 `arm64` 系统:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            对于 `x64` 系统(大多数 Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            对于 `arm64` 系统,例如带有 M1 的 Mac mini:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      接下来,将所有旧配置文件从 `old_config_backup` 文件夹复制回 Smartnode 的文件夹:

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      现在,您只需要重新启动 Docker 容器:

      ```shell
      rocketpool service start
      ```

      完成!您的旧配置已恢复。

    </Tab>
    <Tab label="Native Mode">
      停止 Rocket Pool 服务:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            对于 `x64` 系统(大多数普通机器):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            对于 `arm64` 系统:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            对于 `x64` 系统(大多数 Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            对于 `arm64` 系统,例如带有 M1 的 Mac mini:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      将以前的设置文件复制回您的 Smartnode 目录:

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      现在,恢复 `rp-node` 的服务定义文件:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      将 `ExecStart` 行替换为以下内容:

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        如果您是 Oracle DAO 成员,您_必须_对 `rp-watchtower` 服务重复上述过程。
      </p>

      最后,重新加载服务定义并重新启动服务:

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      完成!您的旧配置已恢复。
    </Tab>

  </Tabs>
</div>
