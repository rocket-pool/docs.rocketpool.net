import { Tab, Tabs } from "@rspress/core/theme";

# [Native Mode] Redstone 업데이트 및 The Merge 가이드

이 가이드는 **Native Mode**를 사용하는 경우 Redstone 업데이트 및 The Merge를 위해 노드를 준비하는 데 필요한 모든 정보를 다룹니다.

## v1.5.0으로 업그레이드하기 전에 해야 할 일

Smartnode를 v1.5.0 이상으로 업그레이드하기 전에 다음 체크리스트를 확인하여 준비가 되었는지 확인하세요:

### 전체 Execution Client로 전환

The Merge는 자체 Execution client를 실행해야 하므로 Infura 또는 Pocket과 같은 원격 공급자를 더 이상 사용할 수 없습니다.

이러한 변경으로 인해 현재 라이트 Execution client를 사용하는 경우 v1.4를 사용하는 동안 전체 클라이언트로 전환하고 동기화가 완료되면 v1.5로 업그레이드해야 합니다.

### Engine API 설정

The Merge는 Execution client가 Consensus client와 통신하는 방식을 변경합니다.
기존 HTTP 또는 Websocket 기반 RPC 시스템을 사용하는 대신, The Merge는 Execution client가 노출하는 Engine API라는 새로운 시스템을 필요로 합니다.

이것은 Consensus client가 기존 Proof-of-Work 마이닝 시스템을 Proof-of-Stake로 대체할 수 있게 하는 특별한 연결입니다. 이것이 The Merge의 핵심입니다.
또한 비밀 토큰으로 **인증**되므로 Consensus client만 Execution client에 연결할 수 있으며 다른 것은 연결할 수 없습니다.

자체 Execution 및 Consensus client를 관리하므로 Engine API를 수동으로 설정해야 합니다.
방법은 실행 중인 클라이언트에 따라 완전히 다릅니다.

CoinCashew는 Execution 및 Consensus client에서 Engine API를 설정하는 방법에 대한 [훌륭하고 간결한 가이드](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators)를 제공합니다.
해당 가이드를 살펴보고 업그레이드하기 전에 여전히 올바르게 증명하는지 확인하여 새 구성을 테스트하세요.

Smartnode 소프트웨어에 필요한 올바른 fee recipient를 사용하도록 Validator client를 설정하는 방법은 아래에서 보여드리겠습니다.

## v1.5.0으로 업그레이드

Smartnode 스택을 v1.5.0으로 업그레이드하는 것은 다른 업그레이드와 다르지 않습니다.
[여기의 일반 지침](../../node-staking/updates#updating-the-smartnode-stack)을 따르기만 하면 됩니다.

## 업그레이드 후 수행해야 할 작업

Native mode에서는 업그레이드 후 수동으로 수행해야 하는 몇 가지 작업이 있습니다:

### 성공적인 업그레이드 확인

가장 먼저 해야 할 일은 노드가 올바르게 작동하는지 확인하는 것입니다.
다음 단계를 수행하는 것을 고려하세요:

- Execution client, Consensus client, Validator client 및 Smartnode 데몬(`rp-node` 서비스)에 대한 로그 스크립트를 확인하여 모두 정상적으로 작동하고 오류가 없는지 확인합니다.
- Block Explorer(예: Grafana 대시보드 및 [https://beaconcha.in](https://beaconcha.in))를 통해 여전히 올바르게 증명하고 있는지 확인합니다
  - Doppelganger 보호가 활성화된 경우 재시작 후 몇 개의 증명을 놓치게 됩니다. 이것은 정상입니다!

### Validator Client에서 Fee Recipient 설정

The Merge 전에 설정해야 하는 **중요한** 세부 사항 중 하나는 validator client가 지정한 **fee recipient**입니다.
[개요 문서](./whats-new#fee-recipients-and-your-distributor)에 설명된 대로 다음 두 값 중 하나일 수 있습니다:

- Smoothing Pool에 **가입한 경우** **Smoothing Pool contract**의 주소여야 합니다. [공식 계약 페이지](/ko/overview/contracts-integrations)에서 주소를 얻을 수 있습니다.
- Smoothing Pool에 **가입하지 않은 경우** 노드의 **fee distributor contract** 주소여야 합니다. `Fee Distributor and Smoothing Pool` 섹션 아래의 `rocketpool node status`를 실행하여 주소를 얻을 수 있습니다.

Native mode에서는 Smartnode 데몬 서비스인 `rp-node`를 사용하는 경우 Smartnode가 이를 관리하도록 하거나 데몬을 사용하지 않는 경우 직접 관리할 수 있습니다.

#### 데몬을 통한 자동 관리

Smartnode 데몬은 노드에 적합한 fee recipient를 자동으로 결정하고 변경되는 경우(예: Smoothing Pool에 가입 및 탈퇴) 관리합니다.
이것이 **가장 안전한** 옵션입니다. Smartnode는 항상 [벌금](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)을 **방지하는** 값으로 설정되도록 보장합니다.

이를 수행하는 방법은 올바른 fee recipient가 포함된 파일을 유지하고 정확성을 보장하기 위해 정기적으로 새로 고치는 것입니다.
업데이트가 필요한 경우 파일을 수정하고 Validator client를 자동으로 재시작하여 새 recipient를 로드합니다. 이는 새 minipool을 스테이킹한 후 Validator client를 재시작하는 방법과 유사합니다.

설정 방법을 알아보려면 아래에서 클라이언트를 선택하세요:

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Validator Client 서비스를 수정하여 `ExecStart` 줄 _이전에_ 다음 줄을 추가합니다:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      예를 들어:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      다음으로 `ExecStart` 줄 _끝에_ 다음 명령줄 인수를 추가합니다:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      이제 VC는 Smartnode 데몬이 관리하는 파일을 사용하며 fee recipient가 변경될 때마다 자동으로 재시작됩니다.
    </Tab>
    <Tab label="Nimbus">
      Validator Client 서비스를 수정하여 `ExecStart` 줄 _이전에_ 다음 줄을 추가합니다:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      예를 들어:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      다음으로 `ExecStart` 줄 _끝에_ 다음 명령줄 인수를 추가합니다:

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      이제 VC는 Smartnode 데몬이 관리하는 파일을 사용하며 fee recipient가 변경될 때마다 자동으로 재시작됩니다.
    </Tab>
    <Tab label="Prysm">
      Validator Client 서비스를 수정하여 `ExecStart` 줄 _이전에_ 다음 줄을 추가합니다:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      예를 들어:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      다음으로 `ExecStart` 줄 _끝에_ 다음 명령줄 인수를 추가합니다:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      이제 VC는 Smartnode 데몬이 관리하는 파일을 사용하며 fee recipient가 변경될 때마다 자동으로 재시작됩니다.
    </Tab>
    <Tab label="Teku">
      Validator Client 서비스를 수정하여 `ExecStart` 줄 _이전에_ 다음 줄을 추가합니다:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      예를 들어:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      다음으로 `ExecStart` 줄 _끝에_ 다음 명령줄 인수를 추가합니다:

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      이제 VC는 Smartnode 데몬이 관리하는 파일을 사용하며 fee recipient가 변경될 때마다 자동으로 재시작됩니다.
    </Tab>

  </Tabs>
</div>

#### 수동 Fee Recipient 관리

::: danger 경고
이렇게 하면 fee recipient가 항상 올바른 주소로 설정되도록 보장할 모든 책임을 지게 됩니다.

구성에 따라 설정해야 하는 값과 한 값에서 다른 값으로 안전하게 변경할 수 있는 시기를 이해하려면 [벌금 사양](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)을 읽으세요.

그렇게 하지 않으면 minipool이 벌금을 받을 수 있습니다!
:::

**Redstone이 배포되기 전에는** 사용 중인 네트워크의 rETH 주소를 사용하면 됩니다([공식 계약 페이지](/ko/overview/contracts-integrations)에서 찾을 수 있습니다).
rETH 주소는 어떤 경우에도 항상 안전합니다.

**Redstone이 배포된 후에는** `rocketpool node status`를 통해 fee recipient로 설정해야 하는 정확한 주소를 확인할 수 있습니다. 예를 들어, Smoothing Pool에 가입한 경우 Smoothing Pool의 주소가 표시되며 이를 fee recipient로 사용해야 한다고 표시됩니다:

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Smoothing Pool에 가입하지 _않은_ 경우 fee distributor 주소가 표시되며 이를 fee recipient로 사용해야 한다고 표시됩니다:

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

구성 방법을 알아보려면 아래에서 Consensus client를 선택하세요.

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Validator Client의 서비스 정의 파일에 다음 명령줄 인수를 추가합니다:

      ```
      --suggested-fee-recipient `address`
      ```

      여기서 `address`는:

      - Redstone 업데이트가 배포되기 **전**의 [rETH address](/ko/overview/contracts-integrations/#token-contracts) (예: Mainnet에서 `0xae78736Cd615f374D3085123A210448E74Fc6393`)
      - Redstone이 배포된 후 노드의 **fee distributor**이며, 계약 업그레이드가 발생하면 `rocketpool node status`로 검색할 수 있습니다
      - Smoothing Pool에 가입한 경우 [Smoothing Pool address](/ko/overview/contracts-integrations/#protocol-contracts)

      참고로 `rocketpool node status`는 언제든지 사용할 올바른 fee recipient를 보여줍니다.

      **fee recipient에 대한 조건 및 기대치를 이해하려면 [벌금 사양](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)을 주의 깊게 읽으세요.**
    </Tab>
    <Tab label="Nimbus">
      Nimbus의 서비스 정의 파일에 다음 명령줄 인수를 추가합니다:

      ```
      --suggested-fee-recipient=`address`
      ```

      여기서 `address`는:

      - Redstone 업데이트가 배포되기 **전**의 [rETH address](/ko/overview/contracts-integrations/#token-contracts) (예: Mainnet에서 `0xae78736Cd615f374D3085123A210448E74Fc6393`)
      - Redstone이 배포된 후 노드의 **fee distributor**이며, 계약 업그레이드가 발생하면 `rocketpool node status`로 검색할 수 있습니다
      - Smoothing Pool에 가입한 경우 [Smoothing Pool address](/ko/overview/contracts-integrations/#protocol-contracts)

      참고로 `rocketpool node status`는 언제든지 사용할 올바른 fee recipient를 보여줍니다.

      **fee recipient에 대한 조건 및 기대치를 이해하려면 [벌금 사양](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)을 주의 깊게 읽으세요.**
    </Tab>
    <Tab label="Prysm">
      Validator Client의 서비스 정의 파일에 다음 명령줄 인수를 추가합니다:

      ```
      --suggested-fee-recipient `address`
      ```

      여기서 `address`는:

      - Redstone 업데이트가 배포되기 **전**의 [rETH address](/ko/overview/contracts-integrations/#token-contracts) (예: Mainnet에서 `0xae78736Cd615f374D3085123A210448E74Fc6393`)
      - Redstone이 배포된 후 노드의 **fee distributor**이며, 계약 업그레이드가 발생하면 `rocketpool node status`로 검색할 수 있습니다
      - Smoothing Pool에 가입한 경우 [Smoothing Pool address](/ko/overview/contracts-integrations/#protocol-contracts)

      참고로 `rocketpool node status`는 언제든지 사용할 올바른 fee recipient를 보여줍니다.

      **fee recipient에 대한 조건 및 기대치를 이해하려면 [벌금 사양](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)을 주의 깊게 읽으세요.**
    </Tab>
    <Tab label="Teku">
      Validator Client의 서비스 정의 파일에 다음 명령줄 인수를 추가합니다:

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      여기서 `address`는:

      - Redstone 업데이트가 배포되기 **전**의 [rETH address](/ko/overview/contracts-integrations/#token-contracts) (예: Mainnet에서 `0xae78736Cd615f374D3085123A210448E74Fc6393`)
      - Redstone이 배포된 후 노드의 **fee distributor**이며, 계약 업그레이드가 발생하면 `rocketpool node status`로 검색할 수 있습니다
      - Smoothing Pool에 가입한 경우 [Smoothing Pool address](/ko/overview/contracts-integrations/#protocol-contracts)

      참고로 `rocketpool node status`는 언제든지 사용할 올바른 fee recipient를 보여줍니다.

      **fee recipient에 대한 조건 및 기대치를 이해하려면 [벌금 사양](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)을 주의 깊게 읽으세요.**
    </Tab>

  </Tabs>
</div>

### MEV-Boost 설정

[MEV-boost](https://boost.flashbots.net/)는 Flashbots가 The Merge 이후 Proof-of-Stake validator에게 MEV 보상을 제공하는 시스템입니다.

**Rocket Pool은 모든 노드가 이를 사용하여 수익을 극대화하고 다른 스테이킹 서비스와 프로토콜의 경쟁력을 유지할 것을 요구합니다.**

Beacon Node / Consensus client를 MEV-boost에 연결하려면 몇 가지 조정을 해야 합니다.

MEV-boost는 현재 Hoodi 또는 Mainnet에서 사용할 수 없으므로 현재로서는 설정할 필요가 없습니다.
물론 이 전환 기간 동안 사용하지 않아도 벌금이 부과되지 않습니다.

사용 가능해지면 노드에 설치하고 연결해야 하는 날짜를 발표할 것입니다.
Flashbots가 그때 따를 수 있는 지침을 제공할 것이며 여기에 링크할 것입니다.

::: danger 참고
모든 노드 운영자가 MEV-boost를 활성화해야 한다는 발표가 있으면 Beacon Node에 올바르게 설치 및 구성되어 있는지 확인해야 합니다!

그렇게 하지 않으면 minipool이 [벌금을 받게](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) 됩니다.
:::

### Fallback Node 설정

The Merge는 Infura 및 Pocket과 같은 원격 공급자와 호환되지 않으므로 기본 Execution client가 오프라인 상태일 때 해당 공급자를 fallback Execution client로 사용할 수 없습니다.

Smartnode는 여전히 fallback Execution client(및 이제 fallback Consensus client도)를 제공할 수 있지만 이제 제어하는 Execution 및 Consensus client를 사용해야 합니다.

fallback node 설정에 대한 자세한 내용은 [Fallback node 가이드](../../node-staking/fallback)를 참조하세요.

### Fee Distributor 초기화

[Smoothing Pool](./whats-new#smoothing-pool)에 가입하지 않고 모든 우선 수수료 및 MEV 보상을 [fee distributor contract](./whats-new#fee-recipients-and-your-distributor)로 청구하려는 경우, 출금 주소로 보상을 청구하려면 결국 초기화(체인에 계약 인스턴스 생성)해야 합니다.

이것은 상당히 저렴한 작업이며 한 번만 수행하면 됩니다.

::: tip 팁
fee distributor 초기화는 **언제든지** 수행할 수 있습니다.
초기화하기 훨씬 전에 주소에 보상을 누적할 수 있으며 초기화 후에도 잔액이 유지됩니다.

오버헤드 비용을 최소화하려면 가스 가격이 낮을 때 수행하는 것이 좋습니다.

**보상을 청구하려면 초기화해야 합니다.**
:::

### Smoothing Pool 가입

[Smoothing Pool](./whats-new#smoothing-pool)을 즉시 활용할 계획이라면 첫 번째 Redstone 보상 기간이 끝나기 전에 가입하여 "적격성" 금액을 최대화해야 합니다.

가입은 다음 명령을 실행하여 수행할 수 있습니다:

```shell
rocketpool node join-smoothing-pool
```

### 보상 청구

Redstone 업그레이드는 비용이 많이 들고 문제가 있는 기존 보상 시스템을 [새로운 시스템](./whats-new#new-rewards-system)으로 교체합니다. 이 시스템은 훨씬 저렴하고 RPL의 자동 재스테이킹(부분 및 전체 금액 모두)을 지원하며 가장 중요한 것은 **원하는 때에 보상을 청구할 수 있다**는 것입니다.

보상 청구에 더 이상 시간 제한이 없고 많은 보상 기간을 한 번에 청구하는 것이 더 저렴하기 때문에 Smartnode의 자동 보상 청구 기능이 **제거되었습니다**.
이제 다음 명령을 통해 보상을 청구할 수 있습니다:

```shell
rocketpool node claim-rewards
```

이것은 Redstone 업그레이드부터 시작하여 모든 보상 기간에 걸쳐 누적된 모든 보상을 보여줍니다.
