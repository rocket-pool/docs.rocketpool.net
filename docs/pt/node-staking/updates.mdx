import { Tab, Tabs } from "@rspress/core/theme";
import tuiEcContainerTag from "./images/tui-ec-container-tag.png";
import tuiCcContainerTag from "./images/tui-cc-container-tag.png";

# Verificando Atualizações

Uma das responsabilidades de um Node Operator é garantir que o seu sistema esteja atualizado com os patches de segurança mais recentes.
Atualizações automáticas são convenientes, mas podem interferir com a operação do seu nó, então pode ser preferível executá-las manualmente.
Em qualquer caso, **você deve garantir que a sua máquina seja regularmente corrigida!**

::: tip NOTA
Na maioria das vezes, a atualização não exigirá que o seu sistema fique inativo por mais de alguns minutos.
Você pode estar preocupado que esse tempo de inatividade afete negativamente o seu saldo na Beacon Chain.
Fique tranquilo, a penalidade por ficar offline por um período tão curto é **completamente negligenciável**.

Cada atestação que você perder irá penalizá-lo por um pouco menos do que a quantia que você ganharia de uma atestação bem-sucedida.
Como regra geral, se você ficar offline por uma hora, você recuperará tudo isso depois de ficar online novamente por uma hora.

Observe também que **não há absolutamente nenhuma chance** de você ser _slashed_ por ficar offline por um curto período.
Slashing só ocorre se você atacar a rede, e ficar offline para manutenção não conta como atacar a rede.

**Por favor, mantenha seus sistemas atualizados - não se preocupe com as penalidades por tempo de inatividade!**
:::

## Atualizando o Sistema Operacional

Você deve verificar frequentemente o gerenciador de pacotes ou serviço de atualização do seu Sistema Operacional para garantir que aplique rapidamente quaisquer novos patches de segurança importantes.
As instruções exatas variam para cada Sistema Operacional e podem ser encontradas na documentação do seu sistema, mas aqui estão alguns exemplos.

<div className="p-3">
  <Tabs>
    <Tab label="Ubuntu">
      Em um terminal, digite o seguinte:

      ```shell
      sudo apt update
      ```

      Isso acessará os servidores de pacotes e verificará se algum dos seus pacotes instalados tem novas versões disponíveis.
      Se houver atualizações disponíveis, a saída será assim:

      ```
      Fetched 3974 kB in 2s (1641 kB/s)
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      12 packages can be upgraded. Run 'apt list --upgradable' to see them.
      ```

      Você pode instalar as atualizações com o seguinte comando:

      ```shell
      sudo apt dist-upgrade
      ```

      Isso mostrará a lista de pacotes que estão prestes a ser atualizados e, se o tamanho total da instalação for grande o suficiente, mostrará o tamanho e solicitará que você confirme que aceita:

      ```
      12 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
      Need to get 51.3 MB of archives.
      After this operation, 52.2 kB of additional disk space will be used.
      Do you want to continue? [Y/n]
      ```

      Certifique-se de que você tem espaço suficiente disponível para fazer isso, depois pressione `y` e `Enter` para iniciar o processo de atualização.

      Assim que a barra de progresso terminar e você retornar ao prompt do terminal, execute o seguinte comando para limpar quaisquer versões antigas dos pacotes que acabaram de ser substituídos:

      ```shell
      sudo apt autoremove
      ```

      Em seguida, verifique se o seu sistema precisa ser reiniciado:

      ```shell
      cat /var/run/reboot-required
      ```

      Se o comando acima imprimir `No such file or directory`, então a reinicialização não é necessária e você pode pular a etapa abaixo.

      No entanto, se o comando imprimir `*** System restart required ***`, então você deve reiniciar sua máquina para terminar de aplicar as atualizações quando puder:

      ```shell
      sudo reboot
      ```

      Rocket Pool será desligado graciosamente e iniciará automaticamente de volta com o sistema assim que ele reiniciar.
    </Tab>
    <Tab label="MacOS">
      Para atualizar os pacotes do sistema operacional, use a interface do usuário para selecionar `Apple -> Software Update`.

      Para atualizar os próprios pacotes, a maneira mais fácil é via `homebrew` no terminal:

      ```shell
      brew update && brew upgrade
      ```
    </Tab>

  </Tabs>
</div>

## Atualizando o Smartnode Stack

Ocasionalmente, Rocket Pool lançará uma nova versão do Smartnode stack.
As atualizações podem conter novas versões do CLI ou dos containers Docker do Rocket Pool, bem como novas versões dos clientes Execution e Consensus.

A maneira mais consistente de descobrir sobre novos lançamentos é assinar o servidor Discord do Rocket Pool; eles sempre serão postados no canal Releases e você receberá uma notificação.

::: warning NOTA
Note que executar `apt update` não atualizará o software do nó.
Isso deve ser feito manualmente usando as etapas abaixo.
:::

::: tip DICA
Quando você completar a atualização do Smartnode, o dashboard Grafana ainda indicará que há uma atualização disponível.
Ele será limpo automaticamente dentro de um dia quando o sistema verificar novamente por atualizações.

Se você quiser limpá-lo imediatamente após a atualização, simplesmente execute:
`sudo apt update`
:::

::: tip DICA
Se você não sabe a arquitetura da sua CPU, pode executar o seguinte comando para descobrir:

```shell
uname -m
```

A saída deste comando imprimirá a sua arquitetura.
**Observe que `x86_64` é o mesmo que `x64` e `amd64`.**
**Observe que `aarch64` é o mesmo que `arm64`.**
:::

As etapas para atualizar dependem de qual modo seu nó usa. Selecione entre as opções abaixo:

<div className="p-3">
  <Tabs>
    <Tab label="Linux (Docker ou Modo Híbrido)">
      Pare os serviços do Rocket Pool:

      ```shell
      rocketpool service stop
      ```

      Baixe o novo CLI do Smartnode:

      Para sistemas `x64` (a maioria das máquinas normais):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
      ```

      Para sistemas `arm64`:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
      ```

      Agora execute o comando de instalação:

      ```shell
      rocketpool service install -d
      ```

      A flag `-d` diz para ignorar dependências do sistema como Docker, já que você já as tem.

      Se você gostaria de ver o que mudou, abra o Settings Manager - a página Review mostrará o que é novo:

      ```shell
      rocketpool service config
      ```

      Quando terminar, inicie o Rocket Pool novamente:

      ```shell
      rocketpool service start
      ```

      Finalmente, verifique a versão para ter certeza de que o CLI e o Smartnode stack estão ambos atualizados:

      ```shell
      rocketpool service version
      ```

      A saída deve parecer algo assim:

      ```
      Your Smartnode is currently using the Hoodi Test Network.

      Rocket Pool client version: 1.5.0
      Rocket Pool service version: 1.5.0
      Selected Eth 1.0 client: Geth (Locally managed)
      Image: ethereum/client-go:v1.10.21
      Selected Eth 2.0 client: Lighthouse (Locally managed)
      Image: rocketpool/lighthouse:mevboost-5ee3bc5
      ```

      Tanto o cliente quanto o serviço devem corresponder à nova versão de lançamento.
    </Tab>
    <Tab label="Linux (Modo Nativo)">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Isso atualizará apenas o próprio Smartnode stack - **não** atualizará seus clientes Execution ou Consensus.
        Você terá que fazer isso manualmente (veja a próxima seção abaixo).
      </p>

      Pare os serviços do Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Baixe o novo CLI do Smartnode e faça backup dos binários antigos do CLI e daemon caso você precise trazê-los de volta:

      Para sistemas `x64` (a maioria das máquinas normais):

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Para sistemas `arm64`:

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Se você gostaria de ver o que mudou, abra o Settings Manager - a página Review mostrará o que é novo:

      ```shell
      rp service config
      ```

      Quando terminar, inicie o Rocket Pool novamente:

      ```shell
      sudo systemctl start rp-node rp-watchtower
      ```

      Finalmente, verifique a versão para ter certeza de que o CLI e o Smartnode stack estão ambos atualizados:

      ```
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      Tanto o cliente quanto o serviço devem corresponder à nova versão de lançamento.
    </Tab>
    <Tab label="macOS (Docker ou Modo Híbrido)">
      Pare os serviços do Rocket Pool:

      ```shell
      rocketpool service stop
      ```

      Baixe o novo CLI do Smartnode:

      Para sistemas `x64` (a maioria dos Macs):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-amd64 -O /usr/local/bin/rocketpool
      ```

      Para sistemas `arm64`, como o Mac mini com M1:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-arm64 -O /opt/homebrew/bin/rocketpool
      ```

      Agora execute o comando de instalação:

      ```shell
      rocketpool service install -d
      ```

      A flag `-d` diz para ignorar dependências do sistema como Docker, já que você já as tem.

      Se você gostaria de ver o que mudou, abra o Settings Manager - a página Review mostrará o que é novo:

      ```shell
      rocketpool service config
      ```

      Quando terminar, inicie o Rocket Pool novamente:

      ```shell
      rocketpool service start
      ```

      Finalmente, verifique a versão para ter certeza de que o CLI e o Smartnode stack estão ambos atualizados:

      ```shell
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      Tanto o cliente quanto o serviço devem corresponder à nova versão de lançamento.

    </Tab>

  </Tabs>
</div>

## Atualizando Manualmente o Cliente Execution ou Consensus

Cada novo lançamento do Smartnode stack virá com referências atualizadas para as versões compatíveis mais recentes dos containers Docker Execution e Consensus.
Em alguns casos, no entanto, você pode querer atualizar um desses clientes _antes_ de esperar por um novo lançamento do Smartnode stack.
Esta seção mostrará como fazer exatamente isso.

<div className="p-3">
  <Tabs>
    <Tab label="Modo Docker">
      Atualizar para novas versões de clientes é fácil no modo Docker.

      Comece abrindo o Settings Manager:

      ```shell
      rocketpool service config
      ```

      Para mudar a versão do cliente Execution, vá para a categoria **Execution Client**.
      Modifique a configuração **Container Tag**:

      <img src={tuiEcContainerTag} width="100%" height="auto"/>

      Para mudar a versão do cliente Consensus, vá para a categoria **Consensus Client**.
      Modifique a configuração **Beacon Node Container Tag**:

      <img src={tuiCcContainerTag} width="100%" height="auto"/>

      Quando estiver satisfeito com suas alterações, salve e saia como de costume.
      O Smartnode oferecerá reiniciar todos os containers afetados automaticamente.
    </Tab>
    <Tab label="Modo Nativo">
      Primeiro, desligue o serviço do seu cliente Execution, Beacon Node e/ou Validator client dependendo do que você gostaria de atualizar.
      Por exemplo, desligando Geth:

      ```shell
      sudo systemctl stop geth
      ```

      Em seguida, baixe o lançamento binário mais recente do fornecedor do seu cliente (ou compile a partir do código-fonte) e substitua o binário antigo pelo novo.
      Recomendamos que você **mova o binário antigo para um local de backup** em vez de sobrescrevê-lo, caso o novo cliente tenha problemas.

      Finalmente, inicie o serviço do cliente novamente - por exemplo, iniciando Geth:

      ```shell
      sudo systemctl start geth
      ```

      Você deve seguir os scripts de log de perto após a atualização para garantir que o novo cliente funcione conforme esperado.
    </Tab>

  </Tabs>
</div>
