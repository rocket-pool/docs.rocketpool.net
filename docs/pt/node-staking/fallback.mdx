import tui_ec_expose_ports from "./images/tui-ec-expose-ports.png";
import tui_cc_expose_ports from "./images/tui-cc-expose-ports.png";
import tui_fallback_clients from "./images/tui-fallback-clients.png";

# Especificando um Nó de Fallback

A partir da versão **1.5.0** da stack do Smartnode, você pode fornecer um par de cliente de Execution "fallback" e cliente de Consensus que podem assumir o controle dos seus clientes primários se eles ficarem offline (como porque [você usa Geth e precisa fazer poda](./pruning)).
Nessa situação, sua máquina de nó primária ainda será responsável por atestar e propor blocos com as chaves de validador dos seus minipools, mas se conectará a uma máquina externa para interagir com a camada de Execution e as cadeias Beacon.

Essencialmente, permite que você use _temporariamente_ outro par de clientes para coisas como consultar as cadeias, enviar transações e receber blocos para atestar.
Este par pode ser gerenciado externamente (como no modo Híbrido), ou pode ser outro nó da Rocket Pool (outra máquina no modo Docker que tem as portas API expostas, que abordaremos abaixo).

Uma vez que os clientes primários do seu nó estejam novamente online, o Smartnode e seu cliente Validator voltarão para eles automaticamente.

::: warning NOTA
Um nó de fallback **não** é o mesmo que um nó de "backup".
Nós de fallback têm um par de cliente de Execution e Consensus sincronizado com a cadeia e em execução, mas **não** têm a carteira do seu nó ou suas chaves de validador carregadas.

Se seu nó principal ficar offline, **seu fallback não começará a validar por você.**
:::

## Clientes Suportados

A partir da v1.9.0, todos os nossos clientes de validador suportados adicionaram suporte a Fallback com apenas algumas limitações:

| Nome       | Suporta Fallback | Clientes de Fallback Válidos                                                   |
| ---------- | ---------------- | ------------------------------------------------------------------------------ |
| Lighthouse | Sim              | Qualquer (proteção doppelganger off)<br />Lighthouse (proteção doppelganger on) |
| Nimbus     | Sim              | Qualquer                                                                       |
| Prysm      | Sim              | Prysm                                                                          |
| Teku       | Sim              | Qualquer                                                                       |
| Lodestar   | Sim              | Qualquer                                                                       |

## Configurando um Novo Nó (Modo Docker)

Você pode usar uma segunda máquina que você possui localmente, um nó remoto hospedado em um VPS ou um nó baseado em nuvem como um nó de fallback.

Este exemplo mostra como criar um segundo Smartnode em uma máquina diferente usando o modo Docker, que pode servir como um nó de fallback.

::: tip DICA
Se você já tem um segundo nó pronto e tem suas portas RPC expostas, sinta-se à vontade para pular esta seção.
:::

1. Siga os passos no guia de configuração de um nó ([local](./local/hardware) ou [remoto](./vps/providers)).
2. Quando a máquina estiver pronta, [instale a stack do Smartnode](./docker).
3. Execute `rocketpool service config` para especificar quais clientes você gostaria de usar.
   1. Quando chegar ao final do assistente e ele perguntar se você gostaria de revisar suas configurações, selecione **Sim**.
   2. Entre nas configurações do `Execution Client`.
   3. Marque a caixa `Expose RPC Ports`:

   <img src={tui_ec_expose_ports} width="100%" height="auto" />
   4. Volte e entre nas configurações do `Consensus Client`. 5. Marque a caixa `Expose API Port` (e, se você estiver usando **Prysm**, a caixa `Expose RPC Port` também):

   <img src={tui_cc_expose_ports} width="100%" height="auto" />
   6. Salve as configurações e inicie o Smartnode.

4. Pule para o guia [Protegendo seu Nó](./securing-your-node) para configurar SSH e a postura de segurança adequada nele.
   1. Se você tiver `ufw` instalado, precisará adicionar regras para permitir tráfego de entrada nas portas API (`8545`, `8546` e `5052` por padrão; também `5053` se você estiver usando **Prysm**).

5. É isso! Você pode parar aqui.

::: danger NOTA
**Não** crie uma carteira com `rocketpool wallet init` ou recupere sua carteira antiga.
Deixe este nó sem uma carteira e sem chaves de validador.

Seu único trabalho é ter um cliente de Execution e um cliente de Consensus sincronizados.
:::

## Conectando seu Nó Principal ao Nó de Fallback

Assim que tiver um nó de fallback preparado, você pode conectá-lo ao seu nó principal.

1. Entre na TUI de `rocketpool service config` e entre nas configurações de `Fallback Clients`.
2. Marque a caixa `Use Fallback Clients`.
3. Digite a URL RPC para seu cliente de Execution na caixa `Execution Client URL`. Por exemplo, se o endereço IP do seu nó de fallback for `192.168.1.45` e você tiver seu cliente de Execution na porta padrão de `8545`, você digitaria `http://192.168.1.45:8545` aqui.
4. Faça o mesmo para a URL RPC do seu cliente de Consensus de fallback. Seguindo o mesmo exemplo, se você o tiver na porta padrão de `5052`, você digitaria `http://192.168.1.45:5052` aqui.

A página final deve ficar assim:

<img src={tui_fallback_clients} width="100%" height="auto" />

::: tip NOTA
Usuários do **modo nativo** podem seguir os mesmos passos, embora a TUI pareça ligeiramente diferente da captura de tela acima.

Observe que isso fornecerá apenas ao **Smartnode em si** (o serviço daemon) o suporte de fallback; **você terá que atualizar os argumentos do serviço do seu cliente Validator manualmente para dar a ele acesso aos clientes de fallback.**
:::

Pressione `enter` na caixa final para garantir que seja confirmada, então salve as configurações e aplique as alterações.

Depois de aplicadas, você pode confirmar a disponibilidade do seu nó de fallback usando o comando `rocketpool node sync`:

```
Your Smartnode is currently using the Ethereum Mainnet.

Your eth2 client is on the correct network.

Your primary execution client is fully synced.
Your fallback execution client is fully synced.
Your primary consensus client is fully synced.
Your fallback consensus client is fully synced.
```

Se mostrar que tanto o cliente de Execution quanto o de Consensus de fallback estão sincronizados, então está tudo pronto!

## Testando os Clientes de Fallback

Se você quiser ter certeza absoluta de que sua configuração funcionará testando os clientes de fallback, simplesmente pare os clientes de Execution e Consensus no seu nó principal:

```shell
docker stop rocketpool_eth1 rocketpool_eth2
```

Então execute qualquer comando que consulte a cadeia, como `rocketpool network stats`.
Você verá uma mensagem de aviso no topo indicando que um (ou ambos) dos seus clientes primários estão offline e que está revertendo para os clientes de fallback:

```
NOTE: primary clients are not ready, using fallback clients...
 Primary EC status: unavailable (Sync progress check failed with [Post "http://eth1:8545": dial tcp: lookup eth1 on 127.0.0.11:53: no such host])
 Primary CC status: unavailable (Sync progress check failed with [Could not get node sync status: Get "http://eth2:5052/eth/v1/node/syncing": dial tcp: lookup eth2 on 127.0.0.11:53: no such host])

========== General Stats ==========
Total Value Locked:      278978.009858 ETH
Staking Pool Balance:    10.587295 ETH
Minipool Queue Demand:   3360.000000 ETH
Staking Pool ETH Used:   99.735490%

============== Nodes ==============
Current Commission Rate: 15.000000%
Node Count:              1325
Active Minipools:        6409
    Initialized:         175
    Prelaunch:           3
    Staking:             6227
    Withdrawable:        0
    Dissolved:           4
Inactive Minipools:      0

========== Smoothing Pool =========
Nodes Opted in:          0
Pending Balance:         0.000000

============== Tokens =============
rETH Price (ETH / rETH): 1.031919 ETH
RPL Price (ETH / RPL):   0.011563 ETH
Total RPL staked:        6098920.170527 RPL
Effective RPL staked:    5751692.043848 RPL
```

Finalmente, inicie seus clientes primários novamente:

```shell
docker start rocketpool_eth1 rocketpool_eth2
```

E pronto!
Sua configuração de fallback está funcionando.

## Próximos Passos

Tenha ou não optado por criar e/ou executar um nó de fallback para sua configuração, o próximo passo é aprender sobre **taxas de prioridade**.
Clique na próxima seção do guia quando estiver pronto para prosseguir.
