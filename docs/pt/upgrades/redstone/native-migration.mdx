import { Tab, Tabs } from "@rspress/core/theme";

# [Modo Nativo] Guia para a Atualização Redstone e The Merge

Este guia cobrirá tudo o que você precisa saber para preparar seu nó para a Atualização Redstone e The Merge se você estiver usando o **Modo Nativo**.

## Coisas a Fazer Antes de Atualizar para v1.5.0

Antes de atualizar para v1.5.0 e versões superiores do Smartnode, por favor passe pela seguinte lista de verificação para ter certeza de que está preparado:

### Mudar para um Cliente de Execução Completo

The Merge requer que você execute seu próprio cliente de Execução, então você não poderá mais usar provedores remotos como Infura ou Pocket.

Devido a esta mudança, se você está atualmente usando um cliente de Execução leve, você deve mudar para um cliente completo enquanto ainda estiver na v1.4, deixá-lo sincronizar até a conclusão, e então atualizar para v1.5.

### Configurar a Engine API

The Merge muda a maneira como seu cliente de Execução se comunica com seu cliente de Consenso.
Em vez de usar o antigo sistema RPC baseado em HTTP ou Websocket, The Merge requer um novo sistema exposto pelo seu cliente de Execução chamado Engine API.

Esta é uma conexão especial que permite ao cliente de Consenso substituir o antigo sistema de mineração Proof-of-Work por Proof-of-Stake; é o coração do The Merge.
Ela também é **autenticada** com um token secreto, então apenas seu cliente de Consenso pode se conectar ao seu cliente de Execução - nada mais pode.

Como você gerencia seus próprios clientes de Execução e Consenso, você precisará configurar a Engine API manualmente.
Como fazer isso depende inteiramente de quais clientes você está executando.

CoinCashew tem [um guia ótimo e conciso](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) sobre como configurar a Engine API nos seus clientes de Execução e Consenso.
Dê uma olhada nisso e teste a nova configuração certificando-se de que ainda atesta adequadamente antes de atualizar.

Mostraremos como configurar seu cliente Validator para que ele use o destinatário de taxas correto exigido pelo software Smartnode automaticamente abaixo.

## Atualizando para v1.5.0

Atualizar a stack Smartnode para v1.5.0 não é diferente de qualquer outra atualização.
Simplesmente siga [as instruções normais aqui](../../node-staking/updates#updating-the-smartnode-stack).

## Coisas Que Você Deve Fazer Após Atualizar

No modo Nativo, há várias coisas que você precisará fazer manualmente após atualizar:

### Garantir uma Atualização Bem-Sucedida

A primeira coisa a fazer é garantir que seu nó está funcionando corretamente.
Considere tomar as seguintes medidas:

- Verifique seus scripts de log para o cliente de Execução, o cliente de Consenso, o cliente Validator e o daemon Smartnode (o serviço `rp-node`) para garantir que todos estejam funcionando normalmente sem erros.
- Confirme com um Block Explorer (como seu painel Grafana e [https://beaconcha.in](https://beaconcha.in)) que você ainda está atestando corretamente
  - Lembre-se de que se você tem proteção Doppelganger ativada, você perderá alguns atestados após o reinício. Isso é normal!

### Configurar o Destinatário de Taxas no seu Cliente Validator

Um dos detalhes **críticos** para configurar antes do The Merge é o **destinatário de taxas** especificado pelo seu cliente validator.
Conforme descrito no [artigo de visão geral](./whats-new#fee-recipients-and-your-distributor), este pode ser um de dois valores:

- Se você **optou por participar** do Smoothing Pool, este deve ser o endereço do **contrato Smoothing Pool**. Você pode obter o endereço da [página de contratos oficiais](/pt/protocol/contracts-integrations).
- Se você **não está** no Smoothing Pool, este deve ser o endereço do **contrato distribuidor de taxas** do seu nó. Você pode obter o endereço executando `rocketpool node status`, na seção `Fee Distributor and Smoothing Pool`.

No modo Nativo, você tem a opção de deixar o Smartnode gerenciar isso para você se você usar o serviço daemon Smartnode, `rp-node`, ou gerenciá-lo você mesmo se você não usar o daemon.

#### Gerenciamento Automático via Daemon

O daemon Smartnode determinará automaticamente o destinatário de taxas apropriado para seu nó e o gerenciará caso ele mude (como optar por entrar e sair do Smoothing Pool).
Esta é a opção **mais segura**, porque o Smartnode sempre garantirá que esteja definido para um valor que **previne [penalização](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)**.

A maneira como ele faz isso é mantendo um arquivo com o destinatário de taxas correto nele, e atualizando-o regularmente para garantir sua correção.
Quando precisa ser atualizado, ele modifica o arquivo e reinicia seu cliente Validator automaticamente para que ele carregue o novo destinatário - de forma semelhante a como ele reinicia seu cliente Validator após fazer stake de um novo minipool.

Selecione seu cliente abaixo para aprender como configurá-lo:

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Modifique seu serviço de Cliente Validator adicionando a seguinte linha _antes_ da linha `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por exemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Em seguida, adicione o seguinte argumento de linha de comando _ao final_ da sua linha `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Seu VC agora usará o arquivo gerenciado pelo daemon Smartnode, e será automaticamente reiniciado sempre que o destinatário de taxas mudar.
    </Tab>
    <Tab label="Nimbus">
      Modifique seu serviço de Cliente Validator adicionando a seguinte linha _antes_ da linha `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por exemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Em seguida, adicione o seguinte argumento de linha de comando _ao final_ da sua linha `ExecStart`:

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      Seu VC agora usará o arquivo gerenciado pelo daemon Smartnode, e será automaticamente reiniciado sempre que o destinatário de taxas mudar.
    </Tab>
    <Tab label="Prysm">
      Modifique seu serviço de Cliente Validator adicionando a seguinte linha _antes_ da linha `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por exemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Em seguida, adicione o seguinte argumento de linha de comando _ao final_ da sua linha `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Seu VC agora usará o arquivo gerenciado pelo daemon Smartnode, e será automaticamente reiniciado sempre que o destinatário de taxas mudar.
    </Tab>
    <Tab label="Teku">
      Modifique seu serviço de Cliente Validator adicionando a seguinte linha _antes_ da linha `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por exemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Em seguida, adicione o seguinte argumento de linha de comando _ao final_ da sua linha `ExecStart`:

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      Seu VC agora usará o arquivo gerenciado pelo daemon Smartnode, e será automaticamente reiniciado sempre que o destinatário de taxas mudar.
    </Tab>

  </Tabs>
</div>

#### Gerenciamento Manual do Destinatário de Taxas

::: danger AVISO
Ao fazer isso, você assume total responsabilidade por garantir que seu destinatário de taxas esteja sempre definido para o endereço correto.

Por favor leia a [especificação de penalidades](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) para entender para o que ele deve estar definido dada sua configuração, e quando você pode mudá-lo com segurança de um valor para outro.

Falhar em fazer isso pode resultar em seus minipools sendo penalizados!
:::

**Antes do Redstone ser implantado**, você pode simplesmente usar o endereço rETH para a rede em que você está (que pode ser encontrado na [página de contratos oficiais](/pt/protocol/contracts-integrations)).
O endereço rETH é sempre seguro não importa o que aconteça.

**Uma vez que o Redstone tenha sido implantado**, você pode ver o endereço exato para o qual você deve definir seu destinatário de taxas via `rocketpool node status`. Por exemplo, se você optou por participar do Smoothing Pool, ele mostrará o endereço do Smoothing Pool e notará que você deve usá-lo como seu destinatário de taxas:

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Se você _não_ optou por participar do Smoothing Pool, ele mostrará seu endereço de distribuidor de taxas e notará que você deve usá-lo como seu destinatário de taxas:

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

Selecione seu cliente de Consenso abaixo para aprender como configurá-lo.

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Adicione o seguinte argumento de linha de comando ao arquivo de definição de serviço do seu Cliente Validator:

      ```
      --suggested-fee-recipient `address`
      ```

      Onde `address` é:

      - O [endereço rETH](/pt/protocol/contracts-integrations/#token-contracts) **antes** da atualização Redstone ser implantada (por exemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` na Mainnet)
      - O **distribuidor de taxas** do seu nó após o Redstone ser implantado, que você pode recuperar com `rocketpool node status` uma vez que a atualização de contrato ocorra
      - O [endereço do Smoothing Pool](/pt/protocol/contracts-integrations/#protocol-contracts) se você optar por participar do Smoothing Pool

      Como lembrete, `rocketpool node status` mostrará o destinatário de taxas correto para usar a qualquer momento.

      **Por favor leia a [especificação de penalidades](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender as condições e expectativas em torno do destinatário de taxas.**
    </Tab>
    <Tab label="Nimbus">
      Adicione o seguinte argumento de linha de comando ao arquivo de definição de serviço do Nimbus:

      ```
      --suggested-fee-recipient=`address`
      ```

      Onde `address` é:

      - O [endereço rETH](/pt/protocol/contracts-integrations/#token-contracts) **antes** da atualização Redstone ser implantada (por exemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` na Mainnet)
      - O **distribuidor de taxas** do seu nó após o Redstone ser implantado, que você pode recuperar com `rocketpool node status` uma vez que a atualização de contrato ocorra
      - O [endereço do Smoothing Pool](/pt/protocol/contracts-integrations/#protocol-contracts) se você optar por participar do Smoothing Pool

      Como lembrete, `rocketpool node status` mostrará o destinatário de taxas correto para usar a qualquer momento.

      **Por favor leia a [especificação de penalidades](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender as condições e expectativas em torno do destinatário de taxas.**
    </Tab>
    <Tab label="Prysm">
      Adicione o seguinte argumento de linha de comando ao arquivo de definição de serviço do seu Cliente Validator:

      ```
      --suggested-fee-recipient `address`
      ```

      Onde `address` é:

      - O [endereço rETH](/pt/protocol/contracts-integrations/#token-contracts) **antes** da atualização Redstone ser implantada (por exemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` na Mainnet)
      - O **distribuidor de taxas** do seu nó após o Redstone ser implantado, que você pode recuperar com `rocketpool node status` uma vez que a atualização de contrato ocorra
      - O [endereço do Smoothing Pool](/pt/protocol/contracts-integrations/#protocol-contracts) se você optar por participar do Smoothing Pool

      Como lembrete, `rocketpool node status` mostrará o destinatário de taxas correto para usar a qualquer momento.

      **Por favor leia a [especificação de penalidades](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender as condições e expectativas em torno do destinatário de taxas.**
    </Tab>
    <Tab label="Teku">
      Adicione o seguinte argumento de linha de comando ao arquivo de definição de serviço do seu Cliente Validator:

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      Onde `address` é:

      - O [endereço rETH](/pt/protocol/contracts-integrations/#token-contracts) **antes** da atualização Redstone ser implantada (por exemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` na Mainnet)
      - O **distribuidor de taxas** do seu nó após o Redstone ser implantado, que você pode recuperar com `rocketpool node status` uma vez que a atualização de contrato ocorra
      - O [endereço do Smoothing Pool](/pt/protocol/contracts-integrations/#protocol-contracts) se você optar por participar do Smoothing Pool

      Como lembrete, `rocketpool node status` mostrará o destinatário de taxas correto para usar a qualquer momento.

      **Por favor leia a [especificação de penalidades](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender as condições e expectativas em torno do destinatário de taxas.**
    </Tab>

  </Tabs>
</div>

### Configurar MEV-Boost

[MEV-boost](https://boost.flashbots.net/) é o sistema que a Flashbots fornece para dar recompensas MEV aos validadores Proof-of-Stake após The Merge.

**Rocket Pool requer que todos os nós o usem para maximizar seus retornos e assim manter o protocolo competitivo com outros serviços de staking.**

Você precisará fazer alguns ajustes no seu Beacon Node / cliente de Consenso para conectá-lo ao MEV-boost.

MEV-boost atualmente não está disponível no Hoodi ou Mainnet, então você não precisa configurá-lo neste momento.
É claro, você não será penalizado por não usá-lo durante este período de transição.

Uma vez que esteja disponível, anunciaremos uma data na qual ele deve estar instalado e conectado ao seu nó.
A Flashbots fornecerá instruções que você pode seguir naquele momento, e nós as vincularemos aqui.

::: danger NOTA
Uma vez que fizermos o anúncio de que MEV-boost deve ser habilitado por todos os operadores de nó, você deve garantir que o tenha instalado e configurado adequadamente com seu Beacon Node!

Não fazer isso resultará em seu minipool sendo [penalizado](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).
:::

### Configurar um Nó de Fallback

Como The Merge não é compatível com provedores remotos como Infura e Pocket, você perderá a capacidade de usá-los como clientes de Execução de fallback quando seu cliente primário ficar offline.

O Smartnode ainda tem a capacidade de fornecer um cliente de Execução de fallback (e agora um cliente de Consenso de fallback também), mas você agora precisará usar clientes de Execução e Consenso que você controla.

Para mais informações sobre configurar um nó de fallback, veja o [guia de nó de fallback](../../node-staking/fallback).

### Inicializar seu Distribuidor de Taxas

Se você não está planejando optar pelo [Smoothing Pool](./whats-new#smoothing-pool) e reivindicar todas as suas taxas de prioridade e recompensas MEV para seu [contrato distribuidor de taxas](./whats-new#fee-recipients-and-your-distributor), você eventualmente terá que inicializá-lo (criar a instância do contrato na cadeia) para reivindicar recompensas dele para seu endereço de retirada.

Esta é uma operação bastante barata e só precisa ser feita uma vez.

::: tip DICA
Inicializar seu distribuidor de taxas pode ser feito a **qualquer momento**.
Você pode deixar recompensas acumularem em seu endereço muito antes de inicializá-lo, e seu saldo permanecerá após a inicialização.

Recomendamos que você faça isso quando os preços de gas estiverem baixos para minimizar o custo geral.

Note que ele **deve ser inicializado para reivindicar suas recompensas.**
:::

### Optar pelo Smoothing Pool

Se você planeja aproveitar o [Smoothing Pool](./whats-new#smoothing-pool) imediatamente, você deve optar antes do final do primeiro período de recompensas Redstone para maximizar seu valor de "elegibilidade".

Optar pode ser feito executando o seguinte comando:

```shell
rocketpool node join-smoothing-pool
```

### Reivindicar Recompensas

A atualização Redstone substitui o antigo sistema de recompensas caro e problemático por um [novo sistema](./whats-new#new-rewards-system) que é muito mais barato, suporta restaking automático de RPL (tanto valores parciais quanto completos), e - mais importante - **permite que você reivindique suas recompensas quando quiser**.

Como não há mais um limite de tempo para reivindicar recompensas, e como é mais barato reivindicar muitos intervalos de recompensas de uma vez, o recurso de reivindicação automática de recompensas do Smartnode **foi removido**.
Agora você poderá reivindicar recompensas através do seguinte comando:

```shell
rocketpool node claim-rewards
```

Isso mostrará todas as recompensas que você acumulou em todos os intervalos de recompensas começando com a atualização Redstone.
