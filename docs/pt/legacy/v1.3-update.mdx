import { Tab, Tabs } from "@rspress/core/theme";

# Atualizando para Smartnode v1.3.x

A versão 1.3.0 do stack Smartnode traz algumas mudanças importantes das quais os usuários devem estar cientes.
Elas foram projetadas para melhorar significativamente sua experiência como operador de nó e abordar muitos dos recursos que nossos usuários solicitaram desde o lançamento do Rocket Pool.

Neste guia, vamos orientá-lo no processo de migração de uma versão mais antiga do Smartnode para v1.3.x e versões posteriores.

## Mudanças no Arquivo de Configuração

A v1.3.0 introduz algumas mudanças significativas na forma como a configuração do Smartnode é gerenciada.
Se você modificou manualmente a configuração do Smartnode antes, deve estar ciente das seguintes mudanças:

- O arquivo `config.yml` foi removido. Todas as suas informações agora estão incorporadas diretamente no stack Smartnode, para que os usuários não possam mais modificar acidentalmente o arquivo de forma a impedir que o Smartnode funcione corretamente.
  - Todos os parâmetros configuráveis pelo usuário que faziam parte dele agora são configurações na nova Interface de Terminal `service config`.

- O arquivo `settings.yml` foi substituído por um novo arquivo chamado `user-settings.yml`. Este contém todas as suas configurações para cada parte configurável pelo usuário do Smartnode.
  - Este arquivo **não deve ser modificado diretamente**. A modificação deve ser feita através da nova Interface de Terminal `service config`.

- A pasta `chains` foi removida. Os scripts para iniciar o Cliente de Execução (ETH1), o Nó Beacon e o Cliente Validador agora residem na pasta `scripts`.

- Os arquivos YAML do `docker-compose` foram removidos. Cada container agora tem seu próprio arquivo na pasta `templates`. Ao executar `rocketpool service start`, esses templates são preenchidos com suas configurações e colocados na pasta `runtime` automaticamente.
  - Não é recomendado modificar os templates ou arquivos de runtime. Em vez disso, preencha suas personalizações de container usando os arquivos de **override** para cada container na pasta `override`. Esses arquivos sobrescreverão os arquivos Docker em `runtime`, então você é livre para personalizá-los como quiser.
  - Os arquivos em `override` **persistirão após atualizações e reinstalações do Smartnode**, então você só precisa criá-los uma vez.
  - Se você estiver interessado em modificar os arquivos `docker-compose` por meio dessa mecânica de override, consulte [esta seção](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## Instalando a Nova Versão

Instalar a nova versão deve parecer muito familiar.

Comece parando os serviços e baixando o novo CLI como de costume:

<div className="p-3">
  <Tabs>
    <Tab label="Modo Docker ou Híbrido">
      Pare os serviços do Rocket Pool:

      ```
      rocketpool service stop
      ```

      Baixe o novo CLI Smartnode para seu sistema (escolha entre as abas abaixo):

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (a maioria das máquinas normais):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (a maioria dos Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como o Mac mini com M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Agora execute o comando de instalação:

      ```
      rocketpool service install -d
      ```

      A flag `-d` diz para ignorar dependências do sistema como Docker, já que você já as tem.

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTA</p>
        A partir da v1.3.0, você **não precisa mais especificar para qual rede deseja instalar!**
        O novo Smartnode saberá qual rede você já está usando e permitirá que você mude sua rede dinamicamente usando a nova Interface de Terminal.
      </p>
    </Tab>
    <Tab label="Modo Nativo">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Isso atualizará apenas o próprio stack Smartnode - **não** atualizará seus clientes de Execução e Consenso.
        Você terá que fazer isso manualmente (consulte [o guia de atualização manual](../node-staking/updates#manually-updating-the-eth1-or-eth2-client) para aprender como fazer isso).
      </p>

      Pare os serviços do Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Baixe os novos binários do CLI e daemon do Smartnode:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (a maioria das máquinas normais):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (a maioria dos Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como o Mac mini com M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTA</p>
        A partir da v1.3.0, `config.yml` foi removido.
        **Você não precisa mais baixar o pacote do instalador e extraí-lo.**
      </p>
      Em seguida, crie uma pasta de backup chamada `old_config_backup` em seu diretório Smartnode e mova seus arquivos de configuração antigos para ela (`config.yml` e `settings.yml`).
      O Smartnode usará estes para migrar suas configurações para o novo sistema.

      Por exemplo, se você seguiu o guia de configuração Nativa e seu diretório Smartnode é `/srv/rocketpool`:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      Agora, modifique os arquivos de definição de serviço para `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Substitua a linha `ExecStart` pelo seguinte:

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      Observe que a flag `--config` foi removida, e `--settings` agora aponta para `user-settings.yml`.
      **Não se preocupe que este arquivo ainda não existe; ele será gerado automaticamente na próxima etapa.**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se você é um membro do Oracle DAO, você _deve_ repetir o processo acima para o serviço `rp-watchtower` também.
      </p>

      Finalmente, recarregue as definições de serviço:

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

Após a instalação, todos os seus arquivos de configuração antigos serão movidos para uma pasta chamada `old_config_backup` em seu diretório Smartnode (por padrão `~/.rocketpool/old_config_backup`).
Você pode encontrá-los lá se precisar consultá-los por qualquer motivo.

**Se você está procurando instruções sobre como reverter para v1.2.4 a partir deste backup, role até a seção [Revertendo para Sua Configuração Anterior](#revertendo-para-sua-configuracao-anterior) no final desta página.**

## Configurando o Smartnode com a Interface de Terminal

Agora que você tem o novo CLI e pacote instalados, todas as suas configurações anteriores foram preservadas e migradas para o novo sistema.
Na próxima etapa, você deve executar `rocketpool service config`.
Isso parecerá bastante diferente em comparação com versões anteriores desta função; a v1.3.0 introduz a **Interface de Terminal**: uma interface de usuário dinâmica baseada em terminal para configurar seu Smartnode.

Você deve executá-la antes de iniciar os containers Docker após o processo de migração para visualizar a configuração, verificar se todas as suas mudanças foram migradas com sucesso e atualizar quaisquer outras configurações que desejar.

Quando você executá-la pela primeira vez, será apresentado com esta tela de saudação (se você estava usando **modo Docker ou Híbrido**):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip NOTA
**Usuários do Modo Nativo** verão esta tela com redação ligeiramente diferente, que afirma que o Smartnode está operando no modo Nativo.
:::

A TUI começará com **o Assistente**, que permite que você altere de forma rápida e fácil os parâmetros mais importantes do Smartnode (como modo e seleção de cliente).

**Todas as suas configurações anteriores já devem estar destacadas enquanto você percorre cada página do assistente, para que você não precise lembrar qual era sua configuração anterior de cabeça.**

:::warning NOTA
**Para um passo a passo detalhado deste Assistente, visite as seguintes páginas:**

- Para **Modo Docker**, visite [o novo guia de configuração Docker](../node-staking/config-docker).

- **Usuários do Modo Híbrido**: o Modo Híbrido agora é um **recurso de primeira classe** do Smartnode e configurá-lo é _muito_ mais fácil do que costumava ser. Visite [o novo guia de configuração Docker](../node-staking/config-docker) e siga-o. Quando for solicitado a escolher um modo de cliente de Execução e modo de cliente de Consenso, escolha **Gerenciado Externamente** para eles de acordo.

- Para **Modo Nativo**, visite [o novo guia de configuração Nativa](../node-staking/config-native).

:::

Navegue por este assistente e confirme que todas as suas configurações estão corretas.

Depois de terminar, você terá a opção de **revisar todas as configurações antes de salvar**, se desejar.
Isso inclui configurações que o Assistente não cobriu, como o **limite de gás de reivindicação de RPL** ou seu **número máximo de peers do Geth** como exemplos.

A **tela principal de configurações**, que você também deve examinar para confirmar suas configurações anteriores, será assim (para usuários do modo Docker e Híbrido):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip NOTA
**Usuários do Modo Nativo** verão uma tela ligeiramente diferente que é exclusiva para o modo Nativo e apresenta apenas as configurações relevantes para ele.
:::

Sinta-se à vontade para explorar esta nova interface e ajustar quaisquer configurações que considerar adequadas.
Use as `Teclas de Seta` para navegar e pressione `Enter` para entrar em uma categoria ou confirmar quaisquer alterações em uma configuração que você fizer.

Pressione `Esc` quando terminar de editar uma categoria para retornar a esta tela inicial.

Quando estiver pronto para salvar suas alterações e iniciar o stack Smartnode, simplesmente pressione `Tab` para descer até os botões na parte inferior da tela, selecione `Review Changes and Save` (tornando-o verde através das teclas de seta).
Pressione `Enter` para ser levado à **Página de Revisão**, onde você pode ver tudo o que alterou desde a última vez que executou `rocketpool service config`.

Confirme que todas as suas alterações estão presentes e pressione `Enter` novamente para salvá-las.
A tela mostrará quais containers precisam ser reiniciados para que as alterações sejam aplicadas, embora, como você está migrando, já tenha desligado os containers e todos serão reiniciados de qualquer forma.

## Iniciando o Stack Smartnode

Depois de salvar sua configuração, o terminal perguntará se você deseja reiniciar os containers automaticamente (a menos que você esteja usando o modo Nativo).
Se você não deseja / não pode permitir que eles iniciem automaticamente, você pode iniciá-los manualmente com os seguintes comandos:

<div className="p-3">
  <Tabs>
    <Tab label="Modo Docker ou Híbrido">```shell rocketpool service start ```</Tab>
    <Tab label="Modo Nativo">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

Depois que eles estiverem ativos, você pode verificar se tudo está funcionando conforme o esperado.

Use o comando `rocketpool service version` para verificar se você tem a versão correta do Smartnode e dos containers de cliente:

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

Use os comandos `rocketpool service logs eth1` e `rocketpool service logs eth2` para assistir os logs do seu cliente de Execução (anteriormente cliente ETH1) e seu cliente de Consenso (anteriormente cliente ETH2).
Fique atento a quaisquer erros e [visite nosso servidor Discord para obter ajuda](https://discord.com/invite/rocketpool) se encontrá-los.

## Revertendo para Sua Configuração Anterior

Se, por qualquer motivo, você precisar reverter para a v1.2.4 do stack Smartnode, não se preocupe!
Todos os seus arquivos de configuração antigos foram preservados em um diretório de backup e podem ser facilmente recuperados para restaurar sua configuração anterior.

Selecione qual modo você usa nas abas abaixo e siga as instruções.

<div className="p-3">
  <Tabs>
    <Tab label="Modo Docker ou Híbrido">
      Comece substituindo o CLI pelo CLI v1.2.4 para seu sistema:
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (a maioria das máquinas normais):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (a maioria dos Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como o Mac mini com M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Em seguida, copie todos os seus arquivos de configuração antigos da pasta `old_config_backup` de volta para a pasta do Smartnode:

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      Agora, tudo o que você precisa fazer é reiniciar os containers Docker:

      ```shell
      rocketpool service start
      ```

      Pronto! Sua configuração antiga está de volta.

    </Tab>
    <Tab label="Modo Nativo">
      Pare os serviços do Rocket Pool:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (a maioria das máquinas normais):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (a maioria dos Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como o Mac mini com M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      Copie os arquivos de configurações anteriores de volta para seu diretório Smartnode:

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      Agora, reverta os arquivos de definição de serviço para `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Substitua a linha `ExecStart` pelo seguinte:

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se você é um membro do Oracle DAO, você _deve_ repetir o processo acima para o serviço `rp-watchtower` também.
      </p>

      Finalmente, recarregue as definições de serviço e reinicie os serviços:

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      Pronto! Sua configuração antiga está de volta.
    </Tab>

  </Tabs>
</div>
