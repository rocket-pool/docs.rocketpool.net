import { Tab, Tabs } from "@rspress/core/theme";

# Upgrade auf Smartnode v1.3.x

Version 1.3.0 des Smartnode-Stacks bringt einige wichtige Änderungen mit sich, die Benutzer kennen sollten.
Sie sind darauf ausgelegt, Ihre Erfahrung als Node-Betreiber erheblich zu verbessern und viele der Funktionen zu adressieren, die unsere Benutzer seit dem Start von Rocket Pool angefordert haben.

In diesem Leitfaden führen wir Sie durch den Prozess der Migration von einer älteren Version der Smartnode auf v1.3.x und darüber hinaus.

## Änderungen der Konfigurationsdatei

v1.3.0 führt einige bedeutende Änderungen in der Art und Weise ein, wie die Konfiguration der Smartnode verwaltet wird.
Wenn Sie die Smartnode-Konfiguration zuvor manuell geändert haben, sollten Sie sich der folgenden Änderungen bewusst sein:

- Die Datei `config.yml` wurde entfernt. Alle ihre Informationen sind jetzt direkt in den Smartnode-Stack eingebacken, sodass Benutzer die Datei nicht mehr versehentlich so ändern können, dass die Smartnode nicht mehr ordnungsgemäß funktioniert.
  - Alle benutzerdefinierbaren Parameter, die zuvor Teil davon waren, sind jetzt Einstellungen in der neuen Terminal-UI für `service config`.

- Die Datei `settings.yml` wurde durch eine neue Datei namens `user-settings.yml` ersetzt. Diese enthält alle Ihre Einstellungen für jeden benutzerdefinierbaren Teil der Smartnode.
  - Diese Datei ist **nicht dazu gedacht, direkt geändert zu werden**. Änderungen sollten stattdessen über die neue Terminal-UI für `service config` vorgenommen werden.

- Der Ordner `chains` wurde entfernt. Die Skripte zum Starten des Execution-Clients (ETH1), des Beacon-Nodes und des Validator-Clients befinden sich jetzt im Ordner `scripts`.

- Die YAML-Dateien für `docker-compose` wurden entfernt. Jeder Container erhält jetzt seine eigene Datei im Ordner `templates`. Bei `rocketpool service start` werden diese Templates mit Ihren Einstellungen ausgefüllt und automatisch in den Ordner `runtime` eingefügt.
  - Das Ändern der Templates oder Runtime-Dateien wird nicht empfohlen. Füllen Sie stattdessen Ihre Container-Anpassungen mit den **Override**-Dateien für jeden Container im Ordner `override` ein. Diese Dateien überschreiben die Docker-Dateien in `runtime`, sodass Sie sie nach Belieben anpassen können.
  - Die Dateien in `override` **bleiben bei Smartnode-Upgrades und Neuinstallationen erhalten**, sodass Sie sie nur einmal erstellen müssen.
  - Wenn Sie daran interessiert sind, die `docker-compose`-Dateien über diesen Override-Mechanismus zu ändern, lesen Sie bitte [diesen Abschnitt](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## Installation der neuen Version

Die Installation der neuen Version sollte sich sehr vertraut anfühlen.

Beginnen Sie wie gewohnt damit, die Dienste zu stoppen und die neue CLI herunterzuladen:

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">
      Stoppen Sie die Rocket-Pool-Dienste:

      ```
      rocketpool service stop
      ```

      Laden Sie die neue Smartnode-CLI für Ihr System herunter (wählen Sie aus den folgenden Tabs):

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Für `x64`-Systeme (die meisten normalen Maschinen):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Für `arm64`-Systeme:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Für `x64`-Systeme (die meisten Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Für `arm64`-Systeme, wie der Mac mini mit M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Führen Sie nun den Installationsbefehl aus:

      ```
      rocketpool service install -d
      ```

      Das Flag `-d` weist ihn an, Systemabhängigkeiten wie Docker zu ignorieren, da Sie diese bereits haben.

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">HINWEIS</p>
        Ab v1.3.0 **müssen Sie nicht mehr angeben, für welches Netzwerk Sie installieren möchten!**
        Die neue Smartnode weiß, welches Netzwerk Sie bereits verwenden, und ermöglicht es Ihnen, Ihr Netzwerk dynamisch über die neue Terminal-UI zu ändern.
      </p>
    </Tab>
    <Tab label="Native Mode">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">HINWEIS</p>
        Dies aktualisiert nur den Smartnode-Stack selbst - es aktualisiert **nicht** Ihre Execution- und Consensus-Clients.
        Sie müssen dies manuell tun (siehe [die manuelle Update-Anleitung](../node-staking/updates#manually-updating-the-eth1-or-eth2-client), um zu erfahren, wie das geht).
      </p>

      Stoppen Sie die Rocket-Pool-Dienste:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Laden Sie die neuen Smartnode-CLI- und Daemon-Binärdateien herunter:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Für `x64`-Systeme (die meisten normalen Maschinen):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Für `arm64`-Systeme:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Für `x64`-Systeme (die meisten Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Für `arm64`-Systeme, wie der Mac mini mit M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">HINWEIS</p>
        Ab v1.3.0 wurde `config.yml` entfernt.
        **Sie müssen das Installationspaket nicht mehr herunterladen und extrahieren.**
      </p>
      Erstellen Sie als Nächstes einen Backup-Ordner namens `old_config_backup` in Ihrem Smartnode-Verzeichnis und verschieben Sie Ihre alten Konfigurationsdateien (`config.yml` und `settings.yml`) dorthin.
      Die Smartnode wird diese verwenden, um Ihre Einstellungen auf das neue System zu migrieren.

      Wenn Sie beispielsweise die Native-Setup-Anleitung befolgt haben und Ihr Smartnode-Verzeichnis `/srv/rocketpool` ist:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      Ändern Sie nun die Service-Definitionsdateien für `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Ersetzen Sie die Zeile `ExecStart` durch Folgendes:

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      Beachten Sie, dass das Flag `--config` entfernt wurde und `--settings` jetzt auf `user-settings.yml` zeigt.
      **Machen Sie sich keine Sorgen, dass diese Datei noch nicht existiert; sie wird im nächsten Schritt automatisch generiert.**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">HINWEIS</p>
        Wenn Sie Oracle-DAO-Mitglied sind, _müssen_ Sie den obigen Prozess auch für den Dienst `rp-watchtower` wiederholen.
      </p>

      Laden Sie schließlich die Service-Definitionen neu:

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

Nach der Installation werden alle Ihre alten Konfigurationsdateien in einen Ordner namens `old_config_backup` in Ihrem Smartnode-Verzeichnis verschoben (standardmäßig `~/.rocketpool/old_config_backup`).
Sie können sie dort finden, falls Sie sie jemals aus irgendeinem Grund konsultieren müssen.

**Wenn Sie nach Anweisungen zum Zurückkehren zu v1.2.4 aus diesem Backup suchen, scrollen Sie bitte zum Abschnitt [Zurückkehren zu Ihrer vorherigen Konfiguration](#reverting-to-your-previous-configuration) am Ende dieser Seite.**

## Konfiguration der Smartnode mit der Terminal-UI

Jetzt, da Sie die neue CLI und das neue Paket installiert haben, wurden alle Ihre vorherigen Einstellungen beibehalten und auf das neue System migriert.
Im nächsten Schritt sollten Sie `rocketpool service config` ausführen.
Dies wird im Vergleich zu früheren Versionen dieser Funktion ganz anders aussehen; v1.3.0 führt die **Terminal-UI** ein: eine terminalbasierte dynamische Benutzeroberfläche zur Konfiguration Ihrer Smartnode.

Sie müssen sie nach dem Migrationsprozess ausführen, bevor Sie die Docker-Container starten, um die Konfiguration anzuzeigen, zu überprüfen, ob alle Ihre Änderungen erfolgreich migriert wurden, und andere gewünschte Einstellungen zu aktualisieren.

Wenn Sie es zum ersten Mal ausführen, werden Sie mit diesem Begrüßungsbildschirm aufgefordert (wenn Sie den **Docker- oder Hybrid-Modus** verwendet haben):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip HINWEIS
**Native-Mode-Benutzer** sehen diesen Bildschirm mit etwas anderem Wortlaut, der besagt, dass die Smartnode im Native-Modus arbeitet.
:::

Die TUI beginnt mit **dem Wizard**, mit dem Sie die wichtigsten Parameter der Smartnode schnell und einfach ändern können (z. B. Client-Modus und Auswahl).

**Alle Ihre vorherigen Einstellungen sollten bereits hervorgehoben sein, während Sie durch jede Seite des Wizards navigieren, sodass Sie sich nicht merken müssen, wie Ihre vorherige Konfiguration aus dem Stegreif war.**

:::warning HINWEIS
**Für eine detaillierte Anleitung zu diesem Wizard besuchen Sie bitte die folgenden Seiten:**

- Für **Docker-Modus** besuchen Sie bitte [die neue Docker-Konfigurationsanleitung](../node-staking/config-docker).

- **Hybrid-Mode-Benutzer**: Der Hybrid-Modus ist jetzt ein **erstklassiges Feature** der Smartnode und seine Konfiguration ist _viel_ einfacher als früher. Bitte besuchen Sie [die neue Docker-Konfigurationsanleitung](../node-staking/config-docker) und folgen Sie ihr. Wenn Sie aufgefordert werden, einen Execution-Client-Modus und Consensus-Client-Modus zu wählen, wählen Sie entsprechend **Externally Managed** für diese.

- Für **Native-Modus** besuchen Sie bitte [die neue Native-Konfigurationsanleitung](../node-staking/config-native).

:::

Navigieren Sie durch diesen Wizard und bestätigen Sie, dass alle Ihre Einstellungen korrekt sind.

Sobald Sie fertig sind, haben Sie die Möglichkeit, **alle Einstellungen vor dem Speichern zu überprüfen**, falls Sie dies wünschen.
Dies umfasst Einstellungen, die der Wizard nicht abgedeckt hat, wie z. B. den **RPL-Claim-Gas-Schwellenwert** oder Ihre **maximale Anzahl von Geth-Peers** als Beispiele.

Der **Haupteinstellungsbildschirm**, den Sie sich auch ansehen sollten, um Ihre vorherigen Einstellungen zu bestätigen, sieht so aus (für Docker- und Hybrid-Mode-Benutzer):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip HINWEIS
**Native-Mode-Benutzer** sehen einen etwas anderen Bildschirm, der einzigartig für den Native-Modus ist und nur die Einstellungen präsentiert, die dafür relevant sind.
:::

Erkunden Sie diese neue Benutzeroberfläche und passen Sie alle Einstellungen nach Belieben an.
Verwenden Sie die `Pfeiltasten` zur Navigation und drücken Sie `Enter`, um eine Kategorie zu betreten oder Änderungen an einer von Ihnen vorgenommenen Einstellung zu bestätigen.

Drücken Sie `Esc`, wenn Sie mit der Bearbeitung einer Kategorie fertig sind, um zu diesem Home-Bildschirm zurückzukehren.

Wenn Sie bereit sind, Ihre Änderungen zu speichern und den Smartnode-Stack zu starten, drücken Sie einfach `Tab`, um zu den Schaltflächen am unteren Bildschirmrand zu wechseln, und wählen Sie `Review Changes and Save` (indem Sie es mit den Pfeiltasten grün machen).
Drücken Sie `Enter`, um zur **Überprüfungsseite** zu gelangen, auf der Sie alles sehen können, was Sie seit dem letzten Ausführen von `rocketpool service config` geändert haben.

Bestätigen Sie, dass alle Ihre Änderungen vorhanden sind, und drücken Sie dann erneut `Enter`, um sie zu speichern.
Der Bildschirm zeigt Ihnen, welche Container neu gestartet werden müssen, damit die Änderungen wirksam werden, obwohl Sie, da Sie migrieren, die Container bereits ausgeschaltet haben und alle ohnehin neu gestartet werden.

## Starten des Smartnode-Stacks

Nachdem Sie Ihre Konfiguration gespeichert haben, fragt das Terminal, ob Sie die Container automatisch neu starten möchten (es sei denn, Sie verwenden den Native-Modus).
Falls Sie dies nicht tun / nicht zulassen können, dass sie automatisch starten, können Sie sie manuell mit den folgenden Befehlen starten:

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">```shell rocketpool service start ```</Tab>
    <Tab label="Native Mode">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

Sobald sie laufen, können Sie überprüfen, ob alles wie beabsichtigt funktioniert.

Verwenden Sie den Befehl `rocketpool service version`, um zu überprüfen, ob Sie die richtige Version der Smartnode und der Client-Container haben:

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

Verwenden Sie die Befehle `rocketpool service logs eth1` und `rocketpool service logs eth2`, um die Logs für Ihren Execution-Client (ehemals ETH1-Client) und Ihren Consensus-Client (ehemals ETH2-Client) anzuzeigen.
Achten Sie auf Fehler und [besuchen Sie bitte unseren Discord-Server für Hilfe](https://discord.com/invite/rocketpool), wenn Sie welche feststellen.

## Zurückkehren zu Ihrer vorherigen Konfiguration

Wenn Sie aus irgendeinem Grund zu v1.2.4 des Smartnode-Stacks zurückkehren müssen, machen Sie sich keine Sorgen!
Alle Ihre alten Konfigurationsdateien wurden in einem Backup-Verzeichnis aufbewahrt und können einfach abgerufen werden, um Ihr vorheriges Setup wiederherzustellen.

Wählen Sie aus den folgenden Tabs, welchen Modus Sie verwenden, und folgen Sie den Anweisungen.

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">
      Beginnen Sie damit, die CLI durch die v1.2.4-CLI für Ihr System zu ersetzen:
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Für `x64`-Systeme (die meisten normalen Maschinen):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Für `arm64`-Systeme:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Für `x64`-Systeme (die meisten Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Für `arm64`-Systeme, wie der Mac mini mit M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Kopieren Sie als Nächstes alle Ihre alten Konfigurationsdateien aus dem Ordner `old_config_backup` zurück in den Ordner der Smartnode:

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      Jetzt müssen Sie nur noch die Docker-Container neu starten:

      ```shell
      rocketpool service start
      ```

      Fertig! Ihre alte Konfiguration ist zurück.

    </Tab>
    <Tab label="Native Mode">
      Stoppen Sie die Rocket-Pool-Dienste:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Für `x64`-Systeme (die meisten normalen Maschinen):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Für `arm64`-Systeme:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Für `x64`-Systeme (die meisten Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Für `arm64`-Systeme, wie der Mac mini mit M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      Kopieren Sie die vorherigen Einstellungsdateien zurück in Ihr Smartnode-Verzeichnis:

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      Setzen Sie nun die Service-Definitionsdateien für `rp-node` zurück:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Ersetzen Sie die Zeile `ExecStart` durch Folgendes:

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">HINWEIS</p>
        Wenn Sie Oracle-DAO-Mitglied sind, _müssen_ Sie den obigen Prozess auch für den Dienst `rp-watchtower` wiederholen.
      </p>

      Laden Sie schließlich die Service-Definitionen neu und starten Sie die Dienste neu:

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      Fertig! Ihre alte Konfiguration ist zurück.
    </Tab>

  </Tabs>
</div>
