import { Tab, Tabs } from "@rspress/core/theme";

# [Modo Nativo] Guía para la Actualización Redstone y The Merge

Esta guía cubrirá todo lo que necesitas saber para preparar tu nodo para la Actualización Redstone y The Merge si estás usando **Modo Nativo**.

## Cosas que Hacer Antes de Actualizar a v1.5.0

Antes de actualizar a v1.5.0 y versiones superiores del Smartnode, por favor revisa la siguiente lista de verificación para asegurarte de que estás preparado:

### Cambiar a un Cliente de Ejecución Completo

The Merge requiere que ejecutes tu propio cliente de Ejecución, por lo que ya no podrás usar proveedores remotos como Infura o Pocket.

Debido a este cambio, si actualmente estás usando un cliente de Ejecución ligero, debes cambiar a un cliente completo mientras aún estás en v1.4, dejarlo sincronizar hasta completarse, y luego actualizar a v1.5.

### Configurar el Engine API

The Merge cambia la forma en que tu cliente de Ejecución se comunica con tu cliente de Consenso.
En lugar de usar el antiguo sistema RPC basado en HTTP o Websocket, The Merge requiere un nuevo sistema expuesto por tu cliente de Ejecución llamado Engine API.

Esta es una conexión especial que permite al cliente de Consenso reemplazar el antiguo sistema de minería Proof-of-Work con Proof-of-Stake; es el corazón de The Merge.
También está **autenticado** con un token secreto, por lo que solo tu cliente de Consenso puede conectarse a tu cliente de Ejecución - nada más puede hacerlo.

Como gestionas tus propios clientes de Ejecución y Consenso, necesitarás configurar el Engine API manualmente.
Cómo hacerlo depende completamente de qué clientes estés ejecutando.

CoinCashew tiene [una guía excelente y concisa](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) sobre cómo configurar el Engine API en tus clientes de Ejecución y Consenso.
Échale un vistazo, y prueba la nueva configuración asegurándote de que todavía atestigua correctamente antes de actualizar.

Te mostraremos cómo configurar tu cliente Validador para que use el destinatario de tarifas correcto requerido por el software Smartnode automáticamente a continuación.

## Actualizar a v1.5.0

Actualizar la pila Smartnode a v1.5.0 no es diferente a cualquier otra actualización.
Simplemente sigue [las instrucciones normales aquí](../../node-staking/updates#updating-the-smartnode-stack).

## Cosas que Debes Hacer Después de Actualizar

En modo Nativo, hay varias cosas que necesitarás hacer manualmente después de actualizar:

### Asegurar una Actualización Exitosa

Lo primero que debes hacer es asegurarte de que tu nodo esté funcionando correctamente.
Considera seguir los siguientes pasos:

- Revisa tus scripts de registro para el cliente de Ejecución, el cliente de Consenso, el cliente Validador y el daemon Smartnode (el servicio `rp-node`) para asegurarte de que todos estén funcionando normalmente sin errores.
- Confirma con un Block Explorer (como tu panel de Grafana y [https://beaconcha.in](https://beaconcha.in)) que todavía estés atestiguando correctamente
  - Recuerda que si tienes habilitada la protección Doppelganger, perderás algunas atestiguaciones después del reinicio. ¡Esto es normal!

### Configurar el Destinatario de Tarifas en tu Cliente Validador

Uno de los detalles **críticos** a configurar antes de The Merge es el **destinatario de tarifas** especificado por tu cliente validador.
Como se describe en el [artículo de resumen](./whats-new#fee-recipients-and-your-distributor), este puede ser uno de dos valores:

- Si **has optado** por el Smoothing Pool, esta debe ser la dirección del **contrato Smoothing Pool**. Puedes obtener la dirección de [la página de contratos oficiales](/es/protocol/contracts-integrations).
- Si **no** estás en el Smoothing Pool, esta debe ser la dirección del **contrato distribuidor de tarifas** de tu nodo. Puedes obtener la dirección ejecutando `rocketpool node status`, en la sección `Fee Distributor and Smoothing Pool`.

En modo Nativo, tienes la opción de dejar que el Smartnode gestione esto por ti si usas el servicio daemon Smartnode, `rp-node`, o gestionarlo tú mismo si no usas el daemon.

#### Gestión Automática a través del Daemon

El daemon Smartnode determinará automáticamente el destinatario de tarifas apropiado para tu nodo y lo gestionará en caso de que cambie (como al optar por entrar y salir del Smoothing Pool).
Esta es la opción **más segura**, porque el Smartnode siempre se asegurará de que esté configurado en un valor que **previene [penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)**.

La forma en que hace esto es manteniendo un archivo con el destinatario de tarifas correcto en él, y actualizándolo regularmente para asegurar su corrección.
Cuando necesita ser actualizado, modifica el archivo y reinicia tu cliente Validador automáticamente para que cargue el nuevo destinatario - de manera similar a cómo reinicia tu cliente Validador después de hacer staking en un nuevo minipool.

Selecciona tu cliente a continuación para aprender cómo configurarlo:

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Modifica tu servicio de Cliente Validador agregando la siguiente línea _antes_ de la línea `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por ejemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Luego, agrega el siguiente argumento de línea de comandos _al final_ de tu línea `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Tu VC ahora usará el archivo gestionado por el daemon Smartnode, y será reiniciado automáticamente cuando el destinatario de tarifas cambie.
    </Tab>
    <Tab label="Nimbus">
      Modifica tu servicio de Cliente Validador agregando la siguiente línea _antes_ de la línea `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por ejemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Luego, agrega el siguiente argumento de línea de comandos _al final_ de tu línea `ExecStart`:

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      Tu VC ahora usará el archivo gestionado por el daemon Smartnode, y será reiniciado automáticamente cuando el destinatario de tarifas cambie.
    </Tab>
    <Tab label="Prysm">
      Modifica tu servicio de Cliente Validador agregando la siguiente línea _antes_ de la línea `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por ejemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Luego, agrega el siguiente argumento de línea de comandos _al final_ de tu línea `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Tu VC ahora usará el archivo gestionado por el daemon Smartnode, y será reiniciado automáticamente cuando el destinatario de tarifas cambie.
    </Tab>
    <Tab label="Teku">
      Modifica tu servicio de Cliente Validador agregando la siguiente línea _antes_ de la línea `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Por ejemplo:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Luego, agrega el siguiente argumento de línea de comandos _al final_ de tu línea `ExecStart`:

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      Tu VC ahora usará el archivo gestionado por el daemon Smartnode, y será reiniciado automáticamente cuando el destinatario de tarifas cambie.
    </Tab>

  </Tabs>
</div>

#### Gestión Manual del Destinatario de Tarifas

::: danger ADVERTENCIA
Al hacer esto, asumes toda la responsabilidad de asegurar que tu destinatario de tarifas esté siempre configurado en la dirección correcta.

Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) para entender a qué debe estar configurado dada tu configuración, y cuándo puedes cambiarlo de forma segura de un valor a otro.

¡No hacerlo podría resultar en que tus minipools sean penalizados!
:::

**Antes de que Redstone sea desplegado**, simplemente puedes usar la dirección rETH para la red en la que estés (que se puede encontrar en [la página de contratos oficiales](/es/protocol/contracts-integrations)).
La dirección rETH siempre es segura sin importar qué.

**Una vez que Redstone haya sido desplegado**, puedes ver la dirección exacta a la que debes configurar tu destinatario de tarifas mediante `rocketpool node status`. Por ejemplo, si has optado por el Smoothing Pool, mostrará la dirección del Smoothing Pool y señalará que debes usarla como tu destinatario de tarifas:

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Si _no_ has optado por el Smoothing Pool, mostrará la dirección de tu distribuidor de tarifas y señalará que debes usarla como tu destinatario de tarifas:

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

Selecciona tu cliente de Consenso a continuación para aprender cómo configurarlo.

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Agrega el siguiente argumento de línea de comandos al archivo de definición de servicio de tu Cliente Validador:

      ```
      --suggested-fee-recipient `address`
      ```

      Donde `address` es:

      - La [dirección rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se despliegue la actualización Redstone (ej., `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea desplegado, que puedes recuperar con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si optas por el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto a usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>
    <Tab label="Nimbus">
      Agrega el siguiente argumento de línea de comandos al archivo de definición de servicio de Nimbus:

      ```
      --suggested-fee-recipient=`address`
      ```

      Donde `address` es:

      - La [dirección rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se despliegue la actualización Redstone (ej., `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea desplegado, que puedes recuperar con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si optas por el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto a usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>
    <Tab label="Prysm">
      Agrega el siguiente argumento de línea de comandos al archivo de definición de servicio de tu Cliente Validador:

      ```
      --suggested-fee-recipient `address`
      ```

      Donde `address` es:

      - La [dirección rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se despliegue la actualización Redstone (ej., `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea desplegado, que puedes recuperar con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si optas por el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto a usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>
    <Tab label="Teku">
      Agrega el siguiente argumento de línea de comandos al archivo de definición de servicio de tu Cliente Validador:

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      Donde `address` es:

      - La [dirección rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se despliegue la actualización Redstone (ej., `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea desplegado, que puedes recuperar con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si optas por el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto a usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>

  </Tabs>
</div>

### Configurar MEV-Boost

[MEV-boost](https://boost.flashbots.net/) es el sistema que Flashbots proporciona para dar recompensas MEV a los validadores Proof-of-Stake después de The Merge.

**Rocket Pool requiere que todos los nodos lo usen para maximizar sus retornos y así mantener el protocolo competitivo con otros servicios de staking.**

Necesitarás hacer algunos ajustes a tu Beacon Node / cliente de Consenso para conectarlo a MEV-boost.

MEV-boost actualmente no está disponible en Hoodi o Mainnet, por lo que no necesitas configurarlo en este momento.
Por supuesto, no serás penalizado por no usarlo durante este período de transición.

Una vez que esté disponible, anunciaremos una fecha en la cual debe ser instalado y conectado a tu nodo.
Flashbots proporcionará instrucciones que puedes seguir en ese momento, y las enlazaremos aquí.

::: danger NOTA
Una vez que hagamos el anuncio de que MEV-boost debe ser habilitado por todos los operadores de nodos, ¡debes asegurarte de tenerlo correctamente instalado y configurado con tu Beacon Node!

No hacerlo resultará en que tu minipool sea [penalizado](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).
:::

### Configurar un Nodo de Respaldo

Como The Merge no es compatible con proveedores remotos como Infura y Pocket, perderás la capacidad de usarlos como clientes de Ejecución de respaldo cuando tu primario se desconecte.

El Smartnode todavía tiene la capacidad de proporcionar un cliente de Ejecución de respaldo (y ahora también un cliente de Consenso de respaldo), pero ahora necesitarás usar clientes de Ejecución y Consenso que tú controles.

Para más información sobre la configuración de un nodo de respaldo, consulta la [Guía de nodo de respaldo](../../node-staking/fallback).

### Inicializar tu Distribuidor de Tarifas

Si no planeas optar por el [Smoothing Pool](./whats-new#smoothing-pool) y reclamar todas tus tarifas prioritarias y recompensas MEV a tu [contrato distribuidor de tarifas](./whats-new#fee-recipients-and-your-distributor), eventualmente tendrás que inicializarlo (crear la instancia del contrato en la cadena) para poder reclamar recompensas de él a tu dirección de retiro.

Esta es una operación bastante económica y solo necesita hacerse una vez.

::: tip CONSEJO
Inicializar tu distribuidor de tarifas se puede hacer en **cualquier momento**.
Puedes dejar que las recompensas se acumulen en su dirección mucho antes de inicializarlo, y tu saldo permanecerá después de la inicialización.

Recomendamos hacerlo cuando los precios del gas sean bajos para minimizar el costo general.

Ten en cuenta que **debe ser inicializado para poder reclamar tus recompensas.**
:::

### Optar por el Smoothing Pool

Si planeas aprovechar el [Smoothing Pool](./whats-new#smoothing-pool) de inmediato, debes optar por él antes del final del primer período de recompensas de Redstone para maximizar tu cantidad de "elegibilidad".

Optar por él se puede hacer ejecutando el siguiente comando:

```shell
rocketpool node join-smoothing-pool
```

### Reclamar Recompensas

La actualización Redstone reemplaza el costoso y problemático antiguo sistema de recompensas con un [sistema completamente nuevo](./whats-new#new-rewards-system) que es mucho más económico, soporta el re-staking automático de RPL (tanto cantidades parciales como completas), y - lo más importante - **te permite reclamar tus recompensas cuando quieras**.

Como ya no hay un límite de tiempo para reclamar recompensas, y como es más económico reclamar muchos intervalos de recompensas a la vez, la función de reclamación automática de recompensas del Smartnode **ha sido eliminada**.
Ahora podrás reclamar recompensas mediante el siguiente comando:

```shell
rocketpool node claim-rewards
```

Esto te mostrará todas las recompensas que has acumulado a través de todos los intervalos de recompensas comenzando con la actualización Redstone.
