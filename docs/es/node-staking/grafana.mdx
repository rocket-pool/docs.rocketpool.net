import { Tab, Tabs } from "@rspress/core/theme";

# Configuración del Panel de Grafana

Ahora que tienes tu nodo en funcionamiento, probablemente querrás tener una forma conveniente de monitorear todo sobre él de un vistazo para asegurarte de que funciona correctamente (y qué tipo de ganancias está generando para ti).

Hay muchas herramientas que hacen este trabajo.
Una de las más populares se llama [Grafana](https://grafana.com/) - un sistema de panel de uso fácil y propósito general al que puedes acceder con un navegador.

Rocket Pool viene listo para usar con soporte para Grafana y sus dependencias; incluso viene con un panel preconstruido para cada uno de los clientes de consenso.
Por ejemplo, aquí hay una captura de lo que se ve el panel en la red de prueba Hoodi:

![](./images/grafana-1.3.jpg)

El panel estándar incluye la siguiente información toda en un formato conveniente:

- **Superior izquierda:** algunas estadísticas importantes sobre la salud y rendimiento de tu máquina, y cualquier actualización pendiente del sistema
- **Superior derecha:** la actividad y rendimiento de tus validadores en la Beacon Chain, junto con algunas estadísticas del cliente de ejecución y consenso
- **Inferior izquierda:** detalles sobre toda la red de Rocket Pool, para referencia
- **Inferior derecha:** detalles sobre tus recompensas de staking, tanto ETH como RPL

En esta guía, te mostraremos cómo habilitar el sistema de métricas de Rocket Pool para que puedas usar este panel - ¡o incluso construir el tuyo propio!

## Visión General del Stack de Métricas de Rocket Pool

Si eliges habilitar las métricas durante el proceso de configuración del Smartnode, tu nodo agregará los siguientes procesos:

- [Prometheus](https://prometheus.io/) - un sistema de recopilación, almacenamiento y reporte de datos que captura todas las métricas que ves arriba (y muchas más) y las almacena, para que puedan ser consultadas a lo largo del tiempo
- El [Node Exporter](https://github.com/prometheus/node_exporter) de Prometheus - un servicio que recopila información sobre la salud de tu máquina (como uso de CPU, uso de RAM, espacio libre en disco y espacio de intercambio, etc.) y lo reporta a Prometheus
- Grafana, la herramienta que expone los datos de Prometheus a través de un sitio web conveniente alojado en tu nodo
- Un conjunto opcional de scripts personalizados que reportarán cualquier actualización disponible del sistema operativo a Prometheus, para que sepas si tu sistema necesita ser parcheado

La configuración predeterminada creará contenedores Docker con todos estos servicios que vivirán junto al resto de los contenedores Docker del Smartnode.
Abrirá un puerto en tu máquina de nodo para Grafana, para que puedas acceder a su panel desde cualquier máquina en tu red local con un navegador.

## Habilitando el Servidor de Métricas

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Habilitar métricas en modo Docker es lo más fácil de todo.

      Comienza ejecutando el comando de configuración del Smartnode nuevamente:

      ```shell
      rocketpool service config
      ```

      Ve a la sección `Monitoring / Metrics` y marca la casilla `Enable Metrics`.

      Para aquellos que prefieren ajustar finamente sus configuraciones de puerto, pueden hacerlo aquí.
      Ten en cuenta que todos estos puertos están restringidos a la red interna de Docker con la excepción del puerto de Grafana - ese se abrirá en tu máquina (para que puedas acceder a él a través de un navegador desde otras máquinas, como tu escritorio o teléfono) por lo que es posible que desees cambiarlo si el puerto predeterminado entra en conflicto con algo que ya tienes.

      Guarda y sal, y smartnode iniciará los contenedores Docker de Prometheus, Node Exporter y Grafana por ti.

      También modificará tus clientes de consenso y validador para que expongan sus propias métricas a Prometheus.

      El rastreador de actualizaciones del sistema operativo y Rocket Pool **no está instalado por defecto** para máxima flexibilidad, pero el proceso es simple.
      Si deseas instalarlo para que tu panel te muestre cuántas actualizaciones están disponibles para tu sistema, puedes hacerlo con este comando:

      ```shell
      rocketpool service install-update-tracker
      ```

      Internamente, esto instalará un servicio que se conecta al administrador de paquetes de tu sistema operativo, verifica periódicamente las actualizaciones y envía esa información a Prometheus.
      Este servicio es diferente para cada sistema operativo, pero se ha confirmado que funciona en los siguientes:

      - Ubuntu 20.04+
      - Debian 9 y 10
      - CentOS 7 y 8
      - Fedora 34


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Habilitar el servicio automáticamente es incompatible con SELinux.
        Si tu sistema tiene SELinux habilitado por defecto (como es el caso de CentOS y Fedora), el comando de instalación te llevará _la mayor parte del camino_ pero también te dará instrucciones sobre cómo finalizar el proceso manualmente al final.
      </p>


      Durante esta verificación, también comparará tu versión instalada de Rocket Pool Smartnode con la última versión, y te informará si hay una nueva versión disponible.

      Si habilitaste el rastreador de actualizaciones, el último paso es reiniciar el Node Exporter con el siguiente comando:

      ```shell
      docker restart rocketpool_exporter
      ```

      Después de eso, deberías estar listo.
    </Tab>
    <Tab label="Hybrid">
      El modo híbrido funciona de manera similar al modo Docker; la única diferencia es que debes agregar manualmente las banderas de línea de comandos apropiadas para habilitar métricas a la definición del servicio de tu cliente de ejecución y consenso.

      Primero, actualizaremos tu cliente de ejecución.
      Abre el archivo de unidad `systemd` que creaste cuando instalaste tu cliente de ejecución y asegúrate de que tenga las banderas correctas, según el cliente que estés ejecutando:

      <div className="p-3">
        <Tabs>
          <Tab label="Geth">
            ```
            --metrics --metrics.addr 0.0.0.0 --metrics.port 9105
            ```
          </Tab>
          <Tab label="Nethermind">
            ```
            --Metrics.Enabled true --Metrics.ExposePort 9105
            ```
          </Tab>
          <Tab label="Besu">
            ```
            --metrics-enabled --metrics-host=0.0.0.0 --metrics-port=9105
            ```
          </Tab>
        </Tabs>
      </div>

      A continuación, actualizaremos tu cliente de consenso.
      Abre el archivo de unidad `systemd` que creaste cuando instalaste tu cliente de consenso y asegúrate de que tenga las banderas correctas, según el cliente que estés ejecutando:

      <div className="p-3">
        <Tabs>
          <Tab label="Lighthouse">
            ```
            --metrics --metrics-address 0.0.0.0 --metrics-port 9100 --validator-monitor-auto
            ```
          </Tab>
          <Tab label="Lodestar">
            ```
            --metrics --metrics.address 0.0.0.0 --metrics.port 9100
            ```
          </Tab>
          <Tab label="Nimbus">
            ```
            --metrics --metrics-address=0.0.0.0 --metrics-port=9100
            ```
          </Tab>
          <Tab label="Prysm">
            ```
            --monitoring-host 0.0.0.0 --monitoring-port 9100
            ```

            Si ves la bandera `--disable-monitoring`, elimínala.
          </Tab>
          <Tab label="Teku">
            ```
            --metrics-enabled=true --metrics-interface=0.0.0.0 --metrics-port=9100 --metrics-host-allowlist=*
            ```
          </Tab>

        </Tabs>
      </div>

      Si ya tienes estas banderas configuradas y estás usando puertos diferentes para tu monitoreo de validador solo, déjalos como están y toma nota de qué puertos estás usando.

      Ahora, desplázate hacia arriba y sigue las instrucciones en la pestaña `Docker` de esta sección para finalizar el proceso - teniendo en cuenta que debes reemplazar los puertos listados allí con cualquier puerto personalizado que uses cuando ejecutes `rocketpool service config`.

    </Tab>
    <Tab label="Native">
      La instalación nativa de Grafana y Prometheus se recomienda solo para usuarios avanzados. Requiere habilidades de administración de Linux como `systemd`, permisos de archivos, gestión de usuarios y redes.

      Primero, asegúrate de que tu cliente de ejecución y cliente de consenso tengan las métricas habilitadas. Consulta la pestaña 'Hybrid' para más detalles.

      A continuación, verifica los paquetes preconstruidos de prometheus y node_exporter en [la página oficial de descargas](https://prometheus.io/download/).
      Elige paquetes con la arquitectura adecuada para tu plataforma (amd64 o arm64).
      Se recomienda la versión LTS (Long Time Support) más reciente de Prometheus.

      Por ejemplo, para descargar prometheus v2.45.3 LTS y node_exporter v1.7.0 para Linux amd64 con `wget` haz:

      ```shell
      wget https://github.com/prometheus/prometheus/releases/download/v2.45.3/prometheus-2.45.3.linux-amd64.tar.gz
      wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
      wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
      ```

      Extrae los ejecutables de prometheus y node_exporter de los archivos descargados.

      ```shell
      sudo tar -zxvf prometheus-2.45.3.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/prometheus' --strip-components=1
      sudo tar -zxvf node_exporter-1.7.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/node_exporter' --strip-components=1
      sudo tar -zxvf alertmanager-0.26.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/alertmanager' --strip-components=1
      ```

      Crea directorios para las configuraciones de prometheus y alertmanager.

      ```shell
      sudo mkdir /etc/prometheus
      sudo mkdir /etc/alertmanager
      sudo mkdir /var/lib/prometheus
      sudo mkdir /var/lib/alertmanager
      ```

      Crea el archivo `/etc/prometheus/prometheus.yml` con el siguiente contenido:

      ```yaml
      global:
      scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
      scrape_timeout: 12s # Timeout must be shorter than the interval
      evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.

      scrape_configs:
      - job_name: "prometheus"
      static_configs:
      - targets: ["localhost:9091"]

      - job_name: "node"
      static_configs:
      - targets: ["localhost:9103"]
      #     - targets: ['localhost:9103', 'node_hostname:9103']
      - job_name: "eth1"
      static_configs:
      - targets: ["localhost:9105"]
      # Uncomment the line below if you are using geth as Execution Client
      #metrics_path: /debug/metrics/prometheus

      - job_name: "eth2"
      static_configs:
      - targets: ["localhost:9100"]

      - job_name: "validator"
      static_configs:
      - targets: ["validator:9101"]

      - job_name: "rocketpool"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["node:9102"]

      - job_name: "watchtower"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["watchtower:9104"]

      alerting:
      alertmanagers:
      - static_configs:
      - targets: ["localhost:9093"]
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Cambia los números de puerto para el cliente de ejecución y cliente de consenso si es necesario.

        Es posible que estés ejecutando tu nodo en un host diferente al host que ejecuta prometheus. En ese caso
        instala node_exporter en el host de tu nodo rocketpool y actualiza `targets` del trabajo `node` para incluir todas las máquinas que deseas monitorear.
        También ajusta `metrics_path` si tu cliente de ejecución es geth - expone un endpoint no estándar para métricas.
      </p>

      Crea el `/etc/alertmanager/alertmanager.yml` con el siguiente contenido:

      ```yaml
      global:
      # ResolveTimeout is the default value used by alertmanager if the alert does
      # not include EndsAt, after this time passes it can declare the alert as resolved if it has not been updated.
      # This has no impact on alerts from Prometheus, as they always include EndsAt.
      # default = 5m
      resolve_timeout: 5m

      route:
      # The labels by which incoming alerts are grouped together.
      group_by: ["alertname"]
      # How long to initially wait to send a notification for a group
      # of alerts. Allows to wait for an inhibiting alert to arrive or collect
      # more initial alerts for the same group.
      group_wait: 30s
      # How long to wait before sending a notification about new alerts that
      # are added to a group of alerts for which an initial notification has
      # already been sent. (Usually ~5m or more.)
      group_interval: 5m
      # How long to wait before sending a notification again if it has already been sent successfully for an alert.
      repeat_interval: 4h
      routes:
      # severity=info: Don't send the follow-up resolved notification.
      - match:
      severity: info
      continue: false
      # The notification destination
      receiver: "node_operator_no_resolved"
      # all other alerts get sent notifications for the initial firing _and_ resolved notifications.
      - receiver: "node_operator_default"
      #match: We want this to match all alerts (severity=info is first though so it will stop)

      # The notification destination
      receiver: "node_operator_default"

      receivers:
      - name: "node_operator_default"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"

      - name: "node_operator_no_resolved"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"
      send_resolved: false

      inhibit_rules:
      # Inhibit rules mute a new alert (target) that matches an existing alert (source).
      - source_match:
      # if the existing alert (source) is severity=critical
      severity: "critical"
      target_match:
      # and the new alert (target) is severity=warning
      severity: "warning"
      # and the alertname, job, and instance labels have the same value
      equal: ["alertname", "job", "instance"]
      ```

      Crea un usuario del sistema para prometheus y alertmanager.

      ```shell
      sudo useradd -r -s /sbin/nologin prometheus
      sudo useradd -r -s /sbin/nologin alertmanager
      ```

      Cambia la propiedad y permisos de los archivos de prometheus/alertmanager.

      ```shell
      sudo chown prometheus:prometheus /usr/local/bin/prometheus
      sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
      sudo chown prometheus:prometheus /usr/local/bin/node_exporter
      sudo chown -R prometheus:prometheus /etc/prometheus
      sudo chown -R alertmanager:alertmanager /etc/alertmanager
      sudo chown -R prometheus:prometheus /var/lib/prometheus
      sudo chown -R alertmanager:alertmanager /var/lib/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/prometheus
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/node_exporter
      ```

      Crea el archivo `/lib/systemd/system/node-exporter.service` para la configuración del servicio node_exporter.

      ```
      [Unit]
      Description=Node metrics exporter for Prometheus
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=node-exporter
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9103

      [Install]
      WantedBy=multi-user.target
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Si deseas cambiar el puerto en el que se ejecuta node_exporter, modifica el comando en el parámetro `ExecStart`. El puerto predeterminado es 9100.
      </p>

      Crea el archivo `/lib/systemd/system/prometheus.service` para la configuración del servicio prometheus.

      ```
      [Unit]
      Description=Prometheus instance
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=prometheus
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --web.listen-address=:9091

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Si deseas cambiar el puerto en el que se ejecuta prometheus, modifica el comando en el parámetro `ExecStart`. El puerto predeterminado es 9090.
      </p>

      Crea el archivo `/lib/systemd/system/alertmanager.service` para la configuración del servicio alertmanager.

      ```
      [Unit]
      Description=Alertmanager instance
      Documentation=https://prometheus.io/docs/alerting/latest/alertmanager/
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=alertmanager
      Group=alertmanager
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/alertmanager
      RuntimeDirectory=alertmanager
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/alertmanager --config.file /etc/alertmanager/alertmanager.yml --web.listen-address=:9093

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Si deseas cambiar el puerto en el que se ejecuta alertmanager, modifica el comando en el parámetro `ExecStart`. El puerto predeterminado es 9093.
      </p>

      Informa a `systemd` sobre los nuevos servicios.

      ```shell
      sudo systemctl daemon-reload
      ```

      Habilita e inicia el servicio node-exporter.

      ```shell
      sudo systemctl enable node-exporter
      sudo systemctl start node-exporter
      ```

      Verifica el estado del servicio para asegurarte de que esté funcionando.

      ```shell
      sudo systemctl status node-exporter
      ```

      Habilita e inicia el servicio prometheus.

      ```shell
      sudo systemctl enable prometheus
      sudo systemctl start prometheus
      ```

      Habilita e inicia el servicio alertmanager.

      ```shell
      sudo systemctl enable alertmanager
      sudo systemctl start alertmanager
      ```

      Verifica el estado del servicio para asegurarte de que esté funcionando.

      ```shell
      sudo systemctl status prometheus
      sudo systemctl status alertmanager
      ```

      Configura el repositorio de paquetes para Grafana.

      ```shell
      sudo apt-get update
      sudo apt-get install -y apt-transport-https software-properties-common
      sudo mkdir -p /etc/apt/keyrings/
      wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
      echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
      ```

      Instala Grafana.

      ```shell
      sudo apt-get update
      sudo apt-get install grafana
      ```

      Verifica la configuración en `/etc/grafana/grafana.ini`. Cambia el `http_port` a 3100 para estar en línea con las otras secciones provistas en este documento.

      Configura la fuente de datos para visualizar métricas desde Prometheus en Grafana. Crea el archivo `/etc/grafana/provisioning/datasources/prometheus.yml`.

      ```yaml
      apiVersion: 1

      deleteDatasources:
      - name: Prometheus
      orgId: 1

      datasources:
      - name: Prometheus
      type: prometheus
      access: proxy
      orgId: 1
      url: http://localhost:9091
      basicAuth: false
      isDefault: true
      version: 1
      editable: true
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Edita `url` si has cambiado el puerto de escucha de Prometheus.
      </p>

      Habilita e inicia el servicio para Grafana.

      ```shell
      sudo systemctl daemon-reload
      sudo systemctl enable grafana-server
      sudo systemctl start grafana-server
      ```

      Verifica si Grafana está funcionando.

      ```shell
      sudo systemctl status grafana-server
      ```

      Esto es prácticamente todo.
    </Tab>

  </Tabs>
</div>

## Configurar el firewall para permitir conexiones de monitoreo

::: warning NOTA
Si tienes UFW habilitado como se referencia en la sección [Asegurando tu Nodo](./securing-your-node), necesitarás abrir algunos puertos para permitir conexiones locales entre Prometheus y tus clientes de ejecución/consenso. Sigue los pasos a continuación.
:::

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Ejecuta lo siguiente y reemplaza los puertos según sea necesario:

      ```shell
      RP_NET=$(docker inspect rocketpool_net | grep -Po "(?<=\"Subnet\": \")[0-9./]+")
      sudo ufw allow from $RP_NET to any port 9105 comment "Allow Prometheus access to Execution Client"
      sudo ufw allow from $RP_NET to any port 9100 comment "Allow Prometheus access to Consensus Client"
      sudo ufw allow from $RP_NET to any port 9103 comment "Allow Prometheus access to Exporter"
      ```
    </Tab>
    <Tab label="Native">
      Si tu nodo RocketPool y Prometheus residen en hosts diferentes, necesitas configurar el firewall en el host de tu nodo para permitir tráfico entrante
      desde la IP del host de Prometheus a los puertos de monitoreo del nodo.
      También necesitas configurar UFW en la máquina de Prometheus para permitir tráfico saliente desde el host de Prometheus al host del nodo RocketPool.

      Teniendo la IP del host del nodo `192.168.1.5` y la IP del host de Prometheus `192.168.1.6`, las reglas UFW para el nodo serán:

      ```shell
      sudo ufw allow from 192.168.1.6 to any port 9100:9105 proto tcp comment 'Allow Prometheus host to scrape metrics of this host'
      ```

      Y para el host de Prometheus:

      ```shell
      sudo ufw allow out from any to 192.168.1.5 port 9100:9105 proto tcp comment 'Allow this host to scrape node metrics'
      ```

      Asumiendo que tu puerto de escucha de Grafana es 3100, continúa leyendo para descubrir cómo exponer Grafana en tu red.
    </Tab>

  </Tabs>
</div>

Luego puedes abrir el firewall para permitir que dispositivos externos accedan a tu panel de Grafana.

<div className="p-3">
  <Tabs>
    <Tab label="Network">
      Usa esto si deseas acceder a Grafana desde cualquier máquina dentro de tu red local, pero denegar el acceso en cualquier otro lugar.
      Este será el caso de uso más común.

      Por favor verifica si tu red local usa la estructura `192.168.1.xxx` primero.
      Es posible que tengas que cambiar el comando a continuación para que coincida con la configuración de tu red local si usa una estructura de direcciones diferente (por ejemplo, `192.168.99.xxx`).

      ```shell
      # This assumes your local IP structure is 192.168.1.xxx
      sudo ufw allow from 192.168.1.0/24 proto tcp to any port 3100 comment 'Allow grafana from local network'
      ```

    </Tab>
    <Tab label="Subnet">
      Usa esto si tu nodo Rocket Pool no está conectado a la misma subred que el dispositivo desde el cual estás viendo Grafana. Esto puede suceder cuando tu nodo está conectado directamente al módem de tu ISP y el dispositivo que usas para ver Grafana está conectado a un router secundario.

      Por favor verifica si tu red local usa la estructura `192.168.1.xxx` primero.
      Es posible que tengas que cambiar el comando a continuación para que coincida con la configuración de tu red local si usa una estructura de direcciones diferente (por ejemplo, `192.168.99.xxx`).

      ```shell
      # To allow any devices in the broader subnet
      # for example allowing 192.168.2.20 to access
      # grafana on 192.168.1.20
      sudo ufw allow from 192.168.1.0/16 proto tcp to any port 3100 comment 'Allow grafana from local subnets'
      ```
    </Tab>
    <Tab label="Anywhere">
      Esto te permitirá acceder a Grafana desde cualquier lugar.
      Si deseas acceder desde fuera de tu red local, aún necesitarás reenviar el puerto de Grafana (predeterminado 3100) en la configuración de tu router.

      ```shell
      # Allow any IP to connect to Grafana
      sudo ufw allow 3100/tcp comment 'Allow grafana from anywhere'
      ```
    </Tab>

  </Tabs>
</div>

## Configurando Grafana

Ahora que el servidor de métricas está listo, puedes acceder a él con cualquier navegador en tu red local.

Consulta las pestañas a continuación para tu modo de instalación del Smartnode.

Navega a la siguiente URL, sustituyendo las variables con tu configuración según sea necesario:

```
http://<IP de tu nodo>:<puerto de grafana>
```

Por ejemplo, si la IP de tu nodo era `192.168.1.5` y usaste el puerto predeterminado de Grafana de `3100`, entonces irías a esta URL en tu navegador:

```
http://192.168.1.5:3100
```

Verás una pantalla de inicio de sesión como esta:

<img src="./images/grafana-login.png" width="100%" height="auto" />

La información predeterminada de Grafana es:

```
Username: admin
Password: admin
```

Luego se te pedirá que cambies la contraseña predeterminada para la cuenta `admin`.
¡Elige algo fuerte y no lo olvides!

::: tip Consejo
Si pierdes la contraseña de admin, puedes restablecerla usando el siguiente comando en tu nodo:

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker exec -it rocketpool_grafana grafana-cli admin reset-admin-password admin
      ```

    </Tab>
    <Tab label="Native">
      ```shell
      sudo grafana-cli admin reset-admin-password admin
      ```
    </Tab>

  </Tabs>
</div>

Podrás iniciar sesión en Grafana usando las credenciales `admin` predeterminadas una vez más, y luego se te pedirá que cambies la contraseña para la cuenta `admin`.
:::

Gracias al trabajo del miembro de la comunidad **tedsteen**, Grafana se conectará automáticamente a tu instancia de Prometheus para que tenga acceso a las métricas que recopila.
¡Todo lo que necesitas hacer es obtener el panel!

## Importando el Panel de Rocket Pool

Ahora que tienes Grafana conectado a Prometheus, puedes importar el panel estándar (o construir el tuyo propio usando las métricas que proporciona, si estás familiarizado con ese proceso).

Comienza yendo al menú **Create** (el icono de más en la barra lateral derecha) y haz clic en **Import**:

<img src="./images/grafana-import.png" width="100%" height="auto" />

Cuando se te solicite el ID del panel en el cuadro **Import via grafana.com**, ingresa `21863` o usa la URL completa ([(https://grafana.com/grafana/dashboards/24900-rocket-pool-dashboard-v1-4-0/](https://grafana.com/grafana/dashboards/24900-rocket-pool-dashboard-v1-4-0/)) y presiona el botón **Load**.

Se te presentará algo de información sobre el panel aquí, como su nombre y dónde te gustaría almacenarlo (la carpeta **General** predeterminada está bien a menos que uses muchos paneles y quieras organizarlos).

En el menú desplegable **Prometheus** en la parte inferior, solo deberías tener una opción etiquetada como **Prometheus (default)**.
Selecciona esta opción.

Tu pantalla debería verse así:

<img src="./images/grafana-import2.png" width="100%" height="auto" />

Si la tuya coincide, haz clic en el botón **Import** y serás llevado inmediatamente a tu nuevo panel.

A primera vista, deberías ver mucha información sobre tu nodo y tus validadores.
Cada cuadro viene con un útil tooltip en la esquina superior izquierda (el icono `i`) sobre el que puedes pasar el cursor para aprender más sobre él.
Por ejemplo, aquí está el tooltip para el cuadro **Your Validator Share**:

<img src="./images/tooltip.png" width="100%" height="auto" />

Sin embargo, aún no hemos terminado de configurar las cosas - todavía hay un poco más de configuración que hacer.

::: warning NOTA
Algunos de los cuadros (notablemente los de APR) han sido temporalmente deshabilitados debido a la forma en que Shapella proporciona recompensas skimmed.

Serán habilitados nuevamente en una versión futura del Smartnode que pueda rastrear las recompensas históricas adecuadamente.
:::

## Adaptando el Monitor de Hardware a tu Sistema

Ahora que el panel está activo, es posible que notes que algunos cuadros están vacíos como **SSD Latency** y **Network Usage**.
Tenemos que adaptar el panel a tu hardware específico para que sepa cómo capturar estas cosas.

### CPU Temp

Para actualizar tu indicador de temperatura de CPU, haz clic en el título del cuadro **CPU Temp** y selecciona **Edit** del menú desplegable.
Tu pantalla ahora se verá algo así:

<img src="./images/cpu-temp.png" width="100%" height="auto" />

Este es el modo de edición de Grafana, donde puedes cambiar qué se muestra y cómo se ve.
Nos interesa el cuadro de consulta resaltado en rojo, a la derecha del botón **Metrics browser**.

Por defecto, ese cuadro tiene esto:

```
node_hwmon_temp_celsius{job="node", chip="", sensor=""}
```

Hay dos campos en este texto que actualmente están en blanco: `chip` y `sensor`.
Estos son únicos para cada máquina, por lo que tendrás que completarlos según lo que proporcione tu máquina.

Para hacer esto, sigue estos pasos:

1. Elimina la porción `, sensor=""` para que termine con `chip=""}`. Para mayor claridad, todo ahora debería ser `node_hwmon_temp_celsius{job="node", chip=""}`.
2. Coloca tu cursor entre las comillas de `chip=""` y presiona `Ctrl+Spacebar`. Esto abrirá un cuadro de autocompletado con las opciones disponibles, que se ve así:

<img src="./images/grafana-autocomplete.png" width="100%" height="auto" />

3. Selecciona la opción que corresponda al CPU de tu sistema.
4. Una vez seleccionado, agrega `, sensor=""` de vuelta a la cadena. Coloca tu cursor entre las comillas de `sensor=""` y presiona `Ctrl+Spacebar` para obtener otro menú de autocompletado. Selecciona el sensor que deseas monitorear.

::: tip Consejo
Si no sabes qué `chip` o `sensor` es correcto, tendrás que probar todos hasta que encuentres el que se ve bien. Para ayudar con esto, instala el paquete `lm-sensors` (por ejemplo, `sudo apt install lm-sensors` en Debian / Ubuntu) y ejecuta el comando `sensors -u` para proporcionar qué sensores tiene tu computadora. Puedes intentar correlacionar un ID de chip de la lista de Grafana con lo que ves aquí según sus nombres e IDs.

Por ejemplo, esta es una de las salidas de nuestro comando `sensors -u`:

```
k10temp-pci-00c3
Tctl:
  temp1_input: 33.500
Tdie:
  temp2_input: 33.500
```

En nuestro caso, el chip correspondiente en Grafana es `pci0000:00_0000:00:18_3` y el sensor correspondiente es `temp1`.
:::

Una vez que estés satisfecho con tus selecciones, haz clic en el botón azul **Apply** en la esquina superior derecha de la pantalla para guardar la configuración.

::: warning NOTA
No todos los sistemas exponen información de temperatura de CPU - notablemente máquinas virtuales o sistemas basados en la nube.
Si el tuyo no tiene nada en el campo de autocompletado para `chip`, este probablemente es el caso y no podrás monitorear la temperatura de tu CPU.
:::

### SSD Latency

El gráfico **SSD Latency** rastrea cuánto tiempo toman las operaciones de lectura/escritura.
Esto es útil para medir qué tan rápido es tu SSD, para que sepas si se convierte en un cuello de botella si tu validador sufre de bajo rendimiento.
Para actualizar el SSD que deseas rastrear en el gráfico, haz clic en el título **SSD Latency** y selecciona **Edit**.

Este gráfico tiene cuatro campos de consulta (cuatro cuadros de texto) con ocho porciones `device=""` en total.
Necesitarás actualizar las primeras cuatro de estas porciones con el dispositivo que deseas rastrear.

Simplemente coloca tu cursor entre las comillas y presiona `Ctrl+Spacebar` para obtener la lista de autocompletado de Grafana, y selecciona la opción correcta desde allí para cada una de las porciones `device=""`.
**Quieres comenzar desde la configuración vacía más a la izquierda primero, o la lista de autocompletado puede no aparecer.**

::: tip Consejo
Si no sabes qué dispositivo rastrear, ejecuta el siguiente comando:

```
lsblk
```

Esto generará un árbol mostrando tu dispositivo y lista de particiones, por ejemplo:

```
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
...
loop25        7:25   0   132K  1 loop /snap/gtk2-common-themes/9
loop26        7:26   0  65,1M  1 loop /snap/gtk-common-themes/1515
nvme0n1     259:0    0 238,5G  0 disk
├─nvme0n1p1 259:1    0   512M  0 part /boot/efi
├─nvme0n1p2 259:2    0 150,1G  0 part /
├─nvme0n1p3 259:3    0  87,4G  0 part
└─nvme0n1p4 259:4    0   527M  0 part
```

Si no cambiaste la ubicación predeterminada de Docker a una unidad diferente durante tu instalación del Smartnode, entonces el disco que deseas rastrear será el que tenga instalado tu sistema operativo.
Busca en la columna `MOUNTPOINT` una entrada simplemente etiquetada como `/`, luego sigue eso de vuelta a su dispositivo padre (el que tiene `disk` en la columna `TYPE`).

Típicamente esto será `sda` para unidades SATA o `nvme0n1` para unidades NVMe.

Si _cambiaste_ la ubicación predeterminada de Docker a una unidad diferente, o si estás ejecutando una configuración híbrida/nativa, deberías poder usar la misma técnica de "seguir el punto de montaje" para determinar en qué dispositivo residen tus datos de cadena.
:::

Opcionalmente, también puedes rastrear la latencia de un segundo disco en tu sistema.
Esto está dirigido a personas que mantienen su sistema operativo y datos de cadena en unidades separadas.
Para configurar esto, simplemente sigue las instrucciones anteriores para los últimos dos campos de consulta, sustituyendo los valores de la porción `device=""` con los del disco que deseas rastrear.

Una vez que estés satisfecho con tus selecciones, haz clic en el botón azul **Apply** en la esquina superior derecha de la pantalla para guardar la configuración.

### Network Usage

Este gráfico rastrea cuántos datos estás enviando y recibiendo sobre una conexión de red particular.
Como podrías esperar, el panel necesita saber qué red deseas que rastree.

Para cambiarlo, haz clic en el título **Network Usage** y selecciona **Edit**.

Este gráfico tiene dos campos de consulta con dos porciones `device=""` en total.
Necesitarás actualizar estas con la red que deseas rastrear.

Coloca tu cursor entre las comillas y presiona `Ctrl+Spacebar` para obtener la lista de autocompletado de Grafana, y selecciona la opción correcta desde allí para cada una de las porciones `device=""`.

::: tip Consejo
Si no sabes qué dispositivo rastrear, ejecuta el siguiente comando:

```shell
sudo route
```

La salida se verá algo así:

```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
```

Busca en la columna `Destination` la fila con el valor `default`.
Sigue esa fila hasta la columna `Iface`.
El dispositivo listado allí es el que deseas usar - en este ejemplo, `eth0`.
:::

Una vez que estés satisfecho con tus selecciones, haz clic en el botón azul **Apply** en la esquina superior derecha de la pantalla para guardar la configuración.

### Total Net I/O

Esto rastrea la cantidad total de datos que has enviado y recibido.
Podrías encontrarlo útil para observar si, por ejemplo, tu ISP te limita a una cierta cantidad de datos por mes.

La configuración es idéntica al cuadro **Network Usage** anterior, así que simplemente sigue esas instrucciones para este cuadro también.

### Disk Space Used

Esto mantiene un registro de qué tan lleno se está volviendo tu disco del sistema operativo, para que sepas cuándo es hora de limpiar (y si tus datos de cadena viven en la misma unidad, hora de [podar Geth o Nethermind](./pruning)).

Los pasos son los mismos que el cuadro **SSD Latency** anterior, así que simplemente sigue esas instrucciones para este cuadro también.
Como recordatorio, quieres la unidad que alberga la partición que tiene `/` en la columna `MOUNTPOINT` para este porque ese será tu disco del sistema operativo.
Completa esto en el primer campo de consulta.

Opcionalmente, también puedes rastrear el espacio libre de un segundo disco en tu sistema.
Esto está dirigido a personas que mantienen su sistema operativo y datos de cadena en unidades separadas.
Configura esto siguiendo el mismo proceso, pero en lugar de buscar qué partición tiene `/` en la columna `MOUNTPOINT`, quieres buscar la que tiene cualquier punto de montaje de tu segunda unidad.
Actualiza el segundo campo de consulta con el disco asociado con esa partición.

### Disk Temp

Esto rastrea la temperatura actual de tu disco del sistema operativo. Los pasos son los mismos que el cuadro **CPU Temp** anterior, así que simplemente sigue esas instrucciones para este cuadro también, sustituyendo los valores de chip y sensor de CPU con los de tu disco del sistema operativo. Completa estos valores en el primer campo de consulta.

Opcionalmente, también puedes rastrear la temperatura actual de un segundo disco en tu sistema. Configura esto siguiendo el mismo proceso, sustituyendo los valores de chip y sensor con los de tu segunda unidad. Completa estos valores en el segundo campo de consulta.

## Personalizando el Panel

Aunque el panel estándar intenta hacer un buen trabajo capturando todo lo que querrías ver de un vistazo, es bastante fácil personalizar un panel de Grafana como quieras.
¡Puedes agregar nuevos gráficos, cambiar la forma en que se ven los gráficos, mover cosas, y mucho más!

Echa un vistazo a la página de [Tutoriales de Grafana](https://grafana.com/tutorials/) para aprender cómo jugar con él y configurarlo a tu gusto.

## Personalizando el Stack de Métricas

Las herramientas utilizadas en el Stack de Métricas de Rocket Pool ofrecen una amplia gama de opciones de configuración más allá de lo que se incluye en la instalación predeterminada de Rocket Pool. Esta sección incluye ejemplos de configuración para diferentes casos de uso.

En general, las [opciones de configuración de Grafana](https://grafana.com/docs/grafana/latest/administration/configuration/) deben pasarse utilizando variables de entorno en `override/grafana.yml`. Cualquier opción de configuración se puede convertir en una variable de entorno usando la siguiente sintaxis:

```
GF_<SectionName>_<KeyName>
```

### Configuración SMTP de Grafana para Enviar Correos

Para enviar correos desde Grafana, por ejemplo para alertas o para invitar a otros usuarios, las configuraciones SMTP deben configurarse en el Stack de Métricas de Rocket Pool.
Consulta la página de [configuración SMTP de Grafana](https://grafana.com/docs/grafana/latest/administration/configuration/#smtp) para referencia.

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      Abre `~/.rocketpool/override/grafana.yml` en un editor de texto.
      Agrega una sección `environment` debajo de la línea `x-rp-comment: Add your customizations below this line`, reemplazando los valores a continuación con los de tu proveedor SMTP.

      ```yaml
      version: "3.7"
      services:
      grafana:
      x-rp-comment: Add your customizations below this line
      environment:
      ## SMTP settings start, replace values with those of your SMTP provider
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      - GF_SMTP_USER=admin@example.com
      - GF_SMTP_PASSWORD=password
      - GF_SMTP_FROM_ADDRESS=admin@example.com
      - GF_SMTP_FROM_NAME="Rocketpool Grafana Admin"
      ## SMTP server settings end
      ```
    </Tab>
    <Tab label="Native">
      Abre `/etc/grafana/grafana.ini` en un editor de texto. Busca la sección `[smtp]` y actualízala, reemplazando los valores a continuación con los de tu proveedor SMTP.

      ```
      [smtp]
      enabled = true
      host = mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      user = admin@example.com
      # If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
      password = """passw0rd"""
      from_address = admin@example.com
      from_name = "Rocketpool Grafana Admin"
      ```
    </Tab>

  </Tabs>
</div>

::: tip Consejo
Si usas Gmail y la [verificación en 2 pasos](https://support.google.com/accounts/answer/185839) está habilitada, crea una [contraseña de aplicación](https://support.google.com/mail/answer/185833?hl=es) para este servicio.
:::

Después de hacer estas modificaciones, **ejecuta lo siguiente para aplicar los cambios**:

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker stop rocketpool_grafana

      rocketpool service start
      ```
    </Tab>
    <Tab label="Native">
      ```shell
      sudo systemctl restart grafana-server
      ```
    </Tab>

  </Tabs>
</div>

Para probar la configuración SMTP, ve al menú **Alerting** y haz clic en **Contact points**.

<img src="./images/grafana-contact-points.png" width="100%" height="auto" />

Haz clic en **New contact point** y selecciona **Email** como tipo de punto de contacto.
Ingresa una dirección de correo en la sección **Addresses** y haz clic en **Test**.

<img src="./images/grafana-new-contact-point.png" width="100%" height="auto" />

Verifica que se haya recibido el correo de prueba.
Haz clic en **Save contact point\*** cuando termines.
