import { Tab, Tabs } from "@rspress/core/theme";

::: danger ADVERTENCIA
Los depósitos de minipool están actualmente deshabilitados en preparación para Saturn 1.
:::

# Crear un Nuevo Minipool (Validator)

Como recordatorio, un `minipool` en términos de Rocket Pool se refiere a una instancia única de contrato inteligente en la Execution Layer que tu nodo administra.
El minipool maneja una porción de tu ETH, conocida como el **monto del bono**, y una porción de ETH del pool de staking de rETH, conocida como el **monto prestado**.
Los fusiona para formar 32 ETH en total, que luego se envían al contrato de depósito de Beacon Chain para crear un nuevo validator.
Por lo tanto, para crear un validator usando Rocket Pool, necesitas **crear un minipool**.

::: danger ADVERTENCIA
La creación de minipools está gobernada por dos colas.

La primera es la cola de depósito de Rocket Pool, que es administrada por el protocolo de Rocket Pool y determina cuándo tu minipool recibirá su ETH prestado. Debe haber ETH disponible en el pool de depósito para igualar tus 8 ETH con 24 ETH en el pool de depósito y crear el minipool.

La segunda es la cola de Beacon Chain, que es administrada por la Beacon Chain de Ethereum y determina cuándo tu validator se activará.

Ten en cuenta que el tiempo que toma para que tu minipool se active puede variar mucho dependiendo de tu posición en cada cola y el estado actual de la red.
:::

::: tip NOTA
Los tiempos de activación (y salida) de la cola de validators de Beacon Chain pueden variar mucho dependiendo del estado actual de la red.

Esto está fuera del control de Rocket Pool y es una función de la propia Beacon Chain.

La siguiente herramienta proporciona una buena estimación de cuánto tiempo puedes esperar:
[https://www.validatorqueue.com/](https://www.validatorqueue.com/)

Por favor revisa esta herramienta para tener una idea de cuánto tiempo puedes esperar para que tu validator se active.
:::

### Hacer Staking de RPL a través del Sitio Web

La forma más fácil y segura de hacer staking de RPL para tu nodo es usar la función **Stake-on-Behalf** del protocolo, que fue
reintroducida con la actualización Atlas. De esta manera, puedes hacer staking de RPL para tu nodo mientras el RPL todavía está en la billetera
que usaste para adquirirlo. En otras palabras, **no necesitas enviar RPL a la hot wallet de tu nodo** para hacer staking.

#### Añadir una dirección a la lista blanca para hacer staking en nombre de

Para hacer staking en nombre de tu nodo, una dirección debe estar en la lista blanca. Tu dirección de retiro siempre está en la lista blanca,
y puedes omitir este paso si tu RPL está en posesión de tu dirección de retiro. Solo necesitas añadir una dirección a la lista blanca una vez
para hacer staking desde ella. Puedes hacer esto mediante el siguiente comando de Smartnode:

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

Donde `address-or-ens` es la dirección o nombre ENS que resuelve a tu dirección deseada. Se te pedirá que
confirmes la adición a la lista blanca y después de que la transacción sea confirmada, puedes navegar a la página relevante a continuación.

#### Hacer Staking de RPL en nombre de

Selecciona qué red estás usando de las pestañas a continuación para ir a ella:

<div className="p-3">
  <Tabs>
    <Tab label="Mainnet">[https://node.rocketpool.net/stake-rpl-on-behalf-of-node](https://node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
    <Tab label="Hoodi Testnet">[https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node](https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
  </Tabs>
</div>

Comienza conectando tu billetera al sitio web usando MetaMask, WalletConnect, o cualquiera de los otros métodos que el sitio web soporte.
Luego se te presentará este diálogo para buscar la dirección de tu nodo.

Ingresa la dirección de tu nodo y haz clic en "Lookup".

**¡Asegúrate de tener la dirección de nodo correcta antes de hacer esto!**
Si necesitas confirmar la dirección de tu nodo, puedes recuperarla rápidamente a través del CLI usando el comando `rocketpool node status`.

Esto verificará que la dirección es un nodo registrado y que el nodo ha añadido la billetera conectada a la lista blanca. Las direcciones de retiro están en la lista blanca por defecto, sin embargo, si deseas permitir otras direcciones, necesitarás añadirlas a la lista blanca mediante el siguiente comando en tu nodo.

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

Este es un proceso de dos pasos.

Primero, ingresa la cantidad de RPL que quieres hacer stake y haz clic en `Approve` - esto **aprobará** que el contrato de staking acceda a esa cantidad de RPL en tu billetera, pero **no más que esa cantidad**.

::: tip CONSEJO
Puedes aprobar más de la cantidad que pretendes hacer stake si confías en el contrato de staking de Rocket Pool, y no quieres realizar esta transacción de Approve adicional cada vez que quieras hacer stake de más RPL.
:::

Una vez que el RPL esté aprobado, podrás hacer staking en nombre de un nodo.

Ingresa la cantidad de RPL que quieres hacer stake en el cuadro `Stake RPL`, e ingresa la dirección de tu nodo en el cuadro `on behalf of Node Address`.

Cuando hayas ingresado esa información, presiona el botón `Stake` y aprueba la transacción.

<video controls="controls" src="https://cdn-rocketpool.s3.us-west-2.amazonaws.com/stake_behalf.mp4" />

Se enviará a la red Ethereum, y una vez incluida en un bloque, ¡estás listo!

Si ejecutas `rocketpool node status`, deberías ver tu RPL en stake aparecer bajo la sección `=== RPL Stake ===`.

#### Eliminar una dirección de la lista blanca de stake

Si alguna vez quieres eliminar una dirección de tu lista blanca de stake-on-behalf, puedes hacerlo con el siguiente comando de Smartnode:

```shell
rocketpool node remove-address-from-stake-rpl-whitelist address-or-ens
```

Donde `address-or-ens` es la dirección o nombre ENS que resuelve a la dirección que quieres eliminar de la lista blanca.

### Hacer Staking a través del CLI del Nodo

Si no puedes (o no quieres) usar el sitio web para hacer staking de tu RPL, también puedes hacerlo directamente a través del CLI del nodo.

Primero, transfiere tu RPL desde la billetera con la que lo adquiriste a la dirección de tu nodo.

::: danger ADVERTENCIA
**¡Por favor haz esto con cuidado y asegúrate de que estás enviando el RPL a la dirección de tu nodo - las transferencias en Ethereum no se pueden deshacer!**
**Enviar RPL a la dirección incorrecta resultará en la pérdida de tu RPL.**

Usa el comando `rocketpool node status` para verificar la dirección de tu nodo si no estás seguro de cuál es.
:::

Ejecuta el siguiente comando:

```
rocketpool node stake-rpl
```

Aquí está la salida:

```
Please choose an amount of RPL to stake:
1: Your entire RPL balance (1440.000000 RPL)?
2: A custom amount
```

Selecciona cuánto te gustaría hacer stake, luego confirma la operación.

La primera vez que ejecutes este comando, involucrará dos transacciones - una para **aprobar** que el contrato de staking de Rocket Pool acceda a tu RPL, y una para **hacer stake** de tu RPL con él.
Las ejecuciones posteriores solo requerirán la transacción de **stake**, ya que el token ya ha sido aprobado.

Una vez que ambas transacciones finalicen, puedes verificar tu cantidad de RPL en stake con `rocketpool node status`.
La siguiente porción de la salida es lo que quieres verificar:

```
The node has a total stake of 300.000000 RPL.
This is currently 29.76% of its borrowed ETH and 89.29% of its bonded ETH.
It can earn max apy on up to 151.209677 RPL (15% of borrowed ETH), and still earn at lower APY with more RPL.
```

Esto te mostrará cuántos minipools puedes hacer de cada tamaño de bono basado en tu colateral de RPL.

## (Opcional) Encontrar una Dirección Vanity Personalizada para tu Minipool

Por defecto, cuando creas un nuevo minipool, Rocket Pool generará una dirección única aleatoria para él.
Sin embargo, el Smartnode proporciona la capacidad de buscar una **dirección vanity** personalizada para el minipool.

Una dirección vanity es aquella en la que personalmente eliges los caracteres con los que comienza la dirección.
Este es un ejercicio puramente cosmético y no tendrá ningún impacto práctico en la operación de tu minipool.
Como las direcciones de Ethereum están en hexadecimal, cualquiera de los siguientes caracteres es legal:

```
0 1 2 3 4 5 6 7 8 9 a b c d e f
```

Como algunos ejemplos, podrías hacer que la dirección de tu minipool comience con un montón de ceros (`0x000000...`), `0x600d` (hex para "good") o `0xa77e57ed` (hex para "attested", un prefijo apropiado para un minipool).

Para encontrar tal dirección vanity, necesitarás **buscarla**.
Este proceso de búsqueda implica elegir un número, aplicarlo como una "sal" al algoritmo de hash, y comparar los resultados con lo que estás buscando.
Los resultados son efectivamente aleatorios (aunque cualquier sal dada siempre produce el mismo resultado), por lo que la única forma de encontrar una dirección con el prefijo que deseas es probar muchas y muchas hasta que encuentres una sal que funcione.

Si deseas una dirección vanity personalizada para usar en tu minipool cuando lo crees, puedes usar el siguiente comando para buscar una:

```
rocketpool minipool find-vanity-address
```

Esto te pedirá el prefijo que quieres buscar, y preguntará qué tipo de depósito harás (un depósito de 16 ETH o de 32 ETH - ve más abajo para más información sobre estos tipos).
Una vez que ingreses esa información, comenzará a probar muchas y muchas sales hasta que encuentre una que produzca tu prefijo deseado!

Aquí hay un ejemplo completo del proceso:

```
$ rocketpool minipool find-vanity-address
Please specify the address prefix you would like to search for (must start with 0x):
0xa77e57
Running with 12 threads.
Found on thread 3: salt 0x5cd7fb = 0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD
Finished in 1.91145873s
```

En este caso, buscamos `0xa77e57` como prefijo y encontramos la sal `0x5cd7fb` que podría generarlo.
En el siguiente paso, cuando creemos un minipool, podemos especificar esta sal como un argumento opcional para crear el nuevo minipool en la dirección asociada con la sal (`0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD` como se muestra arriba).

En general, cada carácter adicional que busques multiplicará el tiempo de búsqueda por aproximadamente 16.
Debido a esto, **recomendamos que solo busques prefijos de 7 u 8 caracteres como máximo a menos que tengas una máquina muy potente con muchos núcleos de CPU**.
De lo contrario, podría tomar un tiempo prohibitivamente largo encontrar una sal que produzca el prefijo que deseas.

Por ejemplo, un AMD 5600x con 6 núcleos (12 hilos) a 4.8 GHz puede buscar aproximadamente 3.2 millones de sales por segundo.
En promedio, tomará unos segundos encontrar un prefijo de 6 caracteres, unos minutos encontrar un prefijo de 7 caracteres, y unas horas encontrar un prefijo de 8 caracteres.

::: tip NOTA
La sal que se genera es específica para las siguientes variables:

- La red que estás usando (ya sea Hoodi Testnet o Mainnet)
- La dirección del nodo
- El monto del bono
- La sal

Si cambias cualquiera de esas variables, la dirección del minipool para una sal dada también cambiará.
:::

Para uso más avanzado (como buscar una dirección de nodo diferente o cambiar cuántos núcleos de CPU se usan para buscar), echa un vistazo al texto de ayuda con `rocketpool minipool find-vanity-address --help`.

## Depositar ETH y Crear un Minipool

::: tip CONSEJO
Si el valor de mercado de rETH es mayor que su respaldo en ETH (es decir, rETH está con prima en el mercado), hay una oportunidad de arbitraje de la diferencia al crear un minipool.
El valor del arbitraje es igual a la cantidad de ETH del protocolo en el minipool multiplicado por la prima (menos una pequeña cantidad de gas).
Por ejemplo, si haces un minipool cuando hay una prima del 2.5%: `16 ETH * .025 = 0.4 ETH`.
En otras palabras, ¡podrías recibir 0.4 ETH de vuelta durante estas condiciones solo por crear un minipool!

Si estás interesado en aprovechar esta oportunidad, considera usar la herramienta desarrollada por la comunidad [rocketarb](https://github.com/xrchz/rocketarb#readme) para capturar la ganancia de la oportunidad de arbitraje MEV rETH que lanzar tu minipool crea.

Para aprender más sobre rocketarb, no dudes en preguntar sobre ella en el [servidor de Discord de RP](https://discord.gg/rocketpool).
:::

Después de todo lo que has hecho hasta ahora, finalmente estás listo para depositar tu ETH, crear un nuevo minipool y crear un validator de Beacon Chain.
Esto se hace con el siguiente comando:

```shell
rocketpool node deposit
```

::: danger ADVERTENCIA

Aunque el CLI automatiza muchos de los siguientes pasos para ti, <strong>recomendamos encarecidamente</strong> monitorear tu nodo y transacciones para asegurar una transición exitosa de `prelaunch` a `staking`.

Las transacciones fallidas (debido a ajustes de gas o ETH insuficiente) podrían hacer que tu minipool pase al estado `dissolved`, lo cual quieres evitar.

[Aprende más sobre cómo confirmar un stake exitoso](./create-validator#confirming-a-successful-stake)

:::

::: tip NOTA
Si quieres usar una sal para una dirección vanity que encontraste usando el proceso anterior, ejecuta el siguiente comando en su lugar:

```shell
rocketpool node deposit --salt <tu sal, ej. 0x1234abcd>
```

:::

Primero verás una nota que depositar un nuevo minipool **distribuirá automáticamente** cualquier saldo en el contrato [fee distributor](./fee-distrib-sp) de tu nodo (usado para capturar recompensas MEV si no estás optando al [Smoothing Pool](./fee-distrib-sp#the-smoothing-pool)):

```
Your eth2 client is on the correct network.
NOTE: by creating a new minipool, your node will automatically claim and distribute any balance you have in your fee distributor contract. If you don't want to claim your balance at this time, you should not create a new minipool.
Would you like to continue? [y/n]
```

Si ya tienes minipools y un saldo en tu fee distributor, puedes decidir no crear otro minipool si distribuir este saldo causa un evento imponible en tu jurisdicción.

Después de eso se te notificará de tu tasa de comisión para el nuevo minipool, y una nota sobre si el [saldo de crédito](./credit) de tu nodo puede usarse para cubrir el costo del bono del minipool por ti:

```
Your minipool will use the current fixed commission rate of 5.00%.
If you participate in the smoothing pool, your minipool will receive at least a 5% commission boost, and up to a 9% commission boost based on RPL stake.
You currently have 8.00 ETH in your credit balance.
This deposit will use 8.000000 ETH from your credit balance and will not require any ETH from your node.
```

A continuación se te presentarán las recomendaciones de costos de gas actuales de la red; confirma tu selección de precio de gas y sigue el resto de las indicaciones.

```
Your consensus client is synced, you may safely create a minipool.
+============== Suggested Gas Prices ==============+
| Avg Wait Time |  Max Fee  |    Total Gas Cost    |
| 15 Seconds    | 15 gwei   | 0.0244 to 0.0366 ETH |
| 1 Minute      | 10 gwei   | 0.0157 to 0.0235 ETH |
| 3 Minutes     | 7 gwei    | 0.0100 to 0.0150 ETH |
| >10 Minutes   | 6 gwei    | 0.0080 to 0.0120 ETH |
+==================================================+
These prices include a maximum priority fee of 2.00 gwei.
Please enter your max fee (including the priority fee) or leave blank for the default of 10 gwei:
Using a max fee of 10.00 gwei and a priority fee of 2.00 gwei.
You are about to deposit 8.000000 ETH to create a minipool with a minimum possible commission rate of 14.000000%.
ARE YOU SURE YOU WANT TO DO THIS? Exiting this minipool and retrieving your capital cannot be done until:
- Your minipool has been *active* on the Beacon Chain for 256 epochs (approx. 27 hours)
- The Shapella upgrade of the Ethereum network has been deployed
- The Atlas upgrade of the Rocket Pool protocol has been deployed
- Your minipool has been upgraded to use the Atlas delegate
 [y/n]
y
Creating minipool...
Transaction has been submitted with hash <transaction hash>.
You may follow its progress by visiting:
<link to transaction>
Waiting for the transaction to be included in a block... you may wait here for it, or press CTRL+C to exit and return to the terminal.
The node deposit of 8.000000 ETH was made successfully!
Your new minipool's address is: <new minipool address>
The validator pubkey is: <new validator public key>
Your minipool is now in Initialized status.
Once the remaining ETH has been assigned to your minipool from the staking pool, it will move to Prelaunch status.
After that, it will move to Staking status once 1h0m0s have passed.
You can watch its progress using `rocketpool service logs node`.
```

Ten en cuenta que crear un minipool **¡es una transacción costosa!**
Presta mucha atención al costo total y asegúrate de aceptarlo.

Si aceptas, se activará la creación de tu minipool.
Una vez que la transacción se complete, se te dará la dirección de tu nuevo contrato de minipool en la Execution Layer y su clave pública de validator correspondiente en la Beacon Chain.
Puedes visitarlas con cualquier explorador de bloques si lo deseas.

## Confirmar un Stake Exitoso

Al crearse, tu minipool será puesto en el estado `initialized`.
Permanecerá aquí hasta que sea tu turno en la cola de Rocket Pool para recibir 24 ETH del pool de staking para que puedas hacer stake de tu nuevo validator en la Beacon Chain.

Una vez que esto suceda, tu minipool pasará al estado `prelaunch` por un cierto período de tiempo (actualmente 12 horas).
Tu depósito de 8 ETH será transferido a la Beacon Chain, y el Oracle DAO [verificará que todo sea correcto](https://github.com/rocket-pool/rocketpool-research/blob/master/Reports/withdrawal-creds-exploit.md).
Durante este tiempo, puedes observar el validator buscando su validator pubkey con un explorador de Beacon Chain como [https://beaconcha.in](https://beaconcha.in) (o [https://hoodi.beaconcha.in](https://hoodi.beaconcha.in) para el Hoodi Testnet).

Puedes verificar el estado del nuevo minipool con el comando `rocketpool minipool status`.
Por ejemplo, cuando haya pasado a `prelaunch`, probablemente verás algo como esto:

```
1 Prelaunch minipool(s):
--------------------
Address:              <your minipool address>
Penalties:             0
Status updated:        2024-10-31, 04:51 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 31.000000 ETH
Your portion:          7.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      7.000000 ETH
Validator pubkey:      <your validator public key>
Validator index:       0
Validator seen:        no
Use latest delegate:   no
Delegate address:      <your delegate address>
Rollback delegate:     <none>
Effective delegate:    <your delegate address>
0 finalized minipool(s):
```

Después de este período de prelaunch, tu minipool entrará en estado `staking` y enviará el ETH adicional del pool de staking al contrato de depósito.
Esto será hecho por el contenedor Docker `rocketpool_node` (o el servicio `rp-node` si usaste la configuración Native) - si, por alguna razón, estás tardando anormalmente en entrar al estado `staking`, mirar los logs de este contenedor / servicio probablemente te dirá qué está mal.
Puedes verificar estos logs con el comando `rocketpool service logs node` (o `/srv/rocketpool/node_log.sh` en configuraciones en modo Native).

Ejecutar `rocketpool minipool status` mostrará entonces algo como esto:

```
$ rocketpool minipool status
1 Staking minipool(s):
--------------------
Address:              <your validator address>
Penalties:             0
RP ETH assigned:       2024-10-31, 05:53 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 0.000000 ETH
Your portion:          0.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      0.000000 ETH
Validator pubkey:     <your validator public key>
Validator index:      <your validator index number>
Validator active:     yes
Validator balance:    32.018460 ETH
Expected rewards:     16.010614 ETH
Use latest delegate:  no
Delegate address:     <your delegate address>
Rollback delegate:    <none>
Effective delegate:   <your delegate address>
0 finalized minipool(s):
```

::: warning NOTA
La transacción para migrar de `prelaunch` a `staking` es enviada automáticamente por tu nodo y está sujeta a la configuración de gas en `rocketpool service config`.
Si la configuración de gas impide que el nodo envíe la transacción, o hay ETH insuficiente en la billetera del nodo para pagar la transacción, el minipool se convertirá en `dissolved` dos semanas después de que entró a `prelaunch`.
Si esto sucede, recuperar el saldo es un proceso costoso y largo, ¡así que asegúrate de monitorear tu minipool de cerca hasta que alcance el estado `staking`!
:::

Una vez que la Beacon Chain acepte ambos depósitos (uno de ti y uno del pool de staking), tu validator entrará en la cola de Beacon Chain donde esperará su turno para ser activado y comenzar a hacer staking.

¡En este punto, has terminado!
¡Felicitaciones!
¡Has creado oficialmente un validator con Rocket Pool!

Echa un vistazo a las siguientes secciones en Monitoreo y Mantenimiento para aprender cómo observar el rendimiento y la salud de tu validator a lo largo del tiempo.

## Crear Múltiples Minipools

Convenientemente, tu nodo de Rocket Pool es capaz de alojar tantos minipools como quieras.
**No** necesitas crear un nuevo nodo para cada minipool.

Si deseas hacer un segundo (o tercero, o cuarto...) minipool para tu nodo, todo lo que necesitas hacer es ejecutar `rocketpool node deposit` nuevamente.
Además, no podrás reutilizar una sal de dirección vanity antigua - necesitarás buscar otra única para cada uno de tus minipools.

## Próximos Pasos

Ahora que tienes un minipool en funcionamiento, los próximos pasos te guiarán sobre cómo monitorear la salud de tu nodo, verificar y aplicar actualizaciones, y mantenerlo a lo largo de su vida.

**Por favor lee la sección `Monitoreo y Mantenimiento` a continuación para aprender más sobre estos temas.**
