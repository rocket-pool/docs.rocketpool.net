import { Tab, Tabs } from "@rspress/core/theme";

# [Modo Híbrido] Guía para la Actualización Redstone y The Merge

Esta guía cubrirá todo lo que necesita saber para preparar su nodo para la Actualización Redstone y The Merge si está usando **Modo Híbrido**.

## Cosas que hacer antes de actualizar a v1.5.0

Antes de actualizar a v1.5.0 y versiones superiores del Smartnode, por favor revise la siguiente lista de verificación para asegurarse de que está preparado:

### Cambiar a un Cliente de Ejecución Completo

The Merge requiere que ejecute su propio cliente de Ejecución, por lo que ya no podrá usar proveedores remotos como Infura o Pocket.

Debido a este cambio, si actualmente está usando un cliente de Ejecución ligero, debe cambiar a un cliente completo mientras aún está en v1.4, dejarlo sincronizar hasta completarse, y luego actualizar a v1.5.

### Asegurar que el EC y el CC sean ambos gestionados externamente

Las versiones anteriores del stack Smartnode le permitían tener un cliente gestionado localmente y el otro gestionado externamente.
Por ejemplo, podría tener un cliente de Ejecución que el Smartnode gestiona y conectarlo a un cliente de Consenso que usted gestiona externamente.

A partir de v1.5, esta configuración ya no es compatible.
Tendrá que cambiar a un cliente de Ejecución y Consenso gestionados localmente (también conocido como [Modo Docker](./docker-migration.mdx)), o configurar tanto un cliente de Ejecución como un cliente de Consenso que gestione por su cuenta.

::: tip CONSEJO
Si está interesado en dejar que el Smartnode mantenga su propio cliente de Ejecución y Consenso pero desea mantener el control sobre su propio cliente Validator (por ejemplo, si tiene sus propias claves de validador de staking solo adjuntas a él), es posible que desee considerar el [Modo Híbrido Inverso](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode) que hace exactamente esto.
:::

### Configurar la Engine API

The Merge cambia la forma en que su cliente de Ejecución se comunica con su cliente de Consenso.
En lugar de usar el antiguo sistema RPC basado en HTTP o Websocket, The Merge requiere un nuevo sistema expuesto por su cliente de Ejecución llamado Engine API.

Esta es una conexión especial que permite que el cliente de Consenso reemplace el antiguo sistema de minería Proof-of-Work con Proof-of-Stake; es el corazón de The Merge.
También está **autenticada** con un token secreto, por lo que solo su cliente de Consenso puede conectarse a su cliente de Ejecución - nada más puede hacerlo.

Como usted gestiona sus propios clientes de Ejecución y Consenso, necesitará configurar la Engine API manualmente.
Cómo hacerlo depende completamente de qué clientes está ejecutando.

CoinCashew tiene [una guía excelente y concisa](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) sobre cómo configurar la Engine API en sus clientes de Ejecución y Consenso.
Échele un vistazo, y pruebe la nueva configuración asegurándose de que todavía atestigua correctamente antes de actualizar.

Como siempre, Rocket Pool gestionará su propio cliente Validator, por lo que no necesita preocuparse por modificarlo manualmente.

## Actualizar a v1.5.0

Actualizar el stack Smartnode a v1.5.0 no es diferente a cualquier otra actualización.
Simplemente siga [las instrucciones normales aquí](../../node-staking/updates#updating-the-smartnode-stack).

## Cosas que el Smartnode maneja automáticamente

En Modo Híbrido, el Smartnode se encargará de algunos de los cambios necesarios para admitir Redstone automáticamente una vez que actualice a v1.5.0, pero necesitará manejar otros manualmente en Modo Híbrido.

Aquí hay una breve lista de lo que hará por usted sin ninguna intervención manual:

### Su destinatario de tarifas

El **destinatario de tarifas** es la dirección en la cadena de la capa de Ejecución (eth1) que recibirá todas las tarifas de prioridad de los bloques que propone.
Es una configuración proporcionada a su cliente Validator cuando se inicia por primera vez.

El Smartnode manejará su configuración a la dirección correcta en el cliente Validator que gestiona cuando actualice a v1.5, y constantemente verificará para asegurarse de que está usando la correcta para que no sea [penalizado accidentalmente](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Si optó por el [Smoothing Pool](./whats-new#smoothing-pool), lo hará su destinatario de tarifas.
Si no lo hizo, hará que su [contrato distribuidor de tarifas](./whats-new#fee-recipients-and-your-distributor) sea el destinatario de tarifas.

## Cosas que debe hacer después de actualizar

Si bien el Smartnode maneja la mayoría de los cambios por usted, hay algunas cosas adicionales que debe hacer manualmente:

### Asegurar una actualización exitosa

Lo primero que debe hacer es asegurarse de que su nodo esté funcionando correctamente.
Considere seguir los siguientes pasos:

- Verifique los registros en busca de errores con `rocketpool service logs validator` y `rocketpool service logs node`.
- Confirme con un Block Explorer (como su dashboard de Grafana y [https://beaconcha.in](https://beaconcha.in)) que todavía está atestiguando correctamente
  - ¡Recuerde que si tiene habilitada la protección Doppelganger, perderá algunas atestaciones después del reinicio. Esto es normal!

### Configurar MEV-Boost

[MEV-boost](https://boost.flashbots.net/) es el sistema que Flashbots proporciona para dar recompensas MEV a los validadores Proof-of-Stake después de The Merge.

**Rocket Pool requiere que todos los nodos lo usen para maximizar sus retornos y así mantener el protocolo competitivo con otros servicios de staking.**

Necesitará hacer algunos ajustes a su Beacon Node / cliente de Consenso para conectarlo a MEV-boost.

MEV-boost actualmente no está disponible en Hoodi o Mainnet, por lo que no necesita configurarlo en este momento.
Por supuesto, no será penalizado por no usarlo durante este período de transición.

Una vez que esté disponible, anunciaremos una fecha en la que debe instalarse y conectarse a su nodo.
Flashbots proporcionará instrucciones que puede seguir en ese momento, y las enlazaremos aquí.

::: danger NOTA
Una vez que hagamos el anuncio de que MEV-boost debe estar habilitado por todos los operadores de nodo, ¡debe asegurarse de tenerlo correctamente instalado y configurado con su Beacon Node!

No hacerlo resultará en que su minipool sea [penalizado](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).
:::

### Configurar un nodo de respaldo

Debido a que The Merge no es compatible con proveedores remotos como Infura y Pocket, perderá la capacidad de usarlos como clientes de Ejecución de respaldo cuando su principal se desconecte.

El Smartnode todavía tiene la capacidad de proporcionar un cliente de Ejecución de respaldo (y ahora también un cliente de Consenso de respaldo), pero ahora necesitará usar clientes de Ejecución y Consenso que usted controle.

Para obtener más información sobre cómo configurar un nodo de respaldo, consulte la [guía de nodo de respaldo](../../node-staking/fallback).

### Inicializar su distribuidor de tarifas

Si no planea optar por el [Smoothing Pool](./whats-new#smoothing-pool) y reclamar todas sus tarifas de prioridad y recompensas MEV en su [contrato distribuidor de tarifas](./whats-new#fee-recipients-and-your-distributor), eventualmente tendrá que inicializarlo (crear la instancia del contrato en la cadena) para reclamar recompensas desde él a su dirección de retiro.

Esta es una operación bastante económica y solo necesita hacerse una vez.

::: tip CONSEJO
Inicializar su distribuidor de tarifas se puede hacer en **cualquier momento**.
Puede dejar que las recompensas se acumulen en su dirección mucho antes de inicializarlo, y su saldo permanecerá después de la inicialización.

Le recomendamos que lo haga cuando los precios del gas sean bajos para minimizar el costo adicional.

Tenga en cuenta que **debe inicializarse para reclamar sus recompensas.**
:::

### Optar por el Smoothing Pool

Si planea aprovechar el [Smoothing Pool](./whats-new#smoothing-pool) de inmediato, debe optar antes del final del primer período de recompensas de Redstone para maximizar su cantidad de "elegibilidad".

Optar puede hacerse ejecutando el siguiente comando:

```shell
rocketpool node join-smoothing-pool
```

### Reclamar recompensas

La actualización Redstone reemplaza el costoso y problemático sistema de recompensas antiguo con [uno completamente nuevo](./whats-new#new-rewards-system) que es mucho más económico, admite el re-staking automático de RPL (tanto en cantidades parciales como completas), y - lo más importante - **le permite reclamar sus recompensas cuando quiera**.

Debido a que ya no hay un límite de tiempo para reclamar recompensas, y debido a que es más económico reclamar muchos intervalos de recompensas a la vez, la función de reclamación automática de recompensas del Smartnode **ha sido eliminada**.
Ahora podrá reclamar recompensas a través del siguiente comando:

```shell
rocketpool node claim-rewards
```

Esto le mostrará todas las recompensas que ha acumulado en todos los intervalos de recompensas comenzando con la actualización Redstone.

## Revertir a v1.4.3

Si, por alguna razón, algo no es de su agrado y desea revertir a la versión anterior del Smartnode, puede hacerlo fácilmente.
El Smartnode hace automáticamente una copia de seguridad de su configuración de la versión anterior cuando lo actualiza, así que simplemente obtenga la versión anterior (aquí estamos demostrando **v1.4.3**) y reemplace la configuración con la copia de seguridad:

1. Detenga el servicio:

```shell
rocketpool service stop
```

1. Descargue el CLI v1.4.3:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Instale el paquete v1.4.3:

```shell
rocketpool service install -d
```

1. Reemplace su configuración antigua con la configuración de respaldo v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Verifique que todas sus configuraciones antiguas ahora se están usando:

```shell
rocketpool service config
```

1. Si se ve bien, inicie el stack Smartnode:

```shell
rocketpool service start
```

¡Todo listo! Ahora está de vuelta en la versión anterior y debería comenzar a atestiguar poco después de iniciar el servicio.

::: danger ADVERTENCIA
v1.4.3 está **obsoleto** y ya no será utilizable después de que se implemente la actualización Redstone.
Si necesita revertir a él, ¡haga planes para actualizar de nuevo a v1.5.0 antes de que se actualicen los contratos!
:::
