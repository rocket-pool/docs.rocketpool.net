import { Tab, Tabs } from "@rspress/core/theme";

# [Modo Nativo] Guía para la actualización Redstone y The Merge

Esta guía cubrirá todo lo que necesitas saber para preparar tu nodo para la actualización Redstone y The Merge si estás usando **Modo Nativo**.

## Cosas que hacer antes de actualizar a v1.5.0

Antes de actualizar a v1.5.0 y versiones superiores del Smartnode, por favor revisa la siguiente lista para asegurarte de que estás preparado:

### Cambiar a un cliente de ejecución completo

The Merge requiere que ejecutes tu propio cliente de ejecución, por lo que ya no podrás usar proveedores remotos como Infura o Pocket.

Debido a este cambio, si actualmente estás usando un cliente de ejecución ligero, deberías cambiar a un cliente completo mientras aún estás en v1.4, dejarlo sincronizar por completo y luego actualizar a v1.5.

### Configurar la Engine API

The Merge cambia la forma en que tu cliente de ejecución se comunica con tu cliente de consenso.
En lugar de usar el antiguo sistema RPC basado en HTTP o Websocket, The Merge requiere un nuevo sistema expuesto por tu cliente de ejecución llamado Engine API.

Esta es una conexión especial que permite al cliente de consenso reemplazar el antiguo sistema de minería de Proof-of-Work con Proof-of-Stake; es el corazón de The Merge.
También está **autenticado** con un token secreto, por lo que solo tu cliente de consenso puede conectarse a tu cliente de ejecución - nada más puede hacerlo.

Como gestionas tus propios clientes de ejecución y consenso, necesitarás configurar la Engine API manualmente.
Cómo hacerlo depende completamente de qué clientes estés ejecutando.

CoinCashew tiene [una guía excelente y concisa](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) sobre cómo configurar la Engine API en tus clientes de ejecución y consenso.
Échale un vistazo y prueba la nueva configuración asegurándote de que aún realiza attestations correctamente antes de actualizar.

Te mostraremos cómo configurar tu cliente validador para que use el destinatario de tarifas correcto requerido por el software Smartnode automáticamente a continuación.

## Actualizar a v1.5.0

Actualizar el stack de Smartnode a v1.5.0 no es diferente a cualquier otra actualización.
Simplemente sigue [las instrucciones normales aquí](../../node-staking/updates#updating-the-smartnode-stack).

## Cosas que deberías hacer después de actualizar

En modo Nativo, hay varias cosas que necesitarás hacer manualmente después de actualizar:

### Asegurar una actualización exitosa

Lo primero que debes hacer es asegurarte de que tu nodo está funcionando correctamente.
Considera seguir los siguientes pasos:

- Revisa tus scripts de logs para el cliente de ejecución, el cliente de consenso, el cliente validador y el daemon del Smartnode (el servicio `rp-node`) para asegurarte de que todos funcionan normalmente sin errores.
- Confirma con un explorador de bloques (como tu panel de Grafana y [https://beaconcha.in](https://beaconcha.in)) que aún estás realizando attestations correctamente
  - Recuerda que si tienes protección contra Doppelganger activada, perderás algunas attestations después del reinicio. ¡Esto es normal!

### Configurar el destinatario de tarifas en tu cliente validador

Uno de los detalles **críticos** para configurar antes de The Merge es el **destinatario de tarifas** especificado por tu cliente validador.
Como se describe en el [artículo de resumen](./whats-new#fee-recipients-and-your-distributor), esto puede ser uno de dos valores:

- Si **estás participando** en el Smoothing Pool, este debe ser la dirección del **contrato del Smoothing Pool**. Puedes obtener la dirección desde [la página oficial de contratos](/es/protocol/contracts-integrations).
- Si **no** estás en el Smoothing Pool, este debe ser la dirección del **contrato distribuidor de tarifas** de tu nodo. Puedes obtener la dirección ejecutando `rocketpool node status`, bajo la sección `Fee Distributor and Smoothing Pool`.

En modo Nativo, tienes la opción de dejar que el Smartnode gestione esto por ti si usas el servicio daemon del Smartnode, `rp-node`, o gestionarlo tú mismo si no usas el daemon.

#### Gestión automática vía el Daemon

El daemon del Smartnode determinará automáticamente el destinatario de tarifas apropiado para tu nodo y lo gestionará en caso de que cambie (como al participar y salir del Smoothing Pool).
Esta es la opción **más segura**, porque el Smartnode siempre asegurará que esté configurado a un valor que **previene [penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)**.

La forma en que hace esto es manteniendo un archivo con el destinatario de tarifas correcto en él, y actualizándolo regularmente para asegurar su corrección.
Cuando necesita ser actualizado, modifica el archivo y reinicia tu cliente validador automáticamente para que cargue el nuevo destinatario - similar a cómo reinicia tu cliente validador después de stakear un nuevo minipool.

Selecciona tu cliente a continuación para aprender cómo configurarlo:

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Modify your Validator Client service by adding the following line _before_ the `ExecStart` line:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      For example:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Next, add the following command line argument _to the end_ of your `ExecStart` line:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Your VC will now use the file managed by the Smartnode daemon, and will automatically be restarted whenever the fee recipient changes.
    </Tab>
    <Tab label="Nimbus">
      Modify your Validator Client service by adding the following line _before_ the `ExecStart` line:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      For example:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Next, add the following command line argument _to the end_ of your `ExecStart` line:

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      Your VC will now use the file managed by the Smartnode daemon, and will automatically be restarted whenever the fee recipient changes.
    </Tab>
    <Tab label="Prysm">
      Modify your Validator Client service by adding the following line _before_ the `ExecStart` line:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      For example:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Next, add the following command line argument _to the end_ of your `ExecStart` line:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Your VC will now use the file managed by the Smartnode daemon, and will automatically be restarted whenever the fee recipient changes.
    </Tab>
    <Tab label="Teku">
      Modify your Validator Client service by adding the following line _before_ the `ExecStart` line:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      For example:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Next, add the following command line argument _to the end_ of your `ExecStart` line:

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      Tu VC ahora usará el archivo gestionado por el daemon del Smartnode, y será reiniciado automáticamente cada vez que cambie el destinatario de tarifas.
    </Tab>

  </Tabs>
</div>

#### Gestión manual del destinatario de tarifas

::: danger ADVERTENCIA
Al hacer esto, asumes la responsabilidad completa de asegurar que tu destinatario de tarifas esté siempre configurado a la dirección correcta.

Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) para entender a qué debe estar configurado dada tu configuración, y cuándo puedes cambiarla de forma segura de un valor a otro.

¡No hacerlo podría resultar en que tus minipools sean penalizados!
:::

**Antes de que se implemente Redstone**, puedes simplemente usar la dirección de rETH para la red en la que estás (que se puede encontrar en [la página oficial de contratos](/es/protocol/contracts-integrations)).
La dirección de rETH siempre es segura sin importar qué.

**Una vez que Redstone haya sido implementado**, puedes ver la dirección exacta a la que debes configurar tu destinatario de tarifas vía `rocketpool node status`. Por ejemplo, si estás participando en el Smoothing Pool, mostrará la dirección del Smoothing Pool y notará que debes usarla como tu destinatario de tarifas:

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Si _no_ estás participando en el Smoothing Pool, mostrará la dirección de tu distribuidor de tarifas y notará que debes usarla como tu destinatario de tarifas:

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

Selecciona tu cliente de consenso a continuación para aprender cómo configurarlo.

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Add the following command line argument to your Validator Client's service definition file:

      ```
      --suggested-fee-recipient `address`
      ```

      Donde `address` es:

      - La [dirección de rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se implemente la actualización Redstone (por ejemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea implementado, que puedes obtener con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si participas en el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto para usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>
    <Tab label="Nimbus">
      Add the following command line argument to Nimbus's service definition file:

      ```
      --suggested-fee-recipient=`address`
      ```

      Donde `address` es:

      - La [dirección de rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se implemente la actualización Redstone (por ejemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea implementado, que puedes obtener con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si participas en el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto para usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>
    <Tab label="Prysm">
      Add the following command line argument to your Validator Client's service definition file:

      ```
      --suggested-fee-recipient `address`
      ```

      Donde `address` es:

      - La [dirección de rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se implemente la actualización Redstone (por ejemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea implementado, que puedes obtener con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si participas en el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto para usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>
    <Tab label="Teku">
      Add the following command line argument to your Validator Client's service definition file:

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      Donde `address` es:

      - La [dirección de rETH](/es/protocol/contracts-integrations/#token-contracts) **antes** de que se implemente la actualización Redstone (por ejemplo, `0xae78736Cd615f374D3085123A210448E74Fc6393` en Mainnet)
      - El **distribuidor de tarifas** de tu nodo después de que Redstone sea implementado, que puedes obtener con `rocketpool node status` una vez que ocurra la actualización del contrato
      - La [dirección del Smoothing Pool](/es/protocol/contracts-integrations/#protocol-contracts) si participas en el Smoothing Pool

      Como recordatorio, `rocketpool node status` te mostrará el destinatario de tarifas correcto para usar en cualquier momento.

      **Por favor lee la [especificación de penalización](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) cuidadosamente para entender las condiciones y expectativas alrededor del destinatario de tarifas.**
    </Tab>

  </Tabs>
</div>

### Configurar MEV-Boost

[MEV-boost](https://boost.flashbots.net/) es el sistema que Flashbots proporciona para dar recompensas MEV a los validadores de Proof-of-Stake después de The Merge.

**Rocket Pool requiere que todos los nodos lo usen para maximizar sus retornos y así mantener el protocolo competitivo con otros servicios de staking.**

Necesitarás hacer algunos ajustes a tu nodo Beacon / cliente de consenso para conectarlo a MEV-boost.

MEV-boost actualmente no está disponible en Hoodi o Mainnet, por lo que no necesitas configurarlo en este momento.
Por supuesto, no serás penalizado por no usarlo durante este período de transición.

Una vez que esté disponible, anunciaremos una fecha en la que debe estar instalado y conectado a tu nodo.
Flashbots proporcionará instrucciones que puedes seguir en ese momento, y las enlazaremos aquí.

::: danger NOTA
Una vez que hagamos el anuncio de que MEV-boost debe estar habilitado por todos los operadores de nodo, ¡debes asegurarte de tenerlo correctamente instalado y configurado con tu nodo Beacon!

No hacerlo resultará en que tu minipool sea [penalizado](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).
:::

### Configurar un nodo de respaldo

Debido a que The Merge no es compatible con proveedores remotos como Infura y Pocket, perderás la capacidad de usarlos como clientes de ejecución de respaldo cuando tu cliente principal se desconecte.

El Smartnode todavía tiene la capacidad de proporcionar un cliente de ejecución de respaldo (y ahora también un cliente de consenso de respaldo), pero ahora necesitarás usar clientes de ejecución y consenso que controles.

Para más información sobre cómo configurar un nodo de respaldo, consulta la [guía de nodo de respaldo](../../node-staking/fallback).

### Inicializar tu distribuidor de tarifas

Si no planeas participar en el [Smoothing Pool](./whats-new#smoothing-pool) y reclamar todas tus tarifas prioritarias y recompensas MEV a tu [contrato distribuidor de tarifas](./whats-new#fee-recipients-and-your-distributor), eventualmente tendrás que inicializarlo (crear la instancia del contrato en la cadena) para reclamar recompensas de él a tu dirección de retiro.

Esta es una operación bastante económica y solo necesita hacerse una vez.

::: tip CONSEJO
Inicializar tu distribuidor de tarifas puede hacerse en **cualquier momento**.
Puedes dejar que las recompensas se acumulen en su dirección mucho antes de inicializarlo, y tu saldo permanecerá después de la inicialización.

Recomendamos que lo hagas cuando los precios del gas sean bajos para minimizar el costo adicional.

Ten en cuenta que **debe ser inicializado para reclamar tus recompensas.**
:::

### Participar en el Smoothing Pool

Si planeas aprovechar el [Smoothing Pool](./whats-new#smoothing-pool) de inmediato, debes participar antes del final del primer período de recompensas de Redstone para maximizar tu cantidad de "elegibilidad".

Participar puede hacerse ejecutando el siguiente comando:

```shell
rocketpool node join-smoothing-pool
```

### Reclamar recompensas

La actualización Redstone reemplaza el antiguo sistema de recompensas costoso y problemático con [uno completamente nuevo](./whats-new#new-rewards-system) que es mucho más económico, soporta el restaking automático de RPL (tanto en cantidades parciales como completas), y - lo más importante - **te permite reclamar tus recompensas cuando quieras**.

Debido a que ya no hay un límite de tiempo para reclamar recompensas, y porque es más económico reclamar muchos intervalos de recompensas a la vez, la función de reclamación automática de recompensas del Smartnode **ha sido eliminada**.
Ahora podrás reclamar recompensas vía el siguiente comando:

```shell
rocketpool node claim-rewards
```

Esto te mostrará todas las recompensas que has acumulado a través de todos los intervalos de recompensas comenzando con la actualización Redstone.
