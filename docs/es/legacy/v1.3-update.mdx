import { Tab, Tabs } from "@rspress/core/theme";

# Actualización a Smartnode v1.3.x

La versión 1.3.0 del stack de Smartnode trae algunos cambios importantes de los que los usuarios deben estar conscientes.
Están diseñados para mejorar significativamente tu experiencia como operador de nodo y abordar muchas de las características que nuestros usuarios han solicitado desde el lanzamiento de Rocket Pool.

En esta guía, te guiaremos a través del proceso de migración de una versión anterior del Smartnode a v1.3.x y posteriores.

## Cambios en el archivo de configuración

v1.3.0 introduce algunos cambios significativos en la forma en que se gestiona la configuración del Smartnode.
Si has modificado manualmente la configuración del Smartnode antes, debes estar consciente de los siguientes cambios:

- El archivo `config.yml` ha sido eliminado. Toda su información ahora está integrada directamente en el stack de Smartnode, para que los usuarios ya no puedan modificar accidentalmente el archivo de una manera que impida que el Smartnode funcione correctamente.
  - Todos los parámetros configurables por el usuario que anteriormente formaban parte de él ahora son configuraciones en la nueva interfaz de usuario de terminal `service config`.

- El archivo `settings.yml` ha sido reemplazado con un nuevo archivo llamado `user-settings.yml`. Este contiene todas tus configuraciones para cada parte configurable del Smartnode.
  - Este archivo **no está destinado a ser modificado directamente**. La modificación debe hacerse a través de la nueva interfaz de usuario de terminal `service config` en su lugar.

- La carpeta `chains` ha sido eliminada. Los scripts para lanzar el cliente de ejecución (ETH1), el nodo Beacon y el cliente validador ahora residen en la carpeta `scripts`.

- Los archivos YAML de `docker-compose` han sido eliminados. Cada contenedor ahora obtiene su propio archivo en la carpeta `templates`. Al ejecutar `rocketpool service start`, estas plantillas se completan con tus configuraciones y se colocan en la carpeta `runtime` automáticamente.
  - No se recomienda modificar las plantillas o los archivos de runtime. En su lugar, completa tus personalizaciones de contenedor usando los archivos **override** para cada contenedor en la carpeta `override`. Estos archivos sobrescribirán los archivos Docker en `runtime`, por lo que eres libre de personalizarlos como desees.
  - Los archivos en `override` **persistirán al actualizar y reinstalar el Smartnode**, por lo que solo necesitas crearlos una vez.
  - Si estás interesado en modificar los archivos `docker-compose` a través de este mecanismo de override, por favor consulta [esta sección](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## Instalando la nueva versión

Instalar la nueva versión debe sentirse muy familiar.

Comienza deteniendo los servicios y descargando el nuevo CLI como de costumbre:

<div className="p-3">
  <Tabs>
    <Tab label="Docker o modo híbrido">
      Detén los servicios de Rocket Pool:

      ```
      rocketpool service stop
      ```

      Descarga el nuevo CLI de Smartnode para tu sistema (elige de las pestañas a continuación):

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (la mayoría de las máquinas normales):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (la mayoría de las Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como la Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Ahora ejecuta el comando de instalación:

      ```
      rocketpool service install -d
      ```

      La bandera `-d` le indica que ignore las dependencias del sistema como Docker, ya que ya las tienes.

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTA</p>
        A partir de v1.3.0, **¡ya no tienes que especificar para qué red deseas instalar!**
        El nuevo Smartnode sabrá qué red estás usando ya, y te permitirá cambiar tu red dinámicamente usando la nueva interfaz de usuario de terminal.
      </p>
    </Tab>
    <Tab label="Modo nativo">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Esto solo actualizará el stack de Smartnode en sí - **no** actualizará tus clientes de ejecución y consenso.
        Tendrás que hacer esto manualmente (consulta [la guía de actualización manual](../node-staking/updates#manually-updating-the-eth1-or-eth2-client) para aprender cómo hacerlo).
      </p>

      Detén los servicios de Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Descarga los nuevos binarios del CLI y daemon de Smartnode:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (la mayoría de las máquinas normales):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (la mayoría de las Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como la Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTA</p>
        A partir de v1.3.0, `config.yml` ha sido eliminado.
        **Ya no necesitas descargar el paquete de instalación y extraerlo.**
      </p>
      A continuación, crea una carpeta de respaldo llamada `old_config_backup` en tu directorio de Smartnode y mueve tus archivos de configuración antiguos a ella (`config.yml` y `settings.yml`).
      El Smartnode usará estos para migrar tus configuraciones al nuevo sistema.

      Por ejemplo, si seguiste la guía de configuración nativa y tu directorio de Smartnode es `/srv/rocketpool`:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      Ahora, modifica los archivos de definición de servicio para `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Reemplaza la línea `ExecStart` con lo siguiente:

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      Nota que la bandera `--config` ha sido eliminada, y `--settings` ahora apunta a `user-settings.yml`.
      **No te preocupes de que este archivo no exista todavía; se generará automáticamente en el siguiente paso.**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Si eres miembro del Oracle DAO, _debes_ repetir el proceso anterior para el servicio `rp-watchtower` también.
      </p>

      Finalmente, recarga las definiciones de servicio:

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

Después de la instalación, todos tus archivos de configuración antiguos se moverán a una carpeta llamada `old_config_backup` en tu directorio de Smartnode (por defecto `~/.rocketpool/old_config_backup`).
Puedes encontrarlos allí si alguna vez necesitas consultarlos por cualquier razón.

**Si estás buscando instrucciones para revertir a v1.2.4 desde esta copia de seguridad, por favor desplázate a la sección [Revertir a tu configuración anterior](#revertir-a-tu-configuracion-anterior) al final de esta página.**

## Configurando el Smartnode con la interfaz de usuario de terminal

Ahora que tienes el nuevo CLI y paquete instalado, todas tus configuraciones anteriores se han preservado y migrado al nuevo sistema.
En el siguiente paso, debes ejecutar `rocketpool service config`.
Esto se verá bastante diferente en comparación con versiones anteriores de esta función; v1.3.0 introduce la **interfaz de usuario de terminal**: una interfaz de usuario dinámica basada en terminal para configurar tu Smartnode.

Debes ejecutarla antes de iniciar los contenedores Docker después del proceso de migración para ver la configuración, verificar que todos tus cambios se migraron con éxito y actualizar cualquier otra configuración que desees.

Cuando la ejecutes por primera vez, se te presentará esta pantalla de bienvenida (si estabas usando **modo Docker o híbrido**):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip NOTA
**Los usuarios de modo nativo** verán esta pantalla con redacción ligeramente diferente, que indica que el Smartnode está operando en modo nativo.
:::

La TUI comenzará con **el Asistente**, que te permite cambiar rápida y fácilmente los parámetros más importantes del Smartnode (como el modo y selección del cliente).

**Todas tus configuraciones anteriores ya deberían estar resaltadas mientras atraviesas cada página del asistente para que no tengas que recordar cuál era tu configuración anterior de memoria.**

:::warning NOTA
**Para un recorrido detallado de este Asistente, por favor visita las siguientes páginas:**

- Para **modo Docker**, por favor visita [la nueva guía de configuración de Docker](../node-staking/config-docker).

- **Usuarios de modo híbrido**: el modo híbrido ahora es una **característica de primera clase** del Smartnode y configurarlo es _mucho_ más fácil de lo que solía ser. Por favor visita [la nueva guía de configuración de Docker](../node-staking/config-docker) y síguelo. Cuando se te solicite elegir un modo de cliente de ejecución y modo de cliente de consenso, elige **Gestionado externamente** para ellos en consecuencia.

- Para **modo nativo**, por favor visita [la nueva guía de configuración nativa](../node-staking/config-native).

:::

Navega a través de este asistente y confirma que todas tus configuraciones son correctas.

Una vez que hayas terminado, tendrás la opción de **revisar todas las configuraciones antes de guardar** si lo deseas.
Esto incluye configuraciones que el Asistente no cubrió, como el **umbral de gas para reclamar RPL** o tu **número máximo de pares de Geth** como ejemplos.

La **pantalla principal de configuración**, que también debes revisar para confirmar tus configuraciones anteriores, se verá así (para usuarios de modo Docker e híbrido):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip NOTA
**Los usuarios de modo nativo** verán una pantalla ligeramente diferente que es única para el modo nativo y solo presenta las configuraciones que son relevantes para él.
:::

Siéntete libre de explorar esta nueva interfaz de usuario y ajustar cualquier configuración que consideres adecuada.
Usa las `Teclas de flecha` para navegar, y presiona `Enter` para entrar en una categoría o confirmar cualquier cambio en una configuración que hagas.

Presiona `Esc` cuando hayas terminado de editar una categoría para volver a esta pantalla de inicio.

Cuando estés listo para guardar tus cambios e iniciar el stack de Smartnode, simplemente presiona `Tab` para moverte a los botones en la parte inferior de la pantalla, selecciona `Review Changes and Save` (haciéndolo verde a través de las teclas de flecha).
Presiona `Enter` para ser llevado a la **Página de Revisión**, donde puedes ver todo lo que has cambiado desde la última vez que ejecutaste `rocketpool service config`.

Confirma que todos tus cambios están presentes, y luego presiona `Enter` nuevamente para guardarlos.
La pantalla te mostrará qué contenedores necesitan ser reiniciados para que los cambios se apliquen, aunque dado que estás migrando, ya has apagado los contenedores y todos se reiniciarán de todos modos.

## Iniciando el stack de Smartnode

Una vez que hayas guardado tu configuración, la terminal te preguntará si deseas reiniciar los contenedores automáticamente (a menos que estés usando el modo nativo).
Si no deseas / no puedes permitir que se inicien automáticamente, puedes iniciarlos manualmente con los siguientes comandos:

<div className="p-3">
  <Tabs>
    <Tab label="Docker o modo híbrido">```shell rocketpool service start ```</Tab>
    <Tab label="Modo nativo">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

Una vez que estén activos, puedes verificar que todo esté funcionando según lo previsto.

Usa el comando `rocketpool service version` para verificar que tengas la versión correcta del Smartnode y contenedores de cliente:

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

Usa los comandos `rocketpool service logs eth1` y `rocketpool service logs eth2` para observar los registros de tu cliente de ejecución (anteriormente cliente ETH1) y tu cliente de consenso (anteriormente cliente ETH2).
Busca cualquier error y [por favor visita nuestro servidor de Discord para obtener ayuda](https://discord.com/invite/rocketpool) si los encuentras.

## Revertir a tu configuración anterior

Si, por alguna razón, necesitas revertir a v1.2.4 del stack de Smartnode, ¡no te preocupes!
Todos tus archivos de configuración antiguos se han conservado en un directorio de respaldo y se pueden recuperar fácilmente para restaurar tu configuración anterior.

Selecciona qué modo usas de las pestañas a continuación y sigue las instrucciones.

<div className="p-3">
  <Tabs>
    <Tab label="Docker o modo híbrido">
      Comienza reemplazando el CLI con el CLI v1.2.4 para tu sistema:
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (la mayoría de las máquinas normales):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (la mayoría de las Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como la Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      A continuación, copia todos tus archivos de configuración antiguos de la carpeta `old_config_backup` de vuelta a la carpeta del Smartnode:

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      Ahora, todo lo que necesitas hacer es reiniciar los contenedores Docker:

      ```shell
      rocketpool service start
      ```

      ¡Listo! Tu configuración antigua está de vuelta.

    </Tab>
    <Tab label="Modo nativo">
      Detén los servicios de Rocket Pool:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Para sistemas `x64` (la mayoría de las máquinas normales):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Para sistemas `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Para sistemas `x64` (la mayoría de las Macs):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Para sistemas `arm64`, como la Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      Copia los archivos de configuración anteriores de vuelta a tu directorio de Smartnode:

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      Ahora, revierte los archivos de definición de servicio para `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Reemplaza la línea `ExecStart` con lo siguiente:

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Si eres miembro del Oracle DAO, _debes_ repetir el proceso anterior para el servicio `rp-watchtower` también.
      </p>

      Finalmente, recarga las definiciones de servicio y reinicia los servicios:

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      ¡Listo! Tu configuración antigua está de vuelta.
    </Tab>

  </Tabs>
</div>
