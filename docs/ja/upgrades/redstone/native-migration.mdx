import { Tab, Tabs } from "@rspress/core/theme";

# [ネイティブモード] RedstoneアップデートとMergeのガイド

このガイドでは、**ネイティブモード**を使用している場合に、RedstoneアップデートとMergeに向けてノードを準備するために知っておく必要があるすべてをカバーします。

## v1.5.0へのアップグレード前にすべきこと

Smartnodeのv1.5.0以降にアップグレードする前に、次のチェックリストを確認して準備が整っていることを確認してください：

### フルExecutionクライアントへの切り替え

Mergeでは独自のExecutionクライアントを実行する必要があるため、InfuraやPocketなどのリモートプロバイダーを使用できなくなります。

この変更により、現在ライトExecutionクライアントを使用している場合は、v1.4のままフルクライアントに切り替え、同期を完了させてからv1.5にアップグレードする必要があります。

### Engine APIのセットアップ

MergeはExecutionクライアントとConsensusクライアントの通信方法を変更します。
古いHTTPまたはWebsocketベースのRPCシステムを使用する代わりに、MergeはExecutionクライアントによって公開されるEngine APIと呼ばれる新しいシステムを必要とします。

これは、Consensusクライアントが古いProof-of-WorkマイニングシステムをProof-of-Stakeに置き換えることを可能にする特別な接続です。これはMergeの心臓部です。
また、秘密トークンで**認証**されているため、ConsensusクライアントのみがExecutionクライアントに接続でき、他には何もできません。

独自のExecutionおよびConsensusクライアントを管理しているため、Engine APIを手動でセットアップする必要があります。
その方法は、実行しているクライアントによって完全に異なります。

CoinCashewには、ExecutionおよびConsensusクライアントでEngine APIをセットアップする方法についての[優れた簡潔なガイド](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators)があります。
それを見て、アップグレードする前に正しくattestすることを確認して新しい構成をテストしてください。

以下で、Smartnodeソフトウェアが自動的に必要とする正しいfee recipientを使用するようにValidator Clientをセットアップする方法を示します。

## v1.5.0へのアップグレード

Smartnodeスタックをv1.5.0にアップグレードすることは、他のアップグレードと変わりません。
単に[こちらの通常の手順](../../node-staking/updates#updating-the-smartnode-stack)に従ってください。

## アップグレード後にすべきこと

ネイティブモードでは、アップグレード後に手動で行う必要があることがいくつかあります：

### アップグレードの成功を確認

最初にすべきことは、ノードが正しく動作していることを確認することです。
次の手順を検討してください：

- Executionクライアント、Consensusクライアント、Validator Client、およびSmartnodeデーモン（`rp-node`サービス）のログスクリプトをチェックして、エラーなく正常に機能していることを確認します。
- Block Explorer（Grafanaダッシュボードや[https://beaconcha.in](https://beaconcha.in)など）で、まだ適切にattestしていることを確認します
  - Doppelganger保護を有効にしている場合、再起動後にいくつかのattestationを失うことを忘れないでください。これは正常です！

### Validator ClientでFee Recipientをセットアップ

Merge前にセットアップすべき**重要な**詳細の1つは、Validator Clientによって指定された**fee recipient**です。
[概要記事](./whats-new#fee-recipients-and-your-distributor)で説明されているように、これは次の2つの値のいずれかになります：

- Smoothing Poolに**オプトイン**している場合、これは**Smoothing Pool契約**のアドレスである必要があります。アドレスは[公式契約ページ](/ja/protocol/contracts-integrations)から取得できます。
- Smoothing Poolに**いない**場合、これはノードの**fee distributor契約**のアドレスである必要があります。アドレスは、`Fee Distributor and Smoothing Pool`セクションの下の`rocketpool node status`を実行して取得できます。

ネイティブモードでは、Smartnodeデーモンサービス`rp-node`を使用する場合はSmartnodeにこれを管理させるか、デーモンを使用しない場合は自分で管理するかを選択できます。

#### デーモンによる自動管理

Smartnodeデーモンは、ノードに適切なfee recipientを自動的に決定し、変更された場合（Smoothing Poolへのオプトインおよびアウトなど）に管理します。
これは**最も安全な**オプションです。Smartnodeは常に[ペナルティ](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を防ぐ値に設定されることを保証するためです。

これを行う方法は、正しいfee recipientを含むファイルを維持し、定期的に更新して正確性を確保することです。
更新が必要な場合、ファイルを変更し、Validator Clientを自動的に再起動して新しいrecipientをロードします。新しいminipoolをステークした後にValidator Clientを再起動する方法と同様です。

以下でクライアントを選択して、セットアップ方法を学んでください：

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      `ExecStart`行の_前_に次の行を追加して、Validator Clientサービスを変更します：

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば：

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します：

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      VCは、Smartnodeデーモンによって管理されるファイルを使用するようになり、fee recipientが変更されるたびに自動的に再起動されます。
    </Tab>
    <Tab label="Nimbus">
      `ExecStart`行の_前_に次の行を追加して、Validator Clientサービスを変更します：

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば：

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します：

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      VCは、Smartnodeデーモンによって管理されるファイルを使用するようになり、fee recipientが変更されるたびに自動的に再起動されます。
    </Tab>
    <Tab label="Prysm">
      `ExecStart`行の_前_に次の行を追加して、Validator Clientサービスを変更します：

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば：

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します：

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      VCは、Smartnodeデーモンによって管理されるファイルを使用するようになり、fee recipientが変更されるたびに自動的に再起動されます。
    </Tab>
    <Tab label="Teku">
      `ExecStart`行の_前_に次の行を追加して、Validator Clientサービスを変更します：

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば：

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します：

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      VCは、Smartnodeデーモンによって管理されるファイルを使用するようになり、fee recipientが変更されるたびに自動的に再起動されます。
    </Tab>

  </Tabs>
</div>

#### 手動Fee Recipient管理

::: danger 警告
これを行うことにより、fee recipientが常に正しいアドレスに設定されていることを確認する全責任を負います。

[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を読んで、構成に応じて何に設定する必要があるか、およびある値から別の値に安全に変更できる時期を理解してください。

そうしないと、minipoolがペナルティを受ける可能性があります！
:::

**Redstoneがデプロイされる前**は、使用しているネットワークのrETHアドレス（[公式契約ページ](/ja/protocol/contracts-integrations)にあります）を単純に使用できます。
rETHアドレスは常に何があっても安全です。

**Redstoneがデプロイされた後**は、`rocketpool node status`を介してfee recipientとして設定する必要がある正確なアドレスを確認できます。たとえば、Smoothing Poolにオプトインしている場合、Smoothing Poolのアドレスが表示され、fee recipientとして使用する必要があることが示されます：

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Smoothing Poolにオプトイン_していない_場合、fee distributorアドレスが表示され、fee recipientとして使用する必要があることが示されます：

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

以下でConsensusクライアントを選択して、構成方法を学んでください。

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Validator Clientのサービス定義ファイルに次のコマンドライン引数を追加します：

      ```
      --suggested-fee-recipient `address`
      ```

      ここで`address`は：

      - Redstoneアップデートがデプロイされる**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例：Mainnetの`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneがデプロイされた後はノードの**fee distributor**で、契約アップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインする場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`はいつでも使用する正しいfee recipientを表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、fee recipientに関する条件と期待を理解してください。**
    </Tab>
    <Tab label="Nimbus">
      Nimbusのサービス定義ファイルに次のコマンドライン引数を追加します：

      ```
      --suggested-fee-recipient=`address`
      ```

      ここで`address`は：

      - Redstoneアップデートがデプロイされる**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例：Mainnetの`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneがデプロイされた後はノードの**fee distributor**で、契約アップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインする場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`はいつでも使用する正しいfee recipientを表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、fee recipientに関する条件と期待を理解してください。**
    </Tab>
    <Tab label="Prysm">
      Validator Clientのサービス定義ファイルに次のコマンドライン引数を追加します：

      ```
      --suggested-fee-recipient `address`
      ```

      ここで`address`は：

      - Redstoneアップデートがデプロイされる**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例：Mainnetの`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneがデプロイされた後はノードの**fee distributor**で、契約アップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインする場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`はいつでも使用する正しいfee recipientを表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、fee recipientに関する条件と期待を理解してください。**
    </Tab>
    <Tab label="Teku">
      Validator Clientのサービス定義ファイルに次のコマンドライン引数を追加します：

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      ここで`address`は：

      - Redstoneアップデートがデプロイされる**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例：Mainnetの`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneがデプロイされた後はノードの**fee distributor**で、契約アップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインする場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`はいつでも使用する正しいfee recipientを表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、fee recipientに関する条件と期待を理解してください。**
    </Tab>

  </Tabs>
</div>

### MEV-Boostのセットアップ

[MEV-boost](https://boost.flashbots.net/)は、Merge後にMEV報酬をProof-of-Stake validatorに提供するためにFlashbotsが提供するシステムです。

**Rocket Poolは、リターンを最大化し、プロトコルを他のstakingサービスと競争力のあるものに保つために、すべてのノードがこれを使用することを要求しています。**

MEV-boostに接続するには、Beacon Node / Consensusクライアントにいくつかの調整を行う必要があります。

MEV-boostは現在HoodiまたはMainnetで利用できないため、現時点でセットアップする必要はありません。
もちろん、この移行期間中に使用しなくてもペナルティを受けることはありません。

利用可能になったら、すべてのノードオペレーターがインストールしてノードに接続する必要がある日付を発表します。
その時点でFlashbotsは従うことができる手順を提供し、ここにリンクします。

::: danger 注意
すべてのノードオペレーターがMEV-boostを有効にする必要があるという発表を行ったら、Beacon Nodeに適切にインストールされ構成されていることを確認する必要があります！

そうしないと、minipoolが[ペナルティ](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を受けることになります。
:::

### フォールバックノードのセットアップ

Mergeは、InfuraやPocketなどのリモートプロバイダーと互換性がないため、プライマリがオフラインになったときにフォールバックExecutionクライアントとして使用する能力を失います。

Smartnodeには依然としてフォールバックExecutionクライアント（および現在はフォールバックConsensusクライアントも）を提供する能力がありますが、制御するExecutionおよびConsensusクライアントを使用する必要があります。

フォールバックノードのセットアップの詳細については、[フォールバックノードガイド](../../node-staking/fallback)を参照してください。

### Fee Distributorの初期化

[Smoothing Pool](./whats-new#smoothing-pool)にオプトインせず、すべてのpriority feesとMEV報酬を[fee distributor契約](./whats-new#fee-recipients-and-your-distributor)に請求する予定がない場合、最終的には初期化（チェーン上に契約インスタンスを作成）して、そこから出金アドレスに報酬を請求する必要があります。

これはかなり安価な操作であり、一度だけ行う必要があります。

::: tip ヒント
fee distributorの初期化は**いつでも**行うことができます。
初期化するずっと前に報酬をそのアドレスに蓄積させることができ、初期化後も残高は残ります。

オーバーヘッドコストを最小限に抑えるために、ガス価格が低いときに行うことをお勧めします。

**報酬を請求するには初期化する必要があります。**
:::

### Smoothing Poolへのオプトイン

すぐに[Smoothing Pool](./whats-new#smoothing-pool)を利用する予定がある場合は、「適格性」金額を最大化するために、最初のRedstone報酬期間の終了前にオプトインする必要があります。

オプトインは次のコマンドを実行して行うことができます：

```shell
rocketpool node join-smoothing-pool
```

### 報酬の請求

Redstoneアップグレードは、高価で問題のある古い報酬システムを、はるかに安価で、RPLの自動再ステーク（部分的および完全な金額の両方）をサポートし、そして最も重要なことに**いつでも報酬を請求できる**[真新しいもの](./whats-new#new-rewards-system)に置き換えます。

報酬請求に時間制限がなくなり、多くの報酬間隔を一度に請求する方が安価になるため、Smartnodeの自動報酬請求機能は**削除されました**。
次のコマンドを介して報酬を請求できるようになります：

```shell
rocketpool node claim-rewards
```

これにより、Redstoneアップグレードから始まるすべての報酬間隔にわたって蓄積したすべての報酬が表示されます。
