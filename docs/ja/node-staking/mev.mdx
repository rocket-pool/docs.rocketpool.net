import { Tab, Tabs } from "@rspress/core/theme";
import tuiMeVBoost from "./images/tui-mev-boost.png";
import tuiMeVBoostMain from "./images/tui-mev-boost-main.png";
import mevBoostIntegrationOverview from "./images/mev-boost-integration-overview.png";

# MEV、MEV-Boost、MEV報酬

前のセクションでは、node operatorがpriority feeを獲得する方法について学びました。
Priority feeはnode operatorの収入を大幅に増やすものですが、Execution layerで利用可能な流動報酬の_唯一の_形態ではありません。
**MEV報酬**として知られる補助的な形態の報酬が利用可能です。

:::tip NOTE
ここで簡単におさらいすると、異なるタイプの報酬とそれらが提供されるレイヤーの内訳は以下の通りです。

- Consensus Layer（出金までロック）: アテステーション、ブロック提案、sync committee、スラッシング報告
- Execution Layer（流動）: ブロック提案からのpriority feeとMEV

:::

## MEVとは

バリデーターがブロックを作成する際、通常は非常にシンプルなアルゴリズムを使用します。保留中のトランザクションのリストを追跡し、構築しているブロックにできるだけ多くのトランザクションをバンドルし（最も高いチップを持つものを優先）、そのブロックをチェーンに送信します。

しかし、Ethereumネットワークのユーザーは、公開されている保留中のトランザクションのプール（**mempool**として知られる）を見ることができることの興味深い副作用を発見しました。
この知識により、トランザクションの順序を変更し、場合によってはそれらの間に_新しい_トランザクションを導入する、巧妙で洗練されたアルゴリズムを採用できるようになりました。
これら2つの技術を組み合わせることで、ブロック提案から追加のETHを抽出できます。

この追加のETHは、**Maximal Extractable Value**、略してMEVとして知られています。

一般的に、MEVには2つの「フレーバー」があります。

- 大規模な買いまたは売りの後、取引所間で最初にアービトラージを行うなど、「良性の」ソースから来るMEV
- Ethereumユーザーのトランザクションをフロントランニングし、ユーザーの結果としてのスリッページから利益を得ることで、Ethereumユーザーの犠牲の上に成り立つMEV（この技術の詳細については、[Sandwich Attacks](https://trustwallet.com/blog/how-to-protect-yourself-from-sandwich-attacks)を参照してください）

## Block BuilderとRelay

MEVの機会を見つけることは簡単なことではありません。最先端の機会発見者は**searcher**として知られており、非常に強力なコンピューターを必要とし、複雑なAIアルゴリズムを採用して、迅速にMEVを特定して抽出します。
Searcherはこれらの機会を取得し、**block builder**（searcher自身または他の当事者である可能性がある）に提供します。block builderは、これらの機会のバンドルを集約して完全なEthereumブロックを形成するエンティティです。

収益性の高いsearcherを実行するためのハードウェアとソフトウェアの要件により、ほとんどのnode operatorはそれらを使用すること（または少なくとも_競争力を持って_使用すること）ができず、したがって独自のMEV機会を見つけて活用することができません。
幸いなことに、単にMEV機会を_見つける_ことは方程式の半分に過ぎません。

各Epoch（6.4分、または32スロット）ごとに、Beacon Chainはアクティブなバリデーターの全リストからランダムにバリデーターを選択して、そのEpochのスロットの1つに収まるブロックを提案します。
このリストは、次の今後のEpochについて確認でき、つまり、各スロットにどのバリデーターが割り当てられているかを数分前に全員が確認できます。

一部の[賢いエンティティ](https://docs.flashbots.net/)は、この事前知識を活用して、ある種の「マーケットプレイス」のようなものを構築しました。
このマーケットプレイスでは、バリデーターは今後のブロック提案がある際に自分自身を登録でき、block builderはバリデーターに提案してもらいたいブロックの入札を提出できます。
これらの入札は常に、ブロック内の各トランザクションからのpriority feeを提案者に提供し、_さらに_、builderが自分自身のために抽出できたMEVから提案者への補助的なチップを提供します。

バリデーターはこれらの入札を調査し、最終的に最も利益をもたらすものを決定し、自分でブロックを構築する代わりにそのブロックを提案できます。

block builderがバリデーターとやり取りするこの「マーケットプレイス」は、**relay**として知られています。
異なるrelayには異なるルールがあります（block builderから許可する前述の「フレーバー」のMEVや、特定の政府制裁規制に準拠するかどうかなど）が、最終的にはすべて同じマーケットプレイス機能を果たします。

Rocket Poolは現在、node operatorに**複数の異なるrelay**へのアクセスを提供しています。

| 名前                                                                                          | 規制                     | MEVタイプ |
| --------------------------------------------------------------------------------------------- | ------------------------ | --------- |
| [Flashbots](https://boost.flashbots.net/)                                                     | OFAC制裁に準拠\* | すべてのタイプ |
| [bloXroute Max Profit](https://docs.bloxroute.com/apis/mev-solution/mev-relay-for-validators) | OFAC制裁に準拠\* | すべてのタイプ |
| [bloXroute Regulated](https://docs.bloxroute.com/apis/mev-solution/mev-relay-for-validators)  | OFAC制裁に準拠\* | すべてのタイプ |
| [Ultra Sound](https://relay.ultrasound.money/)                                                | 規制なし                    | すべてのタイプ |
| [Ultra Sound Filtered](https://relay-filtered.ultrasound.money/)                              | OFAC制裁に準拠\* | すべてのタイプ |
| [AESTUS](https://aestus.live/)                                                                | 規制なし                    | すべてのタイプ |
| [Titan Global](https://docs.titanrelay.xyz/)                                                  | 規制なし                    | すべてのタイプ |
| [Titan Regional](https://docs.titanrelay.xyz/)                                                | OFAC制裁に準拠\* | すべてのタイプ |
| [BTCS OFAC+](https://shop.btcs.com/ofac-relay/)                                               | OFAC制裁に準拠\* | すべてのタイプ |

::: warning NOTE
\*OFAC制裁に準拠するrelayは、米国財務省外国資産管理局（OFAC）が維持しているアドレスのブラックリストに従います。
OFAC制裁、ネットワーク検閲についてさらに読み、それらの制裁に準拠すべきかどうか、およびどのrelayの使用に快適であるかについて、慎重に情報に基づいた決定を下すことを**強くお勧めします**。

詳細については、以下のような記事をご覧ください。

- [https://home.treasury.gov/news/press-releases/jy0916](https://home.treasury.gov/news/press-releases/jy0916)
- [https://www.coindesk.com/tech/2022/08/23/as-censorship-on-ethereum-begins-could-this-open-sourced-code-help-counter-it/](https://www.coindesk.com/tech/2022/08/23/as-censorship-on-ethereum-begins-could-this-open-sourced-code-help-counter-it/)
- [https://blog.bitmex.com/ofac-sanctions-ethereum-pos-some-technical-nuances/](https://blog.bitmex.com/ofac-sanctions-ethereum-pos-some-technical-nuances/)
- [https://www.paradigm.xyz/2022/09/base-layer-neutrality](https://www.paradigm.xyz/2022/09/base-layer-neutrality)

:::

各relayの相対的な市場シェアとブロックあたりの平均チップを調べることに興味がある場合は、[https://www.mevboost.org/](https://www.mevboost.org/)をご覧ください。
このサイトは、さまざまなMEV relayに関する多くの指標を捉えているため、relayの人気と収益をよりよく理解できます。

## MEV-Boost

多くのrelayが存在し、ノードがそれぞれに自動的に登録して連絡を維持することは負担の大きいタスクになる可能性があります。
幸いなことに、Flashbotsのエンジニアは、このrelay管理を処理するために明示的に設計された[MEV-Boost](https://boost.flashbots.net/)として知られるプログラムを作成し、維持しています。

MEV-Boostはシンプルなプログラムです。使用したいrelayを指定し、Consensusクライアントに到達方法を指示すると、Consensusクライアントと連携して、すべての登録、入札、blind署名、提案管理を処理します。
これにより、このbuilder-proposer-marketplaceに受動的に参加でき、したがってあなたの側で労力をかけずに追加の報酬を獲得できます。

MEV-Boostは[オープンソース](https://github.com/flashbots/mev-boost)であり、[監査済み](https://github.com/flashbots/mev-boost/blob/main/docs/audit-20220620)です。

以下は、MEVエコシステム全体がどのように機能するか、およびMEV-Boostがどこに適合するかを視覚的に示した良い図です。

<img src={mevBoostIntegrationOverview} width="100%" height="auto" />

_画像提供: Flashbots_

Rocket Pool Smartnodeには、デフォルトでMEV-Boostが直接バンドルされており、**Docker Mode**および**Hybrid Mode**のnode operatorがシームレスに利用できるようになっています。
**Native Mode**ユーザーは、手動で設定する必要があります。

## Rocket PoolとMEV

Rocket Poolのバリデーターは、rETHステーカーによって部分的に資金提供されているため、プロトコルでは、MEV報酬（およびpriority fee）を**rETHステーカーと共有する**ことが求められます（もちろん、node operatorの手数料を差し引いたもの）。
Node operatorは、Rocket Poolのバリデーターで提案する際に、MEV報酬全体を自分でポケットに入れることは許可されていません。

そのため、MEV-Boostはいくつかの理由でRocket Poolネットワークの重要なコンポーネントです。

- MEV relayのネットワークへの簡単なアクセスを提供します
- Node operatorが独自のブロックを構築していないことを保証します。これは、node operatorが独自のsearcherを実行し、rETHステーカーと共有せずにMEVを盗んでいないことを確保するために重要です
- rETHステーカーの全体的な収益を増やし、プロトコルを他のより中央集権的なステーキングプロバイダーと競争力のある状態に保ちます

ここでの2番目のポイントは重要です。Rocket Poolはプロトコルとして、最終的に[Trusted Block Builder](https://github.com/rocket-pool/rocketpool-research/blob/master/Post%20Merge/Security#option-2-trusted-block-builders)（より正確には、Trusted Relay）設計に依存して、rETHステーカーが常にMEV報酬とpriority feeの公平な分け前を受け取ることを保証します。

上記のrelayのそれぞれは現在、この役割を果たしています。

私たちは、Trusted Block Builder設計への移行に向けて3段階のアプローチを取っています。

### フェーズ1: オプトイン

フェーズ1では、MEV-Boostはすべてのnode operatorに**オプトイン**構成として提供されます。
Node operatorは、rETHの収益を改善し、プロトコルを競争力のある状態に保つため、その使用が奨励されますが、使用は必須ではありません。
Node operatorは、上記の信頼できるrelayの**1つ以上**を使用することを選択できますが、カスタム（信頼できない）relayは使用できません。

このフェーズは2022年11月に終了しました。

### フェーズ2: オプトアウト

フェーズ2では、MEV-Boostはデフォルトですべてのnode operatorに対して有効になっています。
Node operatorは、上記の信頼できるrelayの**1つ以上**を使用することを選択できますが、カスタム（信頼できない）relayは使用できません。
MEV-boostをオプトアウトすることを選択するnode operatorは、Smartnodeを起動する前に明示的にそうする必要があります。

これが**現在のフェーズ**です。

### フェーズ3: 必須

フェーズ3では、MEV-Boostはオプションではなくなります。すべてのnode operatorに必須になります。
Node operatorは、上記の信頼できるrelayの**1つ以上**を使用する**必要があります**が、カスタム（信頼できない）relayは使用できません。

現在、このフェーズには**予定日はありません**。

## SmartnodeでのMEV-Boostの設定

MEV-Boostを設定する方法を学ぶには、使用しているモードを以下から選択してください。

<div className="p-3">
  <Tabs>
    <Tab label="Docker Mode">
      SmartnodeのConfiguration TUIを使用すると、MEV-Boostの設定は簡単です。
      `rocketpool service config`を実行し、`MEV-Boost`オプションに移動してください。

      <img src={tuiMeVBoost} width="100%" height="auto"/>

      `Enable MEV-Boost`というラベルの付いたボックスをチェックして有効にします。

      有効にすると、画面は次のようになります（_Smartnode v1.17.2以降_）。

      <img src={tuiMeVBoostMain} width="100%" height="auto"/>

      以下は各オプションの説明と使用方法です。

      - `MEV-Boost Mode`ボックスでは、Rocket Poolが管理するMEV-Boostインスタンスと、自分で管理する外部インスタンスを切り替えることができます。これは、すでにMEV-Boostを設定しており、Rocket Poolに2つ目のコピーを実行させる代わりに単にそれを使用したい上級ユーザー向けです。通常のDocker Modeユーザーは、これを`Locally Managed`に設定したままにしておく必要があります。

      - `Selection Mode`ボックスでは、**Profile Mode**と**Relay Mode**を切り替えることができます。

      - **Profile Mode**がデフォルトです。これにより、「プロファイル」に基づいて有効にするrelayを選択できます。relayのプロファイルは、以下の選択肢で構成されます。
      - **規制されている**（OFAC リストなどの政府制裁リストに準拠し、特定のアドレスをブラックリストに登録する）か**規制されていない**（ブラックリストに基づいてトランザクションを_検閲しない_）か
      - **すべてのタイプのMEVを許可する**か、sandwichアタックやEthereumユーザーのフロントランニングを含むバンドルを明示的に禁止するか
      - **複数のプロファイルを選択**できます。
      - 選択した各プロファイルには、それに準拠するrelayのセットがあり、説明ボックスにリストされています。そのプロファイルを有効にすると、それらのすべてのrelayが有効になります。
      - 上級ユーザーは、これを**Relay Mode**に変更できます。これにより、使用したいrelayを明示的に選択できます。

      - `Port`ボックスは、Docker modeユーザーにとって重要ではありません。
      - `Expose API Port`ボックスは、Docker modeユーザーにとって重要ではありません。
      - `Container Tag`ボックスは、FlashbotsがSmartnodeアップデートでリリースされる前に使用したい新しい優先度の高いバージョンをリリースした場合に、Smartnodeが実行するMEV-Boostのバージョンを手動でアップグレードするのに役立ちます。
      - `Additional Flags`ボックスは、MEV-Boostコンテナに追加の構成フラグまたはパラメーターを直接追加したい場合に使用します。通常、役に立ちません。

      MEV-Boostを有効にし、使用したいrelayを有効にしたら、保存して終了するだけです。
      Smartnodeは関連するコンテナを再起動し、すべてを自動的に設定します。

      期待通りに動作しているかどうかを確認する方法については、以下を参照してください。
    </Tab>
    <Tab label="Hybrid Mode">
      SmartnodeのConfiguration TUIを使用すると、MEV-Boostの設定は簡単です。
      `rocketpool service config`を実行し、`MEV-Boost`オプションに移動してください。

      <img src={tuiMeVBoost} width="100%" height="auto"/>

      `Enable MEV-Boost`というラベルの付いたボックスをチェックして有効にします。

      有効にすると、画面は次のようになります（_Smartnode v1.17.2以降_）。

      <img src={tuiMeVBoostMain} width="100%" height="auto"/>

      `Enable MEV-Boost`というラベルの付いたボックスをチェックして有効にします。

      以下は各オプションの説明と使用方法です。

      - `MEV-Boost Mode`ボックスでは、Rocket Poolが管理するMEV-Boostインスタンスと、自分で管理する外部インスタンスを切り替えることができます。一部のユーザーは、Rocket Poolに独自のMEV-Boostインスタンスを管理させ、外部で管理されているBeacon Nodeをそれに接続することを好みます。この場合、`Locally Managed`が最良のオプションです。すでに独自のMEV-Boostインスタンスを実行しており、Rocket PoolのVCにそれを使用させたい場合（つまり、blinded block signingを有効にすることによって）、これを`Externally Managed`のままにしておくだけです。**これ以上の操作は必要ありません。**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        独自のMEV-Boostインスタンスを実行する場合、上記の信頼できるrelayにのみ登録する**必要があります**。Rocket Poolのバリデーターが信頼できないrelayを介して送信されたブロックを提案した場合、Oracle DAOは**不正行為のフラグを立てます**。rETHステーカーからMEVを盗んでいる可能性があります。これにより、minipoolに[ペナルティ](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)が科されます。
      </p>

      - `Locally Managed`のMEV-Boostインスタンスを使用することにした場合、`Selection Mode`ボックスでは**Profile Mode**と**Relay Mode**を切り替えることができます。

      - **Profile Mode**がデフォルトです。これにより、「プロファイル」に基づいて有効にするrelayを選択できます。relayのプロファイルは、以下の選択肢で構成されます。
      - **規制されている**（OFAC リストなどの政府制裁リストに準拠し、特定のアドレスをブラックリストに登録する）か**規制されていない**（ブラックリストに基づいてトランザクションを_検閲しない_）か
      - **すべてのタイプのMEVを許可する**か、sandwichアタックやEthereumユーザーのフロントランニングを含むバンドルを明示的に禁止するか
      - **複数のプロファイルを選択**できます。
      - 選択した各プロファイルには、それに準拠するrelayのセットがあり、説明ボックスにリストされています。そのプロファイルを有効にすると、それらのすべてのrelayが有効になります。
      - 上級ユーザーは、これを**Relay Mode**に変更できます。これにより、使用したいrelayを明示的に選択できます。

      - `Port`ボックスは、MEV-BoostがBeacon Nodeからの着信接続をリッスンするポートを決定します。ノード内のポート競合のために変更する必要がある場合は、ここで変更できます。
      - `Expose API Port`ボックスは、外部で管理されているBNがRocket Poolが管理するMEV-Boostインスタンスと通信できるように**チェックする必要があります**。外部で管理されているBNが同じマシンで実行されている場合は、`Open to Localhost`を選択します。外部で管理されているBNが異なるマシンで実行されている*かつ*不要なトラフィックからノードを保護するための適切な手順を実行している場合にのみ、`Open to External hosts`を選択してください: [ノードの保護](./securing-your-node)
      - `Container Tag`ボックスは、FlashbotsがSmartnodeアップデートでリリースされる前に使用したい新しい優先度の高いバージョンをリリースした場合に、Smartnodeが実行するMEV-Boostのバージョンを手動でアップグレードするのに役立ちます。
      - `Additional Flags`ボックスは、MEV-Boostコンテナに追加の構成フラグまたはパラメーターを直接追加したい場合に使用します。通常、役に立ちません。

      MEV-Boostを有効にし、使用したいrelayを有効にしたら、保存して終了するだけです。
      `Locally Managed`インスタンスを使用しており、`Expose API Port`ボックスがチェックされている場合、`http://localhost:18550`でBeacon Nodeを接続するように設定できます。
      外部で管理されているBeacon NodeでMEV-Boostを有効にする方法については、[Flashbotsのドキュメント](https://github.com/flashbots/mev-boost/wiki/Testing)を参照してください。

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTE</p>
        ファイアウォールを有効にしている場合は、UFW設定でこれを許可する**必要がある場合があります**。
      </p>

      期待通りに動作しているかどうかを確認する方法については、以下を参照してください。
    </Tab>
    <Tab label="Native Mode">
      Beacon NodeとValidator ClientサービスでMEV-Boostを有効にする方法については、[Flashbotsのドキュメント](https://github.com/flashbots/mev-boost/wiki/Testing)を参照してください。

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        MEV-Boostインスタンスでは、上記の信頼できるrelayにのみ登録する**必要があります**。Rocket Poolのバリデーターが信頼できないrelayを介して送信されたブロックを提案した場合、Oracle DAOは**不正行為のフラグを立てます**。rETHステーカーからMEVを盗んでいる可能性があります。これにより、minipoolに[ペナルティ](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)が科されます。
      </p>
    </Tab>

  </Tabs>
</div>

## MEV-Boostのログの確認

MEV-Boostのログを確認するには、以下のコマンドを実行します（Docker Modeユーザーおよびローカルで管理されているコンテナを持つHybridユーザー向け）。

```shell
rocketpool service logs mev-boost
```

出力には、有効にしたrelay、それらの接続ステータスが表示され、Beacon Nodeからのトラフィックのリッスンを開始します。

```
mev-boost_1      | time="2022-09-28T22:02:06Z" level=info msg="mev-boost v1.3.1" module=cli
mev-boost_1      | time="2022-09-28T22:02:06Z" level=info msg="Using genesis fork version: 0x00000000" module=cli
mev-boost_1      | time="2022-09-28T22:02:06Z" level=info msg="using 4 relays" module=cli relays="[{0xac6e77dfe25ecd6110b8e780608cce0dab71fdd5ebea22a16c0205200f2f8e2e3ad3b71d3499c54ad14d6c21b41a37ae https://0xac6e77dfe25ecd6110b8e780608cce0dab71fdd5ebea22a16c0205200f2f8e2e3ad3b71d3499c54ad14d6c21b41a37ae@boost-relay.flashbots.net?id=rocketpool} {0xb0b07cd0abef743db4260b0ed50619cf6ad4d82064cb4fbec9d3ec530f7c5e6793d9f286c4e082c0244ffb9f2658fe88 https://0xb0b07cd0abef743db4260b0ed50619cf6ad4d82064cb4fbec9d3ec530f7c5e6793d9f286c4e082c0244ffb9f2658fe88@bloxroute.regulated.blxrbdn.com?id=rocketpool} {0x9000009807ed12c1f08bf4e81c6da3ba8e3fc3d953898ce0102433094e5f22f21102ec057841fcb81978ed1ea0fa8246 https://0x9000009807ed12c1f08bf4e81c6da3ba8e3fc3d953898ce0102433094e5f22f21102ec057841fcb81978ed1ea0fa8246@builder-relay-mainnet.blocknative.com?id=rocketpool} {0xb3ee7afcf27f1f1259ac1787876318c6584ee353097a50ed84f51a1f21a323b3736f271a895c7ce918c038e4265918be https://0xb3ee7afcf27f1f1259ac1787876318c6584ee353097a50ed84f51a1f21a323b3736f271a895c7ce918c038e4265918be@relay.edennetwork.io?id=rocketpool}]"
mev-boost_1      | time="2022-09-28T22:02:06Z" level=info msg="Checking relay" module=service relay="https://0xac6e77dfe25ecd6110b8e780608cce0dab71fdd5ebea22a16c0205200f2f8e2e3ad3b71d3499c54ad14d6c21b41a37ae@boost-relay.flashbots.net?id=rocketpool"
mev-boost_1      | time="2022-09-28T22:02:06Z" level=info msg="Checking relay" module=service relay="https://0xb0b07cd0abef743db4260b0ed50619cf6ad4d82064cb4fbec9d3ec530f7c5e6793d9f286c4e082c0244ffb9f2658fe88@bloxroute.regulated.blxrbdn.com?id=rocketpool"
mev-boost_1      | time="2022-09-28T22:02:07Z" level=info msg="Checking relay" module=service relay="https://0x9000009807ed12c1f08bf4e81c6da3ba8e3fc3d953898ce0102433094e5f22f21102ec057841fcb81978ed1ea0fa8246@builder-relay-mainnet.blocknative.com?id=rocketpool"
mev-boost_1      | time="2022-09-28T22:02:07Z" level=info msg="Checking relay" module=service relay="https://0xb3ee7afcf27f1f1259ac1787876318c6584ee353097a50ed84f51a1f21a323b3736f271a895c7ce918c038e4265918be@relay.edennetwork.io?id=rocketpool"
mev-boost_1      | time="2022-09-28T22:02:07Z" level=info msg="listening on 0.0.0.0:18550" module=cli
```

これは、正しく実行されていることを示しています。

すでにバリデーターを起動して実行している場合、数分ごとにログに次のようなメッセージが表示されます。

```
mev-boost_1      | time="2022-09-28T21:40:48Z" level=info msg="http: GET /eth/v1/builder/status 200" duration=0.147305645 method=GET module=service path=/eth/v1/builder/status status=200
mev-boost_1      | time="2022-09-28T21:40:48Z" level=info msg="http: POST /eth/v1/builder/validators 200" duration=0.052895118 method=POST module=service path=/eth/v1/builder/validators status=200
```

これは、Beacon nodeがそれに正しく接続し、バリデーターを登録できたことを示しており、ノードが現在MEV relayと積極的にやり取りし、block builderからブロックを受信する準備ができていることを示しています。

## 次のステップ

MEV-Boostが設定されたので、新しいminipoolを作成してEthereumネットワークでの検証を開始する準備が整いました。
このプロセスを説明する次のセクションをお読みください。
