import { Tab, Tabs } from "@rspress/core/theme";

# 既存のウォレットのインポート / 復元

ノードに使用したいウォレットが既にある場合、または以前にSmartnodeで作成したウォレットを復元している場合、このガイドがインポート / 復元プロセスを案内します。

以下のセクションから適切なオプションを選択してください。

## Smartnodeウォレットの復元

Smartnodeを使用してノードウォレットを生成し、新しいマシンで単に復元している場合、プロセスは非常に簡単です。
Smartnodeソフトウェアが既にインストールされていることを確認してから、インストール後に次のコマンドを実行するだけです。

```shell
rocketpool wallet recover
```

::: warning 注記
何らかの理由で、ウォレットを復元したいがノードのminipoolに関連付けられたvalidatorキーは復元_したくない_場合は、`-k`フラグを指定してリビルドプロセスをスキップできます。

```shell
rocketpool wallet recover -k
```

このフラグを指定しない場合、Smartnodeはminipoolのvalidatorキーを復元しようとします。ただし、Execution clientが同期を完了するまでは機能しないことに注意してください。
ログファイルを監視して、いつ完了するかを確認してください。完了したら、このステップを実行できます。
:::

まず、ウォレットを暗号化するために使用したいパスワードを尋ねられます。
その後、**24単語のニーモニック復元フレーズ**を尋ねられます。
慎重に入力してください。安全のため画面には表示されず、入力中にミスをしやすいため、時間をかけて行ってください。

完了すると、次のような出力が表示されるはずです。

```shell
$ rocketpool wallet recover

Please enter a password to secure your wallet with:

Please confirm your password:

Please enter your recovery mnemonic phrase:

Recovering node wallet...
The node wallet was successfully recovered.
Node account: <your wallet address>
No validator keys were found.
```

エラーが表示されなければ、ウォレットとvalidatorが復元されます。

完了したら、DockerおよびHybridモードユーザーは次のコマンドでValidator clientを再起動してください。

```shell
docker restart rocketpool_validator
```

**Nativeモード**ユーザーは、Validatorコンテナプロセスを再起動するだけで済みます。

これにより、VCが新しく復元されたすべてのvalidatorキーを確実に読み込むようになります。

## 既存のアドレスをノードウォレットとしてインポート

ノードに使用したいアドレスがあるが、Smartnodeで作成_していない_場合（例: MetaMaskやハードウェアウォレットで作成した場合）、このセクションに従ってください。

::: danger 警告
これを行うと、アドレスは**ホットウォレット**になります。
秘密鍵はノードマシンに保存されます。

ハードウェアウォレットなどのコールドウォレットであるアドレスをインポートする場合、**ハードウェアウォレットが提供する保護はもはや存在しなくなります！**

このウォレットを_他の暗号通貨活動にまったく_使用している場合、**ノードにインポートする前に、すべての資金を別のアドレス（例: 別のハードウェアウォレット）に移行する必要があります。このアドレスには、ノードのガス代に十分なETHのみを残してください（通常0.5 ETHで十分です）。**

ノードウォレットとしてアドレスをインポートする前に、[ノードのセキュリティ保護](./securing-your-node)ガイドの手順に従って、マシンを可能な限り保護してください。
:::

この機能はSmartnodeの**v1.4.3以降**でのみ利用可能です。
それより低いバージョンの場合は、まずアップグレードする必要があります。

これは複数ステップのプロセスなので、以下のセクションを注意深く従ってください。

### ステップ1: 外部で生成されたValidatorキーの追加

**インポートするアドレスに既存のminipoolが関連付けられていない場合は、このステップをスキップできます。**

アドレスが既にRocket Poolノードウォレットとして登録されており（**Allnodes**などのサービスを介して）、既にアクティブなminipoolがあり、それらをアドレスと一緒にSmartnodeスタックにインポートしたい場合、対応する各validatorの秘密キーストアファイルを提供する必要があります。
これらのファイルは独自に選択したパスワードで暗号化されるため、各ファイルのパスワードも必要になります。

これらのファイルをインポートするには、現在ノードを実行しているサービスから取得する必要があります。
一部のサービスプロバイダーは、リクエストに応じてこれらのファイルを取得できる場合があります。
Allnodesを使用している場合、初期セットアッププロセス中にこれらのファイルを取得できますが、**minipool作成時に保存していない限り、将来的に取得することはできません。**

インストールモードを選択し、以下の手順に従ってください。

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      まず、`rocketpool service start`でSmartnodeを起動したことを確認してください。
      これにより、validatorの暗号化されたキーストアファイルを保持するために使用できる特別なフォルダが作成されます。

      デフォルトでは、フォルダは`~/.rocketpool/data/custom-keys`にあります。
      インストールまたはデータディレクトリをカスタマイズしている場合は、適切に置き換えて`custom-keys`フォルダを見つけてください。

      ファイルエクスプローラーまたは`ls`コマンドで、このフォルダが存在することを確認してください。
      存在しない場合は、次のコマンドでフォルダを作成してください。

      ```shell
      mkdir ~/.rocketpool/data/custom-keys
      ```
    </Tab>
    <Tab label="Native Mode">
      Smartnodeの`data`フォルダ内に`custom-keys`というフォルダを作成してください（例: `/srv/rocketpool/data/custom-keys`）。
    </Tab>

  </Tabs>
</div>

次に、各validatorキーストアファイルをこのフォルダに配置します。
ファイルの名前は重要ではありませんが、[EIP-2335](https://eips.ethereum.org/EIPS/eip-2335#scrypt-test-vector)形式に準拠したJSONファイルである必要があります。

Smartnodeは、次のステップでここに配置したキーストアファイルをこのディレクトリで検索します。

::: warning 注記
インポートプロセスは、インポートするアドレスに登録されたminipoolに関連付けられたvalidatorキー_のみ_を検索します。
このプロセスを使用して、ソロステーキングvalidatorなどの他のvalidatorキーを、Smartnodeスタックが管理するValidator clientにインポートすることは**できません**。

これに興味がある場合は、[Reverse Hybridモード](./advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode)での実行に関するドキュメントを参照してください。
:::

### ステップ2（オプション）: アドレスのインポートのテスト

**実際にノードウォレットの秘密鍵を再生成したり、validatorキーをインポートしたりすることなく**、正しいニーモニックとパスワードがあることを確認するために復元プロセスをテストしたい場合は、次のコマンドで実行できます。

```shell
rocketpool wallet test-recovery -a 0x1234abcd...
```

`0x1234abcd...`は、インポートしたいアドレスで、`0x`プレフィックスで始まります。
**アドレスの秘密鍵をインポートするには、ニーモニックフレーズが必要です。**

::: tip ヒント
何らかの理由で、ウォレットを復元したいがminipoolのvalidatorキーは復元_したくない_場合は、`-k`フラグを指定してvalidatorキー復元プロセスをスキップできます。
例えば:

```shell
rocketpool wallet test-recovery -a 0x1234abcd... -k
```

:::

Smartnodeは、最も一般的な派生パス（例: Ledger Live、MyEtherWallet、Trezor、Smartnodeスタックで使用されるもの）とアドレスインデックスを自動的に検索し、提供したアドレスに対応する設定を見つけます。

::: tip ヒント
カスタム派生パスがある場合は、`-d`フラグを使用して指定してください。
例えば:

```shell
rocketpool wallet test-recovery -d "m/44'/60'/0'/%d"
```

異なるインデックスを使用するために反復できるパスの部分には`%d`を使用してください。

カスタムアドレスインデックスがある場合は、`-i`フラグを使用して指定してください。
例えば、アドレスが標準派生パスの6番目だった場合、次のように使用できます。

```shell
rocketpool wallet test-recovery -i 5
```

必要に応じて、`-d`と`-i`フラグの両方を同時に使用できます。
:::

まず、アドレスのニーモニックフレーズの入力を求められます。

```
Please enter the number of words in your mnemonic phrase (24 by default):
24

Enter Word Number 1 of your mnemonic:
```

慎重に入力すると、Smartnodeはすべての標準オプションを検索してアドレスを見つけます（`-d`および/または`-i`フラグを使用して明示的に指定した場合を除く）。

次に、ステップ1から秘密キーストアファイルをインポートした場合、各キーストアファイルのパスワードの入力を求められます。

```
It looks like you have some custom keystores for your minipool's validators.
You will be prompted for the passwords each one was encrypted with, so they can be loaded into the Validator Client that Rocket Pool manages for you.

Please enter the password that the keystore for <validator pubkey> was encrypted with:
```

これらは**pubkey**リストで整理され、**ファイル名ではありません**。
正しいパスワードを入力できるように、どのファイルがどのvalidator pubkeyに対応するかを把握しておいてください。

これを完了すると、テスト復元プロセスが進行し、成功したか失敗したかを報告します。

```
Searching for the derivation path and index for wallet 0x1234abcd...
NOTE: this may take several minutes depending on how large your wallet's index is.
The node wallet was successfully recovered.
Derivation path: m/44'/60'/0'/0/%d
Wallet index:    0
Node account:    0x1234abcd...
Validator keys:
<validator pubkey>
```

上記はテスト復元の成功を示しています。

### ステップ3: アドレスのインポート

::: danger 警告
アドレスが自分自身のセルフホスティングSmartnodeで管理_されていない_Rocket Poolノード（例: **Allnodes**などの外部サービスでホストされている）の場合、このインポートプロセスを開始する**前に**、ノードを実行しているサービスと調整し、自分自身のセルフホスティングシステムに移行したいことを通知することが**重要**です。

ノードの検証を停止し、**決して再開しない**ことを**確認する必要があり**、[https://beaconcha.in](https://beaconcha.in)などのBlockchainエクスプローラーを使用して、validatorがもはやアテステーションしていないことを手動で確認する必要があります。
安全に移行できるように、各validatorが**少なくとも2回のアテステーションを逃した**ことを確認する必要があります。
そうしないと、両方が同時にアテステーションし、**minipoolがスラッシュされます！**

Smartnodeは、インポートプロセスを続行する前に、これを実行したことを確認するよう要求します。
:::

テスト復元が成功した場合、またはスキップした場合、次にウォレットをインポートし、関連するすべてのキーファイルを再生成します。
プロセスは上記とまったく同じですが、`test-recovery`コマンドの代わりに`recover`コマンドを使用します。

```shell
rocketpool wallet recover -a 0x1234abcd...
```

このコマンドを実行すると、まず、インポートされたノードウォレットを暗号化するためのパスワードの入力を求められます。

```
Please enter a password to secure your wallet with:

Please confirm your password:
```

その後、ニーモニックとカスタムvalidatorキーストアのパスワードプロンプトが以前と同じように進みます。

これらすべての情報を入力すると、Smartnodeはアドレスと（無効化されていなければ）minipoolのカスタムvalidatorキーを復元します。

```
Searching for the derivation path and index for wallet 0x1234abcd...
NOTE: this may take several minutes depending on how large your wallet's index is.
The node wallet was successfully recovered.
Derivation path: m/44'/60'/0'/0/%d
Wallet index:    0
Node account:    0x1234abcd...
Validator keys:
<validator pubkey>
```

アドレスの秘密鍵は`data/wallet`ファイル（例: `~/.rocketpool/data/wallet`）に保存され、そのパスワードは`data/password`ファイル（例: `~/.rocketpool/data/password`）に保存されます。

各validatorの秘密鍵は、SmartnodeがサポートするConsensus clientごとの`data/validators`フォルダに保存されます。

::: danger 注記
この方法でアドレスをインポートすると、validatorキーはノードウォレットから**派生されていない**ため、通常のノードウォレットのように単に`rocketpool wallet recover`を実行して後で復元することは**できません**。

このウォレットを再び復元またはインポートする必要がある場合は、この同じプロセスに従う必要があります。つまり、**これらのvalidator秘密キーストアとそのパスワードを安全な場所にバックアップしておく必要があります。**

それらを紛失した場合、**これらのvalidatorキーを復元できなくなります！**
:::

### ステップ4: クリーンアップ

この時点で、`data/custom-keys`ディレクトリ内のすべての秘密キーストアファイルを削除できます。
Smartnodeは既にそれらをインポートし、ランダム化されたパスワードを割り当てているため、これらのキーストアファイルは不要になりました。

最後に、`data`ディレクトリ（例: `~/.rocketpool/data/custom-key-passwords`）に`custom-key-passwords`という名前のファイルが**存在しない**ことを確認してください。
Smartnodeは復元プロセス中にのみこの一時ファイルを作成し、復元プロセスが成功したかどうかに関係なく自動的に削除します。何らかの理由で削除に失敗した場合は、コンソール出力で警告が表示されます。
ただし、慎重になりすぎても問題はありません。

## 次のステップ

ノードウォレットをインポートまたは復元したら、[コマンドラインインターフェースの紹介](./cli-intro)ガイドの次のステップに従ってください。
