import { Tab, Tabs } from "@rspress/core/theme";

# Execution Clientのプルーニング

::: tip 注記
これは`geth`と`nethermind`のユーザー向けです。
Besuはプルーニングする必要は_ありません_。
:::

主要なExecution clientとして`geth`または`nethermind`を使用している場合、ノードの空きディスク容量が時間の経過とともにゆっくりと減少していくことに気付くでしょう。
Execution clientはこれに最も大きく寄与します。`rocketpool service config`でキャッシュに割り当てたRAMの量に応じて、1日あたり数ギガバイトの速度で増加することがあります。

これに対処するため、Execution clientは**プルーニング**と呼ばれる特別な機能を提供しており、安全にデータベースをスキャンしてクリーンアップし、空き容量を回復できます。
GethまたはNethermindを使用するすべてのNode Operatorは、いずれプルーニングを行う必要があります。

2 TBのSSDを使用している場合、通常、プルーニングの間隔は数ヶ月になります。
1 TBのSSDユーザーの場合、より頻繁にプルーニングする必要があります。

[Grafanaダッシュボード](./grafana)を有効にしている場合、ノードの使用済みディスク容量が80%を超えたら、Execution clientのプルーニングを検討し始める良い目安になります。

プルーニングの時期が来たと判断したら、Smartnodeはリクエストに応じてプルーニングを実行する機能を備えています。
以下を読んで、仕組みと予想される動作を学んでください。

::: warning 注記
Execution clientのプルーニングはDockerモードでのみ可能です。

Hybridモードの外部クライアントやNativeモードなど、独自のExecution clientを使用している場合、Smartnodeを使用してExecution clientをプルーニングすることはできません。
手動で行う必要があります。
Execution clientのドキュメントを参照して、プルーニング方法を学んでください。
:::

## 前提条件

以下のタブから使用しているクライアントを選択してください。

<div className="p-3">
  <Tabs>
    <Tab label="Geth">
      Gethをプルーニングするということは、主要なExecution clientをオフラインにして、自身をクリーンアップさせることを意味します。
      これが発生すると、Smartnode（およびConsensus client）は正常に機能するためにETH1チェーンにアクセスする他の方法が必要になります。

      これを提供する最も簡単な方法は**fallbackノード**を使用することです。
      `rocketpool service config`を使用して既に[fallbackノードを設定](./fallback)している場合、Gethコンテナがメンテナンスのためにダウンすると、Smartnodeは自動的にそれに切り替わります。
      また、Consensus clientにもfallbackを使用するよう通知します。

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">警告</p>
        fallbackノードが設定されていない場合、プルーニングプロセス中にノードは検証を停止します。
        完了してネットワークと再同期するまで、すべてのアテステーションとブロック提案を逃します。
        **この間、検証の失敗によりETHを失います！**
      </p>

      これを念頭に置いて、Gethを正常にプルーニングするには以下の2つの条件が必要です。

      - 動作するfallbackノードが設定されていること
      - SSDに少なくとも**50 GB**の空き容量が残っていること
    </Tab>
    <Tab label="Nethermind">
      Nethermindはプルーニング中もオンラインのままでいることができるため、アテステーションを続けるためにfallbackノードは必要ありません。
      ただし、プルーニングは**非常にリソース集約的なタスク**であり、アテステーションのインクルージョン距離の増加や、プルーニング中のアテステーション失敗が増える可能性があることに注意してください。

      Nethermindには特別な前提条件は必要ありません。いつでもプルーニングできます。
    </Tab>

  </Tabs>
</div>

## プルーニングの開始

以下のタブから使用しているクライアントを選択してください。

<div className="p-3">
  <Tabs>
    <Tab label="Geth">
      Gethをプルーニングする場合は、このコマンドを実行するだけです。

      ```shell
      rocketpool service prune-eth1
      ```

      fallback clientペアが有効になっていない場合、次の警告が表示されます。

      ```
      This will shut down your main execution client and prune its database, freeing up disk space.
      Once pruning is complete, your execution client will restart automatically.

      You do not have a fallback execution client configured.
      Your node will no longer be able to perform any validation duties (attesting or proposing blocks) until Geth is done pruning and has synced again.
      Please configure a fallback client with `rocketpool service config` before running this.
      Are you sure you want to prune your main execution client? [y/n]
      ```

      有効になっている場合は、代わりに次のプロンプトが表示されます。

      ```
      This will shut down your main execution client and prune its database, freeing up disk space.
      Once pruning is complete, your execution client will restart automatically.

      You have fallback clients enabled. Rocket Pool (and your consensus client) will use that while the main client is pruning.
      Are you sure you want to prune your main execution client? [y/n]
      ```

      承認すると、Smartnodeが準備を進める際にいくつかの詳細が表示され、最後に成功メッセージが表示されるはずです。

      ```
      Are you sure you want to prune your main ETH1 client? [y/n]
      y

      Your disk has 303 GiB free, which is enough to prune.
      Stopping rocketpool_eth1...
      Provisioning pruning on volume rocketpool_eth1clientdata...
      Restarting rocketpool_eth1...

      Done! Your main ETH1 client is now pruning. You can follow its progress with `rocketpool service logs eth1`.
      Once it's done, it will restart automatically and resume normal operation.
      NOTE: While pruning, you **cannot** interrupt the client (e.g. by restarting) or you risk corrupting the database!
      You must let it run to completion!
      ```

      これでGethがプルーニングを開始し、設定完了です。
      進捗状況は次のコマンドで確認できます。

      ```shell
      rocketpool service logs eth1
      ```

      プルーニングが完了すると自動的に再起動し、Smartnodeはfallbackの代わりに再びGethを使用するようになります。
    </Tab>
    <Tab label="Nethermind">
      Nethermindをプルーニングする場合は、このコマンドを実行するだけです。

      ```shell
      rocketpool service prune-eth1
      ```

      次のプロンプトが表示されます。

      ```
      This will shut down your main execution client and prune its database, freeing up disk space.
      Once pruning is complete, your execution client will restart automatically.

      Are you sure you want to prune your main execution client? [y/n]
      ```

      承認すると、次のようなメッセージがいくつか表示されます。

      ```
      Your disk has 790 GiB free, which is enough to prune.
      Stopping rocketpool_eth1...
      Provisioning pruning on volume rocketpool_eth1clientdata...
      Restarting rocketpool_eth1...
      Error requesting prune: AggregateException - One or more errors occurred. (Connection refused (127.0.0.1:7434))
      Trying again in 3 seconds... (1/100)
      ...
      Trying again in 3 seconds... (10/100)
      Success: Pruning is now "Starting"

      Done! Your main execution client is now pruning. You can follow its progress with `rocketpool service logs eth1`.
      Once it's done, it will restart automatically and resume normal operation.
      NOTE: While pruning, you **cannot** interrupt the client (e.g. by restarting) or you risk corrupting the database!
      You must let it run to completion!
      ```

      これでNethermindがプルーニングを開始し、設定完了です。
      進捗状況は次のコマンドで確認できます。

      ```shell
      rocketpool service logs eth1
      ```

      プルーニングが完了すると自動的に再起動します。
    </Tab>

  </Tabs>
</div>
