import tui_select_ec from "./images/tui-select-ec.png";
import tui_confirm_ec from "./images/tui-confirm-ec.png";
import tui_select_cc from "./images/tui-select-cc.png";
import tui_checkpoint_sync from "./images/tui-checkpoint-sync.png";
import tui_confirm_cc from "./images/tui-confirm-cc.png";

# Executionクライアントまたはコンセンサスクライアントの変更

通常の状況では、Rocket Poolノードを最初に作成する際にExecutionクライアントとコンセンサスクライアントを選択し、ノードの稼働期間中はそのまま使い続けることになるでしょう。
しかし、クライアントの選択を変更したい状況がいくつかあります。
以下にいくつかの例を示します。

- 使用中のクライアントがExecutionチェーンまたはBeaconチェーンで[スーパーマジョリティ](https://clientdiversity.org/)シェアを獲得し、ネットワーク全体の健全性のために変更したい場合
- バグによってクライアントが正常に機能しなくなり、検証業務を再開するために早急にオンラインに戻る必要がある場合
- 別のクライアントが提供する新機能を試したい場合
- 別のクライアントがノードのハードウェアにより適している場合(例: 一部のクライアントは他のクライアントよりもARMシステムで優れています)

幸いなことに、Smartnodeスタックではクライアントの変更が非常に簡単です。
必要なのは、Configuration TUIでいくつかの変更を行うことと、クライアントを変更する前に既存のクライアントデータをバックアップするためのオプションのコマンドだけです。

## Executionクライアントの変更

Executionクライアントを変更する前に、以下の点に注意してください。

- チェーンデータはクライアント間で**共有されません**。新しいクライアントはMainnetチェーンデータを再同期する必要があり、これには時間がかかる場合があります(ただし、各クライアントはスナップ同期をサポートしており、Smartnodeはこれを使用して再同期を高速化します)。
- デフォルトでは、Smartnodeは古いクライアントのチェーンデータをドライブに残すため、古いExecutionクライアントに戻して中断したところから再開できます。Executionクライアントは数百ギガバイトを使用する可能性があるため、クライアントを変更する前に**別の場所にエクスポート**してスペースを解放することをお勧めします。これを行う手順は以下に記載しています。
- 新しいクライアントが再同期している間、Smartnode CLIの機能のほとんどはExecutionクライアントに依存しているため、オフラインになります。**これを行う前に、Smartnodeのダウンタイムを軽減するためにフォールバックExecutionクライアントを用意しておく必要があります。**

### (オプション) Executionクライアントのデータベースをエクスポートする

プロセスの最初のステップはオプションです。必要に応じて、現在のExecutionクライアントの既存のチェーンデータをエクスポートできます。
これにより、新しいExecutionクライアント用のノードの貴重なディスクスペースを解放でき、古いクライアントに戻して中断したところから再開したい場合に備えて、古いチェーンデータを保持できます。

詳細については、[ノードのバックアップ](./backups##backing-up-your-execution-chain-data)ガイドを参照してください。

### 選択したExecutionクライアントを変更する

選択したクライアントを変更するには、`rocketpool service config`を実行して設定UIに入ります。
`Execution Client (ETH1)`セクションに移動し、`Execution Client`ドロップダウンを選択します。

<img src={tui_select_ec} width="100%" height="auto" />

`Enter`でドロップダウンを開き、矢印キーを使用して選択したいクライアントに移動し、もう一度`Enter`を押して選択を確定します。

各クライアントには独自の設定があるため、別のクライアントを選択すると、この画面に追加の設定が表示される場合があります。
それらを自由に探索して、どのように影響するかを確認してください。

選択に満足したら、`Esc`を押してメインメニューに戻り、`Tab`を押して`Review Changes and Save`ボタンをハイライトします。
レビュー画面が表示され、クライアント選択の変更が表示されます。

<img src={tui_confirm_ec} width="100%" height="auto" />

`Enter`を押して変更を承認すれば完了です。
新しいExecutionクライアントはすぐに同期を開始します。
通常通り、`rocketpool service logs eth1`で確認できます。
**エラーがなく、正しく動作することを確認するために、これを行うことをお勧めします。**

::: danger 注意
Executionレイヤーとコンセンサスレイヤーがマージされたため、Executionクライアントを停止すると、Executionクライアントが再同期を完了するまでコンセンサスクライアント_も_停止します。
これは、ノードが**アテステーションとブロック提案を停止し、ETHを獲得する代わりにリークする**ことを意味します。

これを回避し、Executionクライアントの再同期中も検証を続けるには、**[フォールバックノード](./fallback)を設定してください**。
:::

### (推奨) 古いチェーンデータを削除する

これは必須のステップではありませんが、新しいクライアントに切り替えた後、古いクライアントのチェーンデータを削除してディスクスペースを解放することを**強くお勧めします**。

これを行うには、次のコマンドを実行するだけです。

```shell
rocketpool service resync-eth1
```

これにより、すべてのExecutionクライアントデータが削除され、最初からやり直されます。

::: tip ヒント
新しいExecutionクライアントを選択したばかりなので、これによる影響はありません。基本的に、古いチェーンデータを削除するだけです。
新しいクライアントの不必要な進行の損失を防ぐために、クライアントを切り替えた後できるだけ早くこれを行う必要があります。
:::

## コンセンサスクライアントの変更

[チェックポイント同期](./config-docker#beacon-chain-checkpoint-syncing)のおかげで、コンセンサスクライアントの変更はExecutionクライアントよりもさらに簡単です。
この機能により、新しいコンセンサスクライアントをネットワークと即座に同期できるため、古いチェーンデータを保持する必要はありません。

まず、`rocketpool service config` UIを使用して`Consensus Client (ETH2)`セクションに移動します。
次に、`Consensus Client`ドロップダウンを選択します。

<img src={tui_select_cc} width="100%" height="auto" />

`Enter`でドロップダウンを開き、矢印キーを使用して選択したいクライアントに移動し、もう一度`Enter`を押して選択を確定します。

各クライアントには独自の設定があるため、別のクライアントを選択すると、この画面に追加の設定が表示される場合があります。
それらを自由に探索して、どのように影響するかを確認してください。

次に、チェックポイント同期プロバイダーを使用していることを確認します。

<img src={tui_checkpoint_sync} width="100%" height="auto" />

チェックポイント同期プロバイダーが設定されていない場合、[こちらの手順を使用して無料で簡単に設定できます](./config-docker#beacon-chain-checkpoint-syncing)。

選択に満足したら、`Esc`を押してメインメニューに戻り、`Tab`を押して`Review Changes and Save`ボタンをハイライトします。
レビュー画面が表示され、クライアント選択の変更が表示されます。

<img src={tui_confirm_cc} width="100%" height="auto" />

`Enter`を押して変更を承認すれば完了です。
新しいコンセンサスクライアントはすぐに同期を開始します。
通常通り、`rocketpool service logs eth2`で確認できます。
**エラーがなく、正しく動作することを確認するために、これを行うことをお勧めします。**
