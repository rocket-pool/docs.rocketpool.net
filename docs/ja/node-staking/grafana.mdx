import { Tab, Tabs } from "@rspress/core/theme";

# Grafanaダッシュボードの設定

ノードが稼働したら、すべてが正常に機能しているか(そしてどのような収益を生み出しているか)を一目で監視できる便利な方法が欲しくなるでしょう。

これを実現するツールは数多く存在します。
最も人気のあるツールの1つが[Grafana](https://grafana.com/)です。ブラウザでアクセスできる使いやすい汎用ダッシュボードシステムです。

Rocket PoolはGrafanaとその依存関係をすぐに使えるようにサポートしており、各Consensusクライアント用に事前構築されたダッシュボードも付属しています。
例えば、Hoodiテストネットワークのダッシュボードのスナップショットは次のようになります。

![](./images/grafana-1.3.jpg)

標準ダッシュボードには、次の情報が便利な形式で含まれています。

- **左上:** マシンの健全性とパフォーマンスに関する重要な統計情報、および保留中のシステムアップデート
- **右上:** Beacon Chain上のvalidatorのアクティビティとパフォーマンス、ExecutionおよびConsensusクライアントの統計情報
- **左下:** 参考のためのRocket Poolネットワーク全体の詳細
- **右下:** ETHとRPLの両方のstaking報酬の詳細

このガイドでは、Rocket Poolのメトリクスシステムを有効にして、このダッシュボードを使用する方法(または独自のダッシュボードを構築する方法)を説明します。

## Rocket Pool Metricsスタックの概要

Smartnode設定プロセス中にメトリクスを有効にすることを選択すると、ノードに次のプロセスが追加されます。

- [Prometheus](https://prometheus.io/) - 上記のすべてのメトリクス(およびさらに多くのメトリクス)を収集、保存、レポートするデータ収集・保存・レポートシステムで、時間経過とともに確認できるように保存します
- Prometheus [Node Exporter](https://github.com/prometheus/node_exporter) - マシンの健全性に関する情報(CPU使用率、RAM使用率、空きディスク容量とスワップ領域など)を収集し、Prometheusに報告するサービス
- Grafana、ノードでホストされている便利なウェブサイトを通じてPrometheusのデータを公開するツール
- 利用可能なOSアップデートをPrometheusに報告するオプションのカスタムスクリプトセット。システムにパッチが必要かどうかを確認できます

デフォルト設定では、Smartnodeの他のDockerコンテナと並んで存在するこれらすべてのサービスを含むDockerコンテナが作成されます。
Grafana用にノードマシンでポートが開かれるため、ローカルネットワーク上のブラウザを使用して任意のマシンからダッシュボードにアクセスできます。

## Metricsサーバーの有効化

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Dockerモードでメトリクスを有効にするのが最も簡単です。

      まず、Smartnode設定コマンドを再度実行します。

      ```shell
      rocketpool service config
      ```

      `Monitoring / Metrics`セクションに移動し、`Enable Metrics`チェックボックスをオンにします。

      ポート設定を細かく調整したい場合は、ここで行うことができます。
      これらのポートはすべて、Grafanaポートを除いてDockerの内部ネットワークに制限されていることに注意してください。Grafanaポートはマシンで開かれます(デスクトップや携帯電話などの他のマシンからブラウザ経由でアクセスできるようにするため)。デフォルトのポートが既存のものと競合する場合は変更することをお勧めします。

      保存して終了すると、smartnodeがPrometheus、Node Exporter、GrafanaのDockerコンテナを起動します。

      ConsensusクライアントとValidatorクライアントも変更され、独自のメトリクスをPrometheusに公開するようになります。

      OSとRocket Poolアップデートトラッカーは、最大限の柔軟性のために**デフォルトではインストールされません**が、プロセスは簡単です。
      ダッシュボードにシステムで利用可能なアップデート数を表示したい場合は、次のコマンドでインストールできます。

      ```shell
      rocketpool service install-update-tracker
      ```

      内部的には、これによりOSのパッケージマネージャーにフックするサービスがインストールされ、定期的にアップデートをチェックし、その情報をPrometheusに送信します。
      このサービスはOSごとに異なりますが、次のOSで動作することが確認されています。

      - Ubuntu 20.04+
      - Debian 9 and 10
      - CentOS 7 and 8
      - Fedora 34


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        サービスの自動有効化はSELinuxと互換性がありません。
        システムでSELinuxがデフォルトで有効になっている場合(CentOSやFedoraの場合)、インストールコマンドは_ほとんどの作業を完了_しますが、最後に手動でプロセスを完了する方法の指示も提供されます。
      </p>


      このチェック中に、インストールされているRocket Pool Smartnodeバージョンと最新リリースも比較し、新しいリリースが利用可能な場合は通知します。

      アップデートトラッカーを有効にした場合、最後のステップは次のコマンドでNode Exporterを再起動することです。

      ```shell
      docker restart rocketpool_exporter
      ```

      その後、すべての設定が完了します。
    </Tab>
    <Tab label="Hybrid">
      HybridモードはDockerモードと同様に機能します。唯一の違いは、ExecutionおよびConsensusクライアントサービス定義に、メトリクスを有効にするための適切なコマンドラインフラグを手動で追加する必要があることです。

      まず、Executionクライアントを更新します。
      Executionクライアントのインストール時に作成した`systemd`ユニットファイルを開き、実行しているクライアントに基づいて正しいフラグがあることを確認します。

      <div className="p-3">
        <Tabs>
          <Tab label="Geth">
            ```
            --metrics --metrics.addr 0.0.0.0 --metrics.port 9105
            ```
          </Tab>
          <Tab label="Nethermind">
            ```
            --Metrics.Enabled true --Metrics.ExposePort 9105
            ```
          </Tab>
          <Tab label="Besu">
            ```
            --metrics-enabled --metrics-host=0.0.0.0 --metrics-port=9105
            ```
          </Tab>
        </Tabs>
      </div>

      次に、Consensusクライアントを更新します。
      Consensusクライアントのインストール時に作成した`systemd`ユニットファイルを開き、実行しているクライアントに基づいて正しいフラグがあることを確認します。

      <div className="p-3">
        <Tabs>
          <Tab label="Lighthouse">
            ```
            --metrics --metrics-address 0.0.0.0 --metrics-port 9100 --validator-monitor-auto
            ```
          </Tab>
          <Tab label="Lodestar">
            ```
            --metrics --metrics.address 0.0.0.0 --metrics.port 9100
            ```
          </Tab>
          <Tab label="Nimbus">
            ```
            --metrics --metrics-address=0.0.0.0 --metrics-port=9100
            ```
          </Tab>
          <Tab label="Prysm">
            ```
            --monitoring-host 0.0.0.0 --monitoring-port 9100
            ```

            `--disable-monitoring`フラグがある場合は削除してください。
          </Tab>
          <Tab label="Teku">
            ```
            --metrics-enabled=true --metrics-interface=0.0.0.0 --metrics-port=9100 --metrics-host-allowlist=*
            ```
          </Tab>

        </Tabs>
      </div>

      これらのフラグが既に設定されていて、ソロvalidator監視用に異なるポートを使用している場合は、そのままにして、使用しているポートをメモしてください。

      次に、上にスクロールしてこのセクションの`Docker`タブの指示に従ってプロセスを完了します。`rocketpool service config`を実行する際に、使用しているカスタムポートで記載されているポートを置き換える必要があることに注意してください。

    </Tab>
    <Tab label="Native">
      GrafanaとPrometheusのNativeインストールは、上級ユーザーのみにお勧めします。`systemd`、ファイル権限、ユーザー、ネットワーク管理などのLinux管理スキルが必要です。

      まず、ExecutionクライアントとConsensusクライアントでメトリクスが有効になっていることを確認します。詳細については、「Hybrid」タブを参照してください。

      次に、[公式ダウンロードページ](https://prometheus.io/download/)でprometheusとnode_exporterの事前ビルドパッケージを確認します。
      プラットフォームに適したアーキテクチャ(amd64またはarm64)のパッケージを選択してください。
      最新のLTS(Long Time Support)バージョンのPrometheusをお勧めします。

      例えば、`wget`を使用してLinux amd64用のprometheus v2.45.3 LTSとnode_exporter v1.7.0をダウンロードするには、次のようにします。

      ```shell
      wget https://github.com/prometheus/prometheus/releases/download/v2.45.3/prometheus-2.45.3.linux-amd64.tar.gz
      wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
      wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
      ```

      ダウンロードしたアーカイブからprometheusとnode_exporterの実行ファイルを抽出します。

      ```shell
      sudo tar -zxvf prometheus-2.45.3.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/prometheus' --strip-components=1
      sudo tar -zxvf node_exporter-1.7.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/node_exporter' --strip-components=1
      sudo tar -zxvf alertmanager-0.26.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/alertmanager' --strip-components=1
      ```

      prometheusとalertmanagerの設定用ディレクトリを作成します。

      ```shell
      sudo mkdir /etc/prometheus
      sudo mkdir /etc/alertmanager
      sudo mkdir /var/lib/prometheus
      sudo mkdir /var/lib/alertmanager
      ```

      次の内容で`/etc/prometheus/prometheus.yml`ファイルを作成します。

      ```yaml
      global:
      scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
      scrape_timeout: 12s # Timeout must be shorter than the interval
      evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.

      scrape_configs:
      - job_name: "prometheus"
      static_configs:
      - targets: ["localhost:9091"]

      - job_name: "node"
      static_configs:
      - targets: ["localhost:9103"]
      #     - targets: ['localhost:9103', 'node_hostname:9103']
      - job_name: "eth1"
      static_configs:
      - targets: ["localhost:9105"]
      # Uncomment the line below if you are using geth as Execution Client
      #metrics_path: /debug/metrics/prometheus

      - job_name: "eth2"
      static_configs:
      - targets: ["localhost:9100"]

      - job_name: "validator"
      static_configs:
      - targets: ["validator:9101"]

      - job_name: "rocketpool"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["node:9102"]

      - job_name: "watchtower"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["watchtower:9104"]

      alerting:
      alertmanagers:
      - static_configs:
      - targets: ["localhost:9093"]
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        必要に応じて、ExecutionクライアントとConsensusクライアントのポート番号を変更してください。

        prometheus変更を実行しているホストとは異なるホストでノードを実行している場合があります。その場合は、
        rocketpoolノードホストにnode_exporterをインストールし、監視するすべてのマシンを含めるように`node`ジョブの`targets`を更新してください。
        Executionクライアントがgethの場合は、`metrics_path`も調整してください。gethはメトリクス用に非標準のエンドポイントを公開します。
      </p>

      次の内容で`/etc/alertmanager/alertmanager.yml`を作成します。

      ```yaml
      global:
      # ResolveTimeout is the default value used by alertmanager if the alert does
      # not include EndsAt, after this time passes it can declare the alert as resolved if it has not been updated.
      # This has no impact on alerts from Prometheus, as they always include EndsAt.
      # default = 5m
      resolve_timeout: 5m

      route:
      # The labels by which incoming alerts are grouped together.
      group_by: ["alertname"]
      # How long to initially wait to send a notification for a group
      # of alerts. Allows to wait for an inhibiting alert to arrive or collect
      # more initial alerts for the same group.
      group_wait: 30s
      # How long to wait before sending a notification about new alerts that
      # are added to a group of alerts for which an initial notification has
      # already been sent. (Usually ~5m or more.)
      group_interval: 5m
      # How long to wait before sending a notification again if it has already been sent successfully for an alert.
      repeat_interval: 4h
      routes:
      # severity=info: Don't send the follow-up resolved notification.
      - match:
      severity: info
      continue: false
      # The notification destination
      receiver: "node_operator_no_resolved"
      # all other alerts get sent notifications for the initial firing _and_ resolved notifications.
      - receiver: "node_operator_default"
      #match: We want this to match all alerts (severity=info is first though so it will stop)

      # The notification destination
      receiver: "node_operator_default"

      receivers:
      - name: "node_operator_default"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"

      - name: "node_operator_no_resolved"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"
      send_resolved: false

      inhibit_rules:
      # Inhibit rules mute a new alert (target) that matches an existing alert (source).
      - source_match:
      # if the existing alert (source) is severity=critical
      severity: "critical"
      target_match:
      # and the new alert (target) is severity=warning
      severity: "warning"
      # and the alertname, job, and instance labels have the same value
      equal: ["alertname", "job", "instance"]
      ```

      prometheusとalertmanager用のシステムユーザーを作成します。

      ```shell
      sudo useradd -r -s /sbin/nologin prometheus
      sudo useradd -r -s /sbin/nologin alertmanager
      ```

      prometheusとalertmanagerファイルの所有権と権限を変更します。

      ```shell
      sudo chown prometheus:prometheus /usr/local/bin/prometheus
      sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
      sudo chown prometheus:prometheus /usr/local/bin/node_exporter
      sudo chown -R prometheus:prometheus /etc/prometheus
      sudo chown -R alertmanager:alertmanager /etc/alertmanager
      sudo chown -R prometheus:prometheus /var/lib/prometheus
      sudo chown -R alertmanager:alertmanager /var/lib/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/prometheus
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/node_exporter
      ```

      node_exporterサービス設定用に`/lib/systemd/system/node-exporter.service`ファイルを作成します。

      ```
      [Unit]
      Description=Node metrics exporter for Prometheus
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=node-exporter
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9103

      [Install]
      WantedBy=multi-user.target
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        node_exporterが実行されているポートを変更したい場合は、`ExecStart`パラメータのコマンドを変更してください。デフォルトポートは9100です。
      </p>

      prometheusサービス設定用に`/lib/systemd/system/prometheus.service`ファイルを作成します。

      ```
      [Unit]
      Description=Prometheus instance
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=prometheus
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --web.listen-address=:9091

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        prometheusが実行されているポートを変更したい場合は、`ExecStart`パラメータのコマンドを変更してください。デフォルトポートは9090です。
      </p>

      alertmanagerサービス設定用に`/lib/systemd/system/alertmanager.service`ファイルを作成します。

      ```
      [Unit]
      Description=Alertmanager instance
      Documentation=https://prometheus.io/docs/alerting/latest/alertmanager/
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=alertmanager
      Group=alertmanager
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/alertmanager
      RuntimeDirectory=alertmanager
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/alertmanager --config.file /etc/alertmanager/alertmanager.yml --web.listen-address=:9093

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        alertmanagerが実行されているポートを変更したい場合は、`ExecStart`パラメータのコマンドを変更してください。デフォルトポートは9093です。
      </p>

      新しいサービスについて`systemd`に通知します。

      ```shell
      sudo systemctl daemon-reload
      ```

      node-exporterサービスを有効にして起動します。

      ```shell
      sudo systemctl enable node-exporter
      sudo systemctl start node-exporter
      ```

      サービスのステータスを確認して、実行中であることを確認します。

      ```shell
      sudo systemctl status node-exporter
      ```

      prometheusサービスを有効にして起動します。

      ```shell
      sudo systemctl enable prometheus
      sudo systemctl start prometheus
      ```

      alertmanagerサービスを有効にして起動します。

      ```shell
      sudo systemctl enable alertmanager
      sudo systemctl start alertmanager
      ```

      サービスのステータスを確認して、実行中であることを確認します。

      ```shell
      sudo systemctl status prometheus
      sudo systemctl status alertmanager
      ```

      Grafana用のパッケージリポジトリをセットアップします。

      ```shell
      sudo apt-get update
      sudo apt-get install -y apt-transport-https software-properties-common
      sudo mkdir -p /etc/apt/keyrings/
      wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
      echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
      ```

      Grafanaをインストールします。

      ```shell
      sudo apt-get update
      sudo apt-get install grafana
      ```

      `/etc/grafana/grafana.ini`の設定を確認します。このドキュメントの他のセクションに合わせて、`http_port`を3100に変更します。

      GrafanaでPrometheusからメトリクスを視覚化するためのデータソースを設定します。`/etc/grafana/provisioning/datasources/prometheus.yml`ファイルを作成します。

      ```yaml
      apiVersion: 1

      deleteDatasources:
      - name: Prometheus
      orgId: 1

      datasources:
      - name: Prometheus
      type: prometheus
      access: proxy
      orgId: 1
      url: http://localhost:9091
      basicAuth: false
      isDefault: true
      version: 1
      editable: true
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        Prometheusのリスニングポートを変更した場合は、`url`を編集してください。
      </p>

      Grafana用のサービスを有効にして起動します。

      ```shell
      sudo systemctl daemon-reload
      sudo systemctl enable grafana-server
      sudo systemctl start grafana-server
      ```

      Grafanaが起動して実行中であることを確認します。

      ```shell
      sudo systemctl status grafana-server
      ```

      これで完了です。
    </Tab>

  </Tabs>
</div>

## 監視用の接続を許可するようにファイアウォールを設定する

::: warning 注意
[Securing your Node](./securing-your-node)セクションで参照されているようにUFWを有効にしている場合、PrometheusとExecution/Consensusクライアント間のローカル接続を許可するために、いくつかのポートを開く必要があります。以下の手順に従ってください。
:::

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      次のコマンドを実行し、必要に応じてポートを置き換えます。

      ```shell
      RP_NET=$(docker inspect rocketpool_net | grep -Po "(?<=\"Subnet\": \")[0-9./]+")
      sudo ufw allow from $RP_NET to any port 9105 comment "Allow Prometheus access to Execution Client"
      sudo ufw allow from $RP_NET to any port 9100 comment "Allow Prometheus access to Consensus Client"
      sudo ufw allow from $RP_NET to any port 9103 comment "Allow Prometheus access to Exporter"
      ```
    </Tab>
    <Tab label="Native">
      RocketPoolノードとPrometheusが異なるホストにある場合、PrometheusホストIPからノード監視ポートへの着信トラフィックを許可するように、ノードホストでファイアウォールを設定する必要があります。
      また、PrometheusホストからRocketPoolノードホストへの発信トラフィックを許可するように、PrometheusマシンでUFWを設定する必要があります。

      ノードホストIPが`192.168.1.5`でPrometheusホストIPが`192.168.1.6`の場合、ノードのUFWルールは次のようになります。

      ```shell
      sudo ufw allow from 192.168.1.6 to any port 9100:9105 proto tcp comment 'Allow Prometheus host to scrape metrics of this host'
      ```

      Prometheusホストの場合:

      ```shell
      sudo ufw allow out from any to 192.168.1.5 port 9100:9105 proto tcp comment 'Allow this host to scrape node metrics'
      ```

      Grafanaリスニングポートが3100であると仮定して、読み進めてネットワークでGrafanaを公開する方法を確認してください。
    </Tab>

  </Tabs>
</div>

その後、ファイアウォールを開いて、外部デバイスがGrafanaダッシュボードにアクセスできるようにすることができます。

<div className="p-3">
  <Tabs>
    <Tab label="Network">
      ローカルネットワーク内の任意のマシンからGrafanaにアクセスできるようにし、他のすべての場所からのアクセスを拒否する場合は、これを使用します。
      これが最も一般的な使用例です。

      まず、ローカルネットワークが`192.168.1.xxx`構造を使用しているかどうかを確認してください。
      異なるアドレス構造(例: `192.168.99.xxx`)を使用している場合は、ローカルネットワークの構成に合わせて以下のコマンドを変更する必要がある場合があります。

      ```shell
      # This assumes your local IP structure is 192.168.1.xxx
      sudo ufw allow from 192.168.1.0/24 proto tcp to any port 3100 comment 'Allow grafana from local network'
      ```

    </Tab>
    <Tab label="Subnet">
      Rocket Poolノードが、Grafanaを表示するデバイスと同じサブネットに接続されていない場合は、これを使用します。これは、ノードがISPのモデムに直接接続されており、Grafanaを表示するために使用するデバイスがセカンダリルーターに接続されている場合に発生する可能性があります。

      まず、ローカルネットワークが`192.168.1.xxx`構造を使用しているかどうかを確認してください。
      異なるアドレス構造(例: `192.168.99.xxx`)を使用している場合は、ローカルネットワークの構成に合わせて以下のコマンドを変更する必要がある場合があります。

      ```shell
      # To allow any devices in the broader subnet
      # for example allowing 192.168.2.20 to access
      # grafana on 192.168.1.20
      sudo ufw allow from 192.168.1.0/16 proto tcp to any port 3100 comment 'Allow grafana from local subnets'
      ```
    </Tab>
    <Tab label="Anywhere">
      これにより、どこからでもGrafanaにアクセスできるようになります。
      ローカルネットワークの外部からアクセスする場合は、ルーター設定でGrafanaポート(デフォルト3100)を転送する必要があります。

      ```shell
      # Allow any IP to connect to Grafana
      sudo ufw allow 3100/tcp comment 'Allow grafana from anywhere'
      ```
    </Tab>

  </Tabs>
</div>

## Grafanaのセットアップ

これでメトリクスサーバーの準備が整いました。ローカルネットワーク上の任意のブラウザでアクセスできます。

Smartnodeインストールモードについては、以下のタブを参照してください。

次のURLに移動し、必要に応じて変数をセットアップに置き換えます。

```
http://<your node IP>:<grafana port>
```

例えば、ノードのIPが`192.168.1.5`で、デフォルトのGrafanaポート`3100`を使用した場合、ブラウザで次のURLにアクセスします。

```
http://192.168.1.5:3100
```

次のようなログイン画面が表示されます。

<img src="./images/grafana-login.png" width="100%" height="auto" />

デフォルトのGrafana情報は次のとおりです。

```
Username: admin
Password: admin
```

その後、`admin`アカウントのデフォルトパスワードを変更するように求められます。
強力なパスワードを選択し、忘れないようにしてください。

::: tip ヒント
adminパスワードを紛失した場合は、ノードで次のコマンドを使用してリセットできます。

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker exec -it rocketpool_grafana grafana-cli admin reset-admin-password admin
      ```

    </Tab>
    <Tab label="Native">
      ```shell
      sudo grafana-cli admin reset-admin-password admin
      ```
    </Tab>

  </Tabs>
</div>

デフォルトの`admin`認証情報を使用してGrafanaに再度ログインでき、その後`admin`アカウントのパスワードを変更するように求められます。
:::

コミュニティメンバーの**tedsteen**の功績により、GrafanaはPrometheusインスタンスに自動的に接続されるため、収集したメトリクスにアクセスできます。
あとはダッシュボードを取得するだけです。

## Rocket Poolダッシュボードのインポート

GrafanaをPrometheusに接続したので、標準ダッシュボードをインポートできます(または、そのプロセスに精通している場合は、提供されるメトリクスを使用して独自のダッシュボードを構築できます)。

まず、**Create**メニュー(右側のバーのプラスアイコン)に移動し、**Import**をクリックします。

<img src="./images/grafana-import.png" width="100%" height="auto" />

**Import via grafana.com**ボックスでダッシュボードIDの入力を求められたら、`21863`を入力するか、完全なURL([(https://grafana.com/grafana/dashboards/21863](https://grafana.com/grafana/dashboards/21863))を使用して、**Load**ボタンを押します。

ダッシュボードに関する情報(名前や保存場所など)が表示されます(デフォルトの**General**フォルダで問題ありません。多くのダッシュボードを使用していて整理したい場合を除きます)。

下部の**Prometheus**ドロップダウンには、**Prometheus (default)**というラベルの付いた単一のオプションのみが表示されるはずです。
このオプションを選択します。

画面は次のようになります。

<img src="./images/grafana-import2.png" width="100%" height="auto" />

一致する場合は、**Import**ボタンをクリックすると、新しいダッシュボードにすぐに移動します。

一見すると、ノードとvalidatorに関する多くの情報が表示されます。
各ボックスには、左上隅に便利なツールチップ(`i`アイコン)が付いており、マウスを合わせると詳細を確認できます。
例えば、**Your Validator Share**ボックスのツールチップは次のとおりです。

<img src="./images/tooltip.png" width="100%" height="auto" />

ただし、設定はまだ完了していません。まだもう少し設定が必要です。

::: warning 注意
一部のボックス(特にAPRのボックス)は、Shapellaがスキムされた報酬を提供する方法により、一時的に無効になっています。

過去の報酬を適切に追跡できるSmartnodeの将来のバージョンで再び有効になります。
:::

## システムに合わせてハードウェアモニターを調整する

ダッシュボードが起動したので、**SSD Latency**や**Network Usage**などのいくつかのボックスが空であることに気付くかもしれません。
これらをキャプチャする方法を認識できるように、特定のハードウェアに合わせてダッシュボードを調整する必要があります。

### CPU Temp

CPU温度ゲージを更新するには、**CPU Temp**ボックスのタイトルをクリックし、ドロップダウンから**Edit**を選択します。
画面は次のようになります。

<img src="./images/cpu-temp.png" width="100%" height="auto" />

これはGrafanaの編集モードです。表示される内容と見た目を変更できます。
**Metrics browser**ボタンの右側にある、赤で強調表示されたクエリボックスに注目しています。

デフォルトでは、そのボックスには次のようなものがあります。

```
node_hwmon_temp_celsius{job="node", chip="", sensor=""}
```

このテキストには現在空白の2つのフィールドがあります: `chip`と`sensor`。
これらは各マシンに固有であるため、マシンが提供するものに基づいて入力する必要があります。

これを行うには、次の手順に従います。

1. `, sensor=""`の部分を削除して、`chip=""}`で終わるようにします。明確にするために、全体は`node_hwmon_temp_celsius{job="node", chip=""}`になります。
2. `chip=""`の引用符の間にカーソルを置き、`Ctrl+Spacebar`を押します。これにより、利用可能なオプションが表示された自動補完ボックスが表示されます。次のようになります。

<img src="./images/grafana-autocomplete.png" width="100%" height="auto" />

3. システムのCPUに対応するオプションを選択します。
4. それが選択されたら、`, sensor=""`を文字列に戻します。`sensor=""`の引用符の間にカーソルを置き、`Ctrl+Spacebar`を押して別の自動補完メニューを表示します。監視するセンサーを選択します。

::: tip ヒント
どの`chip`または`sensor`が正しいかわからない場合は、正しく見えるものが見つかるまですべてを試す必要があります。これを支援するには、`lm-sensors`パッケージをインストールし(例: Debian/Ubuntuでは`sudo apt install lm-sensors`)、`sensors -u`コマンドを実行して、コンピュータが持っているセンサーを提供します。名前とIDに基づいて、GrafanaのリストからチップIDをここで表示されるものと関連付けることができます。

例えば、これは`sensors -u`コマンドの出力の1つです。

```
k10temp-pci-00c3
Tctl:
  temp1_input: 33.500
Tdie:
  temp2_input: 33.500
```

この場合、Grafanaの対応するチップは`pci0000:00_0000:00:18_3`で、対応するセンサーは`temp1`です。
:::

選択に満足したら、画面の右上隅にある青い**Apply**ボタンをクリックして設定を保存します。

::: warning 注意
すべてのシステムがCPU温度情報を公開するわけではありません。特に仮想マシンやクラウドベースのシステムです。
`chip`の自動補完フィールドに何もない場合は、おそらくこれが原因であり、CPU温度を監視できません。
:::

### SSD Latency

**SSD Latency**チャートは、読み取り/書き込み操作にかかる時間を追跡します。
これは、validatorのパフォーマンスが低下した場合に、SSDがボトルネックになっているかどうかを判断するのに役立ちます。
チャートで追跡するSSDを更新するには、**SSD Latency**タイトルをクリックして**Edit**を選択します。

このチャートには、合計8つの`device=""`部分を持つ4つのクエリフィールド(4つのテキストボックス)があります。
追跡するデバイスで、これらの部分の最初の4つを更新する必要があります。

引用符の間にカーソルを置き、`Ctrl+Spacebar`を押してGrafanaの自動補完リストを表示し、各`device=""`部分の正しいオプションを選択します。
**一番左の空の設定から始める必要があります。そうしないと、自動補完リストが表示されない場合があります。**

::: tip ヒント
追跡するデバイスがわからない場合は、次のコマンドを実行します。

```
lsblk
```

これにより、デバイスとパーティションリストを示すツリーが出力されます。例えば:

```
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
...
loop25        7:25   0   132K  1 loop /snap/gtk2-common-themes/9
loop26        7:26   0  65,1M  1 loop /snap/gtk-common-themes/1515
nvme0n1     259:0    0 238,5G  0 disk
├─nvme0n1p1 259:1    0   512M  0 part /boot/efi
├─nvme0n1p2 259:2    0 150,1G  0 part /
├─nvme0n1p3 259:3    0  87,4G  0 part
└─nvme0n1p4 259:4    0   527M  0 part
```

Smartnodeインストール中にDockerのデフォルトの場所を別のドライブに変更しなかった場合、追跡するディスクはOSがインストールされているディスクになります。
`MOUNTPOINT`列で単に`/`とラベル付けされたエントリを探し、それを親デバイス(`TYPE`列に`disk`があるもの)まで遡ります。

通常、SATAドライブの場合は`sda`、NVMeドライブの場合は`nvme0n1`になります。

Dockerのデフォルトの場所を別のドライブに変更した場合、またはhybrid/nativeセットアップを実行している場合は、「マウントポイントを辿る」という同じ手法を使用して、チェーンデータが存在するデバイスを決定できるはずです。
:::

オプションで、システム上の2番目のディスクのレイテンシを追跡することもできます。
これは、OSとチェーンデータを別々のドライブに保存している人を対象としています。
これを設定するには、上記の指示に従って最後の2つのクエリフィールドを設定し、`device=""`部分の値を追跡するディスクの値に置き換えます。

選択に満足したら、画面の右上隅にある青い**Apply**ボタンをクリックして設定を保存します。

### Network Usage

このチャートは、特定のネットワーク接続を介して送受信しているデータ量を追跡します。
ご想像のとおり、ダッシュボードは追跡するネットワークを知る必要があります。

変更するには、**Network Usage**タイトルをクリックして**Edit**を選択します。

このチャートには、合計2つの`device=""`部分を持つ2つのクエリフィールドがあります。
追跡するネットワークでこれらを更新する必要があります。

引用符の間にカーソルを置き、`Ctrl+Spacebar`を押してGrafanaの自動補完リストを表示し、各`device=""`部分の正しいオプションを選択します。

::: tip ヒント
追跡するデバイスがわからない場合は、次のコマンドを実行します。

```shell
sudo route
```

出力は次のようになります。

```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
```

`Destination`列で値が`default`の行を探します。
その行を`Iface`列まで辿ります。
そこにリストされているデバイスが使用するものです。この例では`eth0`です。
:::

選択に満足したら、画面の右上隅にある青い**Apply**ボタンをクリックして設定を保存します。

### Total Net I/O

これは、送受信したデータの総量を追跡します。
例えば、ISPが月ごとに特定の量のデータに制限している場合に便利です。

設定は上記の**Network Usage**ボックスと同じであるため、このボックスについても同じ指示に従ってください。

### Disk Space Used

これは、OSディスクがどれだけいっぱいになっているかを追跡するため、クリーンアップする時期(そしてチェーンデータが同じドライブにある場合は、[GethまたはNethermindをプルーニングする](./pruning)時期)がわかります。

手順は上記の**SSD Latency**ボックスと同じであるため、このボックスについても同じ指示に従ってください。
念のため、これについてはOSドライブになるため、`MOUNTPOINT`列に`/`があるパーティションを収容するドライブが必要です。
これを最初のクエリフィールドに入力します。

オプションで、システム上の2番目のディスクの空き容量を追跡することもできます。
これは、OSとチェーンデータを別々のドライブに保存している人を対象としています。
同じプロセスに従ってこれを設定しますが、`MOUNTPOINT`列に`/`があるパーティションを見る代わりに、2番目のドライブのマウントポイントがあるパーティションを探します。
そのパーティションに関連付けられたディスクで2番目のクエリフィールドを更新します。

### Disk Temp

これは、OSディスクの現在の温度を追跡します。手順は上記の**CPU Temp**ボックスと同じであるため、このボックスについても同じ指示に従い、CPUチップとセンサーの値をOSディスクの値に置き換えます。これらの値を最初のクエリフィールドに入力します。

オプションで、システム上の2番目のディスクの現在の温度を追跡することもできます。同じプロセスに従ってこれを設定し、チップとセンサーの値を2番目のドライブの値に置き換えます。これらの値を2番目のクエリフィールドに入力します。

## ダッシュボードのカスタマイズ

標準ダッシュボードは、一目で見たいすべてのものをキャプチャするのに適していますが、Grafanaダッシュボードは好きなようにカスタマイズするのは非常に簡単です。
新しいグラフを追加したり、グラフの見た目を変更したり、物を移動したりすることができます。

[Grafanaのチュートリアル](https://grafana.com/tutorials/)ページを見て、操作方法や好みに合わせて設定する方法を学んでください。

## Metricsスタックのカスタマイズ

Rocket Pool Metricsスタックで使用されるツールは、デフォルトのRocket Poolインストールに含まれているもの以外にも、さまざまな設定オプションを提供します。このセクションには、さまざまなユースケースの設定例が含まれています。

一般的に、[Grafana設定オプション](https://grafana.com/docs/grafana/latest/administration/configuration/)は、`override/grafana.yml`で環境変数を使用して渡す必要があります。すべての設定オプションは、次の構文を使用して環境変数に変換できます。

```
GF_<SectionName>_<KeyName>
```

### メール送信用のGrafana SMTP設定

Grafanaからメールを送信するには、例えばアラートや他のユーザーを招待するために、Rocket Pool MetricsスタックでSMTP設定を構成する必要があります。
参考として[Grafana SMTP構成](https://grafana.com/docs/grafana/latest/administration/configuration/#smtp)ページを参照してください。

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      テキストエディタで`~/.rocketpool/override/grafana.yml`を開きます。
      `x-rp-comment: Add your customizations below this line`行の下に`environment`セクションを追加し、以下の値をSMTPプロバイダーの値に置き換えます。

      ```yaml
      version: "3.7"
      services:
      grafana:
      x-rp-comment: Add your customizations below this line
      environment:
      ## SMTP settings start, replace values with those of your SMTP provider
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      - GF_SMTP_USER=admin@example.com
      - GF_SMTP_PASSWORD=password
      - GF_SMTP_FROM_ADDRESS=admin@example.com
      - GF_SMTP_FROM_NAME="Rocketpool Grafana Admin"
      ## SMTP server settings end
      ```
    </Tab>
    <Tab label="Native">
      テキストエディタで`/etc/grafana/grafana.ini`を開きます。`[smtp]`セクションを探して更新し、以下の値をSMTPプロバイダーの値に置き換えます。

      ```
      [smtp]
      enabled = true
      host = mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      user = admin@example.com
      # If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
      password = """passw0rd"""
      from_address = admin@example.com
      from_name = "Rocketpool Grafana Admin"
      ```
    </Tab>

  </Tabs>
</div>

::: tip ヒント
Gmailを使用していて[2段階認証プロセス](https://support.google.com/accounts/answer/185839)が有効になっている場合は、このサービス用の[アプリパスワード](https://support.google.com/mail/answer/185833?hl=en)を作成してください。
:::

これらの変更を行った後、**次のコマンドを実行して変更を適用します**。

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker stop rocketpool_grafana

      rocketpool service start
      ```
    </Tab>
    <Tab label="Native">
      ```shell
      sudo systemctl restart grafana-server
      ```
    </Tab>

  </Tabs>
</div>

SMTP設定をテストするには、**Alerting**メニューに移動して**Contact points**をクリックします。

<img src="./images/grafana-contact-points.png" width="100%" height="auto" />

**New contact point**をクリックし、Contact point typeとして**Email**を選択します。
**Addresses**セクションにメールアドレスを入力し、**Test**をクリックします。

<img src="./images/grafana-new-contact-point.png" width="100%" height="auto" />

テストメールが受信されたことを確認します。
完了したら**Save contact point\***をクリックします。
