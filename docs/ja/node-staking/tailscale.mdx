import tailscale_dashboard_client from "./images/tailscale-dashboard-client.png";
import tailscale_dashboard_servers from "./images/tailscale-dashboard-servers.png";

# Tailscale VPNサーバーの設定

::: tip 注意
これは**オプション**です。
自宅でノードを実行していて、ホームネットワークの外部から接続したい場合にのみ、このセクションを検討する必要があります。
:::

休暇中やビジネストリップ中など、自宅のネットワークにリモートでログインしたい場合、最も一般的な方法は**仮想プライベートネットワーク**サーバーを使用することです。
これにより、SSHポートをインターネットに公開することなく、世界中のどこからでもSSH経由でノードに接続し、Grafanaダッシュボードを監視できます。

多くのRocket Poolノードオペレーターは、このためのVPNサーバーとして[Tailscale](https://tailscale.com/blog/how-tailscale-works/)を使用しています。
TailscaleはオープンソースのP2P VPNトンネルおよびホスト型エンドポイント検出サービスです。
マシンとノードの間に暗号化されたエンドツーエンドのパスを確立するために必要な認証、公開、NATトラバーサルを処理し、機密性の高いトラフィックを集中サーバーに送信しません。
これは非常に強力なツールです。

基本的な設定について簡単に説明しますが、詳細については[ドキュメントを確認](https://tailscale.com/kb/start/)してください。

## Tailscaleのセットアップ

まず、無料の[Tailscaleアカウント](https://tailscale.com/)を作成します。
Tailscaleは、Google、GitHub、Okta、Microsoftなどのシングルサインオン（SSO）IDプロバイダーの使用を必要とします。
詳細については、[SSOページ](https://tailscale.com/kb/1013/sso-providers/)をご覧ください。

セキュリティを強化するために、選択したIDプロバイダーで2FA（二要素認証）を有効にすることをお勧めします。

次に、[オンボーディングガイド](https://tailscale.com/kb/1017/install/)に従って、**クライアント**にTailscaleをインストールします。クライアントとは、ネットワークに接続したいマシン（ラップトップや携帯電話など）です。
**Rocket Poolノードでは_ありません_！**

完了すると、[Tailscaleダッシュボード](https://login.tailscale.com/admin/machines)でコンピューターが「接続済み」として表示されます。

<img src={tailscale_dashboard_client} width="100%" height="auto" />

次に、**Rocket Poolノード**にTailscaleをインストールします。
インストール手順はウェブサイトで確認できます。例えば、[Ubuntuのインストール手順](https://tailscale.com/kb/1039/install-ubuntu-2004/)があります。

::: warning 注意
UFWを設定している場合は、[UFW設定手順](https://tailscale.com/kb/1077/secure-server-ubuntu-18-04/)も参照してください。
:::

まず、**Rocket Poolノード上で**Tailscaleのパッケージ署名キーとリポジトリを追加します:

```shell
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
```

次に、**Rocket Poolノード上で**Tailscaleをインストールします:

```shell
sudo apt-get update
sudo apt-get install tailscale
```

最後に、**Rocket Poolノード上で**マシンを認証し、Tailscaleネットワークに接続します:

```shell
sudo tailscale up
```

接続されました！
次のコマンドを実行して、Tailscale IPv4アドレスを確認できます:

```shell
tailscale ip -4
```

[Tailscaleダッシュボード](https://login.tailscale.com/admin/machines)にノードマシンが追加されたことが確認できます。
ダッシュボードから**ノードマシン**の名前を変更することもできます（例: `rocketnode`）。

<img src={tailscale_dashboard_servers} width="100%" height="auto" />

定期的に再認証する必要がないように、ノードマシンの[キーの有効期限を無効にする](https://tailscale.com/kb/1028/key-expiry)ことをお勧めします。

::: tip 注意
rocketnodeなどの覚えやすいホスト名を使用してノードにアクセスしたい場合は、Tailscale設定でMagicDNSを有効にすることで可能になります。
:::

これで、クライアント上でノードへのSSHセッションを`exit`し、Tailscaleを使用して`ssh your.user@rocketnode`でノードに再度SSHできるようになります。

::: warning 注意
ノードを最初に設定したときに`/etc/ssh/sshd_config`で**ノードマシン**のSSHポートを変更した場合は、代わりに`ssh your.user@rocketnode -p <your port>`を使用してください。

例えば、SSHをポート1234に割り当てた場合、次のようにします:

```shell
ssh your.user@rocketnode -p 1234
```

:::

**クライアント**のウェブブラウザで`http://rocketnode:3100`にアクセスして、Grafanaダッシュボードにアクセスすることもできます。

UFWを設定している場合は、Tailscale経由の受信SSH接続を受け入れるルールを追加できます。

::: danger 警告
以下の手順はファイアウォールルールを変更します。
続行する前に、ノードマシンへのSSHセッションを少なくとも2つ開いておく必要があります。1つは設定を変更してその後テストするため、もう1つは変更によってSSHが壊れた場合に元に戻せるようにバックアップとしてログインしたままにしておくためです！
:::

**ノードマシン上で次のコマンドを実行します。**

Tailscale経由のすべての受信SSH接続へのアクセスを許可します。

```shell
sudo ufw allow in on tailscale0
```

[ファイアウォールの有効化](/ja/node-staking/securing-your-node#essential-enable-a-firewall)の手順から追加したSSHポートへのアクセスを削除して、ノードを完全にロックダウンすることもできます。
tailscaleがログインする唯一の方法になるため、ローカルネットワークからログイン**できなくなる**ことに注意してください。
これで問題ない場合にのみ、次のコマンドを実行してください。

```shell
sudo ufw delete "22/tcp"
```

すべての非Tailscale接続を制限するファイアウォールルールを設定したら、UFWとSSHを再起動します:

```shell
sudo ufw reload
sudo service ssh restart
```

次に、すべてが期待どおりに機能していることを確認します。
現在のSSHセッションの1つから`exit`します（**ただし、バックアップとして2番目のセッションを開いたままにしておくことを忘れないでください**）。

次に、Tailscale IPアドレスを使用してSSH経由で**ノードマシン**に接続します:

```shell
ssh your.user@rocketnode
```

機能する場合は、すべてが正しく行われており、海外にいても安全にホームネットワークにログインできます！

::: tip ヒント
以前にルーターでノードのSSHポートをポート転送していた場合、今すぐ削除できます。
:::
