import { Tab, Tabs } from "@rspress/core/theme";

::: danger 警告
Saturn 1の準備のため、現在minipoolのデポジットは無効化されています。
:::

# 新しいMinipool（Validator）の作成

念のため、Rocket Poolの用語では`minipool`とは、ノードが管理するExecution Layer上のユニークなスマートコントラクトインスタンスを指します。
minipoolは、**ボンド額**として知られるETHの一部と、rETHステーキングプールからの**借入額**として知られるETHの一部を処理します。
これらを合わせて合計32 ETHを形成し、Beacon Chainのデポジットコントラクトに送信して新しいvalidatorを作成します。
したがって、Rocket Poolを使用してvalidatorを作成するには、**minipoolを作成する**必要があります。

::: danger 警告
minipoolの作成は2つのキューによって管理されています。

1つ目はRocket Poolのデポジットキューで、Rocket Poolプロトコルによって管理され、minipoolが借入ETHを受け取るタイミングを決定します。デポジットプールに利用可能なETHがあり、デポジットプール内の24 ETHとあなたの8 ETHをマッチングしてminipoolを作成する必要があります。

2つ目はBeacon Chainのキューで、Ethereum Beacon Chainによって管理され、validatorがアクティブになるタイミングを決定します。

minipoolがアクティブになるまでの時間は、各キューでのあなたの位置とネットワークの現在の状態によって大きく異なる可能性があることに注意してください。
:::

::: tip 注記
Beacon Chainのvalidatorキューのアクティベーション（および終了）時間は、ネットワークの現在の状態によって大きく異なる場合があります。

これはRocket Poolの制御外であり、Beacon Chain自体の機能です。

以下のツールは、待機時間の良い推定値を提供します：
[https://www.validatorqueue.com/](https://www.validatorqueue.com/)

validatorがアクティブになるまでの待機時間の目安を知るために、このツールを確認してください。
:::

### Webサイトを通じたRPLのステーキング

ノードにRPLをステーキングする最も簡単で安全な方法は、Atlasアップグレードで再導入されたプロトコルの**Stake-on-Behalf**機能を使用することです。この方法では、RPLを取得したウォレットにRPLがまだある状態で、ノードのためにRPLをステーキングできます。つまり、RPLをステーキングするために**ノードのホットウォレットにRPLを送信する必要はありません**。

#### アドレスをステーキングのために代理でホワイトリストに追加する

ノードの代理でステーキングするには、アドレスをホワイトリストに登録する必要があります。withdrawal addressは常にホワイトリストに登録されているため、RPLがwithdrawal addressで保持されている場合は、このステップをスキップできます。アドレスからステーキングするために、アドレスをホワイトリストに登録する必要があるのは一度だけです。以下のSmartnodeコマンドでこれを実行できます：

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

ここで`address-or-ens`は、希望するアドレスに解決されるアドレスまたはENS名です。ホワイトリストへの追加を確認するよう求められ、トランザクションが確認された後、以下の該当ページに移動できます。

#### RPLを代理でステーキングする

使用しているネットワークを以下のタブから選択してください：

<div className="p-3">
  <Tabs>
    <Tab label="Mainnet">[https://node.rocketpool.net/stake-rpl-on-behalf-of-node](https://node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
    <Tab label="Hoodi Testnet">[https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node](https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
  </Tabs>
</div>

まず、MetaMask、WalletConnect、またはWebサイトがサポートするその他の方法を使用して、ウォレットをWebサイトに接続します。
次に、ノードアドレスを検索するための以下のダイアログが表示されます。

ノードアドレスを入力し、「Lookup」をクリックします。

**これを行う前に、正しいノードアドレスを持っていることを確認してください！**
ノードのアドレスを確認する必要がある場合は、`rocketpool node status`コマンドを使用してCLI経由ですぐに取得できます。

これにより、アドレスが登録済みノードであり、ノードが接続されたウォレットをホワイトリストに登録していることが確認されます。withdrawal addressはデフォルトでホワイトリストに登録されていますが、他のアドレスを許可したい場合は、ノードで以下のコマンドを使用してホワイトリストに登録する必要があります。

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

これは2段階のプロセスです。

まず、ステーキングしたいRPLの量を入力し、`Approve`をクリックします - これにより、ステーキングコントラクトがウォレット内のその量のRPLにアクセスすることを**承認**しますが、**その量以上はアクセスできません**。

::: tip ヒント
Rocket Poolのステーキングコントラクトを信頼しており、RPLをさらにステーキングするたびにこの追加のApproveトランザクションを実行したくない場合は、ステーキングする予定の量よりも多くを承認できます。
:::

RPLが承認されると、ノードの代理でステーキングできるようになります。

`Stake RPL`ボックスにステーキングしたいRPLの量を入力し、`on behalf of Node Address`ボックスにノードのアドレスを入力します。

情報を入力したら、`Stake`ボタンを押してトランザクションを承認します。

<video controls="controls" src="https://cdn-rocketpool.s3.us-west-2.amazonaws.com/stake_behalf.mp4" />

これはEthereumネットワークに送信され、ブロックに含まれると、すべて完了です！

`rocketpool node status`を実行すると、`=== RPL Stake ===`セクションの下にステーキングされたRPLが表示されるはずです。

#### ステーキングホワイトリストからアドレスを削除する

stake-on-behalfホワイトリストからアドレスを削除したい場合は、以下のSmartnodeコマンドで削除できます：

```shell
rocketpool node remove-address-from-stake-rpl-whitelist address-or-ens
```

ここで`address-or-ens`は、ホワイトリストから削除したいアドレスに解決されるアドレスまたはENS名です。

### Node CLIを使用したステーキング

Webサイトを使用してRPLをステーキングできない（またはしたくない）場合は、ノードのCLIから直接ステーキングすることもできます。

まず、RPLを取得したウォレットからノードのアドレスにRPLを転送します。

::: danger 警告
**これは慎重に行い、ノードのアドレスにRPLを送信していることを確認してください - Ethereum上の転送は元に戻すことができません！**
**間違ったアドレスにRPLを送信すると、RPLを失うことになります。**

ノードのアドレスが不明な場合は、`rocketpool node status`コマンドを使用して確認してください。
:::

以下のコマンドを実行します：

```
rocketpool node stake-rpl
```

以下が出力です：

```
Please choose an amount of RPL to stake:
1: Your entire RPL balance (1440.000000 RPL)?
2: A custom amount
```

ステーキングしたい量を選択し、操作を確認します。

このコマンドを初めて実行する場合、2つのトランザクションが必要になります - 1つはRocket PoolステーキングコントラクトにRPLへのアクセスを**承認**するため、もう1つはRPLを**ステーキング**するためです。
その後の実行では、トークンはすでに承認されているため、**ステーキング**トランザクションのみが必要になります。

両方のトランザクションが完了したら、`rocketpool node status`でステーキングされたRPLの量を確認できます。
確認したい出力の部分は次のとおりです：

```
The node has a total stake of 300.000000 RPL.
This is currently 29.76% of its borrowed ETH and 89.29% of its bonded ETH.
It can earn max apy on up to 151.209677 RPL (15% of borrowed ETH), and still earn at lower APY with more RPL.
```

これにより、RPL担保に基づいて各ボンドサイズのminipoolをいくつ作成できるかが表示されます。

## （オプション）Minipool用のカスタムバニティアドレスの検索

デフォルトでは、新しいminipoolを作成すると、Rocket Poolはランダムなユニークアドレスを生成します。
ただし、Smartnodeはminipoolの**バニティアドレス**をカスタム検索する機能を提供しています。

バニティアドレスとは、アドレスが始まる文字を個人的に選択するアドレスです。
これは純粋に装飾的な演習であり、minipoolの動作に実質的な影響はありません。
Ethereumアドレスは16進数であるため、以下の文字が使用可能です：

```
0 1 2 3 4 5 6 7 8 9 a b c d e f
```

いくつかの例として、minipoolのアドレスを多数のゼロで始めることができます（`0x000000...`）、`0x600d`（「good」の16進数）、または`0xa77e57ed`（「attested」の16進数で、minipoolにふさわしいプレフィックス）。

そのようなバニティアドレスを見つけるには、**検索する**必要があります。
この検索プロセスには、数値を選択し、それを「ソルト」としてハッシュアルゴリズムに適用し、結果を探しているものと比較することが含まれます。
結果は事実上ランダムです（ただし、特定のソルトは常に同じ結果を生成します）。したがって、希望するプレフィックスを持つアドレスを見つける唯一の方法は、機能するソルトが見つかるまで何度も何度も試すことです。

minipoolを作成するときに使用するカスタムバニティアドレスが必要な場合は、以下のコマンドを使用して検索できます：

```
rocketpool minipool find-vanity-address
```

これにより、検索したいプレフィックスの入力を求められ、実行するデポジットのタイプ（16 ETHまたは32 ETHのデポジット - 詳細については以下を参照）を尋ねられます。
その情報を入力すると、希望するプレフィックスを生成するソルトが見つかるまで、何度も何度もソルトを試し始めます！

プロセスの完全な例は次のとおりです：

```
$ rocketpool minipool find-vanity-address
Please specify the address prefix you would like to search for (must start with 0x):
0xa77e57
Running with 12 threads.
Found on thread 3: salt 0x5cd7fb = 0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD
Finished in 1.91145873s
```

この場合、プレフィックスとして`0xa77e57`を検索し、それを生成できるソルト`0x5cd7fb`を見つけました。
次のステップでは、minipoolを作成するときに、このソルトをオプション引数として指定して、ソルトに関連付けられたアドレス（上記のように`0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD`）で新しいminipoolを作成できます。

一般的に、検索する文字を1つ追加するたびに、検索時間が約16倍になります。
このため、**非常に多くのCPUコアを備えた非常に強力なマシンを持っていない限り、最大7〜8文字のプレフィックスのみを検索することをお勧めします**。
それ以外の場合、希望するプレフィックスを生成するソルトを見つけるのに禁止的に長い時間がかかる可能性があります。

たとえば、6コア（12スレッド）を搭載し、4.8 GHzで動作するAMD 5600xは、1秒あたり約320万のソルトを検索できます。
平均して、6文字のプレフィックスを見つけるのに数秒、7文字のプレフィックスを見つけるのに数分、8文字のプレフィックスを見つけるのに数時間かかります。

::: tip 注記
生成されるソルトは、以下の変数に固有です：

- 使用しているネットワーク（Hoodi TestnetまたはMainnet）
- ノードアドレス
- ボンド額
- ソルト

これらの変数のいずれかを変更すると、特定のソルトのminipoolアドレスも変更されます。
:::

より高度な使用法（別のノードアドレスの検索や検索に使用するCPUコア数の変更など）については、`rocketpool minipool find-vanity-address --help`でヘルプテキストを確認してください。

## ETHのデポジットとMinipoolの作成

::: tip ヒント
rETHの市場価値がETHの裏付けよりも高い場合（つまり、rETHが市場でプレミアムである場合）、minipoolを作成するときに差額をアービトラージする機会があります。
アービトラージの価値は、minipool内のプロトコルETHの量にプレミアムを掛けたもの（わずかなガス代を差し引いたもの）に等しくなります。
例えば、2.5%のプレミアムがあるときにminipoolを作成する場合：`16 ETH * .025 = 0.4 ETH`。
言い換えれば、これらの条件下でminipoolを作成するだけで0.4 ETHを受け取ることができます！

この機会を活用したい場合は、コミュニティ開発の[rocketarb](https://github.com/xrchz/rocketarb#readme)ツールを使用して、minipoolの起動によって生成されるMEV rETHアービトラージ機会の利益を獲得することを検討してください。

rocketarbの詳細については、[RP discordサーバー](https://discord.gg/rocketpool)でお問い合わせください。
:::

これまでに行ったすべてのことの後、ついにETHをデポジットし、新しいminipoolを作成し、Beacon Chain validatorを作成する準備が整いました。
これは以下のコマンドで実行されます：

```shell
rocketpool node deposit
```

::: danger 警告

CLIは次のステップの多くを自動化しますが、`prelaunch`から`staking`への正常な移行を確保するために、ノードとトランザクションを監視することを<strong>強くお勧めします</strong>。

失敗したトランザクション（調整されたガス設定や不十分なETHのため）により、minipoolが`dissolved`状態に移行する可能性があり、これは避けたいものです。

[正常なステーキングを確認する方法の詳細](/ja/node-staking/create-validator#confirming-a-successful-stake)

:::

::: tip 注記
上記のプロセスを使用して見つけたバニティアドレスのソルトを使用したい場合は、代わりに以下のコマンドを実行してください：

```shell
rocketpool node deposit --salt <your salt, e.g. 0x1234abcd>
```

:::

まず、新しいminipoolをデポジットすると、ノードの[fee distributor](/ja/node-staking/fee-distrib-sp)コントラクト（[Smoothing Pool](/ja/node-staking/fee-distrib-sp#the-smoothing-pool)にオプトインしていない場合、MEV報酬をキャプチャするために使用されます）内の残高が**自動的に分配される**ことに関する注記が表示されます：

```
Your eth2 client is on the correct network.
NOTE: by creating a new minipool, your node will automatically claim and distribute any balance you have in your fee distributor contract. If you don't want to claim your balance at this time, you should not create a new minipool.
Would you like to continue? [y/n]
```

すでにminipoolがあり、fee distributorに残高がある場合、この残高の分配が管轄区域で課税対象イベントを引き起こす場合、別のminipoolを作成しないことを決定する場合があります。

その後、新しいminipoolの手数料率と、ノードの[credit balance](/ja/node-staking/credit)を使用してminipoolボンドのコストをカバーできるかどうかについての注記が通知されます：

```
Your minipool will use the current fixed commission rate of 5.00%.
If you participate in the smoothing pool, your minipool will receive at least a 5% commission boost, and up to a 9% commission boost based on RPL stake.
You currently have 8.00 ETH in your credit balance.
This deposit will use 8.000000 ETH from your credit balance and will not require any ETH from your node.
```

次に、ネットワークの現在のガスコスト推奨事項が表示されます。ガス価格の選択を確認し、残りのプロンプトに従ってください。

```
Your consensus client is synced, you may safely create a minipool.
+============== Suggested Gas Prices ==============+
| Avg Wait Time |  Max Fee  |    Total Gas Cost    |
| 15 Seconds    | 15 gwei   | 0.0244 to 0.0366 ETH |
| 1 Minute      | 10 gwei   | 0.0157 to 0.0235 ETH |
| 3 Minutes     | 7 gwei    | 0.0100 to 0.0150 ETH |
| >10 Minutes   | 6 gwei    | 0.0080 to 0.0120 ETH |
+==================================================+
These prices include a maximum priority fee of 2.00 gwei.
Please enter your max fee (including the priority fee) or leave blank for the default of 10 gwei:
Using a max fee of 10.00 gwei and a priority fee of 2.00 gwei.
You are about to deposit 8.000000 ETH to create a minipool with a minimum possible commission rate of 14.000000%.
ARE YOU SURE YOU WANT TO DO THIS? Exiting this minipool and retrieving your capital cannot be done until:
- Your minipool has been *active* on the Beacon Chain for 256 epochs (approx. 27 hours)
- The Shapella upgrade of the Ethereum network has been deployed
- The Atlas upgrade of the Rocket Pool protocol has been deployed
- Your minipool has been upgraded to use the Atlas delegate
 [y/n]
y
Creating minipool...
Transaction has been submitted with hash <transaction hash>.
You may follow its progress by visiting:
<link to transaction>
Waiting for the transaction to be included in a block... you may wait here for it, or press CTRL+C to exit and return to the terminal.
The node deposit of 8.000000 ETH was made successfully!
Your new minipool's address is: <new minipool address>
The validator pubkey is: <new validator public key>
Your minipool is now in Initialized status.
Once the remaining ETH has been assigned to your minipool from the staking pool, it will move to Prelaunch status.
After that, it will move to Staking status once 1h0m0s have passed.
You can watch its progress using `rocketpool service logs node`.
```

minipoolの作成は**高価なトランザクション**であることに注意してください！
総コストに細心の注意を払い、それを受け入れることを確認してください。

受け入れる場合、minipoolの作成がトリガーされます。
トランザクションが完了すると、Execution Layer上の新しいminipoolコントラクトのアドレスと、Beacon Chain上の対応するvalidator公開鍵が提供されます。
必要に応じて、任意のブロックエクスプローラーでこれらを訪問できます。

## 正常なステーキングの確認

作成時、minipoolは`initialized`状態になります。
Rocket Poolキューであなたの順番になり、ステーキングプールから24 ETHが提供され、Beacon Chain上で新しいvalidatorをステーキングできるようになるまで、ここにとどまります。

これが起こると、minipoolは一定期間（現在12時間）`prelaunch`状態に移行します。
8 ETHのデポジットがBeacon Chainに転送され、Oracle DAOは[すべてが正しいことを確認します](https://github.com/rocket-pool/rocketpool-research/blob/master/Reports/withdrawal-creds-exploit.md)。
この期間中、[https://beaconcha.in](https://beaconcha.in)（または[https://hoodi.beaconcha.in](https://hoodi.beaconcha.in)（Hoodi Testnet用））などのBeacon Chainエクスプローラーでvalidator公開鍵を検索することで、validatorを観察できます。

`rocketpool minipool status`コマンドで新しいminipoolのステータスを確認できます。
たとえば、`prelaunch`に移行すると、おそらく次のようなものが表示されます：

```
1 Prelaunch minipool(s):
--------------------
Address:              <your minipool address>
Penalties:             0
Status updated:        2024-10-31, 04:51 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 31.000000 ETH
Your portion:          7.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      7.000000 ETH
Validator pubkey:      <your validator public key>
Validator index:       0
Validator seen:        no
Use latest delegate:   no
Delegate address:      <your delegate address>
Rollback delegate:     <none>
Effective delegate:    <your delegate address>
0 finalized minipool(s):
```

このprelaunch期間の後、minipoolは`staking`ステータスに入り、ステーキングプールから追加のETHをデポジットコントラクトに送信します。
これは`rocketpool_node` Dockerコンテナ（またはNativeセットアップを使用した場合は`rp-node`サービス）によって実行されます - 何らかの理由で`staking`ステータスに入るのに異常に時間がかかっている場合、このコンテナ/サービスのログを確認すると、何が問題なのかがわかるでしょう。
これらのログは`rocketpool service logs node`コマンド（またはNativeモードセットアップでは`/srv/rocketpool/node_log.sh`）で確認できます。

`rocketpool minipool status`を実行すると、次のようなものが表示されます：

```
$ rocketpool minipool status
1 Staking minipool(s):
--------------------
Address:              <your validator address>
Penalties:             0
RP ETH assigned:       2024-10-31, 05:53 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 0.000000 ETH
Your portion:          0.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      0.000000 ETH
Validator pubkey:     <your validator public key>
Validator index:      <your validator index number>
Validator active:     yes
Validator balance:    32.018460 ETH
Expected rewards:     16.010614 ETH
Use latest delegate:  no
Delegate address:     <your delegate address>
Rollback delegate:    <none>
Effective delegate:   <your delegate address>
0 finalized minipool(s):
```

::: warning 注記
`prelaunch`から`staking`への移行トランザクションは、ノードによって自動的に送信され、`rocketpool service config`のガス設定の対象となります。
ガス設定によりノードがトランザクションを送信できない場合、またはノードウォレットにトランザクションの支払いに十分なETHがない場合、minipoolは`prelaunch`に入ってから2週間後に`dissolved`になります。
これが起こった場合、残高の取得は高価で長いプロセスになるため、`staking`ステータスに達するまでminipoolを注意深く監視してください！
:::

Beacon Chainが両方のデポジット（あなたからのものとステーキングプールからのもの）を受け入れると、validatorはBeacon Chainキューに入り、アクティブ化されてステーキングを開始する順番を待ちます。

この時点で、完了です！
おめでとうございます！
Rocket Poolでvalidatorを正式に作成しました！

次のセクション「モニタリングとメンテナンス」を参照して、時間の経過とともにvalidatorのパフォーマンスと健全性を監視する方法を学びましょう。

## 複数のMinipoolの作成

便利なことに、Rocket Poolノードは必要な数のminipoolをホストできます。
各minipoolに対して新しいノードを作成する**必要はありません**。

ノードに2番目（または3番目、4番目...）のminipoolを作成したい場合は、`rocketpool node deposit`を再度実行するだけです。
また、古いバニティアドレスソルトを再利用することはできません - 各minipoolに対して別のユニークなソルトを検索する必要があります。

## 次のステップ

minipoolが稼働しているので、次のステップでは、ノードの健全性を監視し、更新を確認して適用し、その生涯を通じてメンテナンスする方法について説明します。

**これらのトピックについて詳しく学ぶために、次に`モニタリングとメンテナンス`セクションをお読みください。**
