import { Tab, Tabs } from "@rspress/core/theme";

# [Hybridモード] RedstoneアップデートとMergeのガイド

このガイドでは、**Hybridモード**を使用している場合に、RedstoneアップデートとMergeに向けてノードを準備するために知っておくべきすべてのことを説明します。

## v1.5.0へのアップグレード前にすべきこと

Smartnodeのv1.5.0以降にアップグレードする前に、次のチェックリストを確認して準備ができていることを確認してください。

### 完全なExecution Clientへの切り替え

Mergeでは独自のExecution Clientを実行する必要があるため、InfuraやPocketなどのリモートプロバイダーを使用できなくなります。

この変更により、現在ライトExecution Clientを使用している場合は、v1.4のままで完全なクライアントに切り替え、同期が完了するまで待ってから、v1.5にアップグレードする必要があります。

### ECとCCの両方が外部管理されていることを確認

以前のバージョンのSmartnodeスタックでは、1つのクライアントをローカル管理、もう1つを外部管理することができました。
たとえば、Smartnodeが管理するExecution Clientと、外部で管理するConsensus Clientに接続することができました。

v1.5以降、この構成はサポートされなくなりました。
ローカル管理されるExecution ClientとConsensus Client（[Dockerモード](./docker-migration.mdx)とも呼ばれます）のいずれかに切り替えるか、自分で管理するExecution ClientとConsensus Clientの両方をセットアップする必要があります。

::: tip ヒント
SmartnodeにそれぞれのExecution ClientとConsensus Clientを維持させたいが、独自のValidator Client（たとえば、独自のソロステーキングバリデータキーが接続されている場合など）を制御し続けたい場合は、まさにそれを実現する[Reverse Hybridモード](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode)を検討することをお勧めします！
:::

### Engine APIのセットアップ

Mergeでは、Execution ClientとConsensus Clientの通信方法が変わります。
古いHTTPまたはWebsocketベースのRPCシステムを使用する代わりに、MergeではExecution Clientが公開するEngine APIと呼ばれる新しいシステムが必要です。

これは、Consensus Clientが古いProof-of-WorkマイニングシステムをProof-of-Stakeに置き換えることを可能にする特別な接続です。これがMergeの中核です。
また、シークレットトークンで**認証**されているため、Consensus ClientのみがExecution Clientに接続でき、他は何も接続できません。

独自のExecution ClientとConsensus Clientを管理しているため、Engine APIを手動でセットアップする必要があります。
その方法は、実行しているクライアントによって完全に異なります。

CoinCashewには、Execution ClientとConsensus ClientでEngine APIをセットアップする方法についての[素晴らしく簡潔なガイド](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators)があります。
それを確認し、アップグレード前に新しい構成が依然として適切にアテステーションすることを確認してテストしてください。

いつものように、Rocket Poolは独自のValidator Clientを管理するため、手動で変更する必要はありません。

## v1.5.0へのアップグレード

Smartnodeスタックをv1.5.0にアップグレードすることは、他のアップグレードと変わりません。
単に[ここの通常の手順](../../node-staking/updates#updating-the-smartnode-stack)に従ってください。

## Smartnodeが自動的に処理すること

Hybridモードでは、v1.5.0にアップデートすると、Redstoneをサポートするために必要な変更の一部をSmartnodeが自動的に処理しますが、Hybridモードでは他のものを手動で処理する必要があります。

手動で介入することなくSmartnodeが実行することの簡単なリストを以下に示します。

### Fee Recipient

**fee recipient**は、提案するブロックのすべてのpriority feesを受け取るExecution Layer（eth1）チェーン上のアドレスです。
これは、Validator Clientが最初に起動するときに提供される設定です。

Smartnodeは、v1.5にアップグレードしたときに管理するValidator Clientで正しいアドレスに設定することを処理し、[誤ってペナルティを受ける](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)ことがないように、正しいアドレスを使用していることを常に確認します。

[Smoothing Pool](./whats-new#smoothing-pool)にオプトインした場合、それがfee recipientになります。
オプトインしなかった場合、[fee distributorコントラクト](./whats-new#fee-recipients-and-your-distributor)がfee recipientになります。

## アップグレード後に実施すべきこと

Smartnodeがほとんどの変更を処理しますが、手動で実施すべきいくつかの追加事項があります。

### アップグレードが成功したことを確認

最初に実施することは、ノードが正しく動作していることを確認することです。
次の手順を検討してください。

- `rocketpool service logs validator`と`rocketpool service logs node`でログにエラーがないか確認します。
- ブロックエクスプローラー（Grafanaダッシュボードや[https://beaconcha.in](https://beaconcha.in)など）で、まだ適切にアテステーションしていることを確認します。
  - Doppelganger保護を有効にしている場合、再起動後にいくつかのアテステーションを見逃すことを覚えておいてください。これは正常です！

### MEV-Boostのセットアップ

[MEV-boost](https://boost.flashbots.net/)は、Merge後にProof-of-StakeバリデータにMEV報酬を提供するためにFlashbotsが提供するシステムです。

**Rocket Poolは、リターンを最大化し、プロトコルを他のステーキングサービスと競争力のあるものに保つために、すべてのノードでそれを使用することを要求しています。**

MEV-boostに接続するために、Beacon Node / Consensus Clientにいくつかの調整を行う必要があります。

MEV-boostは現在HoodiまたはMainnetで利用できないため、この時点でセットアップする必要はありません。
もちろん、この移行期間中に使用しなくてもペナルティは受けません。

利用可能になったら、ノードにインストールして接続する必要がある日付を発表します。
Flashbotsがその時点で従うべき手順を提供し、ここにリンクします。

::: danger 注
すべてのnode operatorがMEV-boostを有効にする必要があるという発表を行ったら、Beacon Nodeに適切にインストールして構成されていることを確認する必要があります！

これを怠ると、minipoolに[ペナルティが科せられます](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)。
:::

### フォールバックノードのセットアップ

Mergeは、InfuraやPocketなどのリモートプロバイダーと互換性がないため、プライマリがオフラインになったときにフォールバックExecution Clientとしてそれらを使用する機能を失います。

Smartnodeには依然としてフォールバックExecution Client（および現在はフォールバックConsensus Clientも）を提供する機能がありますが、自分で制御するExecution ClientとConsensus Clientを使用する必要があります。

フォールバックノードのセットアップの詳細については、[フォールバックノードガイド](../../node-staking/fallback)をご覧ください。

### Fee Distributorの初期化

[Smoothing Pool](./whats-new#smoothing-pool)にオプトインせず、すべてのpriority feesとMEV報酬を[fee distributorコントラクト](./whats-new#fee-recipients-and-your-distributor)に請求する場合、最終的にそれを初期化（チェーン上にコントラクトインスタンスを作成）して、withdrawal addressに報酬を請求できるようにする必要があります。

これは比較的安価な操作で、一度だけ実行する必要があります。

::: tip ヒント
fee distributorの初期化は**いつでも**実行できます。
初期化するずっと前からそのアドレスに報酬を蓄積させることができ、初期化後も残高は残ります。

オーバーヘッドコストを最小限に抑えるために、ガス価格が低いときに実施することをお勧めします。

報酬を請求するには**初期化する必要があります。**
:::

### Smoothing Poolへのオプトイン

すぐに[Smoothing Pool](./whats-new#smoothing-pool)を利用する予定がある場合は、最初のRedstone報酬期間が終了する前にオプトインして、「適格性」量を最大化する必要があります。

オプトインは次のコマンドを実行することで実施できます。

```shell
rocketpool node join-smoothing-pool
```

### 報酬の請求

Redstoneアップグレードは、高額で問題のある古い報酬システムを、はるかに安価で、RPLの自動再ステーク（部分的および全額の両方）をサポートし、そして最も重要なことに**いつでも報酬を請求できる**[全く新しいシステム](./whats-new#new-rewards-system)に置き換えます。

報酬の請求に時間制限がなくなり、多くの報酬インターバルを一度に請求する方がコスト効率が良いため、Smartnodeの自動報酬請求機能は**削除されました**。
次のコマンドで報酬を請求できるようになります。

```shell
rocketpool node claim-rewards
```

これにより、Redstoneアップグレード以降のすべての報酬インターバルにわたって蓄積したすべての報酬が表示されます。

## v1.4.3への復元

何らかの理由で気に入らないことがあり、以前のSmartnodeリリースに復元したい場合、簡単に実施できます。
Smartnodeはアップグレード時に以前のバージョンの設定を自動的にバックアップするため、単に以前のバージョン（ここでは**v1.4.3**を示します）を取得して、設定をバックアップに置き換えるだけです。

1. サービスを停止します。

```shell
rocketpool service stop
```

1. v1.4.3 CLIをダウンロードします。

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. v1.4.3パッケージをインストールします。

```shell
rocketpool service install -d
```

1. 古い設定をv1.4.3バックアップ設定に置き換えます。

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. すべての古い設定が現在使用されていることを確認します。

```shell
rocketpool service config
```

1. 問題がなければ、Smartnodeスタックを起動します。

```shell
rocketpool service start
```

準備完了！古いバージョンに戻り、サービスを開始した直後にアテステーションを開始するはずです。

::: danger 警告
v1.4.3は**非推奨**であり、Redstoneアップデートがデプロイされた後は使用できなくなります。
復元する必要がある場合は、コントラクトが更新される前にv1.5.0にアップグレードし直す計画を立ててください！
:::
