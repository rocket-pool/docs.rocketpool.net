import { Tab, Tabs } from "@rspress/core/theme";

# [ネイティブモード] RedstoneアップデートとThe Mergeのガイド

このガイドでは、**ネイティブモード**を使用している場合に、RedstoneアップデートとThe Mergeのためにノードを準備するために知っておくべきすべてをカバーします。

## v1.5.0にアップグレードする前にすべきこと

Smartnodeのv1.5.0以降にアップグレードする前に、以下のチェックリストを確認して準備ができていることを確認してください。

### フル実行クライアントへの切り替え

The Mergeでは、独自の実行クライアントを実行する必要があるため、InfuraやPocketなどのリモートプロバイダーを使用できなくなります。

この変更により、現在ライト実行クライアントを使用している場合は、v1.4のままフルクライアントに切り替え、同期が完了するまで待ってから、v1.5にアップグレードする必要があります。

### Engine APIのセットアップ

The Mergeは、実行クライアントがコンセンサスクライアントと通信する方法を変更します。
古いHTTPまたはWebSocketベースのRPCシステムを使用する代わりに、The Mergeでは実行クライアントによって公開されるEngine APIと呼ばれる新しいシステムが必要です。

これは、コンセンサスクライアントが古いProof-of-WorkマイニングシステムをProof-of-Stakeに置き換えることを可能にする特別な接続です。これはThe Mergeの中心です。
また、秘密トークンで**認証**されているため、コンセンサスクライアントのみが実行クライアントに接続でき、他の何も接続できません。

独自の実行クライアントとコンセンサスクライアントを管理しているため、Engine APIを手動でセットアップする必要があります。
その方法は、実行しているクライアントによって完全に異なります。

CoinCashewには、実行クライアントとコンセンサスクライアントでEngine APIをセットアップする方法に関する[優れた簡潔なガイド](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators)があります。
それを確認し、アップグレードする前に正しくアテストすることを確認して、新しい構成をテストしてください。

Smartnodeソフトウェアによって自動的に必要とされる正しい報酬受取人を使用するようにバリデータークライアントをセットアップする方法を以下に示します。

## v1.5.0へのアップグレード

Smartnodeスタックをv1.5.0にアップグレードすることは、他のアップグレードと同じです。
単純に[ここの通常の指示](../../node-staking/updates#updating-the-smartnode-stack)に従ってください。

## アップグレード後にすべきこと

ネイティブモードでは、アップグレード後に手動で行う必要があるいくつかのことがあります。

### アップグレードの成功を確認する

最初にすべきことは、ノードが正しく動作していることを確認することです。
次の手順を検討してください。

- 実行クライアント、コンセンサスクライアント、バリデータークライアント、およびSmartnodeデーモン（`rp-node`サービス）のログスクリプトを確認して、エラーなく正常に機能していることを確認します。
- Block Explorer（Grafanaダッシュボードや[https://beaconcha.in](https://beaconcha.in)など）で、引き続き正しくアテストしていることを確認します
  - Doppelganger保護を有効にしている場合は、再起動後にいくつかのアテステーションを見逃すことに注意してください。これは正常です！

### バリデータークライアントで報酬受取人をセットアップする

The Mergeの前にセットアップする**重要な**詳細の1つは、バリデータークライアントによって指定される**報酬受取人**です。
[概要記事](./whats-new#fee-recipients-and-your-distributor)で説明されているように、これは次の2つの値のいずれかになります。

- Smoothing Poolに**オプトインしている**場合、これは**Smoothing Poolコントラクト**のアドレスでなければなりません。アドレスは[公式コントラクトページ](/ja/protocol/contracts-integrations)から取得できます。
- Smoothing Poolに**参加していない**場合、これはノードの**報酬分配コントラクト**のアドレスでなければなりません。アドレスは`rocketpool node status`を実行することで、`Fee Distributor and Smoothing Pool`セクションの下で取得できます。

ネイティブモードでは、Smartnodeデーモンサービス`rp-node`を使用する場合はSmartnodeにこれを管理させるか、デーモンを使用しない場合は自分で管理するかを選択できます。

#### デーモンによる自動管理

Smartnodeデーモンは、ノードに適切な報酬受取人を自動的に決定し、変更された場合（Smoothing Poolへのオプトインおよびオプトアウトなど）に管理します。
これは**最も安全な**オプションです。なぜなら、Smartnodeは常に[ペナルティ](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を**防ぐ**値に設定されることを保証するからです。

これを行う方法は、正しい報酬受取人を含むファイルを維持し、その正確性を確保するために定期的に更新することです。
更新が必要な場合は、ファイルを変更し、バリデータークライアントを自動的に再起動して新しい受取人をロードします。新しいミニプールをステークした後にバリデータークライアントを再起動する方法と同様です。

以下でクライアントを選択して、セットアップ方法を学習してください。

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      バリデータークライアントサービスを変更し、`ExecStart`行の_前_に次の行を追加します。

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します。

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      これで、VCはSmartnodeデーモンによって管理されるファイルを使用し、報酬受取人が変更されるたびに自動的に再起動されます。
    </Tab>
    <Tab label="Nimbus">
      バリデータークライアントサービスを変更し、`ExecStart`行の_前_に次の行を追加します。

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します。

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      これで、VCはSmartnodeデーモンによって管理されるファイルを使用し、報酬受取人が変更されるたびに自動的に再起動されます。
    </Tab>
    <Tab label="Prysm">
      バリデータークライアントサービスを変更し、`ExecStart`行の_前_に次の行を追加します。

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します。

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      これで、VCはSmartnodeデーモンによって管理されるファイルを使用し、報酬受取人が変更されるたびに自動的に再起動されます。
    </Tab>
    <Tab label="Teku">
      バリデータークライアントサービスを変更し、`ExecStart`行の_前_に次の行を追加します。

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      例えば:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      次に、`ExecStart`行の_末尾_に次のコマンドライン引数を追加します。

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      これで、VCはSmartnodeデーモンによって管理されるファイルを使用し、報酬受取人が変更されるたびに自動的に再起動されます。
    </Tab>

  </Tabs>
</div>

#### 手動による報酬受取人管理

::: danger 警告
これを行うことにより、報酬受取人が常に正しいアドレスに設定されていることを確保する全責任を負います。

[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を読んで、構成に応じて何に設定する必要があるか、およびある値から別の値に安全に変更できる時期を理解してください。

これを怠ると、ミニプールにペナルティが科される可能性があります！
:::

**Redstoneが展開される前**、単純に使用しているネットワークのrETHアドレス（[公式コントラクトページ](/ja/protocol/contracts-integrations)にあります）を使用できます。
rETHアドレスは、何があっても常に安全です。

**Redstoneが展開された後**、`rocketpool node status`を介して、報酬受取人に設定すべき正確なアドレスを確認できます。例えば、Smoothing Poolにオプトインしている場合、Smoothing Poolのアドレスが表示され、報酬受取人として使用する必要があることが示されます。

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Smoothing Poolにオプトイン*していない*場合は、報酬分配アドレスが表示され、報酬受取人として使用する必要があることが示されます。

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

以下でコンセンサスクライアントを選択して、構成方法を学習してください。

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      バリデータークライアントのサービス定義ファイルに次のコマンドライン引数を追加します。

      ```
      --suggested-fee-recipient `address`
      ```

      ここで`address`は:

      - Redstoneアップデートが展開される**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例えば、Mainnetでは`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneが展開された後、ノードの**報酬分配器**。コントラクトアップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインした場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`は、いつでも使用すべき正しい報酬受取人を表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、報酬受取人に関する条件と期待を理解してください。**
    </Tab>
    <Tab label="Nimbus">
      Nimbusのサービス定義ファイルに次のコマンドライン引数を追加します。

      ```
      --suggested-fee-recipient=`address`
      ```

      ここで`address`は:

      - Redstoneアップデートが展開される**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例えば、Mainnetでは`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneが展開された後、ノードの**報酬分配器**。コントラクトアップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインした場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`は、いつでも使用すべき正しい報酬受取人を表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、報酬受取人に関する条件と期待を理解してください。**
    </Tab>
    <Tab label="Prysm">
      バリデータークライアントのサービス定義ファイルに次のコマンドライン引数を追加します。

      ```
      --suggested-fee-recipient `address`
      ```

      ここで`address`は:

      - Redstoneアップデートが展開される**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例えば、Mainnetでは`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneが展開された後、ノードの**報酬分配器**。コントラクトアップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインした場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`は、いつでも使用すべき正しい報酬受取人を表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、報酬受取人に関する条件と期待を理解してください。**
    </Tab>
    <Tab label="Teku">
      バリデータークライアントのサービス定義ファイルに次のコマンドライン引数を追加します。

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      ここで`address`は:

      - Redstoneアップデートが展開される**前**は[rETHアドレス](/ja/protocol/contracts-integrations/#token-contracts)（例えば、Mainnetでは`0xae78736Cd615f374D3085123A210448E74Fc6393`）
      - Redstoneが展開された後、ノードの**報酬分配器**。コントラクトアップグレードが発生したら`rocketpool node status`で取得できます
      - Smoothing Poolにオプトインした場合は[Smoothing Poolアドレス](/ja/protocol/contracts-integrations/#protocol-contracts)

      念のため、`rocketpool node status`は、いつでも使用すべき正しい報酬受取人を表示します。

      **[ペナルティ仕様](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)を注意深く読んで、報酬受取人に関する条件と期待を理解してください。**
    </Tab>

  </Tabs>
</div>

### MEV-Boostのセットアップ

[MEV-boost](https://boost.flashbots.net/)は、The Merge後にProof-of-StakeバリデーターにMEV報酬を提供するためにFlashbotsが提供するシステムです。

**Rocket Poolは、すべてのノードがこれを使用して収益を最大化し、プロトコルを他のステーキングサービスと競争力のある状態に保つことを要求します。**

MEV-boostに接続するために、Beacon Node / コンセンサスクライアントにいくつかの調整を行う必要があります。

MEV-boostは現在HoodiまたはMainnetでは利用できないため、現時点でセットアップする必要はありません。
もちろん、この移行期間中に使用しないことでペナルティを受けることはありません。

利用可能になったら、ノードにインストールして接続する必要がある日付を発表します。
Flashbotsはその時点でフォローできる手順を提供し、ここにリンクします。

::: danger 注意
MEV-boostをすべてのノードオペレーターが有効にする必要があるという発表を行った後は、Beacon Nodeに適切にインストールおよび構成されていることを確認する必要があります！

これを怠ると、ミニプールに[ペナルティ](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)が科されます。
:::

### フォールバックノードのセットアップ

The MergeはInfuraやPocketなどのリモートプロバイダーと互換性がないため、プライマリがオフラインになった場合にフォールバック実行クライアントとしてそれらを使用する機能が失われます。

Smartnodeには依然としてフォールバック実行クライアント（および現在はフォールバックコンセンサスクライアント）を提供する機能がありますが、今後は制御する実行クライアントとコンセンサスクライアントを使用する必要があります。

フォールバックノードのセットアップの詳細については、[フォールバックノードガイド](../../node-staking/fallback)を参照してください。

### 報酬分配器の初期化

[Smoothing Pool](./whats-new#smoothing-pool)にオプトインせず、すべての優先手数料とMEV報酬を[報酬分配コントラクト](./whats-new#fee-recipients-and-your-distributor)に請求する予定の場合、最終的にはそれを初期化（チェーン上にコントラクトインスタンスを作成）して、引き出しアドレスに報酬を請求する必要があります。

これは比較的安価な操作で、一度だけ行う必要があります。

::: tip ヒント
報酬分配器の初期化は**いつでも**行うことができます。
初期化する前に長期間報酬を蓄積させることができ、初期化後も残高は残ります。

ガスプライスが低いときに行って、オーバーヘッドコストを最小限に抑えることをお勧めします。

報酬を請求するには**初期化する必要がある**ことに注意してください。
:::

### Smoothing Poolへのオプトイン

すぐに[Smoothing Pool](./whats-new#smoothing-pool)を利用する予定の場合は、最初のRedstone報酬期間の終了前にオプトインして、「適格性」額を最大化する必要があります。

オプトインは、次のコマンドを実行することで行えます。

```shell
rocketpool node join-smoothing-pool
```

### 報酬の請求

Redstoneアップグレードは、高価で問題のある古い報酬システムを、より安価で、RPLの自動再ステーキング（部分的および全額の両方）をサポートし、最も重要なことに**いつでも報酬を請求できる**[まったく新しいシステム](./whats-new#new-rewards-system)に置き換えます。

報酬を請求する時間制限がなくなり、多くの報酬間隔を一度に請求する方が安くなるため、Smartnodeの自動報酬請求機能は**削除されました**。
次のコマンドを介して報酬を請求できるようになります。

```shell
rocketpool node claim-rewards
```

これにより、Redstoneアップグレードから始まるすべての報酬間隔にわたって蓄積されたすべての報酬が表示されます。
