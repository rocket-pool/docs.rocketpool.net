import { Tab, Tabs } from "@rspress/core/theme";

# Smartnode v1.3.xへのアップグレード

Smartnodeスタックのバージョン1.3.0には、ユーザーが知っておくべきいくつかの重要な変更が含まれています。
これらは、node operatorの体験を大幅に改善し、Rocket Poolのローンチ以来、ユーザーから要望されていた多くの機能に対応するように設計されています。

このガイドでは、Smartnodeの古いバージョンからv1.3.x以降への移行プロセスを説明します。

## 設定ファイルの変更

v1.3.0では、Smartnodeの設定管理方法に重要な変更が導入されています。
以前にSmartnode設定を手動で変更したことがある場合は、次の変更に注意する必要があります。

- `config.yml`ファイルが削除されました。すべての情報がSmartnodeスタックに直接組み込まれるようになったため、ユーザーがSmartnodeが正常に動作しなくなるような方法でファイルを誤って変更することがなくなりました。
  - 以前の一部だったユーザー設定可能なパラメータはすべて、新しい`service config` Terminal UIの設定になりました。

- `settings.yml`ファイルは、`user-settings.yml`という新しいファイルに置き換えられました。これには、Smartnodeのすべてのユーザー設定可能部分の設定が含まれています。
  - このファイルは**直接変更することを意図していません**。代わりに、新しい`service config` Terminal UIを通じて変更する必要があります。

- `chains`フォルダが削除されました。Execution Client(ETH1)、Beacon Node、Validator Clientを起動するためのスクリプトは、`scripts`フォルダにあります。

- `docker-compose` YAMLファイルが削除されました。各コンテナは`templates`フォルダに独自のファイルを持つようになりました。`rocketpool service start`を実行すると、これらのテンプレートが設定で埋められ、自動的に`runtime`フォルダに配置されます。
  - テンプレートまたはランタイムファイルを変更することはお勧めしません。代わりに、`override`フォルダの各コンテナの**override**ファイルを使用してコンテナのカスタマイズを入力してください。これらのファイルは`runtime`のDockerファイルを上書きするため、自由にカスタマイズできます。
  - `override`のファイルは**Smartnodeのアップグレードと再インストール時に保持される**ため、一度だけ作成する必要があります。
  - このオーバーライドメカニズムを介して`docker-compose`ファイルを変更することに興味がある場合は、[このセクション](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)を参照してください

## 新しいバージョンのインストール

新しいバージョンのインストールは、非常に馴染みのあるものになるはずです。

まず、通常どおりサービスを停止して、新しいCLIをダウンロードします。

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">
      Rocket Poolサービスを停止します。

      ```
      rocketpool service stop
      ```

      システム用の新しいSmartnode CLIをダウンロードします(以下のタブから選択してください)。

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            `x64`システム(ほとんどの通常のマシン)の場合:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            `arm64`システムの場合:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            `x64`システム(ほとんどのMac)の場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            M1搭載のMac miniなど、`arm64`システムの場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      次に、installコマンドを実行します。

      ```
      rocketpool service install -d
      ```

      `-d`フラグは、Dockerなどのシステム依存関係を無視するように指示します。すでに持っているためです。

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">注意</p>
        v1.3.0以降、**インストールするネットワークを指定する必要がなくなりました!**
        新しいSmartnodeは、すでに使用しているネットワークを認識し、新しいTerminal UIを使用してネットワークを動的に変更できるようになります。
      </p>
    </Tab>
    <Tab label="Native Mode">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        これはSmartnodeスタック自体のみを更新します - ExecutionクライアントとConsensusクライアントは**更新されません**。
        これは手動で行う必要があります([手動更新ガイド](../node-staking/updates#manually-updating-the-eth1-or-eth2-client)を参照して、その方法を学んでください)。
      </p>

      Rocket Poolサービスを停止します。

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      新しいSmartnode CLIとデーモンバイナリをダウンロードします。

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            `x64`システム(ほとんどの通常のマシン)の場合:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            `arm64`システムの場合:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            `x64`システム(ほとんどのMac)の場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            M1搭載のMac miniなど、`arm64`システムの場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">注意</p>
        v1.3.0以降、`config.yml`は削除されました。
        **インストーラーパッケージをダウンロードして展開する必要はなくなりました。**
      </p>
      次に、Smartnodeディレクトリに`old_config_backup`というバックアップフォルダを作成し、古い設定ファイル(`config.yml`と`settings.yml`)をそこに移動します。
      Smartnodeはこれらを使用して、設定を新しいシステムに移行します。

      たとえば、Nativeセットアップガイドに従い、Smartnodeディレクトリが`/srv/rocketpool`の場合:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      次に、`rp-node`のサービス定義ファイルを変更します。

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      `ExecStart`行を次のように置き換えます。

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      `--config`フラグが削除され、`--settings`が`user-settings.yml`を指すようになったことに注意してください。
      **このファイルがまだ存在しないことを心配しないでください。次のステップで自動的に生成されます。**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        Oracle DAOメンバーの場合、`rp-watchtower`サービスについても上記のプロセスを繰り返す_必要があります_。
      </p>

      最後に、サービス定義をリロードします。

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

インストール後、すべての古い設定ファイルは、Smartnodeディレクトリの`old_config_backup`という名前のフォルダに移動されます(デフォルトでは`~/.rocketpool/old_config_backup`)。
何らかの理由で参照する必要がある場合は、そこで見つけることができます。

**このバックアップからv1.2.4に戻す手順を探している場合は、このページの最後の[以前の設定に戻す](#reverting-to-your-previous-configuration)セクションまでスクロールしてください。**

## Terminal UIでSmartnodeを設定する

新しいCLIとパッケージをインストールしたので、以前のすべての設定が保持され、新しいシステムに移行されています。
次のステップでは、`rocketpool service config`を実行する必要があります。
この機能は以前のバージョンと比較してかなり異なって見えます。v1.3.0では**Terminal UI**が導入されています。これは、Smartnodeを設定するためのターミナルベースの動的ユーザーインターフェースです。

移行プロセス後にDockerコンテナを起動する前に実行して、設定を表示し、すべての変更が正常に移行されたことを確認し、必要な他の設定を更新する必要があります。

最初に実行すると、この挨拶画面が表示されます(**DockerまたはHybrid mode**を使用していた場合):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip 注意
**Native Modeユーザー**は、Smartnodeがネイティブモードで動作していることを示す、わずかに異なる文言のこの画面が表示されます。
:::

TUIは**ウィザード**で始まります。これにより、Smartnodeの最も重要なパラメータ(クライアントモードと選択など)を迅速かつ簡単に変更できます。

**ウィザードの各ページを移動するときに、以前の設定がすでに強調表示されているため、以前の設定を覚えておく必要はありません。**

:::warning 注意
**このウィザードの詳細なウォークスルーについては、次のページをご覧ください:**

- **Docker Mode**の場合は、[新しいDocker設定ガイド](../node-staking/config-docker)をご覧ください。

- **Hybrid Mode**ユーザー: Hybrid ModeがSmartnodeの**ファーストクラス機能**になり、設定が*以前よりもはるかに簡単*になりました。[新しいDocker設定ガイド](../node-staking/config-docker)にアクセスして、それに従ってください。ExecutionクライアントモードとConsensusクライアントモードを選択するように求められたら、それに応じて**Externally Managed**を選択してください。

- **Native Mode**の場合は、[新しいNative設定ガイド](../node-staking/config-native)をご覧ください。

:::

このウィザードを移動して、すべての設定が正しいことを確認します。

完了すると、必要に応じて**保存する前にすべての設定を確認する**オプションがあります。
これには、**RPLクレームガス閾値**や**Gethピアの最大数**など、ウィザードでカバーされていない設定が含まれます。

**メイン設定画面**は、以前の設定を確認するために見るべきもので、次のようになります(DockerおよびHybrid modeユーザーの場合):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip 注意
**Native Modeユーザー**には、Native modeに固有のわずかに異なる画面が表示され、それに関連する設定のみが表示されます。
:::

この新しいUIを自由に探索し、適切と思われる設定を調整してください。
`矢印キー`を使用して移動し、`Enter`を押してカテゴリに入るか、行った設定への変更を確認します。

カテゴリの編集が終了したら`Esc`を押して、このホーム画面に戻ります。

変更を保存してSmartnodeスタックを起動する準備ができたら、`Tab`を押して画面下部のボタンに移動し、`Review Changes and Save`を選択します(矢印キーで緑色にします)。
`Enter`を押すと**レビューページ**に移動し、前回`rocketpool service config`を実行してから変更したすべてを確認できます。

すべての変更が存在することを確認してから、`Enter`をもう一度押して保存します。
画面には、変更を適用するために再起動する必要があるコンテナが表示されますが、移行中であるため、すでにコンテナをオフにしており、すべて再起動されます。

## Smartnodeスタックの起動

設定を保存すると、ターミナルがコンテナを自動的に再起動するかどうかを尋ねます(Native modeを使用している場合を除く)。
自動的に起動できない/しない場合は、次のコマンドで手動で起動できます。

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">```shell rocketpool service start ```</Tab>
    <Tab label="Native Mode">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

起動したら、すべてが意図したとおりに動作していることを確認できます。

`rocketpool service version`コマンドを使用して、Smartnodeとクライアントコンテナの正しいバージョンがあることを確認します。

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

`rocketpool service logs eth1`および`rocketpool service logs eth2`コマンドを使用して、Execution client(旧ETH1クライアント)およびConsensus client(旧ETH2クライアント)のログを監視します。
エラーに注意して、遭遇した場合は[Discordサーバーにアクセスしてヘルプを求めてください](https://discord.com/invite/rocketpool)。

## 以前の設定に戻す

何らかの理由でSmartnodeスタックのv1.2.4に戻す必要がある場合でも、心配しないでください!
すべての古い設定ファイルはバックアップディレクトリに保存されており、以前のセットアップを復元するために簡単に取得できます。

以下のタブから使用しているモードを選択し、指示に従ってください。

<div className="p-3">
  <Tabs>
    <Tab label="Docker or Hybrid Mode">
      まず、システム用のv1.2.4 CLIでCLIを置き換えます。
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            `x64`システム(ほとんどの通常のマシン)の場合:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            `arm64`システムの場合:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            `x64`システム(ほとんどのMac)の場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            M1搭載のMac miniなど、`arm64`システムの場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      次に、`old_config_backup`フォルダからすべての古い設定ファイルをSmartnodeのフォルダにコピーします。

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      あとは、Dockerコンテナを再起動するだけです。

      ```shell
      rocketpool service start
      ```

      完了! 古い設定が戻りました。

    </Tab>
    <Tab label="Native Mode">
      Rocket Poolサービスを停止します。

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            `x64`システム(ほとんどの通常のマシン)の場合:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            `arm64`システムの場合:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            `x64`システム(ほとんどのMac)の場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            M1搭載のMac miniなど、`arm64`システムの場合:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      以前の設定ファイルをSmartnodeディレクトリにコピーします。

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      次に、`rp-node`のサービス定義ファイルを元に戻します。

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      `ExecStart`行を次のように置き換えます。

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">注意</p>
        Oracle DAOメンバーの場合、`rp-watchtower`サービスについても上記のプロセスを繰り返す_必要があります_。
      </p>

      最後に、サービス定義をリロードしてサービスを再起動します。

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      完了! 古い設定が戻りました。
    </Tab>

  </Tabs>
</div>
