import { Tab, Tabs } from "@rspress/core/theme";

# Configurazione del Dashboard Grafana

Ora che hai il tuo nodo attivo e funzionante, probabilmente vorrai avere un modo conveniente per monitorare tutto a colpo d'occhio per assicurarti che funzioni correttamente (e che tipo di guadagni sta generando per te).

Ci sono molti strumenti là fuori che fanno questo lavoro.
Uno dei più popolari si chiama [Grafana](https://grafana.com/) - un sistema di dashboard facile da usare e per uso generale a cui puoi accedere con un browser.

Rocket Pool viene fornito di serie con il supporto per Grafana e le sue dipendenze; include persino un dashboard pre-costruito per ciascuno dei client Consensus.
Ad esempio, ecco un'istantanea di come appare il dashboard sulla rete di test Hoodi:

![](./images/grafana-1.3.jpg)

Il dashboard standard include le seguenti informazioni tutte in un formato conveniente:

- **In alto a sinistra:** alcune statistiche importanti sulla salute e le prestazioni della tua macchina, e eventuali aggiornamenti di sistema in sospeso
- **In alto a destra:** l'attività e le prestazioni dei tuoi validatori sulla Beacon Chain, insieme ad alcune statistiche del client Execution e Consensus
- **In basso a sinistra:** dettagli sull'intera rete Rocket Pool, per riferimento
- **In basso a destra:** dettagli sulle tue ricompense di staking, sia ETH che RPL

In questa guida, ti mostreremo come abilitare il sistema di metriche di Rocket Pool in modo da poter utilizzare questo dashboard - o persino costruirne uno tuo!

## Panoramica dello Stack di Metriche di Rocket Pool

Se scegli di abilitare le metriche durante il processo di configurazione dello Smartnode, il tuo nodo aggiungerà i seguenti processi:

- [Prometheus](https://prometheus.io/) - un sistema di raccolta, archiviazione e reporting dei dati che cattura tutte le metriche che vedi sopra (e molte altre) e le memorizza, in modo che possano essere visualizzate nel tempo
- Il [Node Exporter](https://github.com/prometheus/node_exporter) di Prometheus - un servizio che raccoglie informazioni sulla salute della tua macchina (come utilizzo CPU, utilizzo RAM, spazio disco libero e spazio swap, ecc.) e le riporta a Prometheus
- Grafana, lo strumento che espone i dati di Prometheus attraverso un sito web conveniente ospitato sul tuo nodo
- Un set opzionale di script personalizzati che riporteranno eventuali aggiornamenti del sistema operativo disponibili a Prometheus, in modo che tu sappia se il tuo sistema necessita di essere aggiornato

La configurazione predefinita creerà container Docker con tutti questi servizi che vivono insieme al resto dei container Docker dello Smartnode.
Aprirà una porta sulla tua macchina nodo per Grafana, in modo da poter accedere al suo dashboard da qualsiasi macchina sulla tua rete locale con un browser.

## Abilitazione del Server di Metriche

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Abilitare le metriche in modalità Docker è la più facile di tutte.

      Inizia eseguendo nuovamente il comando di configurazione dello Smartnode:

      ```shell
      rocketpool service config
      ```

      Vai alla sezione `Monitoring / Metrics` e spunta la casella `Enable Metrics`.

      Per coloro che preferiscono ottimizzare le impostazioni delle porte, puoi farlo qui.
      Nota che tutte queste porte sono limitate alla rete interna di Docker ad eccezione della porta Grafana - quella sarà aperta sulla tua macchina (in modo da potervi accedere tramite un browser da altre macchine, come il tuo desktop o telefono) quindi potresti voler cambiare quella se la porta predefinita è in conflitto con qualcosa che hai già.

      Salva ed esci, e lo smartnode avvierà i container Docker di Prometheus, Node Exporter e Grafana per te.

      Modificherà anche i tuoi client Consensus e Validator in modo che espongano le proprie metriche a Prometheus.

      Il tracker degli aggiornamenti del sistema operativo e di Rocket Pool **non è installato per impostazione predefinita** per massima flessibilità, ma il processo è semplice.
      Se desideri installarlo in modo che il tuo dashboard mostri quanti aggiornamenti sono disponibili per il tuo sistema, puoi farlo con questo comando:

      ```shell
      rocketpool service install-update-tracker
      ```

      Sotto il cofano, questo installerà un servizio che si collega al gestore di pacchetti del tuo sistema operativo, controlla periodicamente gli aggiornamenti e invia tali informazioni a Prometheus.
      Questo servizio è diverso per ogni sistema operativo, ma è stato confermato funzionare sui seguenti:

      - Ubuntu 20.04+
      - Debian 9 e 10
      - CentOS 7 e 8
      - Fedora 34


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        L'abilitazione automatica del servizio è incompatibile con SELinux.
        Se il tuo sistema ha SELinux abilitato per impostazione predefinita (come nel caso di CentOS e Fedora), il comando di installazione ti porterà _quasi al traguardo_ ma ti fornirà anche istruzioni su come completare il processo manualmente alla fine.
      </p>


      Durante questo controllo, confronterà anche la versione installata di Rocket Pool Smartnode con l'ultima versione, e ti informerà se c'è una nuova versione disponibile.

      Se hai abilitato il tracker degli aggiornamenti, l'ultimo passaggio è riavviare il Node Exporter con il seguente comando:

      ```shell
      docker restart rocketpool_exporter
      ```

      Dopodiché, dovresti essere a posto.
    </Tab>
    <Tab label="Hybrid">
      La modalità Hybrid funziona in modo simile alla modalità Docker; l'unica differenza è che devi aggiungere manualmente i flag appropriati della riga di comando per abilitare le metriche alla definizione del servizio del tuo client Execution e Consensus.

      Prima, aggiorneremo il tuo client Execution.
      Apri il file unit `systemd` che hai creato quando hai installato il tuo client Execution e assicurati che abbia i flag corretti, in base al client che stai utilizzando:

      <div className="p-3">
        <Tabs>
          <Tab label="Geth">
            ```
            --metrics --metrics.addr 0.0.0.0 --metrics.port 9105
            ```
          </Tab>
          <Tab label="Nethermind">
            ```
            --Metrics.Enabled true --Metrics.ExposePort 9105
            ```
          </Tab>
          <Tab label="Besu">
            ```
            --metrics-enabled --metrics-host=0.0.0.0 --metrics-port=9105
            ```
          </Tab>
        </Tabs>
      </div>

      Successivamente, aggiorneremo il tuo client Consensus.
      Apri il file unit `systemd` che hai creato quando hai installato il tuo client Consensus e assicurati che abbia i flag corretti, in base al client che stai utilizzando:

      <div className="p-3">
        <Tabs>
          <Tab label="Lighthouse">
            ```
            --metrics --metrics-address 0.0.0.0 --metrics-port 9100 --validator-monitor-auto
            ```
          </Tab>
          <Tab label="Lodestar">
            ```
            --metrics --metrics.address 0.0.0.0 --metrics.port 9100
            ```
          </Tab>
          <Tab label="Nimbus">
            ```
            --metrics --metrics-address=0.0.0.0 --metrics-port=9100
            ```
          </Tab>
          <Tab label="Prysm">
            ```
            --monitoring-host 0.0.0.0 --monitoring-port 9100
            ```

            Se vedi il flag `--disable-monitoring`, rimuovilo.
          </Tab>
          <Tab label="Teku">
            ```
            --metrics-enabled=true --metrics-interface=0.0.0.0 --metrics-port=9100 --metrics-host-allowlist=*
            ```
          </Tab>

        </Tabs>
      </div>

      Se hai già questi flag impostati e stai utilizzando porte diverse per il monitoraggio del tuo validatore solo, lasciali come sono e prendi nota di quali porte stai utilizzando.

      Ora, scorri verso l'alto e segui le istruzioni nella scheda `Docker` di questa sezione per completare il processo - tenendo presente che devi sostituire le porte elencate lì con eventuali porte personalizzate che utilizzi quando esegui `rocketpool service config`.

    </Tab>
    <Tab label="Native">
      L'installazione nativa di Grafana e Prometheus è consigliata solo per utenti avanzati. Richiede competenze di amministrazione Linux come `systemd`, permessi dei file, gestione di utenti e reti.

      Prima, assicurati che il tuo client Execution e il client Consensus abbiano le metriche abilitate. Fai riferimento alla scheda 'Hybrid' per i dettagli.

      Successivamente, controlla i pacchetti precompilati di prometheus e node_exporter nella [pagina di download ufficiale](https://prometheus.io/download/).
      Scegli i pacchetti con l'architettura appropriata per la tua piattaforma (amd64 o arm64).
      È consigliata la versione LTS (Long Time Support) più recente di Prometheus.

      Ad esempio, per scaricare prometheus v2.45.3 LTS e node_exporter v1.7.0 per Linux amd64 con `wget` fai:

      ```shell
      wget https://github.com/prometheus/prometheus/releases/download/v2.45.3/prometheus-2.45.3.linux-amd64.tar.gz
      wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
      wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
      ```

      Estrai gli eseguibili di prometheus e node_exporter dagli archivi scaricati.

      ```shell
      sudo tar -zxvf prometheus-2.45.3.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/prometheus' --strip-components=1
      sudo tar -zxvf node_exporter-1.7.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/node_exporter' --strip-components=1
      sudo tar -zxvf alertmanager-0.26.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/alertmanager' --strip-components=1
      ```

      Crea directory per le configurazioni di prometheus e alertmanager.

      ```shell
      sudo mkdir /etc/prometheus
      sudo mkdir /etc/alertmanager
      sudo mkdir /var/lib/prometheus
      sudo mkdir /var/lib/alertmanager
      ```

      Crea il file `/etc/prometheus/prometheus.yml` con il seguente contenuto:

      ```yaml
      global:
      scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
      scrape_timeout: 12s # Timeout must be shorter than the interval
      evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.

      scrape_configs:
      - job_name: "prometheus"
      static_configs:
      - targets: ["localhost:9091"]

      - job_name: "node"
      static_configs:
      - targets: ["localhost:9103"]
      #     - targets: ['localhost:9103', 'node_hostname:9103']
      - job_name: "eth1"
      static_configs:
      - targets: ["localhost:9105"]
      # Uncomment the line below if you are using geth as Execution Client
      #metrics_path: /debug/metrics/prometheus

      - job_name: "eth2"
      static_configs:
      - targets: ["localhost:9100"]

      - job_name: "validator"
      static_configs:
      - targets: ["validator:9101"]

      - job_name: "rocketpool"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["node:9102"]

      - job_name: "watchtower"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["watchtower:9104"]

      alerting:
      alertmanagers:
      - static_configs:
      - targets: ["localhost:9093"]
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Cambia i numeri di porta per il client Execution e il client Consensus se necessario.

        Potresti eseguire il tuo nodo su un host diverso dall'host che esegue prometheus. In tal caso
        installa node_exporter sull'host del nodo rocketpool e aggiorna i `targets` del job `node` per includere tutte le macchine che vuoi monitorare.
        Regola anche `metrics_path` se il tuo client Execution è geth - espone un endpoint non standard per le metriche.
      </p>

      Crea il file `/etc/alertmanager/alertmanager.yml` con il seguente contenuto:

      ```yaml
      global:
      # ResolveTimeout is the default value used by alertmanager if the alert does
      # not include EndsAt, after this time passes it can declare the alert as resolved if it has not been updated.
      # This has no impact on alerts from Prometheus, as they always include EndsAt.
      # default = 5m
      resolve_timeout: 5m

      route:
      # The labels by which incoming alerts are grouped together.
      group_by: ["alertname"]
      # How long to initially wait to send a notification for a group
      # of alerts. Allows to wait for an inhibiting alert to arrive or collect
      # more initial alerts for the same group.
      group_wait: 30s
      # How long to wait before sending a notification about new alerts that
      # are added to a group of alerts for which an initial notification has
      # already been sent. (Usually ~5m or more.)
      group_interval: 5m
      # How long to wait before sending a notification again if it has already been sent successfully for an alert.
      repeat_interval: 4h
      routes:
      # severity=info: Don't send the follow-up resolved notification.
      - match:
      severity: info
      continue: false
      # The notification destination
      receiver: "node_operator_no_resolved"
      # all other alerts get sent notifications for the initial firing _and_ resolved notifications.
      - receiver: "node_operator_default"
      #match: We want this to match all alerts (severity=info is first though so it will stop)

      # The notification destination
      receiver: "node_operator_default"

      receivers:
      - name: "node_operator_default"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"

      - name: "node_operator_no_resolved"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"
      send_resolved: false

      inhibit_rules:
      # Inhibit rules mute a new alert (target) that matches an existing alert (source).
      - source_match:
      # if the existing alert (source) is severity=critical
      severity: "critical"
      target_match:
      # and the new alert (target) is severity=warning
      severity: "warning"
      # and the alertname, job, and instance labels have the same value
      equal: ["alertname", "job", "instance"]
      ```

      Crea un utente di sistema per prometheus e alertmanager.

      ```shell
      sudo useradd -r -s /sbin/nologin prometheus
      sudo useradd -r -s /sbin/nologin alertmanager
      ```

      Cambia la proprietà e i permessi dei file di prometheus/alertmanager.

      ```shell
      sudo chown prometheus:prometheus /usr/local/bin/prometheus
      sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
      sudo chown prometheus:prometheus /usr/local/bin/node_exporter
      sudo chown -R prometheus:prometheus /etc/prometheus
      sudo chown -R alertmanager:alertmanager /etc/alertmanager
      sudo chown -R prometheus:prometheus /var/lib/prometheus
      sudo chown -R alertmanager:alertmanager /var/lib/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/prometheus
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/node_exporter
      ```

      Crea il file `/lib/systemd/system/node-exporter.service` per la configurazione del servizio node_exporter.

      ```
      [Unit]
      Description=Node metrics exporter for Prometheus
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=node-exporter
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9103

      [Install]
      WantedBy=multi-user.target
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se vuoi cambiare la porta su cui node_exporter è in esecuzione, modifica il comando al parametro `ExecStart`. La porta predefinita è 9100.
      </p>

      Crea il file `/lib/systemd/system/prometheus.service` per la configurazione del servizio prometheus.

      ```
      [Unit]
      Description=Prometheus instance
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=prometheus
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --web.listen-address=:9091

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se vuoi cambiare la porta su cui prometheus è in esecuzione, modifica il comando al parametro `ExecStart`. La porta predefinita è 9090.
      </p>

      Crea il file `/lib/systemd/system/alertmanager.service` per la configurazione del servizio alertmanager.

      ```
      [Unit]
      Description=Alertmanager instance
      Documentation=https://prometheus.io/docs/alerting/latest/alertmanager/
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=alertmanager
      Group=alertmanager
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/alertmanager
      RuntimeDirectory=alertmanager
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/alertmanager --config.file /etc/alertmanager/alertmanager.yml --web.listen-address=:9093

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se vuoi cambiare la porta su cui alertmanager è in esecuzione, modifica il comando al parametro `ExecStart`. La porta predefinita è 9093.
      </p>

      Fai sapere a `systemd` dei nuovi servizi.

      ```shell
      sudo systemctl daemon-reload
      ```

      Abilita e avvia il servizio node-exporter.

      ```shell
      sudo systemctl enable node-exporter
      sudo systemctl start node-exporter
      ```

      Controlla lo stato del servizio per assicurarti che sia in esecuzione.

      ```shell
      sudo systemctl status node-exporter
      ```

      Abilita e avvia il servizio prometheus.

      ```shell
      sudo systemctl enable prometheus
      sudo systemctl start prometheus
      ```

      Abilita e avvia il servizio alertmanager.

      ```shell
      sudo systemctl enable alertmanager
      sudo systemctl start alertmanager
      ```

      Controlla lo stato del servizio per assicurarti che sia in esecuzione.

      ```shell
      sudo systemctl status prometheus
      sudo systemctl status alertmanager
      ```

      Configura il repository dei pacchetti per Grafana.

      ```shell
      sudo apt-get update
      sudo apt-get install -y apt-transport-https software-properties-common
      sudo mkdir -p /etc/apt/keyrings/
      wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
      echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
      ```

      Installa Grafana.

      ```shell
      sudo apt-get update
      sudo apt-get install grafana
      ```

      Verifica le impostazioni in `/etc/grafana/grafana.ini`. Cambia la `http_port` a 3100 per essere in linea con le altre sezioni fornite in questo documento.

      Configura la sorgente dati per visualizzare le metriche da Prometheus in Grafana. Crea il file `/etc/grafana/provisioning/datasources/prometheus.yml`.

      ```yaml
      apiVersion: 1

      deleteDatasources:
      - name: Prometheus
      orgId: 1

      datasources:
      - name: Prometheus
      type: prometheus
      access: proxy
      orgId: 1
      url: http://localhost:9091
      basicAuth: false
      isDefault: true
      version: 1
      editable: true
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Modifica `url` se hai cambiato la porta di ascolto di Prometheus.
      </p>

      Abilita e avvia il servizio per Grafana.

      ```shell
      sudo systemctl daemon-reload
      sudo systemctl enable grafana-server
      sudo systemctl start grafana-server
      ```

      Controlla se Grafana è attivo e funzionante.

      ```shell
      sudo systemctl status grafana-server
      ```

      Questo è praticamente tutto.
    </Tab>

  </Tabs>
</div>

## Configurare il firewall per consentire le connessioni per il monitoraggio

::: warning NOTA
Se hai UFW abilitato come indicato nella sezione [Protezione del tuo nodo](./securing-your-node), dovrai aprire alcune porte per consentire connessioni locali tra Prometheus e i tuoi client Execution/Consensus. Segui i passaggi seguenti.
:::

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Esegui quanto segue e sostituisci le porte secondo necessità:

      ```shell
      RP_NET=$(docker inspect rocketpool_net | grep -Po "(?<=\"Subnet\": \")[0-9./]+")
      sudo ufw allow from $RP_NET to any port 9105 comment "Allow Prometheus access to Execution Client"
      sudo ufw allow from $RP_NET to any port 9100 comment "Allow Prometheus access to Consensus Client"
      sudo ufw allow from $RP_NET to any port 9103 comment "Allow Prometheus access to Exporter"
      ```
    </Tab>
    <Tab label="Native">
      Se il tuo nodo RocketPool e Prometheus risiedono su host diversi, devi configurare il firewall sull'host del nodo per consentire il traffico in entrata
      dall'IP dell'host Prometheus alle porte di monitoraggio del nodo.
      Devi anche configurare UFW sulla macchina Prometheus per consentire il traffico in uscita dall'host Prometheus all'host del nodo RocketPool.

      Avendo l'IP dell'host del nodo `192.168.1.5` e l'IP dell'host Prometheus `192.168.1.6`, le regole UFW per il nodo saranno:

      ```shell
      sudo ufw allow from 192.168.1.6 to any port 9100:9105 proto tcp comment 'Allow Prometheus host to scrape metrics of this host'
      ```

      E per l'host Prometheus:

      ```shell
      sudo ufw allow out from any to 192.168.1.5 port 9100:9105 proto tcp comment 'Allow this host to scrape node metrics'
      ```

      Supponendo che la porta di ascolto di Grafana sia 3100, continua a leggere per scoprire come esporre Grafana nella tua rete.
    </Tab>

  </Tabs>
</div>

Puoi quindi aprire il firewall per consentire ai dispositivi esterni di accedere al tuo dashboard Grafana.

<div className="p-3">
  <Tabs>
    <Tab label="Network">
      Usa questo se vuoi accedere a Grafana da qualsiasi macchina all'interno della tua rete locale, ma negare l'accesso ovunque altrove.
      Questo sarà il caso d'uso più comune.

      Controlla prima se la tua rete locale utilizza la struttura `192.168.1.xxx`.
      Potrebbe essere necessario modificare il comando seguente per corrispondere alla configurazione della tua rete locale se utilizza una struttura di indirizzo diversa (ad es. `192.168.99.xxx`).

      ```shell
      # This assumes your local IP structure is 192.168.1.xxx
      sudo ufw allow from 192.168.1.0/24 proto tcp to any port 3100 comment 'Allow grafana from local network'
      ```

    </Tab>
    <Tab label="Subnet">
      Usa questo se il tuo nodo Rocket Pool non è connesso alla stessa sottorete del dispositivo da cui stai visualizzando Grafana. Questo può accadere quando il tuo nodo è connesso direttamente al modem del tuo ISP e il dispositivo che usi per visualizzare Grafana è connesso a un router secondario.

      Controlla prima se la tua rete locale utilizza la struttura `192.168.1.xxx`.
      Potrebbe essere necessario modificare il comando seguente per corrispondere alla configurazione della tua rete locale se utilizza una struttura di indirizzo diversa (ad es. `192.168.99.xxx`).

      ```shell
      # To allow any devices in the broader subnet
      # for example allowing 192.168.2.20 to access
      # grafana on 192.168.1.20
      sudo ufw allow from 192.168.1.0/16 proto tcp to any port 3100 comment 'Allow grafana from local subnets'
      ```
    </Tab>
    <Tab label="Anywhere">
      Questo ti permetterà di accedere a Grafana da qualsiasi luogo.
      Se vuoi accedervi dall'esterno della tua rete locale, dovrai comunque inoltrare la porta Grafana (predefinita 3100) nelle impostazioni del tuo router.

      ```shell
      # Allow any IP to connect to Grafana
      sudo ufw allow 3100/tcp comment 'Allow grafana from anywhere'
      ```
    </Tab>

  </Tabs>
</div>

## Configurazione di Grafana

Ora che il server di metriche è pronto, puoi accedervi con qualsiasi browser sulla tua rete locale.

Fai riferimento alle schede seguenti per la modalità di installazione del tuo Smartnode.

Naviga al seguente URL, sostituendo le variabili con la tua configurazione secondo necessità:

```
http://<IP del tuo nodo>:<porta grafana>
```

Ad esempio, se l'IP del tuo nodo era `192.168.1.5` e hai utilizzato la porta Grafana predefinita di `3100`, andresti a questo URL nel tuo browser:

```
http://192.168.1.5:3100
```

Vedrai una schermata di accesso come questa:

<img src="./images/grafana-login.png" width="100%" height="auto" />

Le informazioni predefinite di Grafana sono:

```
Username: admin
Password: admin
```

Ti verrà quindi richiesto di cambiare la password predefinita per l'account `admin`.
Scegli qualcosa di forte e non dimenticarlo!

::: tip Suggerimento
Se perdi la password di admin, puoi reimpostarla usando il seguente comando sul tuo nodo:

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker exec -it rocketpool_grafana grafana-cli admin reset-admin-password admin
      ```

    </Tab>
    <Tab label="Native">
      ```shell
      sudo grafana-cli admin reset-admin-password admin
      ```
    </Tab>

  </Tabs>
</div>

Sarai in grado di accedere a Grafana usando le credenziali predefinite `admin` ancora una volta, e poi ti verrà richiesto di cambiare la password per l'account `admin`.
:::

Grazie al lavoro del membro della community **tedsteen**, Grafana si connetterà automaticamente alla tua istanza di Prometheus in modo che abbia accesso alle metriche che raccoglie.
Tutto quello che devi fare è prendere il dashboard!

## Importazione del Dashboard di Rocket Pool

Ora che hai Grafana collegato a Prometheus, puoi importare il dashboard standard (o costruirne uno tuo usando le metriche che fornisce, se hai familiarità con quel processo).

Inizia andando al menu **Create** (l'icona più sulla barra laterale destra) e fai clic su **Import**:

<img src="./images/grafana-import.png" width="100%" height="auto" />

Quando ti viene richiesto l'ID del dashboard nella casella **Import via grafana.com**, inserisci `21863` o usa l'URL completo ([(https://grafana.com/grafana/dashboards/21863](https://grafana.com/grafana/dashboards/21863)) e premi il pulsante **Load**.

Ti verranno richieste alcune informazioni sul dashboard qui, come il suo nome e dove vorresti memorizzarlo (la cartella predefinita **General** va bene a meno che non usi molti dashboard e voglia organizzarli).

Nel menu a discesa **Prometheus** in basso, dovresti avere solo un'opzione etichettata **Prometheus (default)**.
Seleziona questa opzione.

La tua schermata dovrebbe apparire così:

<img src="./images/grafana-import2.png" width="100%" height="auto" />

Se corrisponde, fai clic sul pulsante **Import** e verrai immediatamente portato al tuo nuovo dashboard.

A prima vista, dovresti vedere molte informazioni sul tuo nodo e sui tuoi validatori.
Ogni riquadro viene fornito con un comodo tooltip nell'angolo in alto a sinistra (l'icona `i`) su cui puoi passare il mouse per saperne di più.
Ad esempio, ecco il tooltip per il riquadro **Your Validator Share**:

<img src="./images/tooltip.png" width="100%" height="auto" />

Tuttavia, non abbiamo ancora finito di configurare le cose - c'è ancora un po' più di configurazione da fare.

::: warning NOTA
Alcuni dei riquadri (in particolare quelli APR) sono stati temporaneamente disabilitati a causa del modo in cui Shapella fornisce ricompense skimmate.

Saranno abilitati di nuovo in una versione futura dello Smartnode che può tracciare correttamente le ricompense storiche.
:::

## Personalizzazione del Monitoraggio Hardware per il tuo Sistema

Ora che il dashboard è attivo, potresti notare che alcuni riquadri sono vuoti come **SSD Latency** e **Network Usage**.
Dobbiamo adattare il dashboard al tuo hardware specifico in modo che sappia come catturare queste cose.

### CPU Temp

Per aggiornare il tuo indicatore di temperatura della CPU, fai clic sul titolo del riquadro **CPU Temp** e seleziona **Edit** dal menu a discesa.
La tua schermata ora apparirà così:

<img src="./images/cpu-temp.png" width="100%" height="auto" />

Questa è la modalità di modifica di Grafana, dove puoi cambiare cosa viene visualizzato e come appare.
Siamo interessati alla casella di query evidenziata in rosso, a destra del pulsante **Metrics browser**.

Per impostazione predefinita, quella casella ha questo:

```
node_hwmon_temp_celsius{job="node", chip="", sensor=""}
```

Ci sono due campi in questo testo che sono attualmente vuoti: `chip` e `sensor`.
Questi sono unici per ogni macchina, quindi dovrai compilarli in base a ciò che la tua macchina fornisce.

Per farlo, segui questi passaggi:

1. Rimuovi la porzione `, sensor=""` in modo che termini con `chip=""}`. Per chiarezza, l'intero testo dovrebbe ora essere `node_hwmon_temp_celsius{job="node", chip=""}`.
2. Posiziona il cursore tra le virgolette di `chip=""` e premi `Ctrl+Spacebar`. Questo farà apparire una casella di auto-completamento con le opzioni disponibili, che appare così:

<img src="./images/grafana-autocomplete.png" width="100%" height="auto" />

3. Seleziona l'opzione che corrisponde alla CPU del tuo sistema.
4. Una volta selezionata, aggiungi `, sensor=""` di nuovo nella stringa. Posiziona il cursore tra le virgolette di `sensor=""` e premi `Ctrl+Spacebar` per ottenere un altro menu di auto-completamento. Seleziona il sensore che vuoi monitorare.

::: tip Suggerimento
Se non sai quale `chip` o `sensor` è corretto, dovrai provarli tutti fino a trovare quello che sembra giusto. Per aiutare con questo, installa il pacchetto `lm-sensors` (ad esempio, `sudo apt install lm-sensors` su Debian / Ubuntu) ed esegui il comando `sensors -u` per fornire quali sensori ha il tuo computer. Puoi provare a correlare un ID chip dall'elenco di Grafana con quello che vedi qui in base ai loro nomi e ID.

Ad esempio, questo è uno degli output del nostro comando `sensors -u`:

```
k10temp-pci-00c3
Tctl:
  temp1_input: 33.500
Tdie:
  temp2_input: 33.500
```

Nel nostro caso, il chip corrispondente in Grafana è `pci0000:00_0000:00:18_3` e il sensore corrispondente è `temp1`.
:::

Una volta che sei soddisfatto delle tue selezioni, fai clic sul pulsante blu **Apply** nell'angolo in alto a destra dello schermo per salvare le impostazioni.

::: warning NOTA
Non tutti i sistemi espongono informazioni sulla temperatura della CPU - in particolare le macchine virtuali o i sistemi basati su cloud.
Se il tuo non ha nulla nel campo di auto-completamento per `chip`, questo è probabilmente il caso e non sarai in grado di monitorare la temperatura della tua CPU.
:::

### SSD Latency

Il grafico **SSD Latency** traccia quanto tempo impiegano le operazioni di lettura/scrittura.
Questo è utile per valutare quanto è veloce il tuo SSD, in modo da sapere se diventa un collo di bottiglia se il tuo validatore soffre di scarse prestazioni.
Per aggiornare l'SSD che vuoi tracciare nel grafico, fai clic sul titolo **SSD Latency** e seleziona **Edit**.

Questo grafico ha quattro campi di query (quattro caselle di testo) con otto porzioni `device=""` in totale.
Dovrai aggiornare i primi quattro di queste porzioni con il dispositivo che vuoi tracciare.

Posiziona semplicemente il cursore tra le virgolette e premi `Ctrl+Spacebar` per ottenere l'elenco di auto-completamento di Grafana, e seleziona l'opzione corretta da lì per ciascuna delle porzioni `device=""`.
**Vuoi iniziare dalla prima impostazione vuota più a sinistra, altrimenti l'elenco di auto-completamento potrebbe non apparire.**

::: tip Suggerimento
Se non sai quale dispositivo tracciare, esegui il seguente comando:

```
lsblk
```

Questo produrrà un albero che mostra il tuo dispositivo e l'elenco delle partizioni, ad esempio:

```
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
...
loop25        7:25   0   132K  1 loop /snap/gtk2-common-themes/9
loop26        7:26   0  65,1M  1 loop /snap/gtk-common-themes/1515
nvme0n1     259:0    0 238,5G  0 disk
├─nvme0n1p1 259:1    0   512M  0 part /boot/efi
├─nvme0n1p2 259:2    0 150,1G  0 part /
├─nvme0n1p3 259:3    0  87,4G  0 part
└─nvme0n1p4 259:4    0   527M  0 part
```

Se non hai cambiato la posizione predefinita di Docker in un'unità diversa durante l'installazione dello Smartnode, l'unità che vuoi tracciare sarà quella su cui è installato il tuo sistema operativo.
Cerca nella colonna `MOUNTPOINT` una voce semplicemente etichettata `/`, quindi segui quella fino al suo dispositivo genitore (quello con `disk` nella colonna `TYPE`).

Tipicamente questo sarà `sda` per unità SATA o `nvme0n1` per unità NVMe.

Se _hai_ cambiato la posizione predefinita di Docker in un'unità diversa, o se stai eseguendo una configurazione ibrida / nativa, dovresti essere in grado di utilizzare la stessa tecnica di "seguire il punto di montaggio" per determinare quale dispositivo ospita i tuoi dati della catena.
:::

Facoltativamente, puoi anche tracciare la latenza di un secondo disco sul tuo sistema.
Questo è rivolto alle persone che mantengono il loro sistema operativo e i dati della catena su unità separate.
Per configurarlo, segui semplicemente le istruzioni sopra per gli ultimi due campi di query, sostituendo i valori della porzione `device=""` con quelli del disco che vuoi tracciare.

Una volta che sei soddisfatto delle tue selezioni, fai clic sul pulsante blu **Apply** nell'angolo in alto a destra dello schermo per salvare le impostazioni.

### Network Usage

Questo grafico traccia quanti dati stai inviando e ricevendo su una particolare connessione di rete.
Come puoi aspettarti, il dashboard deve sapere quale rete vuoi che tracci.

Per cambiarla, fai clic sul titolo **Network Usage** e seleziona **Edit**.

Questo grafico ha due campi di query con due porzioni `device=""` in totale.
Dovrai aggiornare queste con la rete che vuoi tracciare.

Posiziona il cursore tra le virgolette e premi `Ctrl+Spacebar` per ottenere l'elenco di auto-completamento di Grafana, e seleziona l'opzione corretta da lì per ciascuna delle porzioni `device=""`.

::: tip Suggerimento
Se non sai quale dispositivo tracciare, esegui il seguente comando:

```shell
sudo route
```

L'output apparirà così:

```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
```

Cerca nella colonna `Destination` la riga con il valore `default`.
Segui quella riga fino alla colonna `Iface`.
Il dispositivo elencato lì è quello che vuoi utilizzare - in questo esempio, `eth0`.
:::

Una volta che sei soddisfatto delle tue selezioni, fai clic sul pulsante blu **Apply** nell'angolo in alto a destra dello schermo per salvare le impostazioni.

### Total Net I/O

Questo traccia la quantità totale di dati che hai inviato e ricevuto.
Potresti trovarlo utile da guardare se, ad esempio, il tuo ISP ti limita a una certa quantità di dati al mese.

La configurazione è identica al riquadro **Network Usage** sopra, quindi segui semplicemente quelle istruzioni anche per questo riquadro.

### Disk Space Used

Questo tiene traccia di quanto è pieno il disco del tuo sistema operativo, in modo da sapere quando è il momento di pulire (e se i tuoi dati della catena si trovano sulla stessa unità, è il momento di [potare Geth o Nethermind](./pruning)).

I passaggi sono gli stessi del riquadro **SSD Latency** sopra, quindi segui semplicemente quelle istruzioni anche per questo riquadro.
Come promemoria, vuoi l'unità che ospita la partizione che ha `/` nella colonna `MOUNTPOINT` per questa perché quella sarà la tua unità del sistema operativo.
Compila questo nel primo campo di query.

Facoltativamente, puoi anche tracciare lo spazio libero di un secondo disco sul tuo sistema.
Questo è rivolto alle persone che mantengono il loro sistema operativo e i dati della catena su unità separate.
Configura questo seguendo lo stesso processo, ma invece di guardare quale partizione ha `/` nella colonna `MOUNTPOINT`, vuoi cercare quella che ha qualunque sia il punto di montaggio della tua seconda unità.
Aggiorna il secondo campo di query con il disco associato a quella partizione.

### Disk Temp

Questo traccia la temperatura attuale del disco del tuo sistema operativo. I passaggi sono gli stessi del riquadro **CPU Temp** sopra, quindi segui semplicemente quelle istruzioni anche per questo riquadro, sostituendo i valori del chip e del sensore della CPU con quelli del disco del tuo sistema operativo. Compila questi valori nel primo campo di query.

Facoltativamente, puoi anche tracciare la temperatura attuale di un secondo disco sul tuo sistema. Configura questo seguendo lo stesso processo, sostituendo i valori del chip e del sensore con quelli della tua seconda unità. Compila questi valori nel secondo campo di query.

## Personalizzazione del Dashboard

Mentre il dashboard standard cerca di fare un buon lavoro catturando tutto ciò che vorresti vedere a colpo d'occhio, è abbastanza facile personalizzare un dashboard Grafana come vuoi.
Puoi aggiungere nuovi grafici, cambiare il modo in cui i grafici appaiono, spostare le cose e molto altro!

Dai un'occhiata alla pagina [Tutorial di Grafana](https://grafana.com/tutorials/) per imparare come giocarci e configurarlo a tuo piacimento.

## Personalizzazione dello Stack di Metriche

Gli strumenti utilizzati nello Stack di Metriche di Rocket Pool offrono una vasta gamma di opzioni di configurazione oltre a quelle incluse nell'installazione predefinita di Rocket Pool. Questa sezione include esempi di configurazione per diversi casi d'uso.

In generale, le [opzioni di configurazione di Grafana](https://grafana.com/docs/grafana/latest/administration/configuration/) dovrebbero essere passate attraverso usando variabili d'ambiente in `override/grafana.yml`. Qualsiasi opzione di configurazione può essere convertita in una variabile d'ambiente usando la seguente sintassi:

```
GF_<SectionName>_<KeyName>
```

### Impostazioni SMTP di Grafana per l'Invio di Email

Per inviare email da Grafana, ad esempio per avvisi o per invitare altri utenti, le impostazioni SMTP devono essere configurate nello Stack di Metriche di Rocket Pool.
Vedi la pagina [Configurazione SMTP di Grafana](https://grafana.com/docs/grafana/latest/administration/configuration/#smtp) per riferimento.

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      Apri `~/.rocketpool/override/grafana.yml` in un editor di testo.
      Aggiungi una sezione `environment` sotto la riga `x-rp-comment: Add your customizations below this line`, sostituendo i valori seguenti con quelli del tuo provider SMTP.

      ```yaml
      version: "3.7"
      services:
      grafana:
      x-rp-comment: Add your customizations below this line
      environment:
      ## SMTP settings start, replace values with those of your SMTP provider
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      - GF_SMTP_USER=admin@example.com
      - GF_SMTP_PASSWORD=password
      - GF_SMTP_FROM_ADDRESS=admin@example.com
      - GF_SMTP_FROM_NAME="Rocketpool Grafana Admin"
      ## SMTP server settings end
      ```
    </Tab>
    <Tab label="Native">
      Apri `/etc/grafana/grafana.ini` in un editor di testo. Cerca la sezione `[smtp]` e aggiornala, sostituendo i valori seguenti con quelli del tuo provider SMTP.

      ```
      [smtp]
      enabled = true
      host = mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      user = admin@example.com
      # If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
      password = """passw0rd"""
      from_address = admin@example.com
      from_name = "Rocketpool Grafana Admin"
      ```
    </Tab>

  </Tabs>
</div>

::: tip Suggerimento
Se usi Gmail e la [Verifica in 2 passaggi](https://support.google.com/accounts/answer/185839) è abilitata, crea una [Password per l'app](https://support.google.com/mail/answer/185833?hl=en) per questo servizio.
:::

Dopo aver apportato queste modifiche, **esegui quanto segue per applicare le modifiche**:

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker stop rocketpool_grafana

      rocketpool service start
      ```
    </Tab>
    <Tab label="Native">
      ```shell
      sudo systemctl restart grafana-server
      ```
    </Tab>

  </Tabs>
</div>

Per testare le impostazioni SMTP, vai al menu **Alerting** e fai clic su **Contact points**.

<img src="./images/grafana-contact-points.png" width="100%" height="auto" />

Fai clic su **New contact point** e seleziona **Email** come tipo di Contact point.
Inserisci un indirizzo email nella sezione **Addresses** e fai clic su **Test**.

<img src="./images/grafana-new-contact-point.png" width="100%" height="auto" />

Controlla che l'email di test sia stata ricevuta.
Fai clic su **Save contact point\*** quando hai finito.
