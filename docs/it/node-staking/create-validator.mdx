import { Tab, Tabs } from "@rspress/core/theme";

::: danger ATTENZIONE
I depositi dei minipool sono attualmente disabilitati in preparazione di Saturn 1.
:::

# Creazione di un Nuovo Minipool (Validator)

Come promemoria, un `minipool` nei termini di Rocket Pool si riferisce a un'istanza unica di smart contract sull'Execution Layer che il tuo nodo gestisce.
Il minipool gestisce una porzione del tuo ETH, nota come **importo del bond**, e una porzione di ETH dal pool di staking rETH, nota come **importo preso in prestito**.
Li unisce insieme per formare 32 ETH in totale, che vengono poi inviati al contratto di deposito della Beacon Chain per creare un nuovo validator.
Pertanto, per creare un validator utilizzando Rocket Pool, è necessario **creare un minipool**.

::: danger ATTENZIONE
La creazione del minipool è governata da due code.

La prima è la coda di deposito di Rocket Pool, che è gestita dal protocollo Rocket Pool e determina quando il tuo minipool riceverà i suoi ETH presi in prestito. Deve esserci ETH disponibile nel pool di deposito per abbinare i tuoi 8 ETH con 24 ETH nel pool di deposito e creare il minipool.

La seconda è la coda della Beacon Chain, che è gestita dalla Beacon Chain di Ethereum e determina quando il tuo validator diventerà attivo.

Si prega di essere consapevoli che il tempo necessario affinché il tuo minipool diventi attivo può variare notevolmente a seconda della tua posizione in ciascuna coda e dello stato attuale della rete.
:::

::: tip NOTA
I tempi di attivazione (e uscita) della coda dei validator della Beacon Chain possono variare notevolmente a seconda dello stato attuale della rete.

Questo è al di fuori del controllo di Rocket Pool ed è una funzione della Beacon Chain stessa.

Il seguente strumento fornisce una buona stima di quanto tempo puoi aspettarti di attendere:
[https://www.validatorqueue.com/](https://www.validatorqueue.com/)

Si prega di rivedere questo strumento per avere un'idea di quanto tempo puoi aspettarti di attendere affinché il tuo validator diventi attivo.
:::

### Staking di RPL tramite il Sito Web

Il modo più semplice e sicuro per fare staking di RPL per il tuo nodo è utilizzare la funzione **Stake-on-Behalf** del protocollo, che è stata
reintrodotta con l'upgrade Atlas. In questo modo, puoi fare staking di RPL per il tuo nodo mentre l'RPL è ancora nel wallet
che hai usato per acquisirlo. In altre parole, **non è necessario inviare RPL al wallet caldo del tuo nodo** per farne lo staking.

#### Aggiunta di un indirizzo alla whitelist per fare staking per conto terzi

Per fare staking per conto del tuo nodo, un indirizzo deve essere aggiunto alla whitelist. Il tuo indirizzo di prelievo è sempre nella whitelist,
e puoi saltare questo passaggio se il tuo RPL è detenuto dal tuo indirizzo di prelievo. Devi aggiungere un indirizzo alla whitelist solo una volta
per fare staking da esso. Puoi farlo tramite il seguente comando Smartnode:

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

Dove `address-or-ens` è l'indirizzo o il nome ENS che risolve al tuo indirizzo desiderato. Ti verrà chiesto di
confermare l'aggiunta alla whitelist e dopo che la transazione è confermata, puoi quindi navigare alla pagina pertinente qui sotto.

#### Staking di RPL per conto di

Seleziona quale rete stai utilizzando dalle schede qui sotto per accedervi:

<div className="p-3">
  <Tabs>
    <Tab label="Mainnet">[https://node.rocketpool.net/stake-rpl-on-behalf-of-node](https://node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
    <Tab label="Hoodi Testnet">[https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node](https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
  </Tabs>
</div>

Inizia collegando il tuo wallet al sito web utilizzando MetaMask, WalletConnect o uno qualsiasi degli altri metodi supportati dal sito web.
Ti verrà quindi presentata questa finestra di dialogo per cercare l'indirizzo del tuo nodo.

Inserisci l'indirizzo del tuo nodo e fai clic su "Lookup".

**Assicurati di avere l'indirizzo del nodo corretto prima di farlo!**
Se hai bisogno di confermare l'indirizzo del tuo nodo, puoi recuperarlo rapidamente tramite la CLI utilizzando il comando `rocketpool node status`.

Questo verificherà che l'indirizzo sia un nodo registrato e che il nodo abbia aggiunto il wallet connesso alla whitelist. Gli indirizzi di prelievo sono nella whitelist per impostazione predefinita, tuttavia se desideri consentire altri indirizzi dovrai aggiungerli alla whitelist tramite il seguente comando sul tuo nodo.

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

Questo è un processo in due fasi.

Prima, inserisci la quantità di RPL che desideri mettere in staking e fai clic su `Approve` - questo **approverà** il contratto di staking ad accedere a quella quantità di RPL nel tuo wallet, ma **non più di tale importo**.

::: tip SUGGERIMENTO
Puoi approvare più dell'importo che intendi mettere in staking se ti fidi del contratto di staking di Rocket Pool e non vuoi eseguire questa transazione Approve extra ogni volta che vuoi mettere in staking più RPL.
:::

Una volta che l'RPL è approvato, sarai in grado di fare staking per conto di un nodo.

Inserisci la quantità di RPL che desideri mettere in staking nella casella `Stake RPL` e inserisci l'indirizzo del tuo nodo nella casella `on behalf of Node Address`.

Quando hai inserito tali informazioni, premi il pulsante `Stake` e approva la transazione.

<video controls="controls" src="https://cdn-rocketpool.s3.us-west-2.amazonaws.com/stake_behalf.mp4" />

Verrà inviata alla rete Ethereum e, una volta inclusa in un blocco, sei a posto!

Se esegui `rocketpool node status`, dovresti vedere il tuo RPL in staking apparire sotto la sezione `=== RPL Stake ===`.

#### Rimozione di un indirizzo dalla whitelist di staking

Se desideri rimuovere un indirizzo dalla tua whitelist di stake-on-behalf, puoi farlo con il seguente comando Smartnode:

```shell
rocketpool node remove-address-from-stake-rpl-whitelist address-or-ens
```

Dove `address-or-ens` è l'indirizzo o un nome ENS che risolve all'indirizzo che desideri rimuovere dalla whitelist.

### Staking tramite la CLI del Nodo

Se non puoi (o non vuoi) utilizzare il sito web per fare staking del tuo RPL, puoi anche farlo tramite la CLI del nodo direttamente.

Prima, trasferisci il tuo RPL dal wallet con cui lo hai acquisito all'indirizzo del tuo nodo.

::: danger ATTENZIONE
**Si prega di farlo attentamente e assicurarsi di inviare l'RPL all'indirizzo del tuo nodo - i trasferimenti su Ethereum non possono essere annullati!**
**Inviare RPL all'indirizzo sbagliato comporterà la perdita del tuo RPL.**

Usa il comando `rocketpool node status` per verificare l'indirizzo del tuo nodo se non sei sicuro di quale sia.
:::

Esegui il seguente comando:

```
rocketpool node stake-rpl
```

Ecco l'output:

```
Please choose an amount of RPL to stake:
1: Your entire RPL balance (1440.000000 RPL)?
2: A custom amount
```

Seleziona quanto vuoi mettere in staking, quindi conferma l'operazione.

La prima volta che esegui questo comando, comporterà due transazioni - una per **approvare** il contratto di staking di Rocket Pool ad accedere al tuo RPL e una per mettere in **staking** il tuo RPL con esso.
Le esecuzioni successive richiederanno solo la transazione di **stake**, poiché il token è già stato approvato.

Una volta completate entrambe le transazioni, puoi controllare la quantità di RPL in staking con `rocketpool node status`.
La seguente porzione dell'output è quella che vuoi verificare:

```
The node has a total stake of 300.000000 RPL.
This is currently 29.76% of its borrowed ETH and 89.29% of its bonded ETH.
It can earn max apy on up to 151.209677 RPL (15% of borrowed ETH), and still earn at lower APY with more RPL.
```

Questo ti mostrerà quanti minipool puoi creare di ciascuna dimensione del bond in base alla tua garanzia RPL.

## (Opzionale) Trovare un Indirizzo Vanity Personalizzato per il tuo Minipool

Per impostazione predefinita, quando crei un nuovo minipool, Rocket Pool genererà un indirizzo univoco casuale per esso.
Tuttavia, lo Smartnode offre la possibilità di cercare un **indirizzo vanity** personalizzato per il minipool.

Un indirizzo vanity è uno in cui scegli personalmente i caratteri con cui inizia l'indirizzo.
Questo è un esercizio puramente estetico e non avrà alcun impatto pratico sul funzionamento del tuo minipool.
Poiché gli indirizzi Ethereum sono in esadecimale, uno qualsiasi dei seguenti caratteri è legale:

```
0 1 2 3 4 5 6 7 8 9 a b c d e f
```

Come alcuni esempi, potresti far iniziare l'indirizzo del tuo minipool con un mucchio di zeri (`0x000000...`), `0x600d` (esadecimale per "good") o `0xa77e57ed` (esadecimale per "attested", un prefisso adatto per un minipool).

Per trovare un tale indirizzo vanity, dovrai **cercarlo**.
Questo processo di ricerca implica scegliere un numero, applicarlo come "salt" all'algoritmo di hashing e confrontare i risultati con ciò che stai cercando.
I risultati sono effettivamente casuali (anche se un dato salt produce sempre lo stesso risultato), quindi l'unico modo per trovare un indirizzo con il prefisso che desideri è provarne molti e molti finché non trovi un salt che funziona.

Se desideri un indirizzo vanity personalizzato da utilizzare per il tuo minipool quando lo crei, puoi utilizzare il seguente comando per cercarne uno:

```
rocketpool minipool find-vanity-address
```

Questo ti chiederà il prefisso che desideri cercare e ti chiederà quale tipo di deposito farai (un deposito da 16 ETH o da 32 ETH - vedi sotto per maggiori informazioni su questi tipi).
Una volta inserite tali informazioni, inizierà a provare molti e molti salt finché non ne trova uno che produce il prefisso desiderato!

Ecco un esempio completo del processo:

```
$ rocketpool minipool find-vanity-address
Please specify the address prefix you would like to search for (must start with 0x):
0xa77e57
Running with 12 threads.
Found on thread 3: salt 0x5cd7fb = 0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD
Finished in 1.91145873s
```

In questo caso, abbiamo cercato `0xa77e57` come prefisso e abbiamo trovato il salt `0x5cd7fb` che potrebbe generarlo.
Nel passaggio successivo, quando creiamo un minipool, possiamo specificare questo salt come argomento opzionale per creare il nuovo minipool all'indirizzo associato al salt (`0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD` come mostrato sopra).

In generale, ogni carattere aggiuntivo che cerchi moltiplicherà il tempo di ricerca di circa 16.
Per questo motivo, **ti consigliamo di cercare solo prefissi di massimo 7 o 8 caratteri a meno che tu non abbia una macchina molto potente con molti core CPU**.
Altrimenti, potrebbe richiedere un tempo proibitivamente lungo per trovare un salt che produce il prefisso desiderato.

Ad esempio, un AMD 5600x con 6 core (12 thread) a 4,8 GHz può cercare circa 3,2 milioni di salt al secondo.
In media, impiegherà alcuni secondi per trovare un prefisso di 6 caratteri, alcuni minuti per trovare un prefisso di 7 caratteri e alcune ore per trovare un prefisso di 8 caratteri.

::: tip NOTA
Il salt generato è specifico per le seguenti variabili:

- La rete che stai utilizzando (Hoodi Testnet o Mainnet)
- L'indirizzo del nodo
- L'importo del bond
- Il salt

Se cambi una qualsiasi di queste variabili, anche l'indirizzo del minipool per un dato salt cambierà.
:::

Per un utilizzo più avanzato (come la ricerca di un indirizzo di nodo diverso o la modifica di quanti core CPU vengono utilizzati per la ricerca), dai un'occhiata al testo di aiuto con `rocketpool minipool find-vanity-address --help`.

## Deposito di ETH e Creazione di un Minipool

::: tip SUGGERIMENTO
Se il valore di mercato di rETH è superiore alla sua copertura in ETH (cioè, rETH ha un premio sul mercato), c'è un'opportunità di arbitraggio sulla differenza quando si crea un minipool.
Il valore dell'arbitraggio è uguale alla quantità di ETH del protocollo nel minipool moltiplicata per il premio (meno una piccola quantità di gas).
Ad esempio, se si crea un minipool quando c'è un premio del 2,5%: `16 ETH * .025 = 0,4 ETH`.
In altre parole, potresti ricevere indietro 0,4 ETH in queste condizioni solo per aver creato un minipool!

Se sei interessato a sfruttare questa opportunità, considera di utilizzare lo strumento sviluppato dalla community [rocketarb](https://github.com/xrchz/rocketarb#readme) per catturare il profitto dell'opportunità di arbitraggio MEV rETH che la creazione del tuo minipool crea.

Per saperne di più su rocketarb, sentiti libero di chiedere informazioni a riguardo sul [server discord RP](https://discord.gg/rocketpool).
:::

Dopo tutto quello che hai fatto finora, sei finalmente pronto a depositare il tuo ETH, creare un nuovo minipool e creare un validator sulla Beacon Chain.
Questo viene fatto con il seguente comando:

```shell
rocketpool node deposit
```

::: danger ATTENZIONE

Sebbene la CLI automatizzi molti dei prossimi passaggi per te, <strong>consigliamo vivamente</strong> di monitorare il tuo nodo e le transazioni per garantire una transizione riuscita da `prelaunch` a `staking`.

Transazioni fallite (a causa di impostazioni del gas modificate o ETH insufficiente) potrebbero far passare il tuo minipool allo stato `dissolved`, che vuoi evitare.

[Scopri di più su come confermare uno stake riuscito](./create-validator#confermare-uno-stake-riuscito)

:::

::: tip NOTA
Se desideri utilizzare un salt per un indirizzo vanity che hai trovato utilizzando il processo sopra, esegui invece il seguente comando:

```shell
rocketpool node deposit --salt <your salt, e.g. 0x1234abcd>
```

:::

Vedrai prima una nota che depositare un nuovo minipool **distribuirà automaticamente** qualsiasi saldo nel contratto [fee distributor](./fee-distrib-sp) del tuo nodo (utilizzato per catturare le ricompense MEV se non hai optato per il [Smoothing Pool](./fee-distrib-sp#the-smoothing-pool)):

```
Your eth2 client is on the correct network.
NOTE: by creating a new minipool, your node will automatically claim and distribute any balance you have in your fee distributor contract. If you don't want to claim your balance at this time, you should not create a new minipool.
Would you like to continue? [y/n]
```

Se hai già minipool e un saldo nel tuo fee distributor, potresti decidere di non creare un altro minipool se la distribuzione di questo saldo causa un evento tassabile nella tua giurisdizione.

Dopodiché riceverai una notifica della tua commissione per il nuovo minipool e una nota su se il [saldo di credito](./credit) del tuo nodo può essere utilizzato per coprire il costo del bond del minipool per te:

```
Your minipool will use the current fixed commission rate of 5.00%.
If you participate in the smoothing pool, your minipool will receive at least a 5% commission boost, and up to a 9% commission boost based on RPL stake.
You currently have 8.00 ETH in your credit balance.
This deposit will use 8.000000 ETH from your credit balance and will not require any ETH from your node.
```

Verrai quindi richiesto con le raccomandazioni sui costi del gas attuali della rete; conferma la tua selezione del prezzo del gas e segui il resto dei prompt.

```
Your consensus client is synced, you may safely create a minipool.
+============== Suggested Gas Prices ==============+
| Avg Wait Time |  Max Fee  |    Total Gas Cost    |
| 15 Seconds    | 15 gwei   | 0.0244 to 0.0366 ETH |
| 1 Minute      | 10 gwei   | 0.0157 to 0.0235 ETH |
| 3 Minutes     | 7 gwei    | 0.0100 to 0.0150 ETH |
| >10 Minutes   | 6 gwei    | 0.0080 to 0.0120 ETH |
+==================================================+
These prices include a maximum priority fee of 2.00 gwei.
Please enter your max fee (including the priority fee) or leave blank for the default of 10 gwei:
Using a max fee of 10.00 gwei and a priority fee of 2.00 gwei.
You are about to deposit 8.000000 ETH to create a minipool with a minimum possible commission rate of 14.000000%.
ARE YOU SURE YOU WANT TO DO THIS? Exiting this minipool and retrieving your capital cannot be done until:
- Your minipool has been *active* on the Beacon Chain for 256 epochs (approx. 27 hours)
- The Shapella upgrade of the Ethereum network has been deployed
- The Atlas upgrade of the Rocket Pool protocol has been deployed
- Your minipool has been upgraded to use the Atlas delegate
 [y/n]
y
Creating minipool...
Transaction has been submitted with hash <transaction hash>.
You may follow its progress by visiting:
<link to transaction>
Waiting for the transaction to be included in a block... you may wait here for it, or press CTRL+C to exit and return to the terminal.
The node deposit of 8.000000 ETH was made successfully!
Your new minipool's address is: <new minipool address>
The validator pubkey is: <new validator public key>
Your minipool is now in Initialized status.
Once the remaining ETH has been assigned to your minipool from the staking pool, it will move to Prelaunch status.
After that, it will move to Staking status once 1h0m0s have passed.
You can watch its progress using `rocketpool service logs node`.
```

Nota che la creazione di un minipool **è una transazione costosa**!
Presta molta attenzione al costo totale e assicurati di accettarlo.

Se accetti, verrà attivata la creazione del tuo minipool.
Una volta completata la transazione, ti verrà fornito l'indirizzo del tuo nuovo contratto minipool sull'Execution Layer e la sua corrispondente chiave pubblica del validator sulla Beacon Chain.
Puoi visitarli con qualsiasi block explorer se lo desideri.

## Confermare uno Stake Riuscito

Alla creazione, il tuo minipool verrà messo nello stato `initialized`.
Rimarrà qui fino a quando non sarà il tuo turno nella coda di Rocket Pool di ricevere 24 ETH dal pool di staking in modo da poter mettere in staking il tuo nuovo validator sulla Beacon Chain.

Una volta che ciò accade, il tuo minipool passerà allo stato `prelaunch` per un certo periodo di tempo (attualmente 12 ore).
Il tuo deposito di 8 ETH verrà trasferito alla Beacon Chain e l'Oracle DAO [verificherà che sia tutto corretto](https://github.com/rocket-pool/rocketpool-research/blob/master/Reports/withdrawal-creds-exploit.md).
Durante questo periodo, puoi osservare il validator cercando la sua chiave pubblica del validator con un block explorer della Beacon Chain come [https://beaconcha.in](https://beaconcha.in) (o [https://hoodi.beaconcha.in](https://hoodi.beaconcha.in) per l'Hoodi Testnet).

Puoi controllare lo stato del nuovo minipool con il comando `rocketpool minipool status`.
Ad esempio, quando si è spostato in `prelaunch`, probabilmente vedrai qualcosa del genere:

```
1 Prelaunch minipool(s):
--------------------
Address:              <your minipool address>
Penalties:             0
Status updated:        2024-10-31, 04:51 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 31.000000 ETH
Your portion:          7.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      7.000000 ETH
Validator pubkey:      <your validator public key>
Validator index:       0
Validator seen:        no
Use latest delegate:   no
Delegate address:      <your delegate address>
Rollback delegate:     <none>
Effective delegate:    <your delegate address>
0 finalized minipool(s):
```

Dopo questo periodo di prelaunch, il tuo minipool entrerà nello stato `staking` e invierà l'ETH aggiuntivo dal pool di staking al contratto di deposito.
Questo sarà fatto dal container Docker `rocketpool_node` (o dal servizio `rp-node` se hai usato la configurazione Native) - se, per qualche motivo, stai impiegando un tempo anormalmente lungo per entrare nello stato `staking`, guardare i log di questo container / servizio probabilmente ti dirà cosa c'è che non va.
Puoi controllare questi log con il comando `rocketpool service logs node` (o `/srv/rocketpool/node_log.sh` nelle configurazioni in modalità Native).

Eseguendo `rocketpool minipool status` verrà quindi mostrato qualcosa del genere:

```
$ rocketpool minipool status
1 Staking minipool(s):
--------------------
Address:              <your validator address>
Penalties:             0
RP ETH assigned:       2024-10-31, 05:53 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 0.000000 ETH
Your portion:          0.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      0.000000 ETH
Validator pubkey:     <your validator public key>
Validator index:      <your validator index number>
Validator active:     yes
Validator balance:    32.018460 ETH
Expected rewards:     16.010614 ETH
Use latest delegate:  no
Delegate address:     <your delegate address>
Rollback delegate:    <none>
Effective delegate:   <your delegate address>
0 finalized minipool(s):
```

::: warning NOTA
La transazione per migrare da `prelaunch` a `staking` viene inviata automaticamente dal tuo nodo ed è soggetta alle impostazioni del gas in `rocketpool service config`.
Se le impostazioni del gas impediscono al nodo di inviare la transazione, o c'è ETH insufficiente nel wallet del nodo per pagare la transazione, il minipool diventerà `dissolved` due settimane dopo essere entrato in `prelaunch`.
Se ciò accade, recuperare il saldo è un processo costoso e lungo, quindi assicurati di monitorare attentamente il tuo minipool fino a quando non raggiunge lo stato `staking`!
:::

Una volta che la Beacon Chain accetta entrambi i depositi (uno da te e uno dal pool di staking), il tuo validator entrerà nella coda della Beacon Chain dove aspetterà il suo turno per essere attivato e iniziare a fare staking.

A questo punto, hai finito!
Congratulazioni!
Hai ufficialmente creato un validator con Rocket Pool!

Dai un'occhiata alle prossime sezioni in Monitoraggio e Manutenzione per imparare come monitorare le prestazioni e la salute del tuo validator nel tempo.

## Creazione di Più Minipool

Convenientemente, il tuo nodo Rocket Pool è in grado di ospitare tutti i minipool che desideri.
**Non** devi creare un nuovo nodo per ogni minipool.

Se desideri creare un secondo (o terzo, o quarto...) minipool per il tuo nodo, tutto ciò che devi fare è eseguire di nuovo `rocketpool node deposit`.
Inoltre, non sarai in grado di riutilizzare un vecchio salt di indirizzo vanity - dovrai cercarne un altro univoco per ciascuno dei tuoi minipool.

## Prossimi Passi

Ora che hai un minipool attivo e funzionante, i prossimi passi ti guideranno su come monitorare lo stato del tuo nodo, controllare e applicare gli aggiornamenti e mantenerlo per tutta la sua vita.

**Si prega di leggere la sezione `Monitoraggio e Manutenzione` successivamente per saperne di più su questi argomenti.**
