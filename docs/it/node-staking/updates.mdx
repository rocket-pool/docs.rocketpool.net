import { Tab, Tabs } from "@rspress/core/theme";
import tuiEcContainerTag from "./images/tui-ec-container-tag.png";
import tuiCcContainerTag from "./images/tui-cc-container-tag.png";

# Verifica degli Aggiornamenti

Una delle responsabilità di un operatore di nodi è assicurarsi che il tuo sistema sia aggiornato con le ultime patch di sicurezza.
Gli aggiornamenti automatici sono convenienti ma possono interferire con il funzionamento del tuo nodo, quindi potrebbe essere preferibile eseguirli manualmente.
In ogni caso, **devi assicurarti che la tua macchina sia regolarmente aggiornata!**

::: tip NOTA
La maggior parte delle volte, l'aggiornamento non richiederà che il tuo sistema sia inattivo per più di pochi minuti.
Potresti essere preoccupato che tale tempo di inattività influenzi negativamente il tuo saldo sulla Beacon Chain.
Stai tranquillo, la penalità per essere offline per un periodo così breve è **completamente trascurabile**.

Ogni attestazione che manchi ti penalizzerà per un importo leggermente inferiore a quello che guadagneresti da un'attestazione riuscita.
Come regola pratica, se sei offline per un'ora, recupererai tutto dopo essere stato online per un'ora di nuovo.

Nota anche che **non c'è assolutamente alcuna possibilità** che tu venga _slashed_ andando offline per un breve periodo.
Lo slashing si verifica solo se attacchi la rete, e andare offline per manutenzione non conta come attaccare la rete.

**Per favore mantieni i tuoi sistemi aggiornati - non preoccuparti delle penalità per il tempo di inattività!**
:::

## Aggiornamento del Sistema Operativo

Dovresti controllare frequentemente il gestore pacchetti o il servizio di aggiornamento del tuo Sistema Operativo per assicurarti di applicare rapidamente eventuali nuove importanti patch di sicurezza.
Le istruzioni esatte variano per ogni Sistema Operativo e possono essere trovate nella documentazione del tuo sistema, ma ecco alcuni esempi.

<div className="p-3">
  <Tabs>
    <Tab label="Ubuntu">
      In un terminale, digita quanto segue:

      ```shell
      sudo apt update
      ```

      Questo accederà ai server dei pacchetti e verificherà se uno qualsiasi dei tuoi pacchetti installati ha nuove versioni disponibili.
      Se sono disponibili aggiornamenti, l'output sarà simile a questo:

      ```
      Fetched 3974 kB in 2s (1641 kB/s)
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      12 packages can be upgraded. Run 'apt list --upgradable' to see them.
      ```

      Puoi installare gli aggiornamenti con il seguente comando:

      ```shell
      sudo apt dist-upgrade
      ```

      Questo ti mostrerà l'elenco dei pacchetti che stanno per essere aggiornati e, se la dimensione totale dell'installazione è abbastanza grande, ti mostrerà la dimensione e ti chiederà di confermare che accetti:

      ```
      12 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
      Need to get 51.3 MB of archives.
      After this operation, 52.2 kB of additional disk space will be used.
      Do you want to continue? [Y/n]
      ```

      Assicurati di avere abbastanza spazio disponibile per farlo, quindi premi `y` e `Invio` per iniziare il processo di aggiornamento.

      Una volta che la barra di avanzamento è terminata e sei tornato al prompt del terminale, esegui il seguente comando per pulire eventuali vecchie versioni di pacchetti che sono stati appena sostituiti:

      ```shell
      sudo apt autoremove
      ```

      Successivamente, controlla se il tuo sistema deve essere riavviato:

      ```shell
      cat /var/run/reboot-required
      ```

      Se il comando sopra stampa `No such file or directory`, allora il riavvio non è necessario e puoi saltare il passaggio seguente.

      Tuttavia, se il comando stampa `*** System restart required ***`, allora dovresti riavviare la tua macchina per completare l'applicazione degli aggiornamenti quando puoi:

      ```shell
      sudo reboot
      ```

      Rocket Pool si spegnerà correttamente e si riavvierà automaticamente con il sistema una volta riavviato.
    </Tab>
    <Tab label="MacOS">
      Per aggiornare i pacchetti del sistema operativo, usa l'interfaccia utente per selezionare `Apple -> Aggiornamento Software`.

      Per aggiornare i pacchetti stessi, il modo più semplice è tramite `homebrew` nel terminale:

      ```shell
      brew update && brew upgrade
      ```
    </Tab>

  </Tabs>
</div>

## Aggiornamento dello Stack Smartnode

Occasionalmente, Rocket Pool rilascerà una nuova versione dello stack Smartnode.
Gli aggiornamenti possono contenere nuove versioni della CLI o dei container Docker di Rocket Pool, così come nuove versioni dei client Execution e Consensus.

Il modo più coerente per essere informato sui nuovi rilasci è iscriversi al server Discord di Rocket Pool; saranno sempre pubblicati nel canale Releases e riceverai una notifica.

::: warning NOTA
Nota che eseguire `apt update` non aggiornerà il software del nodo.
Questo deve essere fatto manualmente usando i passaggi seguenti.
:::

::: tip SUGGERIMENTO
Quando hai completato l'aggiornamento dello Smartnode, il dashboard Grafana indicherà ancora che è disponibile un aggiornamento.
Si cancellerà automaticamente entro un giorno quando il sistema controllerà automaticamente gli aggiornamenti la prossima volta.

Se vuoi cancellarlo immediatamente dopo l'aggiornamento, esegui semplicemente:
`sudo apt update`
:::

::: tip SUGGERIMENTO
Se non conosci l'architettura della tua CPU, puoi eseguire il seguente comando per trovarla:

```shell
uname -m
```

L'output di questo comando stamperà la tua architettura.
**Nota che `x86_64` è lo stesso di `x64` e `amd64`.**
**Nota che `aarch64` è lo stesso di `arm64`.**
:::

I passaggi per aggiornare dipendono dalla modalità che il tuo nodo utilizza. Seleziona dalle opzioni seguenti:

<div className="p-3">
  <Tabs>
    <Tab label="Linux (Modalità Docker o Hybrid)">
      Ferma i servizi Rocket Pool:

      ```shell
      rocketpool service stop
      ```

      Scarica la nuova CLI Smartnode:

      Per sistemi `x64` (la maggior parte delle macchine normali):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
      ```

      Per sistemi `arm64`:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
      ```

      Ora esegui il comando di installazione:

      ```shell
      rocketpool service install -d
      ```

      Il flag `-d` gli dice di ignorare le dipendenze di sistema come Docker, dato che le hai già.

      Se vuoi vedere cosa è cambiato, apri il Settings Manager - la Pagina di Revisione ti mostrerà cosa c'è di nuovo:

      ```shell
      rocketpool service config
      ```

      Quando hai finito, avvia di nuovo Rocket Pool:

      ```shell
      rocketpool service start
      ```

      Infine, controlla la versione per assicurarti che la CLI e lo stack Smartnode siano entrambi aggiornati:

      ```shell
      rocketpool service version
      ```

      L'output dovrebbe apparire così:

      ```
      Your Smartnode is currently using the Hoodi Test Network.

      Rocket Pool client version: 1.5.0
      Rocket Pool service version: 1.5.0
      Selected Eth 1.0 client: Geth (Locally managed)
      Image: ethereum/client-go:v1.10.21
      Selected Eth 2.0 client: Lighthouse (Locally managed)
      Image: rocketpool/lighthouse:mevboost-5ee3bc5
      ```

      Sia il client che il servizio dovrebbero corrispondere alla nuova versione di rilascio.
    </Tab>
    <Tab label="Linux (Modalità Native)">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Questo aggiornerà solo lo stack Smartnode stesso - **non** aggiornerà i tuoi client Execution o Consensus.
        Dovrai farlo manualmente (vedi la prossima sezione sotto).
      </p>

      Ferma i servizi Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Scarica la nuova CLI Smartnode e fai un backup dei vecchi binari CLI e daemon nel caso tu debba ripristinarli:

      Per sistemi `x64` (la maggior parte delle macchine normali):

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Per sistemi `arm64`:

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Se vuoi vedere cosa è cambiato, apri il Settings Manager - la Pagina di Revisione ti mostrerà cosa c'è di nuovo:

      ```shell
      rp service config
      ```

      Quando hai finito, avvia di nuovo Rocket Pool:

      ```shell
      sudo systemctl start rp-node rp-watchtower
      ```

      Infine, controlla la versione per assicurarti che la CLI e lo stack Smartnode siano entrambi aggiornati:

      ```
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      Sia il client che il servizio dovrebbero corrispondere alla nuova versione di rilascio.
    </Tab>
    <Tab label="macOS (Modalità Docker o Hybrid)">
      Ferma i servizi Rocket Pool:

      ```shell
      rocketpool service stop
      ```

      Scarica la nuova CLI Smartnode:

      Per sistemi `x64` (la maggior parte dei Mac):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-amd64 -O /usr/local/bin/rocketpool
      ```

      Per sistemi `arm64`, come il Mac mini con M1:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-arm64 -O /opt/homebrew/bin/rocketpool
      ```

      Ora esegui il comando di installazione:

      ```shell
      rocketpool service install -d
      ```

      Il flag `-d` gli dice di ignorare le dipendenze di sistema come Docker, dato che le hai già.

      Se vuoi vedere cosa è cambiato, apri il Settings Manager - la Pagina di Revisione ti mostrerà cosa c'è di nuovo:

      ```shell
      rocketpool service config
      ```

      Quando hai finito, avvia di nuovo Rocket Pool:

      ```shell
      rocketpool service start
      ```

      Infine, controlla la versione per assicurarti che la CLI e lo stack Smartnode siano entrambi aggiornati:

      ```shell
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      Sia il client che il servizio dovrebbero corrispondere alla nuova versione di rilascio.

    </Tab>

  </Tabs>
</div>

## Aggiornamento Manuale del Client Execution o Consensus

Ogni nuovo rilascio dello stack Smartnode verrà fornito con riferimenti aggiornati alle ultime versioni compatibili dei container Docker Execution e Consensus.
In alcuni casi, tuttavia, potresti voler aggiornare uno di quei client _prima_ di aspettare un nuovo rilascio dello stack Smartnode.
Questa sezione ti mostrerà come fare proprio questo.

<div className="p-3">
  <Tabs>
    <Tab label="Modalità Docker">
      Aggiornare a nuove versioni del client è facile in modalità Docker.

      Inizia aprendo il Settings Manager:

      ```shell
      rocketpool service config
      ```

      Per cambiare la versione del client Execution, vai alla categoria **Execution Client**.
      Modifica l'impostazione **Container Tag**:

      <img src={tuiEcContainerTag} width="100%" height="auto"/>

      Per cambiare la versione del client Consensus, vai alla categoria **Consensus Client**.
      Modifica l'impostazione **Beacon Node Container Tag**:

      <img src={tuiCcContainerTag} width="100%" height="auto"/>

      Quando sei soddisfatto delle tue modifiche, salva ed esci come al solito.
      Lo Smartnode si offrirà di riavviare automaticamente tutti i container interessati.
    </Tab>
    <Tab label="Modalità Native">
      Innanzitutto, spegni il tuo client Execution, Beacon Node e/o servizio Validator Client a seconda di cosa vuoi aggiornare.
      Ad esempio, spegnendo Geth:

      ```shell
      sudo systemctl stop geth
      ```

      Successivamente, scarica l'ultimo rilascio binario dal fornitore del tuo client (o compilalo dal sorgente) e sostituisci il vecchio binario con quello nuovo.
      Ti consigliamo di **spostare il vecchio binario in una posizione di backup** invece di sovrascriverlo, nel caso in cui il nuovo client abbia problemi.

      Infine, avvia di nuovo il servizio client - ad esempio, avviando Geth:

      ```shell
      sudo systemctl start geth
      ```

      Dovresti seguire attentamente gli script di log dopo l'aggiornamento per assicurarti che il nuovo client funzioni come previsto.
    </Tab>

  </Tabs>
</div>
