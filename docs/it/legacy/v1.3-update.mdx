import { Tab, Tabs } from "@rspress/core/theme";

# Aggiornamento a Smartnode v1.3.x

La versione 1.3.0 dello stack Smartnode introduce alcune modifiche importanti di cui gli utenti dovrebbero essere consapevoli.
Sono progettate per migliorare significativamente la tua esperienza come Node Operator e affrontare molte delle funzionalità richieste dai nostri utenti dal lancio di Rocket Pool.

In questa guida, ti accompagneremo nel processo di migrazione da una versione precedente dello Smartnode alla v1.3.x e successive.

## Modifiche ai File di Configurazione

La v1.3.0 introduce alcune modifiche significative nel modo in cui viene gestita la configurazione dello Smartnode.
Se hai modificato manualmente la configurazione dello Smartnode in precedenza, dovresti essere consapevole delle seguenti modifiche:

- Il file `config.yml` è stato rimosso. Tutte le sue informazioni sono ora integrate direttamente nello stack Smartnode, così gli utenti non possono più modificare accidentalmente il file in un modo che impedisce allo Smartnode di funzionare correttamente.
  - Tutti i parametri configurabili dall'utente che ne facevano parte sono ora impostazioni nella nuova interfaccia utente terminale `service config`.

- Il file `settings.yml` è stato sostituito con un nuovo file chiamato `user-settings.yml`. Questo contiene tutte le tue impostazioni per ogni porzione configurabile dall'utente dello Smartnode.
  - Questo file **non è destinato ad essere modificato direttamente**. La modifica dovrebbe essere effettuata tramite la nuova interfaccia utente terminale `service config`.

- La cartella `chains` è stata rimossa. Gli script per l'avvio dell'Execution Client (ETH1), del Beacon Node e del Validator Client risiedono ora nella cartella `scripts`.

- I file YAML `docker-compose` sono stati rimossi. Ogni container ora ottiene il proprio file nella cartella `templates`. Dopo `rocketpool service start`, questi template vengono compilati con le tue impostazioni e inseriti automaticamente nella cartella `runtime`.
  - Modificare i template o i file runtime non è consigliato. Invece, inserisci le tue personalizzazioni del container utilizzando i file **override** per ciascun container nella cartella `override`. Questi file sovrascriveranno i file Docker in `runtime`, così sei libero di personalizzarli come preferisci.
  - I file in `override` **persisteranno durante gli aggiornamenti e la reinstallazione dello Smartnode**, quindi devi crearli solo una volta.
  - Se sei interessato a modificare i file `docker-compose` tramite questo meccanismo di override, consulta [questa sezione](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## Installazione della Nuova Versione

L'installazione della nuova versione dovrebbe sembrare molto familiare.

Inizia arrestando i servizi e scaricando la nuova CLI come al solito:

<div className="p-3">
  <Tabs>
    <Tab label="Modalità Docker o Ibrida">
      Arresta i servizi Rocket Pool:

      ```
      rocketpool service stop
      ```

      Scarica la nuova CLI Smartnode per il tuo sistema (scegli tra le schede seguenti):

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Per sistemi `x64` (la maggior parte delle macchine normali):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Per sistemi `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Per sistemi `x64` (la maggior parte dei Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Per sistemi `arm64`, come il Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Ora esegui il comando di installazione:

      ```
      rocketpool service install -d
      ```

      Il flag `-d` indica di ignorare le dipendenze di sistema come Docker, poiché le hai già.

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTA</p>
        A partire dalla v1.3.0, **non devi più specificare per quale rete vuoi installare!**
        Il nuovo Smartnode saprà quale rete stai già utilizzando e ti permetterà di cambiare la tua rete dinamicamente utilizzando la nuova interfaccia utente terminale.
      </p>
    </Tab>
    <Tab label="Modalità Nativa">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Questo aggiornerà solo lo stack Smartnode stesso - **non** aggiornerà i tuoi client Execution e Consensus.
        Dovrai farlo manualmente (vedi [la guida all'aggiornamento manuale](../node-staking/updates#manually-updating-the-eth1-or-eth2-client) per imparare come farlo).
      </p>

      Arresta i servizi Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Scarica i nuovi binari CLI e daemon dello Smartnode:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Per sistemi `x64` (la maggior parte delle macchine normali):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Per sistemi `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Per sistemi `x64` (la maggior parte dei Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Per sistemi `arm64`, come il Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">NOTA</p>
        A partire dalla v1.3.0, `config.yml` è stato rimosso.
        **Non è più necessario scaricare il pacchetto di installazione ed estrarlo.**
      </p>
      Successivamente, crea una cartella di backup chiamata `old_config_backup` nella tua directory Smartnode e sposta i tuoi vecchi file di configurazione (`config.yml` e `settings.yml`) al suo interno.
      Lo Smartnode utilizzerà questi file per migrare le tue impostazioni al nuovo sistema.

      Ad esempio, se hai seguito la guida di configurazione nativa e la tua directory Smartnode è `/srv/rocketpool`:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      Ora, modifica i file di definizione del servizio per `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Sostituisci la riga `ExecStart` con la seguente:

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      Nota che il flag `--config` è stato rimosso, e `--settings` ora punta a `user-settings.yml`.
      **Non preoccuparti che questo file non esista ancora; verrà generato automaticamente nel prossimo passaggio.**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se sei un membro dell'Oracle DAO, _devi_ ripetere il processo sopra anche per il servizio `rp-watchtower`.
      </p>

      Infine, ricarica le definizioni dei servizi:

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

Dopo l'installazione, tutti i tuoi vecchi file di configurazione verranno spostati in una cartella denominata `old_config_backup` nella tua directory Smartnode (per impostazione predefinita `~/.rocketpool/old_config_backup`).
Puoi trovarli lì se hai bisogno di consultarli per qualsiasi motivo.

**Se stai cercando istruzioni su come tornare alla v1.2.4 da questo backup, scorri fino alla sezione [Ripristino della Configurazione Precedente](#ripristino-della-configurazione-precedente) alla fine di questa pagina.**

## Configurazione dello Smartnode con l'Interfaccia Utente Terminale

Ora che hai la nuova CLI e il pacchetto installati, tutte le tue impostazioni precedenti sono state preservate e migrate al nuovo sistema.
Nel prossimo passaggio, dovresti eseguire `rocketpool service config`.
Questo apparirà abbastanza diverso rispetto alle versioni precedenti di questa funzione; la v1.3.0 introduce l'**Interfaccia Utente Terminale**: un'interfaccia utente dinamica basata su terminale per configurare il tuo Smartnode.

Devi eseguirlo prima di avviare i container Docker dopo il processo di migrazione per visualizzare la configurazione, verificare che tutte le tue modifiche siano state migrate con successo e aggiornare qualsiasi altra impostazione desideri.

Quando lo esegui per la prima volta, ti verrà mostrata questa schermata di benvenuto (se stavi usando la **modalità Docker o Ibrida**):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip NOTA
Gli utenti della **Modalità Nativa** vedranno questa schermata con una formulazione leggermente diversa, che indica che lo Smartnode sta operando in modalità Nativa.
:::

L'interfaccia utente terminale inizierà con **il Wizard**, che ti consente di modificare rapidamente e facilmente i parametri più importanti dello Smartnode (come la modalità client e la selezione).

**Tutte le tue impostazioni precedenti dovrebbero già essere evidenziate mentre attraversi ogni pagina del wizard, così non devi ricordare quale fosse la tua configurazione precedente a memoria.**

:::warning NOTA
**Per una procedura dettagliata di questo Wizard, visita le seguenti pagine:**

- Per la **Modalità Docker**, visita [la nuova guida alla configurazione Docker](../node-staking/config-docker).

- Utenti della **Modalità Ibrida**: la Modalità Ibrida è ora una **funzionalità di prima classe** dello Smartnode e configurarla è _molto_ più semplice di prima. Visita [la nuova guida alla configurazione Docker](../node-staking/config-docker) e seguila. Quando ti viene richiesto di scegliere una modalità client Execution e una modalità client Consensus, scegli **Gestito Esternamente** per loro di conseguenza.

- Per la **Modalità Nativa**, visita [la nuova guida alla configurazione Nativa](../node-staking/config-native).

:::

Naviga attraverso questo wizard e conferma che tutte le tue impostazioni siano corrette.

Una volta finito, avrai l'opzione di **rivedere tutte le impostazioni prima di salvare** se lo desideri.
Questo include impostazioni che il Wizard non ha coperto, come la **soglia gas per il claim RPL** o il tuo **numero massimo di peer Geth**, ad esempio.

La **schermata delle impostazioni principali**, che dovresti anche consultare per confermare le tue impostazioni precedenti, apparirà così (per gli utenti delle modalità Docker e Ibrida):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip NOTA
Gli utenti della **Modalità Nativa** vedranno una schermata leggermente diversa, unica per la modalità Nativa e che presenta solo le impostazioni rilevanti per essa.
:::

Sentiti libero di esplorare questa nuova interfaccia utente e regolare qualsiasi impostazione ritieni opportuna.
Usa i `Tasti Freccia` per navigare, e premi `Invio` per entrare in una categoria o confermare qualsiasi modifica a un'impostazione che effettui.

Premi `Esc` quando hai finito di modificare una categoria per tornare a questa schermata principale.

Quando sei pronto per salvare le tue modifiche e avviare lo stack Smartnode, premi semplicemente `Tab` per spostarti in basso sui pulsanti nella parte inferiore dello schermo, seleziona `Review Changes and Save` (rendendolo verde tramite i tasti freccia).
Premi `Invio` per essere portato alla **Pagina di Revisione**, dove puoi vedere tutto ciò che hai modificato dall'ultima volta che hai eseguito `rocketpool service config`.

Conferma che tutte le tue modifiche siano presenti, quindi premi `Invio` di nuovo per salvarle.
Lo schermo ti mostrerà quali container devono essere riavviati affinché le modifiche si applichino, anche se dato che stai migrando, hai già spento i container e verranno tutti riavviati comunque.

## Avvio dello Stack Smartnode

Una volta salvata la tua configurazione, il terminale ti chiederà se desideri riavviare i container automaticamente (a meno che tu non stia usando la modalità Nativa).
Se non puoi / non vuoi permettere loro di avviarsi automaticamente, puoi avviarli manualmente con i seguenti comandi:

<div className="p-3">
  <Tabs>
    <Tab label="Modalità Docker o Ibrida">```shell rocketpool service start ```</Tab>
    <Tab label="Modalità Nativa">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

Una volta attivi, puoi verificare che tutto funzioni come previsto.

Usa il comando `rocketpool service version` per verificare di avere la versione corretta dello Smartnode e dei container client:

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

Usa i comandi `rocketpool service logs eth1` e `rocketpool service logs eth2` per guardare i log del tuo client Execution (precedentemente client ETH1) e del tuo client Consensus (precedentemente client ETH2).
Cerca eventuali errori e [visita il nostro server Discord per assistenza](https://discord.com/invite/rocketpool) se li riscontri.

## Ripristino della Configurazione Precedente

Se, per qualsiasi motivo, devi tornare alla v1.2.4 dello stack Smartnode, non preoccuparti!
Tutti i tuoi vecchi file di configurazione sono stati preservati in una directory di backup e possono essere facilmente recuperati per ripristinare la tua configurazione precedente.

Seleziona quale modalità usi dalle schede seguenti e segui le istruzioni.

<div className="p-3">
  <Tabs>
    <Tab label="Modalità Docker o Ibrida">
      Inizia sostituendo la CLI con la CLI v1.2.4 per il tuo sistema:
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Per sistemi `x64` (la maggior parte delle macchine normali):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Per sistemi `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Per sistemi `x64` (la maggior parte dei Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Per sistemi `arm64`, come il Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Successivamente, copia tutti i tuoi vecchi file di configurazione dalla cartella `old_config_backup` nella cartella dello Smartnode:

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      Ora, tutto ciò che devi fare è riavviare i container Docker:

      ```shell
      rocketpool service start
      ```

      Fatto! La tua vecchia configurazione è tornata.

    </Tab>
    <Tab label="Modalità Nativa">
      Arresta i servizi Rocket Pool:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Per sistemi `x64` (la maggior parte delle macchine normali):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Per sistemi `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Per sistemi `x64` (la maggior parte dei Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Per sistemi `arm64`, come il Mac mini con M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      Copia i file delle impostazioni precedenti nella tua directory Smartnode:

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      Ora, ripristina i file di definizione del servizio per `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Sostituisci la riga `ExecStart` con la seguente:

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTA</p>
        Se sei un membro dell'Oracle DAO, _devi_ ripetere il processo sopra anche per il servizio `rp-watchtower`.
      </p>

      Infine, ricarica le definizioni dei servizi e riavvia i servizi:

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      Fatto! La tua vecchia configurazione è tornata.
    </Tab>

  </Tabs>
</div>
