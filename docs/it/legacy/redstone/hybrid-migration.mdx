import { Tab, Tabs } from "@rspress/core/theme";

# [Modalità Ibrida] Guida all'Aggiornamento Redstone e al Merge

Questa guida coprirà tutto ciò che devi sapere per preparare il tuo nodo all'aggiornamento Redstone e al Merge se stai utilizzando la **Modalità Ibrida**.

## Cose da Fare Prima di Aggiornare alla v1.5.0

Prima di aggiornare alla v1.5.0 e versioni successive dello Smartnode, esamina la seguente checklist per assicurarti di essere preparato:

### Passare a un Client di Esecuzione Completo

Il Merge richiede l'esecuzione del proprio client di Esecuzione, quindi non potrai più utilizzare provider remoti come Infura o Pocket.

A causa di questo cambiamento, se stai attualmente utilizzando un client di Esecuzione leggero, dovresti passare a un client completo mentre sei ancora sulla v1.4, lasciarlo sincronizzare completamente e poi aggiornare alla v1.5.

### Assicurarsi che EC e CC Siano Entrambi Gestiti Esternamente

Le versioni precedenti dello stack Smartnode ti permettevano di avere un client gestito localmente e l'altro gestito esternamente.
Ad esempio, potresti avere un client di Esecuzione gestito dallo Smartnode e connetterlo a un client di Consenso che gestisci esternamente.

A partire dalla v1.5, questa configurazione non è più supportata.
Dovrai passare a un client di Esecuzione e Consenso gestiti localmente (noto anche come [Modalità Docker](./docker-migration.mdx)), oppure configurare sia un client di Esecuzione che uno di Consenso che gestisci da solo.

::: tip SUGGERIMENTO
Se sei interessato a lasciare che lo Smartnode mantenga il proprio client di Esecuzione e Consenso ma vuoi mantenere il controllo sul tuo client Validator (ad esempio, se hai le tue chiavi di validatore solo staking collegate ad esso), potresti voler considerare la [Modalità Ibrida Inversa](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode) che fa esattamente questo!
:::

### Configurare l'Engine API

Il Merge cambia il modo in cui il tuo client di Esecuzione comunica con il tuo client di Consenso.
Invece di utilizzare il vecchio sistema RPC basato su HTTP o Websocket, il Merge richiede un nuovo sistema esposto dal tuo client di Esecuzione chiamato Engine API.

Questa è una connessione speciale che consente al client di Consenso di sostituire il vecchio sistema di mining Proof-of-Work con Proof-of-Stake; è il cuore del Merge.
È anche **autenticata** con un token segreto, quindi solo il tuo client di Consenso può connettersi al tuo client di Esecuzione - nient'altro può farlo.

Poiché gestisci i tuoi client di Esecuzione e Consenso, dovrai configurare l'Engine API manualmente.
Come farlo dipende interamente da quali client stai eseguendo.

CoinCashew ha [una guida eccellente e concisa](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) su come configurare l'Engine API sui tuoi client di Esecuzione e Consenso.
Dai un'occhiata a quella e testa la nuova configurazione assicurandoti che attesti ancora correttamente prima di aggiornare.

Come sempre, Rocket Pool gestirà il proprio client Validator quindi non devi preoccuparti di modificarlo manualmente.

## Aggiornamento alla v1.5.0

L'aggiornamento dello stack Smartnode alla v1.5.0 non è diverso da qualsiasi altro aggiornamento.
Basta seguire [le normali istruzioni qui](../../node-staking/updates#updating-the-smartnode-stack).

## Cose che lo Smartnode Gestisce Automaticamente

In modalità Ibrida, lo Smartnode si occuperà di alcune delle modifiche necessarie per supportare Redstone automaticamente una volta aggiornato alla v1.5.0, ma dovrai gestire altre manualmente in Modalità Ibrida.

Ecco un breve elenco di ciò che farà per te senza alcun intervento manuale:

### Il Tuo Fee Recipient

Il **fee recipient** è l'indirizzo sulla catena del layer di Esecuzione (eth1) che riceverà tutte le commissioni prioritarie per i blocchi che proponi.
È un'impostazione fornita al tuo client Validator quando viene avviato per la prima volta.

Lo Smartnode gestirà la configurazione dell'indirizzo corretto sul client Validator che gestisce quando aggiorni alla v1.5 e controllerà costantemente che tu stia utilizzando quello corretto in modo da non essere [penalizzato accidentalmente](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Se hai optato per il [Smoothing Pool](./whats-new#smoothing-pool), questo diventerà il tuo fee recipient.
Se non l'hai fatto, il tuo [contratto di distribuzione delle commissioni](./whats-new#fee-recipients-and-your-distributor) diventerà il fee recipient.

## Cose che Dovresti Fare Dopo l'Aggiornamento

Anche se lo Smartnode gestisce la maggior parte delle modifiche per te, ci sono alcune cose aggiuntive che dovresti fare manualmente:

### Assicurarsi che l'Aggiornamento Sia Riuscito

La prima cosa da fare è assicurarsi che il tuo nodo funzioni correttamente.
Considera di seguire i seguenti passaggi:

- Controlla i log per errori con `rocketpool service logs validator` e `rocketpool service logs node`.
- Conferma con un Block Explorer (come la tua dashboard Grafana e [https://beaconcha.in](https://beaconcha.in)) che stai ancora attestando correttamente
  - Ricorda che se hai abilitato la protezione Doppelganger, mancherai alcune attestazioni dopo il riavvio. Questo è normale!

### Configurare MEV-Boost

[MEV-boost](https://boost.flashbots.net/) è il sistema fornito da Flashbots per dare ricompense MEV ai validatori Proof-of-Stake dopo il Merge.

**Rocket Pool richiede a tutti i nodi di utilizzarlo per massimizzare i loro rendimenti e quindi mantenere il protocollo competitivo con altri servizi di staking.**

Dovrai apportare alcune modifiche al tuo Beacon Node / client di Consenso per connetterlo a MEV-boost.

MEV-boost attualmente non è disponibile su Hoodi o Mainnet, quindi non è necessario configurarlo in questo momento.
Naturalmente, non sarai penalizzato per non utilizzarlo durante questo periodo di transizione.

Una volta che diventerà disponibile, annunceremo una data entro la quale dovrà essere installato e connesso al tuo nodo.
Flashbots fornirà istruzioni che potrai seguire in quel momento e le collegheremo qui.

::: danger NOTA
Una volta che faremo l'annuncio che MEV-boost deve essere abilitato da tutti gli operatori di nodi, devi assicurarti di averlo installato e configurato correttamente con il tuo Beacon Node!

Non farlo comporterà che il tuo minipool venga [penalizzato](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).
:::

### Configurare un Nodo di Fallback

Poiché il Merge non è compatibile con provider remoti come Infura e Pocket, perderai la possibilità di utilizzarli come client di Esecuzione di fallback quando il tuo primario va offline.

Lo Smartnode ha ancora la capacità di fornire un client di Esecuzione di fallback (e ora anche un client di Consenso di fallback), ma ora dovrai utilizzare client di Esecuzione e Consenso che controlli tu.

Per maggiori informazioni sulla configurazione di un nodo di fallback, consulta la [guida al nodo di fallback](../../node-staking/fallback).

### Inizializzare il Tuo Fee Distributor

Se non prevedi di aderire al [Smoothing Pool](./whats-new#smoothing-pool) e richiedere tutte le tue commissioni prioritarie e ricompense MEV al tuo [contratto di distribuzione delle commissioni](./whats-new#fee-recipients-and-your-distributor), alla fine dovrai inizializzarlo (creare l'istanza del contratto sulla catena) per poter richiedere le ricompense da esso al tuo indirizzo di prelievo.

Questa è un'operazione abbastanza economica e deve essere eseguita solo una volta.

::: tip SUGGERIMENTO
L'inizializzazione del tuo fee distributor può essere eseguita **in qualsiasi momento**.
Puoi lasciare accumulare le ricompense nel suo indirizzo molto prima di inizializzarlo e il tuo saldo rimarrà dopo l'inizializzazione.

Ti consigliamo di farlo quando i prezzi del gas sono bassi per ridurre al minimo i costi di overhead.

Nota che **deve essere inizializzato per poter richiedere le tue ricompense.**
:::

### Aderire al Smoothing Pool

Se prevedi di approfittare del [Smoothing Pool](./whats-new#smoothing-pool) subito, dovresti aderire prima della fine del primo periodo di ricompense Redstone per massimizzare la tua quantità di "eleggibilità".

L'adesione può essere eseguita tramite il seguente comando:

```shell
rocketpool node join-smoothing-pool
```

### Richiedere Ricompense

L'aggiornamento Redstone sostituisce il vecchio sistema di ricompense costoso e problematico con uno [completamente nuovo](./whats-new#new-rewards-system) che è molto più economico, supporta il restaking automatico di RPL (sia importi parziali che completi) e - cosa più importante - **ti consente di richiedere le tue ricompense quando vuoi**.

Poiché non c'è più un limite di tempo per richiedere le ricompense e poiché è più economico richiedere molti intervalli di ricompense contemporaneamente, la funzione di richiesta automatica delle ricompense dello Smartnode **è stata rimossa**.
Ora potrai richiedere le ricompense tramite il seguente comando:

```shell
rocketpool node claim-rewards
```

Questo ti mostrerà tutte le ricompense che hai accumulato attraverso tutti gli intervalli di ricompense a partire dall'aggiornamento Redstone.

## Ripristino alla v1.4.3

Se, per qualsiasi motivo, qualcosa non è di tuo gradimento e desideri ripristinare la versione precedente dello Smartnode, puoi farlo facilmente.
Lo Smartnode esegue automaticamente il backup delle impostazioni della versione precedente quando lo aggiorni, quindi basta ottenere la versione precedente (qui stiamo dimostrando la **v1.4.3**) e sostituire le impostazioni con il backup:

1. Ferma il servizio:

```shell
rocketpool service stop
```

1. Scarica la CLI v1.4.3:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Installa il pacchetto v1.4.3:

```shell
rocketpool service install -d
```

1. Sostituisci la tua vecchia configurazione con la configurazione di backup v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Verifica che tutte le tue vecchie impostazioni siano ora in uso:

```shell
rocketpool service config
```

1. Se sembra a posto, avvia lo stack Smartnode:

```shell
rocketpool service start
```

Tutto pronto! Ora sei tornato alla vecchia versione e dovresti iniziare ad attestare poco dopo aver avviato il servizio.

::: danger AVVISO
La v1.4.3 è **deprecata** e non sarà più utilizzabile dopo che l'aggiornamento Redstone sarà stato distribuito.
Se hai bisogno di ripristinarla, fai piani per tornare alla v1.5.0 prima che i contratti vengano aggiornati!
:::
