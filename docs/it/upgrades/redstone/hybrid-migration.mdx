import { Tab, Tabs } from "@rspress/core/theme";

# [Modalità Ibrida] Guida all'Aggiornamento Redstone e al Merge

Questa guida coprirà tutto ciò che devi sapere per preparare il tuo nodo per l'Aggiornamento Redstone e The Merge se stai utilizzando la **Modalità Ibrida**.

## Cose da Fare Prima di Aggiornare alla v1.5.0

Prima di aggiornare alla v1.5.0 e superiore dello Smartnode, si prega di esaminare la seguente checklist per assicurarti di essere preparato:

### Passare a un Execution Client Completo

Il Merge richiede che tu esegua il tuo proprio Execution client, quindi non potrai più utilizzare provider remoti come Infura o Pocket.

A causa di questo cambiamento, se stai attualmente utilizzando un Execution client leggero, dovresti passare a un client completo mentre sei ancora sulla v1.4, lasciarlo sincronizzare fino al completamento, e poi aggiornare alla v1.5.

### Assicurarsi che EC e CC Siano Entrambi Gestiti Esternamente

Le versioni precedenti dello stack Smartnode ti permettevano di avere un client gestito localmente, e l'altro gestito esternamente.
Ad esempio, potresti avere un Execution client che lo Smartnode gestisce e collegarlo a un Consensus client che gestisci esternamente.

A partire dalla v1.5, questa configurazione non è più supportata.
Dovrai passare a un Execution e Consensus client gestiti localmente (noto anche come [Docker Mode](./docker-migration.mdx)), o configurare sia un Execution che un Consensus client che gestisci da solo.

::: tip SUGGERIMENTO
Se sei interessato a lasciare che lo Smartnode mantenga il proprio Execution e Consensus client ma vuoi mantenere il controllo sul tuo proprio Validator client (ad esempio, se hai le tue chiavi di validatore solo staking collegate ad esso), potresti voler considerare la [Modalità Ibrida Inversa](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode) che fa esattamente questo!
:::

### Configurare l'Engine API

Il Merge cambia il modo in cui il tuo Execution client comunica con il tuo Consensus client.
Invece di utilizzare il vecchio sistema RPC basato su HTTP o Websocket, The Merge richiede un nuovo sistema esposto dal tuo Execution client chiamato Engine API.

Questa è una connessione speciale che consente al Consensus client di sostituire il vecchio sistema di mining Proof-of-Work con Proof-of-Stake; è il cuore del Merge.
È anche **autenticata** con un token segreto, quindi solo il tuo Consensus client può connettersi al tuo Execution client - nient'altro può farlo.

Poiché gestisci il tuo proprio Execution e Consensus client, dovrai configurare l'Engine API manualmente.
Come farlo dipende interamente da quali client stai eseguendo.

CoinCashew ha [una guida eccellente e concisa](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) su come configurare l'Engine API sui tuoi Execution e Consensus client.
Dai un'occhiata, e prova la nuova configurazione assicurandoti che attesti ancora correttamente prima di aggiornare.

Come sempre, Rocket Pool gestirà il proprio Validator client quindi non devi preoccuparti di modificarlo manualmente.

## Aggiornamento alla v1.5.0

L'aggiornamento dello stack Smartnode alla v1.5.0 non è diverso da qualsiasi altro aggiornamento.
Semplicemente segui [le normali indicazioni qui](../../node-staking/updates#updating-the-smartnode-stack).

## Cose che lo Smartnode Gestisce Automaticamente

In modalità Ibrida, lo Smartnode si occuperà di alcuni dei cambiamenti necessari per supportare Redstone automaticamente una volta che aggiorni alla v1.5.0, ma dovrai gestire altri manualmente in Modalità Ibrida.

Ecco un breve elenco di cosa farà per te senza alcun intervento manuale:

### Il Tuo Fee Recipient

Il **fee recipient** è l'indirizzo sul layer di Esecuzione (eth1) che riceverà tutte le commissioni prioritarie per i blocchi che proponi.
È un'impostazione fornita al tuo Validator client quando si avvia per la prima volta.

Lo Smartnode gestirà la sua configurazione all'indirizzo corretto sul Validator client che gestisce quando aggiorni alla v1.5, e controllerà costantemente per assicurarsi che tu stia usando quello corretto così non vieni [penalizzato accidentalmente](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Se hai optato per la [Smoothing Pool](./whats-new#smoothing-pool), la renderà il tuo fee recipient.
Se non l'hai fatto, renderà il tuo [contratto distributore di commissioni](./whats-new#fee-recipients-and-your-distributor) il fee recipient.

## Cose che Dovresti Fare Dopo l'Aggiornamento

Mentre lo Smartnode gestisce la maggior parte dei cambiamenti per te, ci sono alcune cose aggiuntive che dovresti fare manualmente:

### Assicurare un Aggiornamento Riuscito

La prima cosa da fare è assicurarsi che il tuo nodo stia funzionando correttamente.
Considera di intraprendere i seguenti passi:

- Controlla i log per errori con `rocketpool service logs validator` e `rocketpool service logs node`.
- Conferma con un Block Explorer (come la tua dashboard Grafana e [https://beaconcha.in](https://beaconcha.in)) che stai ancora attestando correttamente
  - Ricorda che se hai la protezione Doppelganger abilitata, perderai alcune attestazioni dopo il riavvio. Questo è normale!

### Configurare MEV-Boost

[MEV-boost](https://boost.flashbots.net/) è il sistema che Flashbots fornisce per dare ricompense MEV ai validatori Proof-of-Stake dopo The Merge.

**Rocket Pool richiede a tutti i nodi di utilizzarlo per massimizzare i loro rendimenti e quindi mantenere il protocollo competitivo con altri servizi di staking.**

Dovrai apportare alcune modifiche al tuo Beacon Node / Consensus client per collegarlo a MEV-boost.

MEV-boost non è attualmente disponibile su Hoodi o Mainnet, quindi non è necessario configurarlo in questo momento.
Naturalmente, non sarai penalizzato per non utilizzarlo durante questo periodo di transizione.

Una volta che diventa disponibile, annunceremo una data entro cui deve essere installato e collegato al tuo nodo.
Flashbots fornirà istruzioni che potrai seguire in quel momento, e le collegheremo qui.

::: danger NOTA
Una volta che facciamo l'annuncio che MEV-boost deve essere abilitato da tutti gli operatori di nodi, devi assicurarti di averlo installato e configurato correttamente con il tuo Beacon Node!

Non farlo comporterà la [penalizzazione](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) del tuo minipool.
:::

### Configurare un Nodo di Fallback

Poiché The Merge non è compatibile con provider remoti come Infura e Pocket, perderai la possibilità di utilizzarli come Execution client di fallback quando il tuo primario va offline.

Lo Smartnode ha ancora la capacità di fornire un Execution client di fallback (e ora anche un Consensus client di fallback), ma ora dovrai utilizzare Execution e Consensus client che controlli.

Per ulteriori informazioni sulla configurazione di un nodo di fallback, vedere la [guida al nodo di fallback](../../node-staking/fallback).

### Inizializzare il Tuo Fee Distributor

Se non hai intenzione di optare per la [Smoothing Pool](./whats-new#smoothing-pool) e rivendicare tutte le tue commissioni prioritarie e ricompense MEV al tuo [contratto distributore di commissioni](./whats-new#fee-recipients-and-your-distributor), alla fine dovrai inizializzarlo (creare l'istanza del contratto sulla chain) per rivendicare ricompense da esso al tuo indirizzo di prelievo.

Questa è un'operazione abbastanza economica e deve essere fatta solo una volta.

::: tip SUGGERIMENTO
L'inizializzazione del tuo fee distributor può essere fatta **in qualsiasi momento**.
Puoi lasciare accumulare le ricompense nel suo indirizzo molto prima di inizializzarlo, e il tuo saldo rimarrà dopo l'inizializzazione.

Ti consigliamo di farlo quando i prezzi del gas sono bassi per minimizzare il costo generale.

Nota che **deve essere inizializzato per rivendicare le tue ricompense.**
:::

### Optare per la Smoothing Pool

Se hai intenzione di approfittare della [Smoothing Pool](./whats-new#smoothing-pool) immediatamente, dovresti optare prima della fine del primo periodo di ricompense Redstone per massimizzare il tuo importo di "idoneità".

L'adesione può essere effettuata eseguendo il seguente comando:

```shell
rocketpool node join-smoothing-pool
```

### Rivendicare Ricompense

L'aggiornamento Redstone sostituisce il vecchio sistema di ricompense costoso e problematico con un [nuovo di zecca](./whats-new#new-rewards-system) che è molto più economico, supporta il re-staking automatico di RPL (sia importi parziali che completi), e - più importante - **ti permette di rivendicare le tue ricompense quando vuoi**.

Poiché non c'è più un limite di tempo per rivendicare le ricompense, e poiché è più economico rivendicare molti intervalli di ricompense contemporaneamente, la funzionalità di rivendicazione automatica delle ricompense dello Smartnode **è stata rimossa**.
Ora sarai in grado di rivendicare ricompense tramite il seguente comando:

```shell
rocketpool node claim-rewards
```

Questo ti mostrerà tutte le ricompense che hai accumulato in tutti gli intervalli di ricompense a partire dall'aggiornamento Redstone.

## Ripristino alla v1.4.3

Se, per qualsiasi motivo, qualcosa non è di tuo gradimento e vuoi ripristinare la versione precedente dello Smartnode, puoi farlo facilmente.
Lo Smartnode esegue automaticamente il backup delle tue impostazioni dalla versione precedente quando lo aggiorni, quindi semplicemente ottieni la versione precedente (qui stiamo dimostrando **v1.4.3**) e sostituisci le impostazioni con il backup:

1. Ferma il servizio:

```shell
rocketpool service stop
```

1. Scarica la CLI v1.4.3:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Installa il pacchetto v1.4.3:

```shell
rocketpool service install -d
```

1. Sostituisci la tua vecchia configurazione con la configurazione di backup v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Verifica che tutte le tue vecchie impostazioni siano ora utilizzate:

```shell
rocketpool service config
```

1. Se sembra a posto, avvia lo stack Smartnode:

```shell
rocketpool service start
```

Tutto pronto! Ora sei tornato alla vecchia versione e dovresti iniziare ad attestare poco dopo aver avviato il servizio.

::: danger AVVISO
v1.4.3 è **deprecata** e non sarà più utilizzabile dopo che l'aggiornamento Redstone viene distribuito.
Se hai bisogno di ripristinarla, si prega di fare piani per aggiornare di nuovo alla v1.5.0 prima che i contratti vengano aggiornati!
:::
