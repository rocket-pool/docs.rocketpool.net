import { Tab, Tabs } from "@rspress/core/theme";

# Обновление до Smartnode v1.3.x

Версия 1.3.0 стека Smartnode вносит некоторые важные изменения, о которых пользователи должны знать.
Они разработаны для значительного улучшения опыта работы оператора узла и решения многих функций, которые наши пользователи запрашивали с момента запуска Rocket Pool.

В этом руководстве мы проведем вас через процесс миграции со старой версии Smartnode на v1.3.x и выше.

## Изменения файла конфигурации

v1.3.0 вносит значительные изменения в способ управления конфигурацией Smartnode.
Если вы ранее вручную изменяли конфигурацию Smartnode, вы должны знать о следующих изменениях:

- Файл `config.yml` был удален. Вся его информация теперь встроена непосредственно в стек Smartnode, поэтому пользователи больше не могут случайно изменить файл таким образом, который помешал бы правильной работе Smartnode.
  - Все настраиваемые пользователем параметры, которые ранее были его частью, теперь являются настройками в новом терминальном пользовательском интерфейсе `service config`.

- Файл `settings.yml` был заменен новым файлом `user-settings.yml`. Он содержит все ваши настройки для каждой настраиваемой пользователем части Smartnode.
  - Этот файл **не предназначен для прямого изменения**. Изменение должно производиться через новый терминальный пользовательский интерфейс `service config`.

- Папка `chains` была удалена. Скрипты для запуска клиента исполнения (ETH1), узла Beacon и клиента валидатора теперь находятся в папке `scripts`.

- Файлы YAML `docker-compose` были удалены. Каждый контейнер теперь получает свой собственный файл в папке `templates`. При выполнении `rocketpool service start` эти шаблоны автоматически заполняются вашими настройками и помещаются в папку `runtime`.
  - Изменение шаблонов или файлов runtime не рекомендуется. Вместо этого заполните настройки контейнера, используя файлы **override** для каждого контейнера в папке `override`. Эти файлы перезапишут файлы Docker в `runtime`, поэтому вы можете настраивать их по своему усмотрению.
  - Файлы в `override` **сохранятся при обновлениях и переустановке Smartnode**, поэтому вам нужно создать их только один раз.
  - Если вас интересует изменение файлов `docker-compose` с помощью этого механизма override, пожалуйста, см. [этот раздел](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## Установка новой версии

Установка новой версии должна быть очень знакомой.

Начните с остановки сервисов и загрузки нового CLI как обычно:

<div className="p-3">
  <Tabs>
    <Tab label="Режим Docker или гибридный">
      Остановите сервисы Rocket Pool:

      ```
      rocketpool service stop
      ```

      Загрузите новый Smartnode CLI для вашей системы (выберите из вкладок ниже):

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Для систем `x64` (большинство обычных машин):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Для систем `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Для систем `x64` (большинство Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Для систем `arm64`, таких как Mac mini с M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Теперь выполните команду установки:

      ```
      rocketpool service install -d
      ```

      Флаг `-d` указывает игнорировать системные зависимости, такие как Docker, поскольку они у вас уже есть.

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">ПРИМЕЧАНИЕ</p>
        Начиная с v1.3.0, вам **больше не нужно указывать, для какой сети вы хотите установить!**
        Новый Smartnode будет знать, какую сеть вы уже используете, и позволит вам динамически изменять сеть с помощью нового терминального пользовательского интерфейса.
      </p>
    </Tab>
    <Tab label="Нативный режим">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">ПРИМЕЧАНИЕ</p>
        Это обновит только сам стек Smartnode - это **не** обновит ваши клиенты исполнения и консенсуса.
        Вам придется сделать это вручную (см. [руководство по ручному обновлению](../node-staking/updates#manually-updating-the-eth1-or-eth2-client) чтобы узнать, как это сделать).
      </p>

      Остановите сервисы Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Загрузите новые бинарные файлы Smartnode CLI и демона:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Для систем `x64` (большинство обычных машин):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Для систем `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Для систем `x64` (большинство Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Для систем `arm64`, таких как Mac mini с M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">ПРИМЕЧАНИЕ</p>
        Начиная с v1.3.0, `config.yml` был удален.
        **Вам больше не нужно загружать пакет установщика и извлекать его.**
      </p>
      Затем создайте резервную папку с именем `old_config_backup` в вашем каталоге Smartnode и переместите в нее старые файлы конфигурации (`config.yml` и `settings.yml`).
      Smartnode использует их для миграции ваших настроек в новую систему.

      Например, если вы следовали руководству по установке Native и ваш каталог Smartnode - `/srv/rocketpool`:

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      Теперь измените файлы определения сервиса для `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Замените строку `ExecStart` следующей:

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      Обратите внимание, что флаг `--config` был удален, а `--settings` теперь указывает на `user-settings.yml`.
      **Не беспокойтесь, что этого файла еще не существует; он будет создан автоматически на следующем шаге.**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">ПРИМЕЧАНИЕ</p>
        Если вы являетесь членом Oracle DAO, вы _должны_ повторить описанный выше процесс для сервиса `rp-watchtower`.
      </p>

      Наконец, перезагрузите определения сервисов:

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

После установки все ваши старые файлы конфигурации будут перемещены в папку с именем `old_config_backup` в вашем каталоге Smartnode (по умолчанию `~/.rocketpool/old_config_backup`).
Вы можете найти их там, если вам когда-либо понадобится обратиться к ним по какой-либо причине.

**Если вы ищете инструкции по возврату к v1.2.4 из этой резервной копии, пожалуйста, перейдите к разделу [Возврат к предыдущей конфигурации](#reverting-to-your-previous-configuration) в конце этой страницы.**

## Настройка Smartnode с помощью терминального пользовательского интерфейса

Теперь, когда у вас установлен новый CLI и пакет, все ваши предыдущие настройки были сохранены и перенесены в новую систему.
На следующем шаге вы должны выполнить `rocketpool service config`.
Это будет выглядеть совершенно иначе по сравнению с предыдущими версиями этой функции; v1.3.0 представляет **терминальный пользовательский интерфейс**: динамический пользовательский интерфейс на основе терминала для настройки вашего Smartnode.

Вы должны запустить его перед запуском контейнеров Docker после процесса миграции, чтобы просмотреть конфигурацию, убедиться, что все ваши изменения были успешно перенесены, и обновить любые другие настройки по вашему желанию.

При первом запуске вы увидите этот экран приветствия (если вы использовали **режим Docker или гибридный режим**):

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip ПРИМЕЧАНИЕ
**Пользователи нативного режима** увидят этот экран с немного другой формулировкой, в которой говорится, что Smartnode работает в нативном режиме.
:::

TUI начнется с **Мастера**, который позволяет быстро и легко изменить наиболее важные параметры Smartnode (такие как режим и выбор клиента).

**Все ваши предыдущие настройки должны быть уже выделены при переходе по каждой странице мастера, чтобы вам не приходилось запоминать вашу предыдущую конфигурацию.**

:::warning ПРИМЕЧАНИЕ
**Для подробного прохождения этого Мастера, пожалуйста, посетите следующие страницы:**

- Для **режима Docker** посетите [новое руководство по настройке Docker](../node-staking/config-docker).

- Пользователи **гибридного режима**: гибридный режим теперь является **первоклассной функцией** Smartnode, и его настройка _намного_ проще, чем раньше. Пожалуйста, посетите [новое руководство по настройке Docker](../node-staking/config-docker) и следуйте ему. Когда вас попросят выбрать режим клиента исполнения и режим клиента консенсуса, выберите **Externally Managed** для них соответственно.

- Для **нативного режима** посетите [новое руководство по настройке Native](../node-staking/config-native).

:::

Пройдитесь по этому мастеру и убедитесь, что все ваши настройки верны.

После завершения у вас будет возможность **просмотреть все настройки перед сохранением**, если хотите.
Это включает настройки, которые мастер не охватил, такие как **порог газа для требования RPL** или ваше **максимальное количество пиров Geth** в качестве примеров.

**Главный экран настроек**, на который вам также следует взглянуть для подтверждения ваших предыдущих настроек, будет выглядеть так (для пользователей Docker и гибридного режима):

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip ПРИМЕЧАНИЕ
**Пользователи нативного режима** увидят немного другой экран, уникальный для нативного режима и представляющий только настройки, относящиеся к нему.
:::

Не стесняйтесь исследовать этот новый пользовательский интерфейс и настраивать любые настройки по своему усмотрению.
Используйте `клавиши со стрелками` для навигации и нажмите `Enter`, чтобы войти в категорию или подтвердить любые изменения настройки, которые вы вносите.

Нажмите `Esc`, когда закончите редактирование категории, чтобы вернуться на этот главный экран.

Когда вы будете готовы сохранить изменения и запустить стек Smartnode, просто нажмите `Tab`, чтобы переместиться вниз к кнопкам в нижней части экрана, выберите `Review Changes and Save` (сделав её зеленой с помощью клавиш со стрелками).
Нажмите `Enter`, чтобы перейти на **страницу проверки**, где вы можете увидеть все, что вы изменили с момента последнего запуска `rocketpool service config`.

Подтвердите, что все ваши изменения присутствуют, а затем снова нажмите `Enter`, чтобы сохранить их.
Экран покажет вам, какие контейнеры необходимо перезапустить для применения изменений, хотя, поскольку вы выполняете миграцию, вы уже выключили контейнеры, и они все равно будут перезапущены.

## Запуск стека Smartnode

После сохранения конфигурации терминал спросит, хотите ли вы перезапустить контейнеры автоматически (если вы не используете нативный режим).
Если вы не хотите / не можете запустить их автоматически, вы можете запустить их вручную с помощью следующих команд:

<div className="p-3">
  <Tabs>
    <Tab label="Режим Docker или гибридный">```shell rocketpool service start ```</Tab>
    <Tab label="Нативный режим">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

После запуска вы можете убедиться, что все работает как задумано.

Используйте команду `rocketpool service version`, чтобы проверить, что у вас правильная версия Smartnode и контейнеров клиентов:

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

Используйте команды `rocketpool service logs eth1` и `rocketpool service logs eth2`, чтобы просмотреть логи для вашего клиента исполнения (ранее клиент ETH1) и вашего клиента консенсуса (ранее клиент ETH2).
Обратите внимание на любые ошибки и [пожалуйста, посетите наш сервер Discord для помощи](https://discord.com/invite/rocketpool), если вы столкнетесь с ними.

## Возврат к предыдущей конфигурации

Если по какой-либо причине вам нужно вернуться к v1.2.4 стека Smartnode, не волнуйтесь!
Все ваши старые файлы конфигурации были сохранены в резервном каталоге и могут быть легко восстановлены для восстановления вашей предыдущей настройки.

Выберите режим, который вы используете, из вкладок ниже и следуйте инструкциям.

<div className="p-3">
  <Tabs>
    <Tab label="Режим Docker или гибридный">
      Начните с замены CLI на CLI v1.2.4 для вашей системы:
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Для систем `x64` (большинство обычных машин):

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Для систем `arm64`:

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Для систем `x64` (большинство Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Для систем `arm64`, таких как Mac mini с M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Затем скопируйте все ваши старые файлы конфигурации из папки `old_config_backup` обратно в папку Smartnode:

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      Теперь все, что вам нужно сделать, это перезапустить контейнеры Docker:

      ```shell
      rocketpool service start
      ```

      Готово! Ваша старая конфигурация восстановлена.

    </Tab>
    <Tab label="Нативный режим">
      Остановите сервисы Rocket Pool:

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Для систем `x64` (большинство обычных машин):

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Для систем `arm64`:

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Для систем `x64` (большинство Mac):

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Для систем `arm64`, таких как Mac mini с M1:

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      Скопируйте предыдущие файлы настроек обратно в каталог Smartnode:

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      Теперь верните файлы определения сервиса для `rp-node`:

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Замените строку `ExecStart` следующей:

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">ПРИМЕЧАНИЕ</p>
        Если вы являетесь членом Oracle DAO, вы _должны_ повторить описанный выше процесс для сервиса `rp-watchtower`.
      </p>

      Наконец, перезагрузите определения сервисов и перезапустите сервисы:

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      Готово! Ваша старая конфигурация восстановлена.
    </Tab>

  </Tabs>
</div>
