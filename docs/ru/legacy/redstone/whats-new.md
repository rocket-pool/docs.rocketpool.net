# Обновление Rocket Pool Redstone

Следующее крупное обновление Rocket Pool под названием **Redstone** было выпущено для бета-тестирования в тестовых сетях Ropsten и Holesky.
Эта страница описывает основные изменения, которые приносит Redstone, включая обновления стека Smartnode и протокола Rocket Pool в целом.

Пожалуйста, внимательно прочитайте эту страницу, чтобы понять все различия между предыдущей версией Rocket Pool и Redstone.

::: tip ВНИМАНИЕ
Для получения подробной информации о том, как подготовить вашу ноду к обновлению и что делать после обновления, обратитесь к следующим руководствам:

- [Руководство для режима Docker](./docker-migration.mdx)
- [Руководство для гибридного режима](./hybrid-migration.mdx)
- [Руководство для нативного режима](./native-migration.mdx)

:::

## Изменения клиентов и слияние

Ropsten (и вскоре Holesky) успешно прошли **слияние уровней исполнения и консенсуса**.
Они больше не используют Proof-of-Work; вместо этого валидаторы в Ropsten теперь отвечают за создание и предложение блоков в обеих цепях.
Хотя это приносит некоторые интересные финансовые преимущества (которые будут обсуждаться позже), это также влечет за собой важные изменения в работе валидаторов.

Ниже приведено краткое описание изменений в поведении клиентов в рамках слияния:

- Ваш клиент исполнения теперь использует три API-порта:
  - Один для HTTP-доступа к его API (**по умолчанию 8545**)
  - Один для доступа через Websocket к его API (**по умолчанию 8546**)
  - Один для нового **Engine API**, используемого клиентами консенсуса после слияния (**по умолчанию 8551**)

- Клиентам исполнения теперь требуется клиент консенсуса для функционирования, а клиентам консенсуса требуется клиент исполнения.
  - **Ни один из них больше не может работать изолированно.**

- Один клиент исполнения должен быть связан с одним, и только одним клиентом консенсуса (и наоборот).
  - Вы не сможете связать несколько клиентов исполнения с одним клиентом консенсуса или несколько клиентов консенсуса с одним клиентом исполнения.
  - По этой причине **резервные клиенты исполнения больше не доступны** для операторов нод Rocket Pool.

- Требуются **полные клиенты исполнения**.
  - Удаленные провайдеры (такие как Infura и Pocket) больше не могут использоваться никакими валидаторами, Rocket Pool или другими.

## Получатели комиссий и ваш дистрибьютор

Поскольку валидаторы теперь отвечают за создание блоков, это означает, что они получают **приоритетные комиссии** (также известные как **чаевые**), прикрепленные к каждой транзакции.
Эти комиссии выплачиваются в ETH и предоставляются вам напрямую каждый раз, когда один из валидаторов вашего minipoolа предлагает блок.
В отличие от ETH, заблокированных в Beacon Chain, **вам не нужно ждать вывода средств, чтобы получить доступ к вашим приоритетным комиссиям**!
Они просто присуждаются вам как часть процесса предложения блока.

Чтобы знать, куда отправлять комиссии, вашему клиенту валидатора требуется дополнительный параметр, известный как `fee recipient` (получатель комиссии).
Это адрес на уровне исполнения (ETH1), на который будут отправляться все приоритетные комиссии, заработанные вашей нодой во время предложения блоков.

Rocket Pool разработан для справедливого распределения этих вознаграждений так же, как он справедливо распределяет ваши вознаграждения Beacon chain: половина любых приоритетных комиссий, которые зарабатывают валидаторы вашего minipoolа, достанется вам (плюс средняя комиссия всех ваших minipoolов), а другая половина достанется стейкерам пула (минус ваша средняя комиссия).

Для этого Smartnode автоматически установит `fee recipient` вашего клиента валидатора на специальный адрес, известный как **дистрибьютор комиссий** вашей ноды.
Ваш дистрибьютор комиссий — это уникальный контракт на уровне исполнения, **специфичный для вашей ноды**.
Он будет хранить все приоритетные комиссии, которые вы заработали с течением времени, и содержит логику, необходимую для их справедливого разделения и распределения.
Этот процесс распределения контролируется вами (оператором ноды) и может быть выполнен в любое время.
У него нет временных ограничений.

Адрес дистрибьютора комиссий вашей ноды **детерминированно основан на адресе вашей ноды**.
Это означает, что он известен заранее, еще до создания дистрибьютора комиссий.
**Smartnode будет использовать этот адрес в качестве вашего получателя комиссий.**

::: tip ПРИМЕЧАНИЕ
По умолчанию ваш получатель комиссий будет установлен на **адрес rETH**, когда вы установите Smartnode v1.5.0 (если обновления контрактов Redstone еще не были развернуты).
Smartnode автоматически обновит это на адрес дистрибьютора комиссий вашей ноды после развертывания обновления Redstone.

Одно исключение из этого правила — если вы участвуете в **Smoothing Pool** — см. раздел в конце этой страницы для получения дополнительной информации об этом.
:::

Новые ноды Rocket Pool автоматически инициализируют контракт дистрибьютора своей ноды при регистрации.
Существующим нодам нужно будет выполнить этот процесс вручную.
Это нужно сделать только один раз.

Одним интересным следствием этого является то, что адрес вашего дистрибьютора может начать накапливать баланс **до того**, как вы инициализируете контракт дистрибьютора вашей ноды.
Это нормально, потому что ваш дистрибьютор получит доступ ко всему этому существующему балансу, как только вы его инициализируете.

Вы можете просмотреть баланс вашего дистрибьютора комиссий как часть:

```shell
rocketpool node status
```

Вывод будет выглядеть следующим образом:

![](../../node-staking/images/status-fee-distributor.png)

Чтобы инициализировать дистрибьютор вашей ноды, просто выполните эту новую команду:

```shell
rocketpool node initialize-fee-distributor
```

::: warning ПРИМЕЧАНИЕ
После обновления Redstone вы должны вызвать эту функцию, прежде чем сможете создавать новые minipoolы с помощью `rocketpool node deposit`.
:::

Когда ваш дистрибьютор будет инициализирован, вы можете запросить и распределить весь его баланс с помощью следующей команды:

```shell
rocketpool node distribute-fees
```

Это отправит вашу долю вознаграждений на ваш **адрес вывода средств**.

## Изменения протокола Rocket Pool

В дополнение к изменениям клиентов исполнения и консенсуса и новым приоритетным комиссиям, сам протокол Rocket Pool претерпел некоторые важные изменения, о которых вам следует знать.

### Новая система вознаграждений

Одним из наиболее значительных изменений, внесенных в обновление Redstone, является **новая система вознаграждений**.
Это полная переработка способа, которым операторы нод получают свои вознаграждения RPL (и ETH из Smoothing Pool — обсуждается позже).

_Старая_ система вознаграждений имела следующие недостатки:

- Запрос стоил приблизительно 400 тысяч газа, что довольно дорого.
- Операторы нод должны были запрашивать вознаграждения в каждом интервале (каждые 28 дней), иначе они теряли их. Это означало, что затраты на газ могли стать непомерно дорогими для операторов нод с небольшими суммами RPL.
- Вознаграждения определялись во время _запроса_, а не во время контрольной точки. Если пользователь застейкал значительное количество RPL между контрольной точкой и вашим запросом, ваши вознаграждения могли быть разбавлены, и вы получили бы меньше RPL, чем ожидали.

_Новая_ система запросов решает все эти проблемы.

На каждом интервале Oracle DAO коллективно создаст **истинный снимок** состояния операторов нод в сети Rocket Pool, включая все их эффективные суммы стейка.
Эта информация компилируется в [дерево Меркла](https://en.wikipedia.org/wiki/Merkle_tree) — чрезвычайно эффективный способ сделать все детали доступными для смарт-контрактов.
Дерево Меркла встраивается в JSON-файл и размещается в [межпланетной файловой системе (IPFS)](https://en.wikipedia.org/wiki/InterPlanetary_File_System), а корень дерева Меркла отправляется в контракты.

Эта новая система имеет следующие особенности:

- Теперь вы можете **позволить вознаграждениям накапливаться** столько времени, сколько хотите. Больше нет временных ограничений на то, когда вам нужно запрашивать их.
- Вы можете запрашивать **несколько интервалов** одновременно.
- Ваша первая транзакция запроса использует около 85 тысяч газа. Каждая последующая транзакция запроса стоит около 55 тысяч газа.
  - Если вы запрашиваете несколько интервалов одновременно, каждый дополнительный интервал стоит **6 тысяч газа**, поэтому наиболее экономически выгодно запрашивать как можно больше из них за один раз.
- Ваши вознаграждения RPL **больше не разбавляются** — ваши вознаграждения RPL фиксируются во время снимка, и вы всегда имеете право на эту сумму.
- Вы можете **рестейкнуть часть (или все) ваших вознаграждений RPL** в рамках транзакции запроса, что дополнительно сокращает требования к газу по сравнению с сегодняшним днем.
- В настоящее время **все ваши запросы должны быть в Mainnet**, но у нас есть инфраструктура для создания возможности запроса в сетях Layer 2 позднее.

Когда ваша нода обнаружит новую контрольную точку вознаграждений, она автоматически загрузит JSON-файл для этого интервала.
Затем вы можете просмотреть свои вознаграждения с помощью следующей команды:

```shell
rocketpool node claim-rewards
```

По мере прохождения интервалов и накопления вознаграждений вывод будет выглядеть следующим образом:

![](../../node-staking/images/claim-rewards-gb.png)

Здесь вы можете быстро увидеть, сколько вознаграждений вы заработали в каждом интервале, и решить, какие из них вы хотите запросить.
Обратите внимание, что **время интервала Ropsten установлено на 1 день для облегчения тестирования.**

Вы также можете указать сумму, которую хотите рестейкнуть во время этого запроса:

![](../../node-staking/images/autostake.png)

Это позволит вам совместить ваши вознаграждения RPL в одной транзакции, используя значительно меньше газа, чем вам нужно использовать сегодня.

::: tip ПРИМЕЧАНИЕ
Если вы предпочитаете создавать контрольную точку вознаграждений вручную вместо загрузки созданной Oracle DAO, вы можете изменить эту настройку с `Download` на `Generate` в TUI:

![](../../node-staking/images/tui-generate-tree.png)

Как подсказывает подсказка, для этого вам понадобится доступ к архивной ноде.
Если ваш локальный клиент исполнения не является архивной нодой, вы можете указать отдельную (например, Infura или Alchemy) в поле `Archive-Mode EC URL` под ним.
Этот URL будет использоваться только при генерации деревьев Меркла; он не будет использоваться для обязанностей валидации.
:::

::: danger ПРЕДУПРЕЖДЕНИЕ
Если у вас меньше 10% залога RPL _во время снимка_, вы не будете иметь право на вознаграждения за этот снимок.
В отличие от текущей системы, где вы можете просто "пополнить" перед запросом, чтобы снова стать правомочным, это будет зафиксировано в этом снимке навсегда, и **вы никогда не получите вознаграждения за этот период**.
Вы **должны** иметь более 10% залога во время снимка, чтобы получить вознаграждения за этот период.
:::

### Smoothing Pool

Одной из последних захватывающих новых функций обновления Redstone является **Smoothing Pool**.
Smoothing Pool — это **опциональная функция**, которая будет коллективно объединять приоритетные комиссии каждого участника, который в него вступил.
Во время контрольной точки вознаграждений общий баланс ETH пула делится на часть стейкеров пула и часть операторов нод.
Все вознаграждения в части операторов нод **распределяются справедливо каждому участнику пула**.

По сути, Smoothing Pool — это способ эффективно устранить случайность, связанную с предложениями блоков в Beacon Chain.
Если у вас когда-либо была полоса неудач, и вы месяцами не получали предложений, вы можете найти Smoothing Pool весьма захватывающим.

::: tip ПРИМЕЧАНИЕ
Вознаграждения Smoothing Pool встроены в дерево Меркла, используемое для вознаграждений RPL, поэтому вы запрашиваете их одновременно с запросом RPL с помощью `rocketpool node claim-rewards`.
:::

Чтобы помочь прояснить детали, Smoothing Pool использует следующие правила:

- Вступление в Smoothing Pool осуществляется на **уровне ноды**. Если вы вступили, все ваши minipoolы вступили.

- Общая доля оператора ноды определяется средней комиссией каждого minipoolа в каждой ноде, вступившей в Smoothing Pool.

- Любой может вступить в любое время. Они должны подождать полный интервал вознаграждений (1 день в Ropsten, 28 дней в Mainnet) перед выходом, чтобы предотвратить игру в систему.
  - После выхода вы должны подождать еще один полный интервал, чтобы снова вступить.

- Smoothing Pool рассчитывает "долю" каждого minipoolа (часть ETH пула за интервал), принадлежащую каждой ноде, вступившей в пул.
  - Доля является функцией производительности вашего minipoolа во время интервала (рассчитывается путем просмотра того, сколько аттестаций вы отправили в Beacon Chain и сколько пропустили), и ставки комиссии вашего minipoolа.

- Общая доля вашей ноды — это сумма долей ваших minipoolов.

- Общая доля вашей ноды масштабируется по времени, в течение которого вы были участником.
  - Если вы были участником в течение всего интервала, вы получаете свою полную долю.
  - Если вы были участником в течение 30% интервала, вы получаете 30% своей полной доли.

Чтобы вступить в Smoothing Pool, выполните следующую команду:

```shell
rocketpool node join-smoothing-pool
```

Это зарегистрирует вас как участника в контрактах Rocket Pool и автоматически изменит `fee recipient` вашего клиента валидатора с контракта дистрибьютора вашей ноды на контракт Smoothing Pool.

Чтобы покинуть пул, выполните эту команду:

```shell
rocketpool node leave-smoothing-pool
```

### Система штрафов

Чтобы гарантировать, что операторы нод не "жульничают", вручную изменяя получателя комиссий, используемого в их клиенте валидатора, Rocket Pool использует систему штрафов.

Oracle DAO постоянно отслеживает каждый блок, созданный операторами нод Rocket Pool.
Любой блок, имеющий получателя комиссий, отличного от одного из следующих адресов, считается **недействительным**:

- Адрес rETH
- Адрес Smoothing Pool
- Контракт дистрибьютора комиссий ноды (если не участвует в Smoothing Pool)

Minipool, который предложил блок с **недействительным** получателем комиссий, получит **предупреждение**.
На третьем предупреждении minipool начнет получать **нарушения** — каждое нарушение будет вычитать **10% от его общего баланса Beacon Chain, включая заработки ETH**, и отправлять их стейкерам пула rETH при выводе средств из minipoolа.

Нарушения находятся на уровне **minipoolа**, а не на уровне **ноды**.

Программное обеспечение Smartnode разработано так, чтобы гарантировать, что честные пользователи никогда не будут наказаны, даже если для этого потребуется перевести клиент валидатора в автономный режим.
Если это произойдет, вы перестанете аттестовывать и увидите сообщения об ошибках в файлах журнала о том, почему Smartnode не может правильно установить вашего получателя комиссий.

## Руководства для до и после обновления

Для получения подробной информации о том, как подготовить вашу ноду к обновлению и что делать после обновления, обратитесь к следующим руководствам:

- [Руководство для режима Docker](./docker-migration.mdx)
- [Руководство для гибридного режима](./hybrid-migration.mdx)
- [Руководство для нативного режима](./native-migration.mdx)
