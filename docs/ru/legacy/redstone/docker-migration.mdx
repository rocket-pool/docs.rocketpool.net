import { Tab, Tabs } from "@rspress/core/theme";

# [Docker Mode] Руководство по обновлению Redstone и Merge

Это руководство охватывает всё, что вам нужно знать для подготовки вашей ноды к обновлению Redstone и The Merge, если вы используете **Docker Mode**.

## Что нужно сделать перед обновлением до v1.5.0

Перед обновлением до v1.5.0 и выше Smartnode, пожалуйста, пройдитесь по следующему чек-листу, чтобы убедиться, что вы готовы:

### Переключитесь на полный Execution Client

Merge требует, чтобы вы запускали свой собственный Execution клиент, поэтому вы больше не сможете использовать удаленные провайдеры, такие как Infura или Pocket.
В v1.5.0 их больше не будет, и вам не позволят запустить стек, пока вы не выберете полный Execution клиент.

Из-за этого изменения вам следует переключиться на полный клиент, пока вы всё ещё на v1.4, дать ему полностью синхронизироваться, а затем обновиться до v1.5.

Docker Mode делает переключение клиентов очень простым.
[Это руководство](../../node-staking/change-clients#changing-execution-clients) предоставляет пошаговое описание процесса.

## Обновление до v1.5.0

Обновление стека Smartnode до v1.5.0 не отличается от любого другого обновления.
Просто следуйте [обычным инструкциям здесь](../../node-staking/updates#updating-the-smartnode-stack).

## Что Smartnode обрабатывает автоматически

В режиме Docker, Smartnode позаботится о большинстве изменений, необходимых для поддержки Redstone и The Merge, автоматически после обновления до v1.5.0.
Вот краткий список того, что он сделает за вас без какого-либо ручного вмешательства:

### Engine API

Merge изменяет способ взаимодействия вашего Execution клиента с вашим Consensus клиентом.
Вместо использования старой RPC системы на базе HTTP или Websocket, Merge требует новую систему, предоставляемую вашим Execution клиентом, называемую Engine API.

Это специальное соединение, которое позволяет Consensus клиенту заменить старую систему майнинга Proof-of-Work на Proof-of-Stake; это сердце The Merge.
Оно также **аутентифицировано** секретным токеном, поэтому только ваш Consensus клиент может подключиться к вашему Execution клиенту — ничто другое не может.

Smartnode обработает настройку токена аутентификации и Engine API как на вашем Execution, так и на Consensus клиентах автоматически.

### Ваш Fee Recipient

**Fee recipient** — это адрес на цепочке Execution layer, который будет получать все priority fees за блоки, которые вы предлагаете.
Это настройка, предоставляемая вашему Validator клиенту при его первом запуске.

Smartnode обработает его настройку на правильный адрес при обновлении до v1.5 и будет постоянно проверять, что вы используете правильный адрес, чтобы вы случайно не получили [штраф](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Если вы подписались на [Smoothing Pool](./whats-new#smoothing-pool), это будет ваш fee recipient.
Если нет, то ваш [fee distributor контракт](./whats-new#fee-recipients-and-your-distributor) станет fee recipient.

### MEV-Boost

[MEV-boost](https://boost.flashbots.net/) — это система, которую предоставляет Flashbots для получения MEV наград валидаторами Proof-of-Stake после The Merge.
Rocket Pool имеет MEV-Boost, встроенный в Smartnode, и автоматически настраивает вашу ноду для его использования, чтобы ваши предложения получали максимальное количество наград.

## Что вам следует сделать после обновления

Хотя Smartnode обрабатывает большинство изменений за вас, есть несколько дополнительных вещей, которые вам следует сделать вручную:

### Убедитесь в успешном обновлении

Первое, что нужно сделать, это убедиться, что ваша нода работает корректно.
Рассмотрите следующие шаги:

- Проверьте логи на наличие ошибок с помощью `rocketpool service logs eth1`, `rocketpool service logs eth2`, `rocketpool service logs validator` и `rocketpool service logs node`.
- Подтвердите с помощью Block Explorer (например, вашей Grafana панели и [https://beaconcha.in](https://beaconcha.in)), что вы всё ещё правильно аттестуете
  - Помните, что если у вас включена защита от Doppelganger, вы пропустите несколько аттестаций после перезапуска. Это нормально!

### Настройте резервную ноду

Поскольку The Merge несовместим с удаленными провайдерами, такими как Infura и Pocket, вы потеряете возможность использовать их в качестве резервных Execution клиентов, когда ваш основной клиент будет недоступен.

Smartnode всё ещё имеет возможность предоставлять резервный Execution клиент (а теперь и резервный Consensus клиент), но теперь вам нужно будет использовать Execution и Consensus клиенты, которые вы контролируете.

Для получения дополнительной информации о настройке резервной ноды см. [Руководство по резервной ноде](../../node-staking/fallback).

### Инициализируйте свой Fee Distributor

Если вы не планируете подключаться к [Smoothing Pool](./whats-new#smoothing-pool) и требовать все свои priority fees и MEV награды в свой [fee distributor контракт](./whats-new#fee-recipients-and-your-distributor), вам в конечном итоге придется инициализировать его (создать экземпляр контракта в цепи), чтобы востребовать награды из него на ваш адрес вывода средств.

Это довольно дешевая операция, которую нужно выполнить только один раз.

::: tip СОВЕТ
Инициализация вашего fee distributor может быть выполнена в **любое время**.
Вы можете позволить наградам накапливаться по его адресу задолго до того, как вы его инициализируете, и ваш баланс останется после инициализации.

Мы рекомендуем сделать это, когда цены на газ низкие, чтобы минимизировать накладные расходы.

Обратите внимание, что он **должен быть инициализирован, чтобы востребовать ваши награды.**
:::

### Подключитесь к Smoothing Pool

Если вы планируете сразу же воспользоваться преимуществами [Smoothing Pool](./whats-new#smoothing-pool), вам следует подключиться до конца первого периода наград Redstone, чтобы максимизировать вашу сумму "права".

Подключение можно выполнить, запустив следующую команду:

```
rocketpool node join-smoothing-pool
```

### Востребуйте награды

Обновление Redstone заменяет дорогую, проблемную старую систему наград [совершенно новой](./whats-new#new-rewards-system), которая намного дешевле, поддерживает автоматическое рестейкинг RPL (как частичные, так и полные суммы) и — что самое важное — **позволяет вам востребовать свои награды, когда вы захотите**.

Поскольку больше нет временного ограничения на востребование наград, и поскольку дешевле востребовать много интервалов наград за раз, функция автоматического востребования наград Smartnode **была удалена**.
Теперь вы сможете востребовать награды с помощью следующей команды:

```
rocketpool node claim-rewards
```

Это покажет вам все награды, которые вы накопили за все интервалы наград, начиная с обновления Redstone.

## Возврат к v1.4.3

Если по какой-либо причине что-то вам не нравится, и вы хотите вернуться к предыдущему релизу Smartnode, вы можете сделать это легко.
Smartnode автоматически создает резервную копию ваших настроек из предыдущей версии при обновлении, поэтому просто получите предыдущую версию (здесь мы демонстрируем **v1.4.3**) и замените настройки резервной копией:

1. Остановите сервис:

```shell
rocketpool service stop
```

1. Загрузите v1.4.3 CLI:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Установите пакет v1.4.3:

```shell
rocketpool service install -d
```

1. Замените вашу старую конфигурацию резервной конфигурацией v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Убедитесь, что все ваши старые настройки теперь используются:

```shell
rocketpool service config
```

1. Если всё выглядит хорошо, запустите стек Smartnode:

```shell
rocketpool service start
```

Всё готово! Теперь вы вернулись к старой версии и должны начать аттестовать вскоре после запуска сервиса.

::: danger ПРЕДУПРЕЖДЕНИЕ
v1.4.3 **устарела** и больше не будет использоваться после развертывания обновления Redstone.
Если вам всё же нужно вернуться к ней, пожалуйста, планируйте обновиться обратно до v1.5.0 до того, как контракты будут обновлены!
:::
