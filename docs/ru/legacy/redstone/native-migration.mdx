import { Tab, Tabs } from "@rspress/core/theme";

# [Нативный режим] Руководство по обновлению Redstone и слиянию (The Merge)

Это руководство охватывает все, что вам нужно знать для подготовки вашей ноды к обновлению Redstone и слиянию (The Merge), если вы используете **нативный режим**.

## Что нужно сделать перед обновлением до версии 1.5.0

Перед обновлением до версии 1.5.0 и выше Smartnode, пройдите следующий контрольный список, чтобы убедиться, что вы готовы:

### Переключитесь на полный клиент исполнения

Слияние требует запуска собственного клиента исполнения, поэтому вы больше не сможете использовать удаленные провайдеры, такие как Infura или Pocket.

Из-за этого изменения, если вы в настоящее время используете легкий клиент исполнения, вам следует переключиться на полный клиент, пока вы все еще используете версию 1.4, дождаться завершения синхронизации, а затем обновиться до версии 1.5.

### Настройте Engine API

Слияние изменяет способ взаимодействия вашего клиента исполнения с вашим клиентом консенсуса.
Вместо использования старой системы RPC на основе HTTP или Websocket, слияние требует новую систему, предоставляемую вашим клиентом исполнения, которая называется Engine API.

Это специальное соединение, которое позволяет клиенту консенсуса заменить старую систему майнинга Proof-of-Work на Proof-of-Stake; это сердце слияния.
Оно также **аутентифицировано** с помощью секретного токена, поэтому только ваш клиент консенсуса может подключаться к вашему клиенту исполнения - больше ничто не может.

Поскольку вы управляете своими клиентами исполнения и консенсуса, вам нужно будет настроить Engine API вручную.
Как это сделать, полностью зависит от того, какие клиенты вы используете.

У CoinCashew есть [отличное и краткое руководство](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) о том, как настроить Engine API на ваших клиентах исполнения и консенсуса.
Ознакомьтесь с ним и протестируйте новую конфигурацию, убедившись, что она все еще правильно аттестует перед обновлением.

Мы покажем вам, как настроить ваш клиент валидатора так, чтобы он автоматически использовал правильного получателя комиссий, требуемого программным обеспечением Smartnode, ниже.

## Обновление до версии 1.5.0

Обновление стека Smartnode до версии 1.5.0 не отличается от любого другого обновления.
Просто следуйте [обычным инструкциям здесь](../../node-staking/updates#updating-the-smartnode-stack).

## Что вы должны сделать после обновления

В нативном режиме есть несколько вещей, которые вам нужно будет сделать вручную после обновления:

### Убедитесь в успешном обновлении

Первое, что нужно сделать, это убедиться, что ваша нода работает правильно.
Рассмотрите следующие шаги:

- Проверьте ваши скрипты логов для клиента исполнения, клиента консенсуса, клиента валидатора и демона Smartnode (сервис `rp-node`), чтобы убедиться, что все они функционируют нормально без ошибок.
- Подтвердите с помощью обозревателя блоков (например, вашей панели Grafana и [https://beaconcha.in](https://beaconcha.in)), что вы все еще правильно аттестуете
  - Помните, что если у вас включена защита от двойника, вы пропустите несколько аттестаций после перезапуска. Это нормально!

### Настройте получателя комиссий в вашем клиенте валидатора

Одна из **критических** деталей, которую нужно настроить перед слиянием, это **получатель комиссий**, указанный вашим клиентом валидатора.
Как описано в [обзорной статье](./whats-new#fee-recipients-and-your-distributor), это может быть одно из двух значений:

- Если вы **подписаны** на Smoothing Pool, это должен быть адрес **контракта Smoothing Pool**. Вы можете получить адрес на [официальной странице контрактов](/ru/protocol/contracts-integrations).
- Если вы **не** в Smoothing Pool, это должен быть адрес **контракта дистрибьютора комиссий** вашей ноды. Вы можете получить адрес, выполнив `rocketpool node status`, в разделе `Fee Distributor and Smoothing Pool`.

В нативном режиме у вас есть выбор: позволить Smartnode управлять этим за вас, если вы используете сервис демона Smartnode, `rp-node`, или управлять им самостоятельно, если вы не используете демон.

#### Автоматическое управление через демон

Демон Smartnode автоматически определит соответствующего получателя комиссий для вашей ноды и будет управлять им в случае изменений (например, при входе и выходе из Smoothing Pool).
Это **самый безопасный** вариант, потому что Smartnode всегда гарантирует, что значение установлено таким образом, чтобы **предотвратить [штрафы](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)**.

Способ, которым это делается, заключается в поддержании файла с правильным получателем комиссий и регулярном его обновлении для обеспечения правильности.
Когда его нужно обновить, он изменяет файл и автоматически перезапускает ваш клиент валидатора, чтобы он загрузил нового получателя - аналогично тому, как он перезапускает ваш клиент валидатора после стейкинга нового минипула.

Выберите ваш клиент ниже, чтобы узнать, как его настроить:

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Измените сервис вашего клиента валидатора, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>
    <Tab label="Nimbus">
      Измените сервис вашего клиента валидатора, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>
    <Tab label="Prysm">
      Измените сервис вашего клиента валидатора, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>
    <Tab label="Teku">
      Измените сервис вашего клиента валидатора, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>

  </Tabs>
</div>

#### Ручное управление получателем комиссий

::: danger ПРЕДУПРЕЖДЕНИЕ
Делая это, вы берете на себя полную ответственность за то, чтобы ваш получатель комиссий всегда был установлен на правильный адрес.

Пожалуйста, прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять, на что он должен быть установлен в зависимости от вашей конфигурации, и когда вы можете безопасно изменить его с одного значения на другое.

Несоблюдение этого может привести к штрафам для ваших минипулов!
:::

**До развертывания Redstone** вы можете просто использовать адрес rETH для сети, в которой вы находитесь (который можно найти на [официальной странице контрактов](/ru/protocol/contracts-integrations)).
Адрес rETH всегда безопасен, независимо от обстоятельств.

**После развертывания Redstone** вы можете увидеть точный адрес, на который вы должны установить получателя комиссий, с помощью `rocketpool node status`. Например, если вы подписаны на Smoothing Pool, он покажет адрес Smoothing Pool и отметит, что вы должны использовать его в качестве получателя комиссий:

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Если вы _не_ подписаны на Smoothing Pool, он покажет адрес вашего дистрибьютора комиссий и отметит, что вы должны использовать его в качестве получателя комиссий:

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

Выберите ваш клиент консенсуса ниже, чтобы узнать, как его настроить.

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Добавьте следующий аргумент командной строки в файл определения сервиса вашего клиента валидатора:

      ```
      --suggested-fee-recipient `address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - **Дистрибьютор комиссий** вашей ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы подписаны на Smoothing Pool

      Напоминаем, что `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания относительно получателя комиссий.**
    </Tab>
    <Tab label="Nimbus">
      Добавьте следующий аргумент командной строки в файл определения сервиса Nimbus:

      ```
      --suggested-fee-recipient=`address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - **Дистрибьютор комиссий** вашей ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы подписаны на Smoothing Pool

      Напоминаем, что `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания относительно получателя комиссий.**
    </Tab>
    <Tab label="Prysm">
      Добавьте следующий аргумент командной строки в файл определения сервиса вашего клиента валидатора:

      ```
      --suggested-fee-recipient `address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - **Дистрибьютор комиссий** вашей ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы подписаны на Smoothing Pool

      Напоминаем, что `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания относительно получателя комиссий.**
    </Tab>
    <Tab label="Teku">
      Добавьте следующий аргумент командной строки в файл определения сервиса вашего клиента валидатора:

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - **Дистрибьютор комиссий** вашей ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы подписаны на Smoothing Pool

      Напоминаем, что `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания относительно получателя комиссий.**
    </Tab>

  </Tabs>
</div>

### Настройте MEV-Boost

[MEV-boost](https://boost.flashbots.net/) - это система, которую Flashbots предоставляет для выдачи вознаграждений MEV валидаторам Proof-of-Stake после слияния.

**Rocket Pool требует от всех нод использовать его для максимизации доходов и, таким образом, поддержания конкурентоспособности протокола с другими сервисами стейкинга.**

Вам нужно будет внести некоторые изменения в ваш узел маяка / клиент консенсуса, чтобы подключить его к MEV-boost.

MEV-boost в настоящее время недоступен на Hoodi или Mainnet, поэтому вам не нужно настраивать его в данный момент.
Конечно, вы не будете оштрафованы за его неиспользование в этот переходный период.

Как только он станет доступен, мы объявим дату, к которой он должен быть установлен и подключен к вашей ноде.
Flashbots предоставит инструкции, которым вы сможете следовать в то время, и мы дадим на них ссылку здесь.

::: danger ПРИМЕЧАНИЕ
После того как мы сделаем объявление о том, что MEV-boost должен быть включен всеми операторами нод, вы должны убедиться, что он правильно установлен и настроен с вашим узлом маяка!

Несоблюдение этого приведет к [штрафам](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) для вашего минипула.
:::

### Настройте резервную ноду

Поскольку слияние несовместимо с удаленными провайдерами, такими как Infura и Pocket, вы потеряете возможность использовать их в качестве резервных клиентов исполнения, когда ваш основной выйдет из строя.

Smartnode все еще имеет возможность предоставить резервный клиент исполнения (а теперь и резервный клиент консенсуса), но теперь вам нужно будет использовать клиенты исполнения и консенсуса, которые вы контролируете.

Для получения дополнительной информации о настройке резервной ноды см. [руководство по резервной ноде](../../node-staking/fallback).

### Инициализируйте ваш дистрибьютор комиссий

Если вы не планируете подписываться на [Smoothing Pool](./whats-new#smoothing-pool) и требовать все ваши приоритетные комиссии и вознаграждения MEV в ваш [контракт дистрибьютора комиссий](./whats-new#fee-recipients-and-your-distributor), вам в конечном итоге придется инициализировать его (создать экземпляр контракта в цепи), чтобы получить вознаграждения с него на ваш адрес вывода.

Это довольно недорогая операция, и ее нужно сделать только один раз.

::: tip СОВЕТ
Инициализация вашего дистрибьютора комиссий может быть выполнена **в любое время**.
Вы можете позволить вознаграждениям накапливаться на его адресе задолго до того, как вы его инициализируете, и ваш баланс останется после инициализации.

Мы рекомендуем вам сделать это, когда цены на газ низкие, чтобы минимизировать накладные расходы.

Обратите внимание, что он **должен быть инициализирован для того, чтобы получить ваши вознаграждения.**
:::

### Подпишитесь на Smoothing Pool

Если вы планируете сразу воспользоваться преимуществами [Smoothing Pool](./whats-new#smoothing-pool), вам следует подписаться до конца первого периода вознаграждений Redstone, чтобы максимизировать вашу сумму "приемлемости".

Подписка может быть выполнена путем запуска следующей команды:

```shell
rocketpool node join-smoothing-pool
```

### Получите вознаграждения

Обновление Redstone заменяет дорогую, проблематичную старую систему вознаграждений [совершенно новой](./whats-new#new-rewards-system), которая намного дешевле, поддерживает автоматический рестейкинг RPL (как частичные, так и полные суммы), и - что наиболее важно - **позволяет вам получать ваши вознаграждения, когда вы хотите**.

Поскольку больше нет временного ограничения на получение вознаграждений, и поскольку дешевле получать много интервалов вознаграждений сразу, функция автоматического получения вознаграждений Smartnode **была удалена**.
Теперь вы сможете получать вознаграждения с помощью следующей команды:

```shell
rocketpool node claim-rewards
```

Это покажет вам все вознаграждения, которые вы накопили за все интервалы вознаграждений, начиная с обновления Redstone.
