import { Tab, Tabs } from "@rspress/core/theme";

# [Hybrid Mode] Руководство по обновлению Redstone и Merge

Это руководство охватывает всё, что вам нужно знать для подготовки вашей ноды к обновлению Redstone и The Merge, если вы используете **Hybrid Mode**.

## Что нужно сделать перед обновлением до v1.5.0

Перед обновлением до v1.5.0 и выше Smartnode, пожалуйста, пройдитесь по следующему чек-листу, чтобы убедиться, что вы готовы:

### Переключитесь на полный Execution Client

Merge требует, чтобы вы запускали свой собственный Execution клиент, поэтому вы больше не сможете использовать удаленные провайдеры, такие как Infura или Pocket.

Из-за этого изменения, если вы в настоящее время используете легкий Execution клиент, вам следует переключиться на полный клиент, пока вы всё ещё на v1.4, дать ему полностью синхронизироваться, а затем обновиться до v1.5.

### Убедитесь, что EC и CC оба управляются внешне

Предыдущие версии стека Smartnode позволяли иметь один клиент, управляемый локально, и другой, управляемый внешне.
Например, вы могли иметь Execution клиент, которым управляет Smartnode, и подключить его к Consensus клиенту, которым вы управляете внешне.

Начиная с v1.5, эта конфигурация больше не поддерживается.
Вам придется переключиться либо на локально управляемый Execution и Consensus клиент (также известный как [Docker Mode](./docker-migration.mdx)), либо настроить как Execution, так и Consensus клиент, которыми вы управляете самостоятельно.

::: tip СОВЕТ
Если вы заинтересованы в том, чтобы Smartnode поддерживал свой собственный Execution и Consensus клиент, но хотите сохранить контроль над своим собственным Validator клиентом (например, если у вас есть свои ключи solo staking валидатора, прикрепленные к нему), вы можете рассмотреть [Reverse Hybrid Mode](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode), который делает именно это!
:::

### Настройте Engine API

Merge изменяет способ взаимодействия вашего Execution клиента с вашим Consensus клиентом.
Вместо использования старой RPC системы на базе HTTP или Websocket, Merge требует новую систему, предоставляемую вашим Execution клиентом, называемую Engine API.

Это специальное соединение, которое позволяет Consensus клиенту заменить старую систему майнинга Proof-of-Work на Proof-of-Stake; это сердце The Merge.
Оно также **аутентифицировано** секретным токеном, поэтому только ваш Consensus клиент может подключиться к вашему Execution клиенту — ничто другое не может.

Поскольку вы управляете своими собственными Execution и Consensus клиентами, вам нужно будет настроить Engine API вручную.
Как это сделать, полностью зависит от того, какие клиенты вы используете.

У CoinCashew есть [отличное и краткое руководство](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) о том, как настроить Engine API на ваших Execution и Consensus клиентах.
Ознакомьтесь с ним и протестируйте новую конфигурацию, убедившись, что она всё ещё правильно аттестует перед обновлением.

Как всегда, Rocket Pool будет управлять своим собственным Validator клиентом, поэтому вам не нужно беспокоиться о ручном изменении его.

## Обновление до v1.5.0

Обновление стека Smartnode до v1.5.0 не отличается от любого другого обновления.
Просто следуйте [обычным инструкциям здесь](../../node-staking/updates#updating-the-smartnode-stack).

## Что Smartnode обрабатывает автоматически

В режиме Hybrid, Smartnode позаботится о некоторых изменениях, необходимых для поддержки Redstone, автоматически после обновления до v1.5.0, но вам нужно будет обработать другие вручную в Hybrid Mode.

Вот краткий список того, что он сделает за вас без какого-либо ручного вмешательства:

### Ваш Fee Recipient

**Fee recipient** — это адрес на цепочке Execution layer (eth1), который будет получать все priority fees за блоки, которые вы предлагаете.
Это настройка, предоставляемая вашему Validator клиенту при его первом запуске.

Smartnode обработает его настройку на правильный адрес на Validator клиенте, которым он управляет, при обновлении до v1.5 и будет постоянно проверять, что вы используете правильный адрес, чтобы вы случайно не получили [штраф](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Если вы подписались на [Smoothing Pool](./whats-new#smoothing-pool), это будет ваш fee recipient.
Если нет, то ваш [fee distributor контракт](./whats-new#fee-recipients-and-your-distributor) станет fee recipient.

## Что вам следует сделать после обновления

Хотя Smartnode обрабатывает большинство изменений за вас, есть несколько дополнительных вещей, которые вам следует сделать вручную:

### Убедитесь в успешном обновлении

Первое, что нужно сделать, это убедиться, что ваша нода работает корректно.
Рассмотрите следующие шаги:

- Проверьте логи на наличие ошибок с помощью `rocketpool service logs validator` и `rocketpool service logs node`.
- Подтвердите с помощью Block Explorer (например, вашей Grafana панели и [https://beaconcha.in](https://beaconcha.in)), что вы всё ещё правильно аттестуете
  - Помните, что если у вас включена защита от Doppelganger, вы пропустите несколько аттестаций после перезапуска. Это нормально!

### Настройте MEV-Boost

[MEV-boost](https://boost.flashbots.net/) — это система, которую предоставляет Flashbots для получения MEV наград валидаторами Proof-of-Stake после The Merge.

**Rocket Pool требует от всех нод использовать его для максимизации доходов и, таким образом, поддержания конкурентоспособности протокола с другими сервисами стейкинга.**

Вам нужно будет внести некоторые изменения в ваш Beacon Node / Consensus клиент, чтобы подключить его к MEV-boost.

MEV-boost в настоящее время недоступен на Hoodi или Mainnet, поэтому вам не нужно настраивать его в данный момент.
Конечно, вы не будете оштрафованы за его неиспользование в течение этого переходного периода.

Как только он станет доступен, мы объявим дату, до которой он должен быть установлен и подключен к вашей ноде.
Flashbots предоставит инструкции, которым вы сможете следовать в то время, и мы разместим ссылку на них здесь.

::: danger ПРИМЕЧАНИЕ
Как только мы сделаем объявление о том, что MEV-boost должен быть включен всеми операторами нод, вы должны убедиться, что он правильно установлен и настроен с вашим Beacon Node!

Невыполнение этого приведет к [штрафу](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) вашего minipool.
:::

### Настройте резервную ноду

Поскольку The Merge несовместим с удаленными провайдерами, такими как Infura и Pocket, вы потеряете возможность использовать их в качестве резервных Execution клиентов, когда ваш основной клиент будет недоступен.

Smartnode всё ещё имеет возможность предоставлять резервный Execution клиент (а теперь и резервный Consensus клиент), но теперь вам нужно будет использовать Execution и Consensus клиенты, которые вы контролируете.

Для получения дополнительной информации о настройке резервной ноды см. [Руководство по резервной ноде](../../node-staking/fallback).

### Инициализируйте свой Fee Distributor

Если вы не планируете подключаться к [Smoothing Pool](./whats-new#smoothing-pool) и требовать все свои priority fees и MEV награды в свой [fee distributor контракт](./whats-new#fee-recipients-and-your-distributor), вам в конечном итоге придется инициализировать его (создать экземпляр контракта в цепи), чтобы востребовать награды из него на ваш адрес вывода средств.

Это довольно дешевая операция, которую нужно выполнить только один раз.

::: tip СОВЕТ
Инициализация вашего fee distributor может быть выполнена в **любое время**.
Вы можете позволить наградам накапливаться по его адресу задолго до того, как вы его инициализируете, и ваш баланс останется после инициализации.

Мы рекомендуем сделать это, когда цены на газ низкие, чтобы минимизировать накладные расходы.

Обратите внимание, что он **должен быть инициализирован, чтобы востребовать ваши награды.**
:::

### Подключитесь к Smoothing Pool

Если вы планируете сразу же воспользоваться преимуществами [Smoothing Pool](./whats-new#smoothing-pool), вам следует подключиться до конца первого периода наград Redstone, чтобы максимизировать вашу сумму "права".

Подключение можно выполнить, запустив следующую команду:

```shell
rocketpool node join-smoothing-pool
```

### Востребуйте награды

Обновление Redstone заменяет дорогую, проблемную старую систему наград [совершенно новой](./whats-new#new-rewards-system), которая намного дешевле, поддерживает автоматическое рестейкинг RPL (как частичные, так и полные суммы) и — что самое важное — **позволяет вам востребовать свои награды, когда вы захотите**.

Поскольку больше нет временного ограничения на востребование наград, и поскольку дешевле востребовать много интервалов наград за раз, функция автоматического востребования наград Smartnode **была удалена**.
Теперь вы сможете востребовать награды с помощью следующей команды:

```shell
rocketpool node claim-rewards
```

Это покажет вам все награды, которые вы накопили за все интервалы наград, начиная с обновления Redstone.

## Возврат к v1.4.3

Если по какой-либо причине что-то вам не нравится, и вы хотите вернуться к предыдущему релизу Smartnode, вы можете сделать это легко.
Smartnode автоматически создает резервную копию ваших настроек из предыдущей версии при обновлении, поэтому просто получите предыдущую версию (здесь мы демонстрируем **v1.4.3**) и замените настройки резервной копией:

1. Остановите сервис:

```shell
rocketpool service stop
```

1. Загрузите v1.4.3 CLI:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Установите пакет v1.4.3:

```shell
rocketpool service install -d
```

1. Замените вашу старую конфигурацию резервной конфигурацией v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Убедитесь, что все ваши старые настройки теперь используются:

```shell
rocketpool service config
```

1. Если всё выглядит хорошо, запустите стек Smartnode:

```shell
rocketpool service start
```

Всё готово! Теперь вы вернулись к старой версии и должны начать аттестовать вскоре после запуска сервиса.

::: danger ПРЕДУПРЕЖДЕНИЕ
v1.4.3 **устарела** и больше не будет использоваться после развертывания обновления Redstone.
Если вам всё же нужно вернуться к ней, пожалуйста, планируйте обновиться обратно до v1.5.0 до того, как контракты будут обновлены!
:::
