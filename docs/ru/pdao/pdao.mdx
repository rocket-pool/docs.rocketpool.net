import proposal_diagram from "./images/proposal_diagram.png";
import proposal_checker from "./images/proposal_checker.png";

# Protocol DAO (pDAO)

Rocket Pool Protocol DAO (pDAO) отвечает за формирование направления протокола и управляется через управление RPL. Его члены и их сила голоса состоят из операторов нод, больших и малых, все из которых напрямую участвуют в протоколе. Он служит сообществу Rocket Pool в целом, включая держателей rETH, операторов нод и держателей RPL. pDAO приоритизирует безопасность протокола Rocket Pool и здоровье сети Ethereum. Для явного определения того, кто и что такое pDAO, не стесняйтесь ознакомиться с [уставом pDAO](https://rpips.rocketpool.net/RPIPs/RPIP-23).

## Новые функции pDAO в Houston

### On-chain выполнение обязанностей pDAO

Обновление Houston вводит on-chain замену для процесса выполнения системы управления pDAO. Оно использует оптимистичную систему доказательства мошенничества, которая позволяет любому оператору ноды выдвигать предложения и голосовать по предложениям для настройки "параметров протокола pDAO" и расходования средств казначейства. Чтобы увидеть полный список параметров, контролируемых pDAO, нажмите [здесь](https://rpips.rocketpool.net/RPIPs/RPIP-33#parameter-table).
До Houston основная команда была ответственна за выполнение обязанностей pDAO по указанию процесса управления сообществом. Например, команда выполняет ежемесячные платежи IMC и GMC в соответствии с графиками платежей, одобренными управлением. План заключался в том, чтобы эта власть временно находилась у команды до тех пор, пока не будет создана новая структура власти для принятия на себя этих обязанностей. Houston устраняет эту зависимость от команды, делая протокол более децентрализованным и не требующим доверия.

### Security Council

Обновление Houston также включает новый Security Council, чтобы помочь быстро реагировать в случае любых потенциальных проблем с протоколом. Эти члены могут быть избраны pDAO и имеют возможность предлагать и выполнять изменения без задержки. pDAO имеет право избирать и удалять членов из Security Council. Это серьёзная роль, и pDAO должна разработать строгие требования к вступлению и процессы для удаления застойных членов. Хранитель pDAO будет единственным членом Security Council на старте Houston.

### Повторяющиеся расходы казначейства

RPL имеет ставку инфляции 5%. 22% этой инфляции направляется в pDAO, как определено в [RPIP-25](https://rpips.rocketpool.net/RPIPs/RPIP-25). pDAO может использовать эти средства для различных целей. Например, стимулы, такие как бонусы поставщикам ликвидности (LP), гранты и вознаграждения за улучшения и проекты третьих сторон, а также финансирование разработки протокола Rocket Pool. Обновление Houston также вводит новую функцию, которая позволяет повторяющиеся платежи казначейства, производимые указанному бенефициару в каждый период вознаграждений.

## Предложения Protocol DAO (pDAO)

Любая нода с ненулевой силой голоса может выдвинуть или участвовать в предложении pDAO в любое время. Предложения могут быть одного из следующих типов:

- Изменение настроек pDAO
- Одноразовые расходы казначейства
- Повторяющиеся расходы казначейства (комитеты управления)
- Членство в Security Council

Для получения более подробной информации и обоснования обратитесь к [типам предложений](https://rpips.rocketpool.net/RPIPs/RPIP-33#proposal-types). Важно понимать, что предложение pDAO — это on-chain сущность, которая существует для выполнения изменений на уровне протокола.

## Жизненный цикл предложения pDAO

Предложение должно быть предсказано [процессом управления](./participate#governance-process) до того, как оно окажется on-chain. Оно состоит из 4 периодов, все из которых являются [контролируемыми параметрами](https://rpips.rocketpool.net/RPIPs/RPIP-33#parameter-table) pDAO:

- Период задержки голосования: `proposal.vote.delay.time`
- Фаза голосования 1: `proposal.vote.phase1.time`
- Фаза голосования 2: `proposal.vote.phase2.time`
- Выполнение: `proposal.execute.time	`

<img src={proposal_diagram} width="100%" height="auto" />

### Период задержки голосования

Чтобы определить результат предложения, протокол должен знать требуемый кворум. Предлагатель вычисляет это значение off-chain и представляет его вместе со своим предложением. Значение оптимистично принимается, но в случае мошенничества верификаторы могут выполнить процесс вызова/ответа, чтобы доказать, что значение неверно. Недействительные предложения затем отбрасываются.

Несколько причин, по которым предлагатели и оспаривающие должны блокировать RPL.

- `proposal.bond` стимулирует действительные предложения и препятствует спаму.
- `proposal.challenge.bond` стимулирует устранение недействительных/вредоносных предложений.

Оспаривающие предоставляют индекс в дереве сумм Меркла, который они утверждают, что является неправильным. Любой оператор ноды может участвовать в оспаривании мошеннических предложений (и зарабатывать вознаграждение при этом). Не стесняйтесь прочитать о [процессе оспаривания pDAO](./pdao#challenge-process), если вы заинтересованы в участии. Предложение, не побеждённое в оспаривании к концу периода задержки голосования, войдёт в этапы голосования.

::: tip ПРИМЕЧАНИЕ
Когда `proposal.vote.delay.time` истекает, предложение больше не может быть оспорено или побеждено.
:::

### Период голосования 1

Во время периода голосования операторы нод и делегаты могут отдать голос с одним из четырёх вариантов:

```
1. Abstain: Сила голоса избирателя вносит вклад в кворум, но не является ни за, ни против предложения.
2. For: Избиратель голосует за выполнение предложения.
3. Against: Избиратель голосует против выполнения предложения.
4. Veto: Избиратель голосует против предложения, а также указывает, что считает предложение спамом или вредоносным.
```

Их сила голоса будет включена в выбранный ими вариант.

Это можно сделать с помощью команды:

```shell
rocketpool pdao proposals vote
```

Если кворум вето (как определено параметром `proposal.veto.quorum`) достигнут, предложение немедленно побеждается, и предлагатель теряет свой залог. Это для того, чтобы отговорить от спама, предложений низкого качества или предложений, которые не прошли через off-chain процессы сначала. Команда smartnode `rocketpool pdao proposals finalize` используется для финализации предложения с вето путём сжигания заблокированного залога RPL предлагателя.

Продолжительность периода 1 определяется параметром `proposal.vote.phase1.time`. Предложение перейдёт к фазе 2 независимо от того, достигнут ли `proposal.quorum` или нет.

### Период голосования 2

Делегаты могут голосовать во время периода голосования 2, но только их голос стоит только их **локальной силы голоса**. Избиратели, которые не голосовали в периоде 1, всё ещё смогут отдать голос во время периода 2. Операторы нод, которые не согласны с выбором своего делегата, будут иметь возможность отменить голос своего делегата.

Процесс отмены голоса довольно прост, просто вызовите `rocketpool pdao proposals vote` во время периода голосования 2 и следуйте подсказкам. Сила голоса делегата будет отменена силой голоса делегата.

Результат предложения заключается, когда период голосования 2 заканчивается. Чтобы результат был определён (и выполнен), `proposal.quorum` общей силы голоса должен быть достигнут к концу `proposal.vote.phase2.time`. Если кворум достигнут и достигнут консенсус, предложение пройдёт периоды голосования и будет помечено как успешное.

::: tip ПРИМЕЧАНИЕ
Никакие дальнейшие действия не могут быть предприняты в случае, если `proposal.quorum` не достигнут. Предложение считается завершённым и окончательным, если кворум не достигнут.
:::

### Выполнение

Как только оба периода голосования прошли, и предложение успешно, предложение может быть выполнено, и изменение (определяемое полезной нагрузкой) применяется к протоколу Rocket Pool. Чтобы выполнить предложение, используйте команду:

```shell
rocketpool pdao proposals execute
```

Вам будет предложено выбрать предложение для выполнения, предложение будет применено к протоколу после этого шага!

После того, как предложение прошло периоды голосования, предлагатель может [получить](./participate#claiming-bonds-and-rewards) свой заблокированный залог RPL, если предложение не было побеждено оспариванием или вето.

::: tip ПРИМЕЧАНИЕ
Есть окно `proposal.execute.time`, в течение которого предложение может быть выполнено. Предложение истечёт, если этот таймер достигнет своего конца.
:::

И это всё! Имейте в виду, что все переменные, упомянутые выше, являются контролируемыми параметрами pDAO. Нажмите [здесь](https://rpips.rocketpool.net/RPIPs/RPIP-33#parameter-table) для полного списка каждого параметра, который pDAO имеет право изменить с помощью on-chain предложений.

## Процесс оспаривания

Полное дерево силы голоса сети хранится off-chain из-за лимитов газа. Когда пользователь отправляет новое предложение, он отвечает за построение дерева голосования сети в целевом блоке. Это дерево генерируется off-chain, но проверяется через корни Меркла, которые представляются on-chain. Протокол полагается на **верификаторов** для проверки деталей, представленных предлагателем.

Любая нода может участвовать в отслеживании и проверке правильности предложений. Чтобы принять участие в этой ответственности, используйте команду `rocketpool service config`, перейдите в меню **Smartnode and TX Fee Settings** и отметьте галочку `Enable PDAO Proposal Checker`.

<img src={proposal_checker} width="100%" height="auto" />

Когда эта настройка включена, нода будет проверять новые предложения, проверять их правильность и отправлять оспаривания недействительных предложений. Единственное предварительное условие — это то, что [блокировка RPL](./participate#allowing-rpl-locking) включена.

Эта проверка выполняется каждые 5 минут в сочетании с несколькими другими обязанностями, связанными с нодой. Мы пройдём через пример того, как выглядит оспаривание мошеннического предложения. Мы можем использовать команду smartnode `rocketpool service logs node` для мониторинга прогресса:

```
rocketpool_node  | 2024/04/05 02:19:16 Checking for Protocol DAO proposal challenges to defend...
rocketpool_node  | 2024/04/05 02:19:26 Checking for Protocol DAO proposals to challenge...
rocketpool_node  | 2024/04/05 02:19:26 [Network Tree] Couldn't load network tree for block 1283202 from disk, so it must be regenerated.
rocketpool_node  | 2024/04/05 02:19:26 [PDAO Proposals] Network tree for block 1283202 didn't exist, creating one.
rocketpool_node  | 2024/04/05 02:19:26 [Voting Info Snapshot] Couldn't load network tree for block 1283202 from disk, so it must be regenerated.
rocketpool_node  | 2024/04/05 02:19:26 [PDAO Proposals] Voting info snapshot for block 1283202 didn't exist, creating one.
rocketpool_node  | 2024/04/05 02:19:26 Proposal 177 does not match the local tree artifacts and must be challenged.
rocketpool_node  | 2024/04/05 02:19:26 [Voting Info Snapshot] Loaded file [vi-1283202.json.zst].
rocketpool_node  | 2024/04/05 02:19:26 [Network Tree] Loaded file [network-tree-1283202.json.zst].
rocketpool_node  | 2024/04/05 02:19:26 Submitting challenge against proposal 177, index 5...
rocketpool_node  | 2024/04/05 02:19:26 This transaction will use a max fee of 16.067134 Gwei, for a total of up to 0.003252 - 0.004878 ETH.
rocketpool_node  | 2024/04/05 02:19:26 Transaction has been submitted with hash 0x327e59e398bf2141a0d9273947d1da5c255606c45afaca428ab092186300eac2.
rocketpool_node  | 2024/04/05 02:19:26 You may follow its progress by visiting:
rocketpool_node  | 2024/04/05 02:19:26 https://holesky.etherscan.io/tx/0x327e59e398bf2141a0d9273947d1da5c255606c45afaca428ab092186300eac2

```

Мы можем видеть, что наша нода поймала мошенническое предложение и начала процесс оспаривания его. Блок `1283202` — это блок, в котором было выдвинуто предложение 177, что означает, что сила голоса для этого предложения будет рассчитана в блоке `1283202`. Если вас интересует, как выглядят эти **Voting Info Snapshots**, вы можете найти их в этом каталоге: `~/.rocketpool/data/voting`

Поскольку предлагатель был пойман при отправке неверной информации о голосовании, наша нода делает вызов контракта `Function: createChallenge` для предложения 177 в индексе 5 и ждёт, пока предлагатель ответит на оспаривание.

```
rocketpool3_node  | 2024/04/05 02:56:51 Checking for Protocol DAO proposal challenges to defend...
rocketpool3_node  | 2024/04/05 02:57:01 Checking for Protocol DAO proposals to challenge...
rocketpool3_node  | 2024/04/05 02:57:01 [Network Tree] Loaded file [network-tree-1283202.json.zst].
rocketpool3_node  | 2024/04/05 02:57:01 Proposal 177 does not match the local tree artifacts and must be challenged.
rocketpool3_node  | 2024/04/05 02:57:01 [Voting Info Snapshot] Loaded file [vi-1283202.json.zst].
rocketpool3_node  | 2024/04/05 02:57:01 [Network Tree] Loaded file [network-tree-1283202.json.zst].
rocketpool3_node  | 2024/04/05 02:57:01 Proposal 177 has been defeated with node index 20, submitting defeat...
rocketpool3_node  | 2024/04/05 02:57:01 This transaction will use a max fee of 19.078965 Gwei, for a total of up to 0.002061 - 0.003091 ETH.
rocketpool3_node  | 2024/04/05 02:57:01 Transaction has been submitted with hash 0x8cc01dff37205dc98e53f4e9fae7f3c802ecc1c69a01f53e734115a73401287e.
rocketpool3_node  | 2024/04/05 02:57:01 You may follow its progress by visiting:
rocketpool3_node  | 2024/04/05 02:57:01 https://holesky.etherscan.io/tx/0x8cc01dff37205dc98e53f4e9fae7f3c802ecc1c69a01f53e734115a73401287e
rocketpool3_node  |
rocketpool3_node  | 2024/04/05 02:57:01 Waiting for the transaction to be validated...
rocketpool3_node  | 2024/04/05 02:57:13 Successfully defeated proposal.
```

Поскольку информация о голосовании предлагателя неверна, он не сможет ответить на оспаривание вовремя (определяется `proposal.challenge.period`). Предложение считается побеждённым в этой точке. Когда предложение побеждено, наша нода автоматически делает вызов контракта `defeatProposal` для предложения 177 в индексе 5, чтобы завершить предложение.

::: tip ПРИМЕЧАНИЕ
Оспаривающие, которые участвуют в побеждении предложения, получают пропорциональную сумму залога предлагателя, если они представляют индекс, доказанный как неправильный. Все остальные оспаривающие получают обратно только свой залог.
:::

Теперь, когда предложение побеждено, наша нода (оспаривающий) может [получить](./participate#claiming-bonds-and-rewards) свой исходный залог RPL, а также залог RPL предлагателя в качестве вознаграждения за побеждение мошеннического предложения.

Если вам интересно углубиться в детали системы предложений и оспариваний pDAO, ознакомьтесь с [техническими спецификациями](https://github.com/rocket-pool/rocketpool-research/blob/houston/Protocol%20DAO/pdao-prop-challenge-spec.md#draft-protocol-dao-proposal-challenge-system-specification). Не стесняйтесь перейти к этому разделу о [процессе оспаривания](https://github.com/rocket-pool/rocketpool-research/blob/houston/Protocol%20DAO/pdao-prop-challenge-spec.md#challenge-process), если вас интересует изучение примера, который углубляется в детали низкого уровня.
