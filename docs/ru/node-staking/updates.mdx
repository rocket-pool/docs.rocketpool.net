import { Tab, Tabs } from "@rspress/core/theme";
import tuiEcContainerTag from "./images/tui-ec-container-tag.png";
import tuiCcContainerTag from "./images/tui-cc-container-tag.png";

# Проверка обновлений

Одна из обязанностей операторов узлов - убедиться, что ваша система обновлена последними патчами безопасности.
Автоматические обновления удобны, но могут мешать работе вашего узла, поэтому может быть предпочтительнее выполнять их вручную.
В любом случае, **вы должны убедиться, что ваша машина регулярно обновляется!**

::: tip ПРИМЕЧАНИЕ
Большую часть времени обновление не потребует, чтобы ваша система была выключена более чем на несколько минут.
Вы можете быть обеспокоены тем, что такое время простоя негативно повлияет на ваш баланс Beacon Chain.
Будьте уверены, штраф за пребывание в автономном режиме в течение такого короткого периода времени **совершенно незначителен**.

Каждая аттестация, которую вы пропускаете, будет наказывать вас немного меньше, чем сумма, которую вы заработали бы от успешной аттестации.
Как правило, если вы находитесь в автономном режиме в течение часа, вы заработаете все это обратно после того, как будете онлайн в течение часа снова.

Также обратите внимание, что **абсолютно нет шансов**, что вы будете _slashed_, если будете автономны в течение короткого времени.
Slashing происходит только в том случае, если вы атакуете сеть, а переход в автономный режим для технического обслуживания не считается атакой на сеть.

**Пожалуйста, держите свои системы обновленными - не беспокойтесь о штрафах за время простоя!**
:::

## Обновление вашей операционной системы

Вы должны часто проверять менеджер пакетов вашей операционной системы или службу обновления, чтобы убедиться, что быстро применяете любые новые важные патчи безопасности.
Точные инструкции различаются для каждой операционной системы и могут быть найдены в документации вашей системы, но вот несколько примеров.

<div className="p-3">
  <Tabs>
    <Tab label="Ubuntu">
      В терминале введите следующее:

      ```shell
      sudo apt update
      ```

      Это получит доступ к серверам пакетов и проверит, есть ли новые версии каких-либо установленных пакетов.
      Если доступны обновления, вывод будет выглядеть так:

      ```
      Fetched 3974 kB in 2s (1641 kB/s)
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      12 packages can be upgraded. Run 'apt list --upgradable' to see them.
      ```

      Вы можете установить обновления с помощью следующей команды:

      ```shell
      sudo apt dist-upgrade
      ```

      Это покажет вам список пакетов, которые собираются быть обновлены, и если общий размер установки достаточно велик, он покажет вам размер и попросит вас подтвердить, что вы принимаете:

      ```
      12 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
      Need to get 51.3 MB of archives.
      After this operation, 52.2 kB of additional disk space will be used.
      Do you want to continue? [Y/n]
      ```

      Убедитесь, что у вас достаточно места для этого, затем нажмите `y` и `Enter`, чтобы начать процесс обновления.

      Как только индикатор прогресса закончится и вы вернетесь к командной строке терминала, выполните следующую команду, чтобы очистить старые версии пакетов, которые только что были заменены:

      ```shell
      sudo apt autoremove
      ```

      Затем проверьте, нужно ли перезагрузить систему:

      ```shell
      cat /var/run/reboot-required
      ```

      Если приведенная выше команда печатает `No such file or directory`, то перезагрузка не требуется, и вы можете пропустить шаг ниже.

      Однако, если команда печатает `*** System restart required ***`, то вы должны перезагрузить машину, чтобы завершить применение обновлений, когда сможете:

      ```shell
      sudo reboot
      ```

      Rocket Pool корректно выключится и автоматически запустится обратно с системой после перезагрузки.
    </Tab>
    <Tab label="MacOS">
      Чтобы обновить пакеты ОС, используйте пользовательский интерфейс, чтобы выбрать `Apple -> Software Update`.

      Чтобы обновить сами пакеты, самый простой способ - через `homebrew` в терминале:

      ```shell
      brew update && brew upgrade
      ```
    </Tab>

  </Tabs>
</div>

## Обновление стека Smartnode

Иногда Rocket Pool выпускает новую версию стека Smartnode.
Обновления могут содержать новые версии CLI или Docker-контейнеров Rocket Pool, а также новые версии клиентов Execution и Consensus.

Наиболее последовательный способ узнать о новых релизах - подписаться на сервер Discord Rocket Pool; они всегда будут опубликованы в канале Releases, и вы получите уведомление.

::: warning ПРИМЕЧАНИЕ
Обратите внимание, что выполнение `apt update` не обновит программное обеспечение узла.
Это должно быть сделано вручную, используя шаги ниже.
:::

::: tip СОВЕТ
Когда вы завершите обновление Smartnode, панель Grafana все еще будет указывать, что доступно обновление.
Оно автоматически очистится в течение дня, когда система в следующий раз автоматически проверит наличие обновлений.

Если вы хотите очистить его немедленно после обновления, просто выполните:
`sudo apt update`
:::

::: tip СОВЕТ
Если вы не знаете архитектуру вашего CPU, вы можете выполнить следующую команду, чтобы найти ее:

```shell
uname -m
```

Вывод этой команды покажет вашу архитектуру.
**Обратите внимание, что `x86_64` - это то же самое, что `x64` и `amd64`.**
**Обратите внимание, что `aarch64` - это то же самое, что `arm64`.**
:::

Шаги для обновления зависят от того, какой режим использует ваш узел. Выберите из вариантов ниже:

<div className="p-3">
  <Tabs>
    <Tab label="Linux (Docker или Hybrid Mode)">
      Остановите службы Rocket Pool:

      ```shell
      rocketpool service stop
      ```

      Загрузите новый Smartnode CLI:

      Для систем `x64` (большинство обычных машин):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
      ```

      Для систем `arm64`:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
      ```

      Теперь выполните команду установки:

      ```shell
      rocketpool service install -d
      ```

      Флаг `-d` говорит ему игнорировать системные зависимости, такие как Docker, так как они у вас уже есть.

      Если вы хотите увидеть, что изменилось, откройте менеджер настроек - страница обзора покажет вам, что нового:

      ```shell
      rocketpool service config
      ```

      Когда закончите, снова запустите Rocket Pool:

      ```shell
      rocketpool service start
      ```

      Наконец, проверьте версию, чтобы убедиться, что CLI и стек Smartnode оба обновлены:

      ```shell
      rocketpool service version
      ```

      Вывод должен выглядеть примерно так:

      ```
      Your Smartnode is currently using the Hoodi Test Network.

      Rocket Pool client version: 1.5.0
      Rocket Pool service version: 1.5.0
      Selected Eth 1.0 client: Geth (Locally managed)
      Image: ethereum/client-go:v1.10.21
      Selected Eth 2.0 client: Lighthouse (Locally managed)
      Image: rocketpool/lighthouse:mevboost-5ee3bc5
      ```

      И клиент, и служба должны соответствовать новой версии релиза.
    </Tab>
    <Tab label="Linux (Native Mode)">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">ПРИМЕЧАНИЕ</p>
        Это обновит только сам стек Smartnode - это **не** обновит ваши клиенты Execution или Consensus.
        Вам придется сделать это вручную (см. следующий раздел ниже).
      </p>

      Остановите службы Rocket Pool:

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Загрузите новый Smartnode CLI и создайте резервную копию старых бинарных файлов CLI и демона, если вам нужно вернуть их:

      Для систем `x64` (большинство обычных машин):

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Для систем `arm64`:

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Если вы хотите увидеть, что изменилось, откройте менеджер настроек - страница обзора покажет вам, что нового:

      ```shell
      rp service config
      ```

      Когда закончите, снова запустите Rocket Pool:

      ```shell
      sudo systemctl start rp-node rp-watchtower
      ```

      Наконец, проверьте версию, чтобы убедиться, что CLI и стек Smartnode оба обновлены:

      ```
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      И клиент, и служба должны соответствовать новой версии релиза.
    </Tab>
    <Tab label="macOS (Docker или Hybrid Mode)">
      Остановите службы Rocket Pool:

      ```shell
      rocketpool service stop
      ```

      Загрузите новый Smartnode CLI:

      Для систем `x64` (большинство Mac):

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-amd64 -O /usr/local/bin/rocketpool
      ```

      Для систем `arm64`, таких как Mac mini с M1:

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-arm64 -O /opt/homebrew/bin/rocketpool
      ```

      Теперь выполните команду установки:

      ```shell
      rocketpool service install -d
      ```

      Флаг `-d` говорит ему игнорировать системные зависимости, такие как Docker, так как они у вас уже есть.

      Если вы хотите увидеть, что изменилось, откройте менеджер настроек - страница обзора покажет вам, что нового:

      ```shell
      rocketpool service config
      ```

      Когда закончите, снова запустите Rocket Pool:

      ```shell
      rocketpool service start
      ```

      Наконец, проверьте версию, чтобы убедиться, что CLI и стек Smartnode оба обновлены:

      ```shell
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      И клиент, и служба должны соответствовать новой версии релиза.

    </Tab>

  </Tabs>
</div>

## Ручное обновление клиента Execution или Consensus

Каждый новый релиз стека Smartnode будет содержать обновленные ссылки на последние совместимые версии Docker-контейнеров Execution и Consensus.
Однако в некоторых случаях вы можете захотеть обновить один из этих клиентов _до_ ожидания нового релиза стека Smartnode.
В этом разделе показано, как это сделать.

<div className="p-3">
  <Tabs>
    <Tab label="Docker Mode">
      Обновление до новых версий клиентов легко в режиме Docker.

      Начните с открытия менеджера настроек:

      ```shell
      rocketpool service config
      ```

      Чтобы изменить версию клиента Execution, перейдите в категорию **Execution Client**.
      Измените настройку **Container Tag**:

      <img src={tuiEcContainerTag} width="100%" height="auto"/>

      Чтобы изменить версию клиента Consensus, перейдите в категорию **Consensus Client**.
      Измените настройку **Beacon Node Container Tag**:

      <img src={tuiCcContainerTag} width="100%" height="auto"/>

      Когда вы довольны своими изменениями, сохраните и выйдите, как обычно.
      Smartnode предложит автоматически перезапустить все затронутые контейнеры.
    </Tab>
    <Tab label="Native Mode">
      Сначала выключите службу вашего клиента Execution, Beacon Node и/или клиента Validator в зависимости от того, что вы хотите обновить.
      Например, выключение Geth:

      ```shell
      sudo systemctl stop geth
      ```

      Затем загрузите последний бинарный релиз от поставщика вашего клиента (или соберите его из исходного кода) и замените старый бинарный файл новым.
      Мы рекомендуем вам **переместить старый бинарный файл в резервное местоположение** вместо того, чтобы перезаписывать его, на случай, если у нового клиента возникнут проблемы.

      Наконец, снова запустите службу клиента - например, запуск Geth:

      ```shell
      sudo systemctl start geth
      ```

      Вы должны внимательно следить за скриптами логов после обновления, чтобы убедиться, что новый клиент работает должным образом.
    </Tab>

  </Tabs>
</div>
