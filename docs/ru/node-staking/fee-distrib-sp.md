# Распределители комиссий и Smoothing Pool

Теперь, когда прошел [Merge](https://ethereum.org/en/upgrades/merge/), операторы узлов получают **комиссии за приоритет** (**чаевые**) от транзакций, которые они включают в любые блоки, которые они предлагают в цепочку Ethereum.
Эти комиссии поступают и остаются на уровне Execution.

В отличие от большинства вознаграждений за валидацию, которые генерируются на уровне Consensus и автоматически выводятся периодически, эти комиссии _немедленно ликвидны_.
Как правило, комиссии за приоритет предоставляют вам почти столько же ETH, сколько вознаграждения Beacon Chain, поэтому они являются очень приятным преимуществом Merge.

::: tip ПРИМЕЧАНИЕ
В качестве быстрого напоминания вот разбивка различных типов вознаграждений и на каком уровне они предоставляются:

- Уровень Consensus: аттестации, предложения блоков, комитеты синхронизации, отчеты о слэшинге
- Уровень Execution: комиссии за приоритет и MEV (обсуждается в следующем разделе) от предложений блоков

:::

## Получатели комиссий

Когда вы предлагаете блок в цепочке Ethereum, протокол должен знать, куда отправлять чаевые от каждой транзакции, включенной в ваш блок.
Он не может отправить их на адрес вашего валидатора, потому что это на уровне Consensus - а не на уровне Execution.
Он не может отправить их на адрес вашего minipool, потому что это должно работать и для соло-стейкеров, а соло-стейкеры не имеют адреса на уровне Execution, прикрепленного к их валидаторам, как это делает Rocket Pool.

Вместо этого, способ работы довольно прост: когда Rocket Pool запускает ваш клиент Validator, он передает аргумент, называемый **получатель комиссии**.
Получатель комиссии - это просто адрес на уровне Execution, куда вы хотите, чтобы отправлялись чаевые.

Rocket Pool разработан для справедливого распределения этих вознаграждений между вами и стейкерами пула rETH, так же, как он справедливо распределяет ваши вознаграждения Beacon chain: ваша часть любых комиссий за приоритет, которые зарабатывают ваши валидаторы minipool, пойдет вам (плюс средняя комиссия всех ваших minipool), а остающаяся часть пойдет стейкерам пула (минус ваша средняя комиссия).
Точная часть зависит от количества minipool с залогом в 8 ETH по сравнению с minipool с залогом в 16 ETH, которые у вас есть.

Для этого Smartnode автоматически установит `получателя комиссии` вашего узла на один из этих специальных контрактов:

- Персональный **распределитель комиссий** вашего узла (по умолчанию)
- **Smoothing Pool** (по желанию)

Вкратце, **распределитель комиссий** - это уникальный контракт, привязанный к вашему узлу, который собирает и справедливо распределяет ваши комиссии за приоритет между вами и стейкерами rETH.
Это как ваше личное хранилище для комиссий за приоритет.
Любой (включая вас) может распределить его баланс в любое время, чтобы гарантировать, что вознаграждения всегда доступны для стейкеров rETH.

**Smoothing Pool** - это специальный контракт по желанию, который позволяет всем участвующим операторам узлов объединять и группировать свои комиссии за приоритет вместе и распределять их равномерно среди участников во время каждого интервала вознаграждений Rocket Pool (в настоящее время каждые 28 дней) и стейкеров пула rETH.
Это очень привлекательная функция для операторов узлов, которые не хотят беспокоиться о факторе удачи, связанном с получением предложений блоков с высокими комиссиями за приоритет, и предпочли бы иметь приятный, регулярный, последовательный набор ежемесячных доходов.

Мы рассмотрим оба этих варианта ниже, чтобы вы поняли разницу и хотите ли вы присоединиться к Smoothing Pool.

::: tip ПРИМЕЧАНИЕ
Для minipool, созданных после 28 октября 2024 года, настоятельно рекомендуется Smoothing Pool, поскольку он используется для распределения бонусной комиссии. Если вы откажетесь от Smoothing Pool, эти minipool получат общую комиссию в 5%. Если вы присоединитесь к Smoothing Pool, эти minipool получат комиссию от 10% (RPL не застейкано) до 14% (стоимость застейканного RPL составляет 10% от заимствованных ETH или более).
:::

## Ваш распределитель комиссий

Ваш распределитель комиссий - это уникальный контракт на уровне Execution, который **специфичен для вашего узла**.
Он будет хранить все комиссии за приоритет, которые вы заработали с течением времени, и содержит логику, необходимую для справедливого распределения их между стейкерами пула rETH и вашим адресом для вывода средств.
Этот процесс распределения **может быть вызван кем угодно** (включая стейкеров rETH) и может быть выполнен **в любое время**.
У него нет временного ограничения до истечения срока действия вознаграждений.

Адрес распределителя комиссий вашего узла **детерминированно основан на адресе вашего узла**.
Это означает, что он известен заранее, до того, как распределитель комиссий будет создан.

Новые узлы Rocket Pool автоматически создадут (инициализируют) контракт распределителя комиссий своего узла при регистрации.
Узлы, которые были созданы до обновления Redstone, должны будут выполнить этот процесс вручную.
Это нужно выполнить только один раз.

Одним интересным следствием этого является то, что адрес вашего распределителя может начать накапливать баланс **до того, как** вы инициализировали контракт распределителя комиссий.
Это нормально, потому что ваш распределитель получит доступ ко всему этому существующему балансу, как только вы его инициализируете.

**По умолчанию ваш узел будет использовать свой распределитель комиссий в качестве получателя комиссий для ваших валидаторов.**

### Просмотр его адреса и баланса

Вы можете просмотреть адрес и баланс вашего распределителя комиссий как часть:

```shell
rocketpool node status
```

Вывод будет выглядеть так:

![](../node-staking/images/status-fee-distributor.png)

### Инициализация распределителя комиссий

Чтобы инициализировать распределитель вашего узла, просто выполните эту новую команду:

```shell
rocketpool node initialize-fee-distributor
```

::: warning ПРИМЕЧАНИЕ
Если вы создали свой узел до обновления Redstone, вы должны вызвать эту функцию один раз, прежде чем сможете создавать какие-либо новые minipool с помощью `rocketpool node deposit`.
:::

Когда ваш распределитель был инициализирован, вы можете запросить и распределить весь его баланс с помощью следующей команды:

```shell
rocketpool node distribute-fees
```

Это отправит вашу долю вознаграждений на ваш **адрес для вывода средств**.

::: warning ПРИМЕЧАНИЕ О НАЛОГООБЛАГАЕМЫХ СОБЫТИЯХ
Всякий раз, когда вы создаете новый minipool, Rocket Pool автоматически вызовет `distribute-fees`.
Это делается для того, чтобы любые накопленные вами комиссии были распределены с использованием средней комиссии вашего узла, которая может измениться при создании нового minipool.

Также обратите внимание, что любой может вызвать `distribute-fees` на вашем распределителе комиссий (чтобы вы не удерживали вознаграждения rETH в заложниках).
У вас может возникнуть налогооблагаемое событие всякий раз, когда вызывается этот метод.

Пожалуйста, учитывайте эти условия при принятии решения о том, использовать ли Smoothing Pool (обсуждается ниже).
:::

### Система штрафов

Чтобы гарантировать, что операторы узлов не "обманывают", вручную изменяя получателя комиссии, используемого в их клиенте Validator, Rocket Pool использует систему штрафов.

Oracle DAO постоянно отслеживает каждый блок, созданный операторами узлов Rocket Pool.

Если узел _отказался_ от Smoothing Pool, следующие адреса считаются допустимыми получателями комиссий:

- Адрес rETH
- Адрес Smoothing Pool
- Контракт распределителя комиссий узла

Если узел _присоединился_ к Smoothing Pool, следующий адрес считается допустимым получателем комиссий:

- Адрес Smoothing Pool

Получатель комиссии, отличный от одного из допустимых адресов выше, считается **недопустимым**.

Minipool, который предложил блок с **недопустимым** получателем комиссии, получит **страйк**.
На третьем страйке minipool начнет получать **нарушения** - каждое нарушение вычтет **10% от его общего баланса Beacon Chain, включая заработанные ETH**, и отправит их стейкерам пула rETH при выводе средств из minipool.

Нарушения находятся на уровне **minipool**, а не на уровне **узла**.

Программное обеспечение Smartnode разработано так, чтобы гарантировать, что честные пользователи никогда не будут оштрафованы, даже если для этого придется отключить клиент Validator.
Если это произойдет, вы перестанете аттестовать и увидите сообщения об ошибках в ваших лог-файлах о том, почему Smartnode не может правильно установить вашего получателя комиссии.

## Smoothing Pool

**Smoothing Pool** - это уникальная функция сети Rocket Pool, доступная по желанию нашим операторам узлов.
По сути, он становится получателем комиссии для каждого оператора узла, который присоединяется к нему, и коллективно накапливает комиссии за приоритет от блоков, предложенных этими операторами узлов, в один большой пул. Во время контрольной точки вознаграждений Rocket Pool (те же, что используются для распределения вознаграждений RPL), общий баланс ETH пула справедливо распределяется между стейкерами пула и операторами узлов, которые присоединились к нему.

По сути, Smoothing Pool - это способ эффективно устранить случайность, связанную с выбором для предложений блоков.
Если у вас когда-либо была полоса неудач и вы месяцами не получали предложение, или если ваши предложения блоков имели только низкие комиссии за приоритет, вы можете найти Smoothing Pool весьма захватывающим.

Чтобы упростить математику, член сообщества Кен Смит составил [масштабный анализ](https://raw.githubusercontent.com/htimsk/SPanalysis/main/report/Analysis%20of%20the%20Smoothing%20Pool.pdf), сравнивающий прибыльность Smoothing Pool и распределителя комиссий, который прекрасно резюмируется этой диаграммой:

![](../node-staking/images/sp-chart.png)

Вкратце, пока в Smoothing Pool больше minipool, чем у вас, более вероятно, что вы выиграете, присоединившись к нему.

### Правила

Smoothing Pool использует следующие правила:

- Во время контрольной точки вознаграждений Rocket Pool, когда распределяется баланс Smoothing Pool, общий баланс ETH контракта делится пополам.
  - Стейкеры rETH получают 1/2 (для залогов в 16 ETH) или 3/4 (для залогов в 8 ETH, также известных как LEB8), минус **средняя комиссия** всех присоединившихся операторов узлов
  - Остаток идет операторам узлов, которые присоединились.

- Присоединение к Smoothing Pool осуществляется на **уровне узла**. Если вы присоединяетесь, все ваши minipool присоединяются.

- Любой может присоединиться в любое время. Они должны подождать полный интервал вознаграждений (3 дня на Hoodi, 28 дней на Mainnet), прежде чем выйти, чтобы предотвратить манипулирование системой (например, выход из SP сразу после выбора для предложения блока).
  - После выхода они должны подождать еще один полный интервал, чтобы снова присоединиться.

- Smoothing Pool вычисляет "долю" каждого minipool (часть ETH пула за интервал), принадлежащую каждому присоединившемуся узлу.
  - Доля является функцией производительности вашего minipool во время интервала (вычисляется путем просмотра того, сколько аттестаций вы отправили в Beacon Chain и сколько пропустили), и ставки комиссии вашего minipool.

- Общая доля вашего узла - это сумма долей ваших minipool.

- Общая доля вашего узла масштабируется в зависимости от времени, в течение которого вы были присоединены.
  - Если вы были присоединены на протяжении всего интервала, вы получаете свою полную долю.
  - Если вы были присоединены на 30% интервала, вы получаете 30% вашей полной доли.

Если вас интересуют полные технические детали расчета вознаграждений Smoothing Pool, пожалуйста, ознакомьтесь с [полной спецификацией здесь](https://github.com/rocket-pool/rocketpool-research/blob/master/Merkle%20Rewards%20System/rewards-calculation-spec.md#smoothing-pool-rewards).

### Присоединение и выход из Smoothing Pool

Чтобы присоединиться к Smoothing Pool, выполните следующую команду:

```shell
rocketpool node join-smoothing-pool
```

Это запишет вас как присоединившегося в контрактах Rocket Pool и автоматически изменит `получателя комиссии` вашего клиента Validator с контракта распределителя вашего узла на контракт Smoothing Pool.

Чтобы покинуть пул, выполните эту команду:

```shell
rocketpool node leave-smoothing-pool
```

Это запишет вас как вышедшего в контрактах Rocket Pool, и после небольшой задержки автоматически изменит `получателя комиссии` вашего клиента Validator с контракта Smoothing Pool обратно на контракт распределителя комиссий вашего узла.

### Получение вознаграждений из Smoothing Pool

Вознаграждения из Smoothing Pool объединяются вместе с RPL в конце каждого интервала вознаграждений с использованием системы вознаграждений Redstone.
Получение их так же просто, как выполнение:

```shell
rocketpool node claim-rewards
```

Если вы присоединились к Smoothing Pool, вы заметите, что количество ETH, которое вы получаете за каждый интервал, больше нуля:

```
Welcome to the new rewards system!
You no longer need to claim rewards at each interval - you can simply let them accumulate and claim them whenever you want.
Here you can see which intervals you haven't claimed yet, and how many rewards you earned during each one.

Rewards for Interval 0 (2022-08-04 01:35:39 -0400 EDT to 2022-09-01 01:35:39 -0400 EDT):
	Staking:        50.820133 RPL
	Smoothing Pool: 0.000000 ETH

Rewards for Interval 1 (2022-09-01 01:35:39 -0400 EDT to 2022-09-29 01:35:39 -0400 EDT):
	Staking:        40.668885 RPL
	Smoothing Pool: 0.096200 ETH

Total Pending Rewards:
	91.489018 RPL
	0.096200 ETH

Which intervals would you like to claim? Use a comma separated list (such as '1,2,3') or leave it blank to claim all intervals at once.
```

Обратите внимание, что вознаграждения Smoothing Pool в интервале 1 здесь указывают, что узел был присоединен во время этого интервала и получил вознаграждения соответственно.

Мы рассмотрим более подробно получение вознаграждений RPL и Smoothing Pool позже в руководстве, в разделе [Получение вознаграждений](./rewards).

## Следующие шаги

Как только вы решите, хотите ли вы присоединиться к Smoothing Pool, взгляните на следующий раздел о MEV и вознаграждениях MEV.
