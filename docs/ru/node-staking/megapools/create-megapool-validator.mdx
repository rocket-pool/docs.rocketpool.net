

# Создание мегапула (Validator)

Добро пожаловать в Saturn 1! Мегапул Rocket Pool — это экземпляр смарт-контракта на уровне исполнения.
Ваша нода будет управлять мегапулом, который служит адресом для вывода средств Ethereum для одного или нескольких валидаторов.
Каждый валидатор состоит из части вашего ETH, известной как сумма залога, и части ETH из стейкинг-пула rETH,
известной как заёмная сумма. Ваш мегапул отвечает за объединение суммы залога и заёмной суммы ETH для формирования 32 ETH, которые затем
отправляются в депозитный контракт Beacon Chain для создания нового валидатора.

Ваш мегапул автоматически развёртывается во время первого депозита валидатора. После этого вы сможете использовать тот же мегапул для управления любым количеством валидаторов! Вам не нужно
будет развёртывать новый мегапул каждый раз, когда вы создаёте нового валидатора.


::: tip ПРИМЕЧАНИЕ
Время активации (и выхода) из очереди валидаторов Beacon Chain может сильно варьироваться в зависимости от текущего состояния сети.

Это вне контроля Rocket Pool и является функцией самого Beacon Chain.

Следующий инструмент даёт хорошую оценку ожидаемого времени ожидания:
[https://www.validatorqueue.com/](https://www.validatorqueue.com/)

Пожалуйста, ознакомьтесь с этим инструментом, чтобы получить представление о том, сколько времени вам придётся ждать активации валидатора.
:::

::: tip ПРИМЕЧАНИЕ

Создание валидатора регулируется двумя очередями.

1. Первая — это очередь депозитов Rocket Pool. Мы подробнее рассмотрим её в другом разделе, но по сути эта очередь управляется протоколом Rocket Pool и определяет, когда ваш валидатор получит заёмный ETH.
Для создания валидатора необходимо наличие ETH в депозитном пуле для сопоставления ваших 4 ETH с 28 ETH из депозитного пула.

2. Вторая — это очередь Beacon Chain, которая управляется Ethereum Beacon Chain и определяет, когда ваш валидатор станет активным.
Обратите внимание, что время активации валидатора может сильно варьироваться в зависимости от вашего положения в каждой очереди и текущего состояния сети.

Очередь депозитов Rocket Pool имеет систему экспресс-очереди, которая помогает существующим операторам нод мигрировать ETH своих валидаторов minipool
на ETH валидаторов megapool.

:::

## Очередь депозитов Rocket Pool и экспресс-очередь

В очереди депозитов Rocket Pool есть два типа очередей: экспресс-очередь и стандартная очередь.

Очередь депозитов имеет систему экспресс-очереди, которая помогает существующим операторам нод мигрировать ETH своих валидаторов minipool
на ETH валидаторов megapool. Это также создаёт более предсказуемые сроки депозитов для депозитов с использованием экспресс-очереди.

Экспресс-очередь обрабатывается в соотношении 4:1, что означает, что 4 валидатора из экспресс-очереди получают сопоставление на каждые 1 из стандартной очереди.
Иными словами: сопоставляются 4 валидатора из экспресс-очереди, затем 1 из стандартной, затем снова 4 из экспресс-очереди и так далее.

Существующие операторы нод получают билеты экспресс-очереди на основе их залогового ETH в устаревших minipools: один билет за каждые 4 ETH в залоге.
Например, оператор ноды с устаревшим minipool на 8 ETH получает 2 билета экспресс-очереди. Этого достаточно для полной миграции в два валидатора megapool с 4 ETH через экспресс-очередь.
[RPIP-59: Deposit Mechanics](https://rpips.rocketpool.net/RPIPs/RPIP-59#deposit-queue) подробно описывает механику обработки депозитов.

Вашей ноде будет возвращён билет экспресс-очереди, если вы решите [вывести валидатор из экспресс-очереди](./create-megapool-validator#exit-a-validator-from-the-rocket-pool-deposit-queue).

## Внесение ETH и создание валидатора

Если это первый валидатор megapool вашей ноды, мегапул вашей ноды также будет автоматически развёрнут одновременно. Помните, что мегапул вашей ноды может
управлять одним или несколькими валидаторами, поэтому развёртывание мегапула происходит только один раз для каждой ноды!

Как только вы будете готовы внести ETH в мегапул и создать валидатор Beacon Chain, вы можете сделать это с помощью следующей команды:

```
rocketpool megapool deposit
```
::: danger ПРЕДУПРЕЖДЕНИЕ

Хотя CLI автоматизирует многие следующие шаги за вас, мы <strong>настоятельно</strong> рекомендуем следить за вашей нодой и транзакциями, чтобы обеспечить успешный переход от `prelaunch` к `staking`.

Неудачные транзакции (из-за скорректированных настроек газа, недостаточного ETH для газа или отключения ноды в течение 28 дней после первоначального депозита) могут привести к переходу валидатора мегапула в состояние `dissolved`, чего следует избегать.

Если валидатор в состоянии prelaunch не выполнит стейкинг в течение 28 дней, валидатор будет аннулирован. 1 ETH (из залога в 4 ETH), отправленный в Beacon Chain в процессе prelaunch, **не подлежит возврату**.
Оператору ноды [начисляется кредит](/ru/node-staking/megapools/credit) в размере оставшихся 3 ETH из их залога с применением штрафа за аннулирование в 0,05 ETH в качестве долга. Чистый кредит за аннулированный валидатор составляет 2,95 ETH.

[Узнайте больше о том, как подтвердить успешный стейкинг](./create-megapool-validator#confirming-a-successful-stake)

:::

Первый запрос спросит, сколько валидаторов вы хотите создать. Вы можете создать до 35 в одном депозите, но мы продолжим с 1 валидатором
для остальной части нашей демонстрации. Введите `1`, затем нажмите `enter`, чтобы начать создание 1 валидатора.
```
Your eth2 client is on the correct network.

How many validators would you like to create? (max: 35)
1
```

Второй запрос отобразит некоторую информацию о том, с каким количеством ETH в настоящее время залогирована ваша нода, а также
об общем требовании залога для выбранного количества валидаторов. Нода в нашей демонстрации не имеет
валидаторов megapool, поэтому `0.00 ETH bonded`. Текущее требование залога — `4 ETH`.
После прочтения и понимания показанной информации введите `y`, затем нажмите `enter`, чтобы перейти к следующему запросу.


```
The node is currently bonded with 0.00 ETH.
The total bond requirement is 4.00 ETH.

NOTE: You are about to create 1 new megapool validator(s), requiring a total of: 4.00 ETH.
Would you like to continue? [y/n]
y
```
Следующий запрос отобразит статус [очереди депозитов Rocket Pool](/ru/node-staking/megapools/create-megapool-validator#rocket-pool-deposit-queue-and-express-queue).
Это показывает, сколько валидаторов ожидают перед вами для сопоставления с ETH. Экспресс-очередь в основном предназначена для уже существующих операторов нод, поскольку у новых нод не будет билетов экспресс-очереди.
`The express queue rate is 4` означает, что 4 валидатора из экспресс-очереди сопоставляются на каждый 1 из стандартной очереди.
```
There are 1 validator(s) on the express queue.
There are 12 validator(s) on the standard queue.
The express queue rate is 4 (4 express validators assigned per 1 standard).
A new express validator would be at queue position 3.
A new standard validator would be at queue position 14.
```
::: tip ПРИМЕЧАНИЕ
Если вы возвращающийся оператор ноды и у вас есть доступные билеты экспресс-очереди для этого депозита, вам будет предложено использовать их на этом этапе.
Введите `1`, затем нажмите `enter`, чтобы продолжить использование одного билета экспресс-очереди для этого одного депозита валидатора megapool.
```
How many express tickets would you like to use? (max: 7)
1
```
Если вы хотите сохранить свой билет(ы) экспресс-очереди и продолжить в стандартной очереди, просто введите `0`, затем нажмите `enter`, чтобы перейти к следующему запросу.
:::

Если у вас есть [кредит для депозита](/ru/node-staking/megapools/credit), который нужно использовать для валидатора, вам будет предложено сделать это здесь. В противном случае на этом шаге вам будут предложены текущие предложения по цене газа в сети.
```
Your credit balance is 0.00 ETH. (Credit in addition to ETH staked on your behalf).
Your consensus client is synced, you may safely create a megapool validator.
+================ Suggested Gas Prices ================+
| Avg Wait Time |   Max Fee    |     Total Gas Cost     |
| 15 Seconds    | 2.13120 gwei | 0.00160 to 0.00240 ETH |
| 1 Minute      | 1.96787 gwei | 0.00148 to 0.00222 ETH |
| 3 Minutes     | 1.00871 gwei | 0.00075 to 0.00113 ETH |
| >10 Minutes   | 1.00871 gwei | 0.00075 to 0.00113 ETH |
+======================================================+

These prices include a maximum priority fee of 0.010 gwei.
Please enter your max fee (including the priority fee) or leave blank for the default of 1.96787 gwei:

```
После подтверждения цены газа мы сделаем последнее и окончательное подтверждение для создания валидатора megapool.
```
Using a max fee of 1.968 gwei and a priority fee of 0.010 gwei.
You are about to deposit 4.000000 ETH to create 1 new megapool validator(s).
ARE YOU SURE YOU WANT TO DO THIS?
 [y/n]
y

Creating 1 megapool validator(s) ...
Transaction has been submitted with hash <tx-hash>.
You may follow its progress by visiting:
https://hoodi.etherscan.io/tx/<tx-hash>

Waiting for the transaction to be included in a block... you may wait here for it, or press CTRL+C to exit and return to the terminal.

The node deposit of 4.000000 ETH total was made successfully!
Validator pubkeys:
  1. <beacon-pubkey>

The 1 new megapool validators have been created.
Once your validators progress through the queue, ETH will be assigned and a 1 ETH prestake submitted for each.
After the prestake, your node will automatically perform a stake transaction for each validator, to complete the progress.
To check the status of your validators use `rocketpool megapool validators`
To monitor the stake transactions use `rocketpool service logs node`

```
После завершения транзакции вы получите подтверждение вашего депозита
в виде хэша транзакции etherscan вместе с ожидаемым pubkey Beacon Chain после того, как ваш валидатор megapool выйдет в онлайн. Не стесняйтесь использовать команду `rocketpool megapool status` для
проверки статуса вашего мегапула или `rocketpool megapool validators` для проверки статуса вашего конкретного валидатора. Ваш валидатор будет в
состоянии `initialized` по мере прохождения через очередь депозитов Rocket Pool. Имейте в виду, что pubkey вашего валидатора megapool не будет зарегистрирован в Beacon Chain до тех пор, пока он не будет
обработан очередью депозитов Rocket Pool и ему не будет присвоен ETH.

На этом этапе вы справились! Поздравляем с вашим валидатором megapool. Вам определённо стоит ознакомиться с разделом [Мониторинг и обслуживание](/ru/node-staking/maintenance/overview)
нашего руководства, чтобы узнать, как поддерживать вашу ноду в наилучшем состоянии. Также продолжайте читать следующий раздел о подтверждении успешного стейкинга, чтобы убедиться,
что ваш `initialized` валидатор плавно перейдёт в состояние `staking` без каких-либо штрафов.

## Подтверждение успешного стейкинга

::: danger ПРЕДУПРЕЖДЕНИЕ

Хотя CLI автоматизирует многие следующие шаги за вас, мы <strong>настоятельно</strong> рекомендуем следить за вашей нодой и транзакциями, чтобы обеспечить успешный переход от `prelaunch` к `staking`.

Неудачные транзакции (из-за скорректированных настроек газа, недостаточного ETH для газа или отключения ноды в течение 28 дней после первоначального депозита) могут привести к переходу валидатора мегапула в состояние `dissolved`, чего следует избегать.

Если валидатор в состоянии prelaunch не выполнит стейкинг в течение 28 дней, валидатор будет аннулирован. 1 ETH (из залога в 4 ETH), отправленный в Beacon Chain в процессе prelaunch, **не подлежит возврату**.
Оператору ноды [начисляется кредит](/ru/node-staking/megapools/credit) в размере оставшихся 3 ETH из их залога с применением штрафа за аннулирование в 0,05 ETH в качестве долга. Чистый кредит за аннулированный валидатор составляет 2,95 ETH.

:::


Убедитесь, что ваша нода остаётся онлайн на протяжении всего этого процесса! Она выполнит несколько полностью автоматических шагов, чтобы убедиться, что ваш валидатор плавно продвигается
между различными этапами, описанными ниже:

Ваш новый валидатор megapool будет в состоянии `initialized`. Он будет находиться в этом состоянии до тех пор, пока не пройдёт через очередь депозитов Rocket Pool
и ему не будет присвоено 28 ETH из депозитного пула. Используйте команду `rocketpool megapool validators`, чтобы проверить статус вашего валидатора. Вывод должен выглядеть примерно так:

```
1 Initialized validator(s):

--------------------

Megapool Validator ID:        7
Expected pubkey:              <expected-pubkey>
Validator active:             no
Validator Queue Position:     14
Express Ticket Used:          no
```
Как только вашему валидатору будет присвоен ETH из [очереди депозитов Rocket Pool](/ru/node-staking/megapools/create-megapool-validator#rocket-pool-deposit-queue-and-express-queue), он будет переведён в состояние `Prelaunch`. В этот момент 1 ETH из баланса вашего мегапула будет депонирован
в Beacon Chain. Pubkey вашего валидатора также будет зарегистрирован в Beacon Chain, что означает, что вы можете просмотреть статус вашего `Prelaunch` валидатора в таком обозревателе, как https://beaconcha.in/ (или https://hoodi.beaconcha.in/, если вы используете тестовую сеть).
Вы можете наблюдать за своим валидатором, выполнив поиск pubkey на https://beaconcha.in/ или перейдя по ссылке в формате: `https://beaconcha.in/validator/<your-validator-pubkey>`
```
1 Prelaunch validator(s):

--------------------

Megapool Validator ID:        7
Validator pubkey:             <pubkey>
Validator active:             no
Express Ticket Used:          no

```
<img src="../images/prestaking.png" width="100%" height="auto" />
После того как ваш `Prelaunch` валидатор будет обработан Beacon Chain и зачтён первоначальный депозит в 1 ETH, ваша нода автоматически выполнит
транзакцию `stake` для завершения полного депозита в 32 ETH в Beacon Chain. Транзакция `stake` переведёт ваш `Prelaunch` валидатор
в состояние `Staking`. На этом этапе ваш `Staking` валидатор:
- Имеет 32 ETH, депонированных в Beacon Chain
- Получил индексный номер валидатора
- Ожидает активации в Beacon Chain

```
1 Staking validator(s):

Megapool Validator ID:        1
Validator pubkey:             <pubkey>
Validator active:             no
Validator index:              <index>
Beacon status:                pending_queued
Express Ticket Used:          no

```
<img src="../images/pending-activation.png" width="100%" height="auto" />

Текущий статус очереди валидаторов Beacon Chain можно найти здесь: https://www.validatorqueue.com/. Как только ваш `Staking` валидатор будет активирован в Beacon Chain, вы
увидите `Beacon status:                active_ongoing` в меню `rocketpool megapool validators`, подтверждающее, что он был активирован и готов делать аттестации.

```
1 Staking validator(s):

--------------------

Megapool Validator ID:        0
Validator pubkey:             <pubkey>
Validator active:             yes
Validator index:              <index>
Beacon status:                active_ongoing
Express Ticket Used:          no
```
<img src="../images/activated.png" width="100%" height="auto" />

На этом этапе всё готово! Поздравляем! Вы официально создали валидатор megapool с Rocket Pool! Ознакомьтесь с руководствами по [Мониторингу и обслуживанию](/ru/node-staking/maintenance/overview),
чтобы узнать, как следить за своей нодой и поддерживать её в отличном состоянии.

## Вывод валидатора из очереди депозитов Rocket Pool

Если ваш валидатор ожидал в очереди (экспресс ИЛИ стандартной) и вы хотите покинуть очередь, вы можете сделать это! Ваш депозит в 4 ETH будет возвращён
в виде кредита, который можно обменять на эквивалентную сумму в rETH. Шаги достаточно просты:

Сначала проверьте `rocketpool megapool validators`, чтобы определить, какой валидатор вывести из очереди. Убедитесь,
что валидатор, который вы выводите из очереди, находится в состоянии `Initialized`. Запомните его pubkey. После того как вашему валидатору будет присвоен ETH, вы не сможете вывести его из очереди.
```
1 Initialized validator(s):

--------------------

Megapool Validator ID:        6
Expected pubkey:              <beacon-pubkey>
Validator active:             no
Validator Queue Position:     14
Express Ticket Used:          no
```


Используйте следующую команду для вывода валидатора из очереди, затем продолжите с выбором:
```
staker@node:~$ rocketpool megapool exit-queue

Please select a validator to exit the queue:
1: Pubkey: <beacon-pubkey>
```
После выбора и подтверждения того, что ваш валидатор покинул очередь депозитов Rocket Pool, вы можете использовать следующую команду для обмена кредита на rETH:

```
staker@node:~$ rocketpool node withdraw-credit

You have 4.000000 ETH of credit that you can withdraw, receiving the equivalent amount in rETH. Would you like to withdraw the maximum amount of credit? [y/n]
```
И вот всё готово! Если вы хотите внести депозит для другого валидатора, этот кредит также можно использовать для депозита валидатора в дополнение к обмену на rETH.
Если вы использовали билет экспресс-очереди для вашего вышедшего (исключённого из очереди) валидатора, вашей ноде будет возвращён этот билет экспресс-очереди.

## Создание нескольких валидаторов мегапула

Мегапул вашей ноды может управлять любым количеством валидаторов. Если вы хотите создать дополнительный валидатор (или создать несколько валидаторов в одной транзакции для экономии на комиссиях),
вы можете сделать это с помощью команды `rocketpool megapool deposit`. С учётом текущего лимита газа блока, максимальное количество валидаторов, которые вы можете создать в одной транзакции, равно 35.

## Следующие шаги

Теперь, когда ваш валидатор megapool запущен, следующие шаги проведут вас через то, как отслеживать состояние вашей ноды, проверять и применять обновления, а также обслуживать её на протяжении всего её существования.

Пожалуйста, прочитайте раздел [Мониторинг и обслуживание](/ru/node-staking/maintenance/overview) далее, чтобы узнать больше об этих темах.
