# Как писать дополнения для Rocket Pool Smart Node

## Введение

Дополнения Rocket Pool Smart Node - это расширения, которые предоставляют дополнительные функции стеку Smart Node. Они могут быть реализованы как Docker-контейнеры, которые интегрируются с клиентами Ethereum или сервисом Smart Node. Дополнения могут быть включены и настроены через терминальный пользовательский интерфейс (TUI) Smart Node с помощью команды `rocketpool service config`.

Разработка дополнений может быть основана на двух существующих примерах:

- **Graffiti Wall Writer**: Позволяет операторам нод вносить вклад в общественные рисунки на стене граффити Beaconcha.in, динамически устанавливая граффити предложения блока. Он использует децентрализованный инструмент рисования, чтобы определить, какие пиксели "рисовать" с каждым предложением.
- **Rescue Node**: Предоставляет резервный сервис beacon node, используя учетные данные из проекта Rocket Rescue Node. Это помогает предотвратить пропущенные аттестации во время обслуживания ноды, синхронизации или сбоев, направляя запросы на общий удаленный beacon node.

Дополнения являются частью исходного кода Smart Node и должны быть внесены через pull request в репозиторий. Они реализуют стандартизированный интерфейс для конфигурации и интеграции.

## Предварительные требования

- Знакомство с программированием на Go, поскольку дополнения написаны на Go.
- Понимание Docker, поскольку дополнения могут работать как контейнеры.
- Знание архитектуры Rocket Pool Smart Node, включая его настройку Docker compose и систему конфигурации.
- Доступ к репозиторию Smart Node для локальной разработки и тестирования.

## Шаги по созданию дополнения

Чтобы создать новое дополнение, вам нужно добавить код в определенные места в репозитории Smart Node. Процесс включает реализацию логики дополнения, настройку его пользовательского интерфейса, регистрацию и обработку интеграции со стеком Docker.

### 1. Реализация логики дополнения

Создайте новый подкаталог в `addons/` с именем вашего дополнения (используйте snake_case, например, `my_addon`).

В этом каталоге создайте Go-файл (например, `my_addon.go`), который определяет структуру дополнения и реализует интерфейс `SmartnodeAddon` из `github.com/rocket-pool/smartnode/shared/types/addons`.

```
type MyAddon struct {
    cfg *MyAddonConfig `yaml:"config,omitempty"`
}

func NewMyAddon() addons.SmartnodeAddon {
    return &MyAddon{
        cfg: NewConfig(),
    }
}
```

Ключевые методы для реализации:

- `GetName()`: Возвращает отображаемое имя дополнения.
- `GetDescription()`: Возвращает краткое описание.
- `GetConfig()`: Возвращает объект конфигурации с параметрами (например, флаг включения, ключи API, URL).
- `GetEnabledParameter()`: Возвращает параметр, контролирующий, включено ли дополнение.
- Методы для запуска/остановки дополнения, генерации разделов Docker compose или взаимодействия с другими сервисами.

Если дополнение запускает Docker-контейнер:

- Определите образ Docker (например, пользовательский образ или внешний).
- Укажите тома, порты или переменные среды, которые необходимы.

Например, дополнение Graffiti Wall Writer запускает контейнер, который периодически обновляет файл граффити клиента валидатора на основе конфигурации JSON для рисуемого изображения.

Дополнение Rescue Node настраивает клиент валидатора для использования удаленного резервного beacon node через прокси, требуя параметров имени пользователя и пароля.

### 2. Создание пользовательского интерфейса конфигурации

Добавьте файл в `rocketpool-cli/service/config/` с именем `addon-myaddon.go`.

Этот файл определяет страницу TUI для настройки дополнения с использованием библиотеки `tview`.

Ключевые элементы:

- Определите структуру `AddonMyAddonPage` с полями для макета, основной конфигурации и элементов формы.
- Конструктор `NewAddonMyAddonPage`, который инициализирует страницу и вызывает `createContent()`.
- `createContent()`: Настраивает форму с флажками (например, включено) и полями ввода для других параметров.
- Обработчики событий, такие как `handleEnableChanged()`, для показа/скрытия параметров на основе состояния включения.

Пример фрагмента:

```go
package config

import (
	"fmt"

	"github.com/rivo/tview"
	"github.com/rocket-pool/smartnode/shared/services/config"
	"github.com/rocket-pool/smartnode/shared/types/addons"
	cfgtypes "github.com/rocket-pool/smartnode/shared/types/config"
)

// The page wrapper for the add-on config
type AddonMyAddonPage struct {
	addonsPage   *AddonsPage
	page         *page
	layout       *standardLayout
	masterConfig *config.RocketPoolConfig
	addon        addons.SmartnodeAddon
	enabledBox   *parameterizedFormItem
	otherParams  []*parameterizedFormItem
}

// Creates a new page for the add-on settings
func NewAddonMyAddonPage(addonsPage *AddonsPage, addon addons.SmartnodeAddon) *AddonMyAddonPage {
	configPage := &AddonMyAddonPage{
		addonsPage:   addonsPage,
		masterConfig: addonsPage.home.md.Config,
		addon:        addon,
	}
	configPage.createContent()
	// ... (additional code for page setup)
}

// Creates the content for the settings page
func (configPage *AddonMyAddonPage) createContent() {
	// Setup layout and form items
	// ...
}
```

### 3. Регистрация дополнения

Обновите `addons/constructors.go`, чтобы включить конструктор для вашего дополнения.

Этот файл содержит функции для создания всех дополнений.

Пример:

```
func NewMyAddon() addons.SmartnodeAddon {
    return my_addon.NewMyAddon()
}
```

Затем добавьте его в список доступных дополнений в `NewRocketPoolConfig` в `shared/services/config/rocket-pool-config.go`.

```
// Addons
cfg.GraffitiWallWriter = addons.NewGraffitiWallWriter()
cfg.RescueNode = addons.NewRescueNode()
cfg.MyAddon = addons.MyAddon()
```

### 4. Интеграция с Docker Compose

Дополнения часто требуют модификаций файлов Docker compose.

- Добавьте шаблоны в каталог `shared/services/rocketpool/assets/install/templates/addons` для раздела compose вашего дополнения (например, `my_addon.tmpl`).
- Код дополнения генерирует YAML compose при включении, включая сервисы, тома и зависимости.

Функция `composeAddons` внутри папки `services/rocketpool/client` отвечает за провизионирование контейнеров Docker Compose на основе конфигурации Rocket Pool, настраивая runtime, шаблон и переопределяющие ресурсы для дополнения.

Для установки:

- Обновите скрипт установщика (`install.sh`), если дополнению нужно скопировать файлы (например, файлы конфигурации по умолчанию).

### 5. Необязательные интеграции

- **Команда статуса ноды**: Если дополнение имеет информацию о статусе (например, срок действия учетных данных для Rescue Node), обновите `rocketpool-cli/node/status.go`, чтобы отобразить ее.
- **Метрики или логи**: Интегрируйте с Prometheus/Grafana, если применимо.
- **Внешние зависимости**: Если используется внешний репозиторий (например, прокси Rescue Node), убедитесь, что он задокументирован.

### 6. Тестирование и отправка

- Создайте и протестируйте локально: Используйте Makefile для сборки Smart Node, установите и включите ваше дополнение.
- Проверьте в TUI, проверьте контейнеры Docker и протестируйте функциональность.
- Отправьте pull request на https://github.com/rocket-pool/smartnode со своими изменениями.

## Пример: Graffiti Wall Writer

- **Назначение**: Рисует общественные изображения на стене граффити Beaconcha.in с использованием предложений блоков.
- **Реализация**: Запускает Docker-контейнер, который получает состояние стены и обновляет файл граффити валидатора.
- **Конфигурация**: Флаг включения и параметр для URL JSON изображения (по умолчанию: логотип Rocket Pool).
- **Интеграция**: Контейнер монтирует каталог данных валидатора для записи файла граффити. Включается через TUI; способствует децентрализованному рисованию.

## Пример: Rescue Node

- **Назначение**: Резервный beacon node для предотвращения штрафов во время простоя.
- **Реализация**: Настраивает клиент валидатора для использования удаленного прокси с аутентификацией.
- **Конфигурация**: Флаг включения, имя пользователя и пароль с веб-сайта Rescue Node.
- **Интеграция**: Изменяет конфигурацию валидатора для указания на прокси rescue. Показывает статус учетных данных в `rocketpool node status`.

Для получения более подробной информации просмотрите исходный код в репозитории или внесите вклад в улучшение документации по разработке дополнений.
