import { Tab, Tabs } from "@rspress/core/theme";

# [Режим Docker] Руководство по обновлению Redstone и Слиянию

Это руководство охватывает все, что вам нужно знать для подготовки вашей ноды к обновлению Redstone и Слиянию, если вы используете **режим Docker**.

## Что нужно сделать перед обновлением до v1.5.0

Перед обновлением до v1.5.0 и выше Smartnode, пожалуйста, пройдите следующий контрольный список, чтобы убедиться, что вы готовы:

### Переключитесь на полный Execution-клиент

Слияние требует, чтобы вы запускали свой собственный Execution-клиент, поэтому вы больше не сможете использовать удаленные провайдеры, такие как Infura или Pocket.
v1.5.0 больше не будет иметь их и не позволит вам запустить стек, пока вы не выберете полный Execution-клиент.

Из-за этого изменения вам следует переключиться на полный клиент, пока вы еще на v1.4, дождаться его полной синхронизации, а затем обновиться до v1.5.

Режим Docker делает переключение клиентов очень простым.
[Это руководство](../../node-staking/change-clients#changing-execution-clients) предоставляет пошаговое описание процесса.

## Обновление до v1.5.0

Обновление стека Smartnode до v1.5.0 ничем не отличается от любого другого обновления.
Просто следуйте [обычным инструкциям здесь](../../node-staking/updates#updating-the-smartnode-stack).

## Что Smartnode обрабатывает автоматически

В режиме Docker Smartnode позаботится о большинстве изменений, необходимых для поддержки Redstone и Слияния, автоматически после обновления до v1.5.0.
Вот краткий список того, что он сделает для вас без какого-либо ручного вмешательства:

### Engine API

Слияние меняет способ взаимодействия вашего Execution-клиента с вашим Consensus-клиентом.
Вместо использования старой системы RPC на основе HTTP или Websocket, Слияние требует новой системы, предоставляемой вашим Execution-клиентом, называемой Engine API.

Это специальное соединение, которое позволяет Consensus-клиенту заменить старую систему майнинга Proof-of-Work на Proof-of-Stake; это сердце Слияния.
Оно также **аутентифицировано** секретным токеном, поэтому только ваш Consensus-клиент может подключаться к вашему Execution-клиенту - больше ничто не может.

Smartnode автоматически обработает настройку токена аутентификации и Engine API как на вашем Execution-, так и на Consensus-клиенте.

### Ваш получатель комиссий

**Получатель комиссий** - это адрес на цепочке Execution-уровня, который будет получать все приоритетные комиссии за блоки, которые вы предлагаете.
Это настройка, предоставляемая вашему Validator-клиенту при его первом запуске.

Smartnode обработает его настройку на правильный адрес при обновлении до v1.5 и будет постоянно проверять, что вы используете правильный, чтобы вы не получили [случайный штраф](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Если вы присоединились к [Smoothing Pool](./whats-new#smoothing-pool), он сделает его вашим получателем комиссий.
Если нет, он сделает получателем комиссий ваш [контракт распределителя комиссий](./whats-new#fee-recipients-and-your-distributor).

### MEV-Boost

[MEV-boost](https://boost.flashbots.net/) - это система, которую предоставляет Flashbots для передачи MEV-вознаграждений валидаторам Proof-of-Stake после Слияния.
Rocket Pool имеет MEV-Boost, встроенный в Smartnode, и автоматически настраивает вашу ноду для его использования, чтобы ваши предложения получали максимальное количество вознаграждений.

## Что вам следует сделать после обновления

Хотя Smartnode обрабатывает большинство изменений за вас, есть несколько дополнительных вещей, которые вам следует сделать вручную:

### Убедитесь в успешном обновлении

Первое, что нужно сделать, это убедиться, что ваша нода работает правильно.
Рассмотрите следующие шаги:

- Проверьте логи на наличие ошибок с помощью `rocketpool service logs eth1`, `rocketpool service logs eth2`, `rocketpool service logs validator` и `rocketpool service logs node`.
- Подтвердите с помощью Block Explorer (такого как ваша панель Grafana и [https://beaconcha.in](https://beaconcha.in)), что вы все еще аттестуете правильно
  - Помните, что если у вас включена защита Doppelganger, вы пропустите несколько аттестаций после перезапуска. Это нормально!

### Настройте резервную ноду

Поскольку Слияние несовместимо с удаленными провайдерами, такими как Infura и Pocket, вы потеряете возможность использовать их в качестве резервных Execution-клиентов, когда ваш основной отключается.

Smartnode по-прежнему имеет возможность предоставить резервный Execution-клиент (и теперь также резервный Consensus-клиент), но теперь вам нужно будет использовать Execution- и Consensus-клиенты, которые вы контролируете.

Для получения дополнительной информации о настройке резервной ноды см. [руководство по резервной ноде](../../node-staking/fallback).

### Инициализируйте ваш распределитель комиссий

Если вы не планируете присоединяться к [Smoothing Pool](./whats-new#smoothing-pool) и требовать все свои приоритетные комиссии и MEV-вознаграждения в ваш [контракт распределителя комиссий](./whats-new#fee-recipients-and-your-distributor), вам в конечном итоге придется инициализировать его (создать экземпляр контракта в цепочке), чтобы получить вознаграждения от него на ваш адрес для вывода.

Это довольно дешевая операция, которую нужно выполнить только один раз.

::: tip СОВЕТ
Инициализация вашего распределителя комиссий может быть выполнена **в любое время**.
Вы можете позволить вознаграждениям накапливаться по его адресу задолго до его инициализации, и ваш баланс останется после инициализации.

Мы рекомендуем вам сделать это, когда цены на газ низкие, чтобы минимизировать накладные расходы.

Обратите внимание, что он **должен быть инициализирован, чтобы получить ваши вознаграждения.**
:::

### Присоединитесь к Smoothing Pool

Если вы планируете сразу воспользоваться преимуществами [Smoothing Pool](./whats-new#smoothing-pool), вам следует присоединиться до конца первого периода вознаграждений Redstone, чтобы максимизировать ваше количество "права на участие".

Присоединение можно выполнить, запустив следующую команду:

```
rocketpool node join-smoothing-pool
```

### Получите вознаграждения

Обновление Redstone заменяет дорогую, проблемную старую систему вознаграждений [совершенно новой](./whats-new#new-rewards-system), которая намного дешевле, поддерживает автоматический рестейкинг RPL (как частичные, так и полные суммы), и - что наиболее важно - **позволяет вам получать свои вознаграждения, когда захотите**.

Поскольку больше нет ограничения по времени на получение вознаграждений, и поскольку дешевле получать много интервалов вознаграждений сразу, функция автоматического получения вознаграждений Smartnode **была удалена**.
Теперь вы сможете получать вознаграждения с помощью следующей команды:

```
rocketpool node claim-rewards
```

Это покажет вам все вознаграждения, которые вы накопили за все интервалы вознаграждений, начиная с обновления Redstone.

## Возврат к v1.4.3

Если по какой-либо причине что-то вам не нравится, и вы хотите вернуться к предыдущему релизу Smartnode, вы можете легко это сделать.
Smartnode автоматически создает резервную копию ваших настроек из предыдущей версии при обновлении, поэтому просто получите предыдущую версию (здесь мы демонстрируем **v1.4.3**) и замените настройки резервной копией:

1. Остановите сервис:

```shell
rocketpool service stop
```

1. Загрузите CLI v1.4.3:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Установите пакет v1.4.3:

```shell
rocketpool service install -d
```

1. Замените вашу старую конфигурацию резервной конфигурацией v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Убедитесь, что все ваши старые настройки теперь используются:

```shell
rocketpool service config
```

1. Если все выглядит хорошо, запустите стек Smartnode:

```shell
rocketpool service start
```

Готово! Теперь вы вернулись к старой версии и должны начать аттестацию вскоре после запуска сервиса.

::: danger ПРЕДУПРЕЖДЕНИЕ
v1.4.3 **устарела** и больше не будет использоваться после развертывания обновления Redstone.
Если вам все же нужно вернуться к ней, пожалуйста, спланируйте обновление обратно до v1.5.0 до того, как контракты будут обновлены!
:::
