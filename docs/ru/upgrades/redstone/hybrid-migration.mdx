import { Tab, Tabs } from "@rspress/core/theme";

# [Гибридный режим] Руководство по обновлению Redstone и The Merge

Это руководство охватит все, что вам нужно знать для подготовки вашей ноды к обновлению Redstone и The Merge, если вы используете **гибридный режим**.

## Что нужно сделать перед обновлением до v1.5.0

Перед обновлением до v1.5.0 и выше Smartnode, пожалуйста, пройдите следующий контрольный список, чтобы убедиться, что вы готовы:

### Переключитесь на полный Execution Client

The Merge требует, чтобы вы запускали свой собственный Execution клиент, поэтому вы больше не сможете использовать удаленных провайдеров, таких как Infura или Pocket.

Из-за этого изменения, если вы в настоящее время используете легкий Execution клиент, вы должны переключиться на полный клиент, пока вы еще на v1.4, дать ему синхронизироваться до завершения, а затем обновиться до v1.5.

### Убедитесь, что EC и CC оба управляются внешне

Предыдущие версии стека Smartnode позволяли иметь один клиент, управляемый локально, и другой, управляемый внешне.
Например, вы могли иметь Execution клиент, который управляется Smartnode, и подключить его к Consensus клиенту, который вы управляете внешне.

Начиная с v1.5, эта конфигурация больше не поддерживается.
Вам придется переключиться либо на локально управляемый Execution и Consensus клиент (также известный как [режим Docker](./docker-migration.mdx)), либо настроить и Execution, и Consensus клиент, которыми вы управляете самостоятельно.

::: tip СОВЕТ
Если вы заинтересованы в том, чтобы позволить Smartnode поддерживать свой собственный Execution и Consensus клиент, но хотите сохранить контроль над своим собственным Validator клиентом (например, если у вас есть свои ключи валидатора для соло стейкинга, прикрепленные к нему), вы можете рассмотреть [обратный гибридный режим](../../node-staking/advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode), который делает именно это!
:::

### Настройте Engine API

The Merge изменяет способ общения вашего Execution клиента с вашим Consensus клиентом.
Вместо использования старой системы RPC на основе HTTP или Websocket, The Merge требует новую систему, предоставляемую вашим Execution клиентом, называемую Engine API.

Это специальное соединение, которое позволяет Consensus клиенту заменить старую систему майнинга Proof-of-Work на Proof-of-Stake; это сердце The Merge.
Оно также **аутентифицировано** секретным токеном, поэтому только ваш Consensus клиент может подключиться к вашему Execution клиенту - ничто больше не может.

Поскольку вы управляете своими собственными Execution и Consensus клиентами, вам нужно будет настроить Engine API вручную.
Как это сделать, полностью зависит от того, какие клиенты вы запускаете.

CoinCashew имеет [отличное и краткое руководство](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) о том, как настроить Engine API на ваших Execution и Consensus клиентах.
Посмотрите на это и протестируйте новую конфигурацию, убедившись, что она все еще правильно аттестует перед обновлением.

Как всегда, Rocket Pool будет управлять своим собственным Validator клиентом, поэтому вам не нужно беспокоиться о его ручном изменении.

## Обновление до v1.5.0

Обновление стека Smartnode до v1.5.0 ничем не отличается от любого другого обновления.
Просто следуйте [обычным инструкциям здесь](../../node-staking/updates#updating-the-smartnode-stack).

## Что Smartnode обрабатывает автоматически

В гибридном режиме Smartnode позаботится о некоторых изменениях, необходимых для поддержки Redstone, автоматически после обновления до v1.5.0, но вам нужно будет обработать другие вручную в гибридном режиме.

Вот краткий список того, что он сделает для вас без какого-либо ручного вмешательства:

### Ваш получатель комиссий

**Получатель комиссий** - это адрес на уровне Execution (eth1) цепи, который будет получать все приоритетные комиссии за блоки, которые вы предлагаете.
Это настройка, предоставляемая вашему Validator клиенту при первом запуске.

Smartnode будет обрабатывать настройку правильного адреса на Validator клиенте, которым он управляет, когда вы обновитесь до v1.5, и будет постоянно проверять, что вы используете правильный, чтобы вы случайно не получили [штраф](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system).

Если вы подписались на [Smoothing Pool](./whats-new#smoothing-pool), он сделает его вашим получателем комиссий.
Если нет, он сделает ваш [контракт дистрибьютора комиссий](./whats-new#fee-recipients-and-your-distributor) получателем комиссий.

## Что вам следует сделать после обновления

Хотя Smartnode обрабатывает большинство изменений за вас, есть несколько дополнительных вещей, которые вы должны сделать вручную:

### Убедитесь в успешном обновлении

Первое, что нужно сделать, это убедиться, что ваша нода работает правильно.
Рассмотрите возможность предпринять следующие шаги:

- Проверьте логи на наличие ошибок с помощью `rocketpool service logs validator` и `rocketpool service logs node`.
- Подтвердите с помощью Block Explorer (такого как ваша панель Grafana и [https://beaconcha.in](https://beaconcha.in)), что вы все еще правильно аттестуете
  - Помните, что если у вас включена защита от двойников, вы пропустите несколько аттестаций после перезапуска. Это нормально!

### Настройте MEV-Boost

[MEV-boost](https://boost.flashbots.net/) - это система, которую предоставляет Flashbots для предоставления наград MEV валидаторам Proof-of-Stake после The Merge.

**Rocket Pool требует, чтобы все ноды использовали ее для максимизации своей доходности и, таким образом, сохранения конкурентоспособности протокола с другими сервисами стейкинга.**

Вам нужно будет внести некоторые корректировки в ваш Beacon Node / Consensus клиент, чтобы подключить его к MEV-boost.

MEV-boost в настоящее время недоступен на Hoodi или Mainnet, поэтому вам не нужно настраивать его в это время.
Конечно, вы не будете оштрафованы за неиспользование в течение этого переходного периода.

Как только он станет доступен, мы объявим дату, к которой он должен быть установлен и подключен к вашей ноде.
Flashbots предоставит инструкции, которым вы сможете следовать в то время, и мы сделаем на них ссылку здесь.

::: danger ПРИМЕЧАНИЕ
После того, как мы сделаем объявление, что MEV-boost должен быть включен всеми операторами нод, вы должны убедиться, что он правильно установлен и настроен с вашим Beacon Node!

Неиспользование этого приведет к [штрафу](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) вашего minipool.
:::

### Настройте резервную ноду

Поскольку The Merge не совместим с удаленными провайдерами, такими как Infura и Pocket, вы потеряете возможность использовать их в качестве резервных Execution клиентов, когда ваш основной клиент выходит из сети.

Smartnode все еще имеет возможность предоставить резервный Execution клиент (и теперь также резервный Consensus клиент), но теперь вам нужно будет использовать Execution и Consensus клиенты, которыми вы управляете.

Для получения дополнительной информации о настройке резервной ноды см. [руководство по резервной ноде](../../node-staking/fallback).

### Инициализируйте свой дистрибьютор комиссий

Если вы не планируете подписываться на [Smoothing Pool](./whats-new#smoothing-pool) и заявлять все свои приоритетные комиссии и награды MEV в свой [контракт дистрибьютора комиссий](./whats-new#fee-recipients-and-your-distributor), вам в конечном итоге придется инициализировать его (создать экземпляр контракта в цепи), чтобы требовать награды от него на ваш адрес вывода.

Это довольно дешевая операция и должна быть выполнена только один раз.

::: tip СОВЕТ
Инициализация вашего дистрибьютора комиссий может быть выполнена **в любое время**.
Вы можете позволить наградам накапливаться на его адресе задолго до того, как вы его инициализируете, и ваш баланс останется после инициализации.

Мы рекомендуем вам сделать это, когда цены на газ низкие, чтобы минимизировать накладные расходы.

Обратите внимание, что он **должен быть инициализирован для того, чтобы требовать ваши награды.**
:::

### Подпишитесь на Smoothing Pool

Если вы планируете воспользоваться преимуществами [Smoothing Pool](./whats-new#smoothing-pool) сразу, вы должны подписаться до конца первого периода наград Redstone, чтобы максимизировать вашу сумму "приемлемости".

Подписка может быть выполнена с помощью следующей команды:

```shell
rocketpool node join-smoothing-pool
```

### Заявите награды

Обновление Redstone заменяет дорогую, проблематичную старую систему наград [совершенно новой](./whats-new#new-rewards-system), которая намного дешевле, поддерживает автоматическое пере-стейкание RPL (как частичных, так и полных сумм), и - что наиболее важно - **позволяет вам требовать ваши награды, когда хотите**.

Поскольку больше нет временных ограничений на требование наград, и поскольку дешевле требовать много интервалов наград одновременно, функция автоматического требования наград Smartnode **была удалена**.
Теперь вы сможете требовать награды с помощью следующей команды:

```shell
rocketpool node claim-rewards
```

Это покажет вам все награды, которые вы накопили по всем интервалам наград, начиная с обновления Redstone.

## Возврат к v1.4.3

Если по какой-либо причине что-то вам не нравится и вы хотите вернуться к предыдущему выпуску Smartnode, вы можете сделать это легко.
Smartnode автоматически создает резервную копию ваших настроек из предыдущей версии при обновлении, поэтому просто получите предыдущую версию (здесь мы демонстрируем **v1.4.3**) и замените настройки резервной копией:

1. Остановите сервис:

```shell
rocketpool service stop
```

1. Скачайте CLI v1.4.3:

<div className="p-3">
  <Tabs>
    <Tab label="Linux x64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Linux arm64">```shell wget https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool ```</Tab>
    <Tab label="Mac x64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool ```</Tab>
    <Tab label="Mac arm64">```shell curl -L https://github.com/rocket-pool/smartnode/releases/download/v1.4.3/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool ```</Tab>
  </Tabs>
</div>

1. Установите пакет v1.4.3:

```shell
rocketpool service install -d
```

1. Замените вашу старую конфигурацию на резервную конфигурацию v1.4.3:

```shell
cp ~/.rocketpool/user-settings-backup.yml ~/.rocketpool/user-settings.yml
```

1. Проверьте, что все ваши старые настройки теперь используются:

```shell
rocketpool service config
```

1. Если все выглядит хорошо, запустите стек Smartnode:

```shell
rocketpool service start
```

Все готово! Теперь вы вернулись к старой версии и должны начать аттестовать вскоре после запуска сервиса.

::: danger ПРЕДУПРЕЖДЕНИЕ
v1.4.3 **устарела** и больше не будет использоваться после развертывания обновления Redstone.
Если вам действительно нужно вернуться к ней, пожалуйста, запланируйте обновление обратно до v1.5.0 до обновления контрактов!
:::
