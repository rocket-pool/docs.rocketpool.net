import { Tab, Tabs } from "@rspress/core/theme";

# [Нативный режим] Руководство по обновлению Redstone и Слиянию

Это руководство охватывает все, что вам нужно знать для подготовки вашей ноды к обновлению Redstone и Слиянию, если вы используете **нативный режим**.

## Что нужно сделать перед обновлением до v1.5.0

Перед обновлением до v1.5.0 и выше Smartnode, пожалуйста, пройдите следующий контрольный список, чтобы убедиться, что вы готовы:

### Переключитесь на полный Execution-клиент

Слияние требует, чтобы вы запускали свой собственный Execution-клиент, поэтому вы больше не сможете использовать удаленные провайдеры, такие как Infura или Pocket.

Из-за этого изменения, если вы в настоящее время используете легкий Execution-клиент, вам следует переключиться на полный клиент, пока вы еще на v1.4, дождаться его полной синхронизации, а затем обновиться до v1.5.

### Настройте Engine API

Слияние меняет способ взаимодействия вашего Execution-клиента с вашим Consensus-клиентом.
Вместо использования старой системы RPC на основе HTTP или Websocket, Слияние требует новой системы, предоставляемой вашим Execution-клиентом, называемой Engine API.

Это специальное соединение, которое позволяет Consensus-клиенту заменить старую систему майнинга Proof-of-Work на Proof-of-Stake; это сердце Слияния.
Оно также **аутентифицировано** секретным токеном, поэтому только ваш Consensus-клиент может подключаться к вашему Execution-клиенту - больше ничто не может.

Поскольку вы управляете своими собственными Execution- и Consensus-клиентами, вам нужно будет настроить Engine API вручную.
Как это сделать, полностью зависит от того, какие клиенты вы используете.

CoinCashew имеет [отличное и краткое руководство](https://www.coincashew.com/coins/overview-eth/ethereum-merge-upgrade-checklist-for-home-stakers-and-validators) о том, как настроить Engine API на ваших Execution- и Consensus-клиентах.
Взгляните на это и протестируйте новую конфигурацию, убедившись, что она по-прежнему аттестует правильно перед обновлением.

Мы покажем вам, как настроить ваш Validator-клиент так, чтобы он использовал правильного получателя комиссий, требуемого программным обеспечением Smartnode, автоматически ниже.

## Обновление до v1.5.0

Обновление стека Smartnode до v1.5.0 ничем не отличается от любого другого обновления.
Просто следуйте [обычным инструкциям здесь](../../node-staking/updates#updating-the-smartnode-stack).

## Что вам следует сделать после обновления

В нативном режиме есть несколько вещей, которые вам нужно будет сделать вручную после обновления:

### Убедитесь в успешном обновлении

Первое, что нужно сделать, это убедиться, что ваша нода работает правильно.
Рассмотрите следующие шаги:

- Проверьте ваши скрипты логов для Execution-клиента, Consensus-клиента, Validator-клиента и демона Smartnode (сервис `rp-node`), чтобы убедиться, что все они функционируют нормально без ошибок.
- Подтвердите с помощью Block Explorer (такого как ваша панель Grafana и [https://beaconcha.in](https://beaconcha.in)), что вы все еще аттестуете правильно
  - Помните, что если у вас включена защита Doppelganger, вы пропустите несколько аттестаций после перезапуска. Это нормально!

### Настройте получателя комиссий в вашем Validator-клиенте

Одной из **критических** деталей для настройки перед Слиянием является **получатель комиссий**, указанный вашим validator-клиентом.
Как описано в [обзорной статье](./whats-new#fee-recipients-and-your-distributor), это может быть одно из двух значений:

- Если вы **присоединились** к Smoothing Pool, это должен быть адрес **контракта Smoothing Pool**. Вы можете получить адрес со [страницы официальных контрактов](/ru/protocol/contracts-integrations).
- Если вы **не** в Smoothing Pool, это должен быть адрес **контракта распределителя комиссий** вашей ноды. Вы можете получить адрес, запустив `rocketpool node status`, в разделе `Fee Distributor and Smoothing Pool`.

В нативном режиме у вас есть выбор: позволить Smartnode управлять этим за вас, если вы используете сервис демона Smartnode, `rp-node`, или управлять им самостоятельно, если вы не используете демон.

#### Автоматическое управление через демон

Демон Smartnode автоматически определит подходящего получателя комиссий для вашей ноды и будет управлять им в случае изменения (например, присоединение и выход из Smoothing Pool).
Это **самый безопасный** вариант, потому что Smartnode всегда будет гарантировать, что он установлен на значение, которое **предотвращает [штрафы](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system)**.

Способ, которым он это делает, заключается в поддержании файла с правильным получателем комиссий в нем и регулярном обновлении его для обеспечения его корректности.
Когда его нужно обновить, он изменяет файл и автоматически перезапускает ваш Validator-клиент, чтобы он загрузил нового получателя - аналогично тому, как он перезапускает ваш Validator-клиент после стейкинга нового minipool.

Выберите ваш клиент ниже, чтобы узнать, как его настроить:

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Измените ваш сервис Validator Client, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>
    <Tab label="Nimbus">
      Измените ваш сервис Validator Client, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --suggested-fee-recipient=${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>
    <Tab label="Prysm">
      Измените ваш сервис Validator Client, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --suggested-fee-recipient ${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>
    <Tab label="Teku">
      Измените ваш сервис Validator Client, добавив следующую строку _перед_ строкой `ExecStart`:

      ```
      EnvironmentFile=`data dir`/validators/rp-fee-recipient-env.txt
      ```

      Например:

      ```
      EnvironmentFile=/srv/rocketpool/data/validators/rp-fee-recipient-env.txt
      ```

      Затем добавьте следующий аргумент командной строки _в конец_ вашей строки `ExecStart`:

      ```
      --validators-proposer-default-fee-recipient=${FEE_RECIPIENT}
      ```

      Ваш VC теперь будет использовать файл, управляемый демоном Smartnode, и будет автоматически перезапускаться при изменении получателя комиссий.
    </Tab>

  </Tabs>
</div>

#### Ручное управление получателем комиссий

::: danger ПРЕДУПРЕЖДЕНИЕ
Делая это, вы берете на себя полную ответственность за обеспечение того, чтобы ваш получатель комиссий всегда был установлен на правильный адрес.

Пожалуйста, прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять, на что он должен быть установлен с учетом вашей конфигурации, и когда вы можете безопасно изменить его с одного значения на другое.

Несоблюдение этого может привести к штрафам для ваших minipools!
:::

**До развертывания Redstone** вы можете просто использовать адрес rETH для сети, в которой вы находитесь (который можно найти на [странице официальных контрактов](/ru/protocol/contracts-integrations)).
Адрес rETH всегда безопасен, независимо от обстоятельств.

**После развертывания Redstone** вы можете увидеть точный адрес, который вы должны установить в качестве получателя комиссий, с помощью `rocketpool node status`. Например, если вы присоединились к Smoothing Pool, он покажет адрес Smoothing Pool и отметит, что вы должны использовать его в качестве получателя комиссий:

<img src="../../node-staking/images/native-fee-rc-in.png" width="100%" height="auto" />

Если вы _не_ присоединились к Smoothing Pool, он покажет адрес вашего распределителя комиссий и отметит, что вы должны использовать его в качестве получателя комиссий:

<img src="../../node-staking/images/native-fee-rc-out.png" width="100%" height="auto" />

Выберите ваш Consensus-клиент ниже, чтобы узнать, как его настроить.

<div className="p-3">
  <Tabs>
    <Tab label="Lighthouse">
      Добавьте следующий аргумент командной строки в файл определения сервиса вашего Validator Client:

      ```
      --suggested-fee-recipient `address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - Ваш **распределитель комиссий** ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы присоединились к Smoothing Pool

      В качестве напоминания, `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания в отношении получателя комиссий.**
    </Tab>
    <Tab label="Nimbus">
      Добавьте следующий аргумент командной строки в файл определения сервиса Nimbus:

      ```
      --suggested-fee-recipient=`address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - Ваш **распределитель комиссий** ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы присоединились к Smoothing Pool

      В качестве напоминания, `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания в отношении получателя комиссий.**
    </Tab>
    <Tab label="Prysm">
      Добавьте следующий аргумент командной строки в файл определения сервиса вашего Validator Client:

      ```
      --suggested-fee-recipient `address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - Ваш **распределитель комиссий** ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы присоединились к Smoothing Pool

      В качестве напоминания, `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания в отношении получателя комиссий.**
    </Tab>
    <Tab label="Teku">
      Добавьте следующий аргумент командной строки в файл определения сервиса вашего Validator Client:

      ```
      --validators-proposer-default-fee-recipient=`address`
      ```

      Где `address` это:

      - [Адрес rETH](/ru/protocol/contracts-integrations/#token-contracts) **до** развертывания обновления Redstone (например, `0xae78736Cd615f374D3085123A210448E74Fc6393` на Mainnet)
      - Ваш **распределитель комиссий** ноды после развертывания Redstone, который вы можете получить с помощью `rocketpool node status` после обновления контракта
      - [Адрес Smoothing Pool](/ru/protocol/contracts-integrations/#protocol-contracts), если вы присоединились к Smoothing Pool

      В качестве напоминания, `rocketpool node status` покажет вам правильного получателя комиссий для использования в любое время.

      **Пожалуйста, внимательно прочитайте [спецификацию штрафов](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system), чтобы понять условия и ожидания в отношении получателя комиссий.**
    </Tab>

  </Tabs>
</div>

### Настройте MEV-Boost

[MEV-boost](https://boost.flashbots.net/) - это система, которую предоставляет Flashbots для передачи MEV-вознаграждений валидаторам Proof-of-Stake после Слияния.

**Rocket Pool требует, чтобы все ноды использовали его для максимизации своей прибыли и, таким образом, поддержания конкурентоспособности протокола с другими сервисами стейкинга.**

Вам нужно будет внести некоторые изменения в ваш Beacon Node / Consensus-клиент, чтобы подключить его к MEV-boost.

MEV-boost в настоящее время недоступен в Hoodi или Mainnet, поэтому вам не нужно настраивать его в данный момент.
Конечно, вы не будете оштрафованы за его неиспользование в течение этого переходного периода.

Как только он станет доступен, мы объявим дату, к которой он должен быть установлен и подключен к вашей ноде.
Flashbots предоставит инструкции, которым вы сможете следовать в то время, и мы дадим на них ссылку здесь.

::: danger ПРИМЕЧАНИЕ
После того, как мы объявим, что MEV-boost должен быть включен всеми операторами нод, вы должны убедиться, что он правильно установлен и настроен с вашим Beacon Node!

Невыполнение этого приведет к [штрафу](https://github.com/rocket-pool/rocketpool-research/blob/master/Penalties/penalty-system) для вашего minipool.
:::

### Настройте резервную ноду

Поскольку Слияние несовместимо с удаленными провайдерами, такими как Infura и Pocket, вы потеряете возможность использовать их в качестве резервных Execution-клиентов, когда ваш основной отключается.

Smartnode по-прежнему имеет возможность предоставить резервный Execution-клиент (и теперь также резервный Consensus-клиент), но теперь вам нужно будет использовать Execution- и Consensus-клиенты, которые вы контролируете.

Для получения дополнительной информации о настройке резервной ноды см. [руководство по резервной ноде](../../node-staking/fallback).

### Инициализируйте ваш распределитель комиссий

Если вы не планируете присоединяться к [Smoothing Pool](./whats-new#smoothing-pool) и требовать все свои приоритетные комиссии и MEV-вознаграждения в ваш [контракт распределителя комиссий](./whats-new#fee-recipients-and-your-distributor), вам в конечном итоге придется инициализировать его (создать экземпляр контракта в цепочке), чтобы получить вознаграждения от него на ваш адрес для вывода.

Это довольно дешевая операция, которую нужно выполнить только один раз.

::: tip СОВЕТ
Инициализация вашего распределителя комиссий может быть выполнена **в любое время**.
Вы можете позволить вознаграждениям накапливаться по его адресу задолго до его инициализации, и ваш баланс останется после инициализации.

Мы рекомендуем вам сделать это, когда цены на газ низкие, чтобы минимизировать накладные расходы.

Обратите внимание, что он **должен быть инициализирован, чтобы получить ваши вознаграждения.**
:::

### Присоединитесь к Smoothing Pool

Если вы планируете сразу воспользоваться преимуществами [Smoothing Pool](./whats-new#smoothing-pool), вам следует присоединиться до конца первого периода вознаграждений Redstone, чтобы максимизировать ваше количество "права на участие".

Присоединение можно выполнить, запустив следующую команду:

```shell
rocketpool node join-smoothing-pool
```

### Получите вознаграждения

Обновление Redstone заменяет дорогую, проблемную старую систему вознаграждений [совершенно новой](./whats-new#new-rewards-system), которая намного дешевле, поддерживает автоматический рестейкинг RPL (как частичные, так и полные суммы), и - что наиболее важно - **позволяет вам получать свои вознаграждения, когда захотите**.

Поскольку больше нет ограничения по времени на получение вознаграждений, и поскольку дешевле получать много интервалов вознаграждений сразу, функция автоматического получения вознаграждений Smartnode **была удалена**.
Теперь вы сможете получать вознаграждения с помощью следующей команды:

```shell
rocketpool node claim-rewards
```

Это покажет вам все вознаграждения, которые вы накопили за все интервалы вознаграждений, начиная с обновления Redstone.
