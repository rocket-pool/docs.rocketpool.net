import { Tab, Tabs } from "@rspress/core/theme";

# Mise à Niveau vers Smartnode v1.3.x

La version 1.3.0 de la pile Smartnode apporte des changements importants dont les utilisateurs doivent être conscients.
Ils sont conçus pour améliorer significativement votre expérience d'opérateur de nœud et répondre à de nombreuses fonctionnalités que nos utilisateurs ont demandées depuis le lancement de Rocket Pool.

Dans ce guide, nous vous guiderons à travers le processus de migration d'une ancienne version du Smartnode vers la v1.3.x et au-delà.

## Modifications du Fichier de Configuration

La v1.3.0 introduit des changements significatifs dans la façon dont la configuration du Smartnode est gérée.
Si vous avez modifié manuellement la configuration du Smartnode auparavant, vous devez être conscient des changements suivants :

- Le fichier `config.yml` a été supprimé. Toutes ses informations sont maintenant intégrées directement dans la pile Smartnode, afin que les utilisateurs ne puissent plus modifier accidentellement le fichier d'une manière qui empêchait le Smartnode de fonctionner correctement.
  - Tous les paramètres configurables par l'utilisateur qui en faisaient auparavant partie sont maintenant des paramètres dans la nouvelle interface utilisateur Terminal `service config`.

- Le fichier `settings.yml` a été remplacé par un nouveau fichier appelé `user-settings.yml`. Il contient tous vos paramètres pour chaque partie configurable du Smartnode.
  - Ce fichier **n'est pas destiné à être modifié directement**. La modification doit être effectuée via la nouvelle interface utilisateur Terminal `service config` à la place.

- Le dossier `chains` a été supprimé. Les scripts de lancement du client d'exécution (ETH1), du nœud Beacon et du client validateur résident maintenant dans le dossier `scripts`.

- Les fichiers YAML `docker-compose` ont été supprimés. Chaque conteneur obtient maintenant son propre fichier dans le dossier `templates`. Lors du `rocketpool service start`, ces modèles sont remplis avec vos paramètres et placés automatiquement dans le dossier `runtime`.
  - La modification des modèles ou des fichiers runtime n'est pas recommandée. Au lieu de cela, remplissez vos personnalisations de conteneur en utilisant les fichiers de **remplacement** pour chaque conteneur dans le dossier `override`. Ces fichiers remplaceront les fichiers Docker dans `runtime`, vous êtes donc libre de les personnaliser comme bon vous semble.
  - Les fichiers dans `override` **persisteront lors des mises à niveau et réinstallations du Smartnode**, vous n'avez donc besoin de les créer qu'une seule fois.
  - Si vous souhaitez modifier les fichiers `docker-compose` via ce mécanisme de remplacement, veuillez consulter [cette section](../node-staking/advanced-config#customizing-the-docker-compose-definition-files)

## Installation de la Nouvelle Version

L'installation de la nouvelle version devrait vous sembler très familière.

Commencez par arrêter les services et télécharger le nouveau CLI comme d'habitude :

<div className="p-3">
  <Tabs>
    <Tab label="Mode Docker ou Hybride">
      Arrêtez les services Rocket Pool :

      ```
      rocketpool service stop
      ```

      Téléchargez le nouveau CLI Smartnode pour votre système (choisissez parmi les onglets ci-dessous) :

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Pour les systèmes `x64` (la plupart des machines normales) :

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Pour les systèmes `arm64` :

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Pour les systèmes `x64` (la plupart des Macs) :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Pour les systèmes `arm64`, tels que le Mac mini avec M1 :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Maintenant, exécutez la commande d'installation :

      ```
      rocketpool service install -d
      ```

      Le flag `-d` lui indique d'ignorer les dépendances système comme Docker, puisque vous les avez déjà.

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">REMARQUE</p>
        À partir de la v1.3.0, vous **n'avez plus besoin de spécifier le réseau pour lequel vous souhaitez installer !**
        Le nouveau Smartnode saura quel réseau vous utilisez déjà, et il vous permettra de changer votre réseau dynamiquement en utilisant la nouvelle interface utilisateur Terminal.
      </p>
    </Tab>
    <Tab label="Mode Natif">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">REMARQUE</p>
        Cela ne mettra à jour que la pile Smartnode elle-même - cela **ne mettra pas à jour** vos clients d'exécution et de consensus.
        Vous devrez le faire manuellement (consultez [le guide de mise à jour manuelle](../node-staking/updates#manually-updating-the-eth1-or-eth2-client) pour apprendre comment le faire).
      </p>

      Arrêtez les services Rocket Pool :

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Téléchargez les nouveaux binaires CLI et daemon Smartnode :

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Pour les systèmes `x64` (la plupart des machines normales) :

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Pour les systèmes `arm64` :

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Pour les systèmes `x64` (la plupart des Macs) :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Pour les systèmes `arm64`, tels que le Mac mini avec M1 :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/latest/download/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>

      <p className="rspress-directive tip">
        <p className="rspress-directive-title">REMARQUE</p>
        À partir de la v1.3.0, `config.yml` a été supprimé.
        **Vous n'avez plus besoin de télécharger le package d'installation et de l'extraire.**
      </p>
      Ensuite, créez un dossier de sauvegarde appelé `old_config_backup` dans votre répertoire Smartnode et déplacez-y vos anciens fichiers de configuration (`config.yml` et `settings.yml`).
      Le Smartnode les utilisera pour migrer vos paramètres vers le nouveau système.

      Par exemple, si vous avez suivi le guide de configuration Native et que votre répertoire Smartnode est `/srv/rocketpool` :

      ```shell
      cd /srv/rocketpool
      mkdir old_config_backup
      mv config.yml old_config_backup
      mv settings.yml old_config_backup
      ```

      Maintenant, modifiez les fichiers de définition de service pour `rp-node` :

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Remplacez la ligne `ExecStart` par ce qui suit :

      ```
      ExecStart=/home/ubuntu20/bin/rocketpoold --settings /srv/rocketpool/user-settings.yml node
      ```

      Notez que le flag `--config` a été supprimé, et `--settings` pointe maintenant vers `user-settings.yml`.
      **Ne vous inquiétez pas si ce fichier n'existe pas encore ; il sera généré automatiquement à l'étape suivante.**

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">REMARQUE</p>
        Si vous êtes membre de l'Oracle DAO, vous _devez_ répéter le processus ci-dessus pour le service `rp-watchtower` également.
      </p>

      Enfin, rechargez les définitions de service :

      ```shell
      sudo systemctl daemon-reload
      ```
    </Tab>

  </Tabs>
</div>

Après l'installation, tous vos anciens fichiers de configuration seront déplacés dans un dossier nommé `old_config_backup` dans votre répertoire Smartnode (par défaut `~/.rocketpool/old_config_backup`).
Vous pouvez les trouver là si vous avez besoin de vous y référer pour une raison quelconque.

**Si vous recherchez des instructions pour revenir à la v1.2.4 à partir de cette sauvegarde, veuillez faire défiler jusqu'à la section [Retour à Votre Configuration Précédente](#retour-à-votre-configuration-précédente) à la fin de cette page.**

## Configuration du Smartnode avec l'Interface Utilisateur Terminal

Maintenant que vous avez le nouveau CLI et le package installé, tous vos paramètres précédents ont été préservés et migrés vers le nouveau système.
À l'étape suivante, vous devez exécuter `rocketpool service config`.
Cela aura l'air très différent par rapport aux versions précédentes de cette fonction ; la v1.3.0 introduit l'**Interface Utilisateur Terminal** : une interface utilisateur dynamique basée sur le terminal pour configurer votre Smartnode.

Vous devez l'exécuter avant de démarrer les conteneurs Docker après le processus de migration pour visualiser la configuration, vérifier que tous vos changements ont été migrés avec succès, et mettre à jour tous les autres paramètres que vous souhaitez.

Lorsque vous l'exécutez pour la première fois, vous serez invité avec cet écran d'accueil (si vous utilisiez le **mode Docker ou Hybride**) :

<img src="../node-staking/images/tui-migrate.png" width="100%" height="auto" />

:::tip REMARQUE
Les utilisateurs du **Mode Natif** verront cet écran avec une formulation légèrement différente, qui indique que le Smartnode fonctionne en mode Natif.
:::

L'interface utilisateur Terminal commencera avec **l'Assistant**, qui vous permet de modifier rapidement et facilement les paramètres les plus importants du Smartnode (tels que le mode et la sélection du client).

**Tous vos paramètres précédents devraient déjà être mis en surbrillance lorsque vous parcourez chaque page de l'assistant afin que vous n'ayez pas à vous rappeler quelle était votre configuration précédente de mémoire.**

:::warning REMARQUE
**Pour une procédure détaillée de cet Assistant, veuillez visiter les pages suivantes :**

- Pour le **Mode Docker**, veuillez visiter [le nouveau guide de configuration Docker](../node-staking/config-docker).

- Utilisateurs du **Mode Hybride** : Le mode Hybride est maintenant une **fonctionnalité de première classe** du Smartnode et sa configuration est _beaucoup plus facile_ qu'auparavant. Veuillez visiter [le nouveau guide de configuration Docker](../node-staking/config-docker) et le suivre. Lorsqu'on vous demande de choisir un mode de client d'exécution et un mode de client de consensus, choisissez **Géré Externement** pour eux en conséquence.

- Pour le **Mode Natif**, veuillez visiter [le nouveau guide de configuration Native](../node-staking/config-native).

:::

Parcourez cet assistant et confirmez que tous vos paramètres sont corrects.

Une fois que vous avez terminé, vous aurez la possibilité de **revoir tous les paramètres avant de les sauvegarder** si vous le souhaitez.
Cela inclut les paramètres que l'Assistant n'a pas couverts, tels que le **seuil de gaz de réclamation RPL** ou votre **nombre maximum de pairs Geth** par exemple.

L'**écran des paramètres principaux**, que vous devriez également consulter pour confirmer vos paramètres précédents, ressemblera à ceci (pour les utilisateurs des modes Docker et Hybride) :

<img src="../node-staking/images/tui-settings-home.png" width="100%" height="auto" />

:::tip REMARQUE
Les utilisateurs du **Mode Natif** verront un écran légèrement différent qui est unique au mode Natif et ne présente que les paramètres qui lui sont pertinents.
:::

N'hésitez pas à explorer cette nouvelle interface utilisateur et à ajuster les paramètres que vous jugez appropriés.
Utilisez les `Touches Fléchées` pour naviguer, et appuyez sur `Entrée` pour entrer dans une catégorie ou confirmer les modifications apportées à un paramètre.

Appuyez sur `Échap` lorsque vous avez fini d'éditer une catégorie pour revenir à cet écran d'accueil.

Lorsque vous êtes prêt à sauvegarder vos modifications et à démarrer la pile Smartnode, appuyez simplement sur `Tab` pour descendre vers les boutons en bas de l'écran, sélectionnez `Review Changes and Save` (en le rendant vert via les touches fléchées).
Appuyez sur `Entrée` pour être amené à la **Page de Révision**, où vous pouvez voir tout ce que vous avez changé depuis la dernière fois que vous avez exécuté `rocketpool service config`.

Confirmez que tous vos changements sont présents, puis appuyez à nouveau sur `Entrée` pour les sauvegarder.
L'écran vous montrera quels conteneurs doivent être redémarrés pour que les modifications s'appliquent, bien que puisque vous migrez, vous avez déjà éteint les conteneurs et ils seront tous redémarrés de toute façon.

## Démarrage de la Pile Smartnode

Une fois que vous avez sauvegardé votre configuration, le terminal vous demandera si vous souhaitez redémarrer les conteneurs automatiquement (sauf si vous utilisez le mode Natif).
Si vous ne pouvez pas ou ne voulez pas les autoriser à démarrer automatiquement, vous pouvez les démarrer manuellement avec les commandes suivantes :

<div className="p-3">
  <Tabs>
    <Tab label="Mode Docker ou Hybride">```shell rocketpool service start ```</Tab>
    <Tab label="Mode Natif">```shell sudo systemctl start rp-node rp-watchtower ```</Tab>
  </Tabs>
</div>

Une fois qu'ils sont en marche, vous pouvez vérifier que tout fonctionne comme prévu.

Utilisez la commande `rocketpool service version` pour vérifier que vous avez la version correcte du Smartnode et des conteneurs clients :

```
$ rocketpool service version

Your Smartnode is currently using the Hoodi Test Network.

Rocket Pool client version: 1.3.0-rc1
Rocket Pool service version: 1.3.0-rc1
Selected Eth 1.0 client: Geth (Locally managed)
	Image: ethereum/client-go:v1.10.16
Selected Eth 2.0 client: Nimbus (Locally managed)
	Image: statusim/nimbus-eth2:multiarch-v22.3.0
```

Utilisez les commandes `rocketpool service logs eth1` et `rocketpool service logs eth2` pour surveiller les journaux de votre client d'exécution (anciennement client ETH1) et de votre client de consensus (anciennement client ETH2).
Recherchez les erreurs et [veuillez visiter notre serveur Discord pour obtenir de l'aide](https://discord.com/invite/rocketpool) si vous en rencontrez.

## Retour à Votre Configuration Précédente

Si, pour une raison quelconque, vous devez revenir à la v1.2.4 de la pile Smartnode, ne vous inquiétez pas !
Tous vos anciens fichiers de configuration ont été préservés dans un répertoire de sauvegarde et peuvent facilement être récupérés pour restaurer votre configuration précédente.

Sélectionnez le mode que vous utilisez dans les onglets ci-dessous et suivez les instructions.

<div className="p-3">
  <Tabs>
    <Tab label="Mode Docker ou Hybride">
      Commencez par remplacer le CLI par le CLI v1.2.4 pour votre système :
      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Pour les systèmes `x64` (la plupart des machines normales) :

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="Linux arm64">
            Pour les systèmes `arm64` :

            ```shell
            wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS x64">
            Pour les systèmes `x64` (la plupart des Macs) :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool
            ```
          </Tab>
          <Tab label="macOS arm64">
            Pour les systèmes `arm64`, tels que le Mac mini avec M1 :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool
            ```
          </Tab>
        </Tabs>
      </div>

      Ensuite, copiez tous vos anciens fichiers de configuration du dossier `old_config_backup` dans le dossier du Smartnode :

      ```shell
      cd ~/.rocketpool
      cp -r old_config_backup/*
      ```

      Maintenant, tout ce que vous avez à faire est de redémarrer les conteneurs Docker :

      ```shell
      rocketpool service start
      ```

      Terminé ! Votre ancienne configuration est de retour.

    </Tab>
    <Tab label="Mode Natif">
      Arrêtez les services Rocket Pool :

      <div className="p-3">
        <Tabs>
          <Tab label="Linux x64">
            Pour les systèmes `x64` (la plupart des machines normales) :

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="Linux arm64">
            Pour les systèmes `arm64` :

            ```shell
            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

            sudo wget https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS x64">
            Pour les systèmes `x64` (la plupart des Macs) :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-amd64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-amd64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
          <Tab label="macOS arm64">
            Pour les systèmes `arm64`, tels que le Mac mini avec M1 :

            ```shell
            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-cli-darwin-arm64 > /usr/local/bin/rocketpool

            curl -L https://github.com/rocket-pool/smartnode-install/releases/download/v1.2.4/rocketpool-daemon-darwin-arm64 > /usr/local/bin/rocketpoold
            ```
          </Tab>
        </Tabs>
      </div>
      Copiez les anciens fichiers de paramètres dans votre répertoire Smartnode :

      ```shell
      cd /srv/rocketpool
      cp old_config_backup *
      ```

      Maintenant, rétablissez les fichiers de définition de service pour `rp-node` :

      ```shell
      sudo nano /etc/systemd/system/rp-node.service
      ```

      Remplacez la ligne `ExecStart` par ce qui suit :

      ```
      ExecStart=/usr/local/bin/rocketpoold --config /srv/rocketpool/config.yml --settings /srv/rocketpool/settings.yml node
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">REMARQUE</p>
        Si vous êtes membre de l'Oracle DAO, vous _devez_ répéter le processus ci-dessus pour le service `rp-watchtower` également.
      </p>

      Enfin, rechargez les définitions de service et redémarrez les services :

      ```shell
      sudo systemctl daemon-reload

      sudo systemctl start rp-node rp-watchtower
      ```

      Terminé ! Votre ancienne configuration est de retour.
    </Tab>

  </Tabs>
</div>
