import { Tab, Tabs } from "@rspress/core/theme";
import tuiEcContainerTag from "./images/tui-ec-container-tag.png";
import tuiCcContainerTag from "./images/tui-cc-container-tag.png";

# Vérification des mises à jour

L'une des responsabilités d'un opérateur de nœud est de s'assurer que votre système est à jour avec les derniers correctifs de sécurité.
Les mises à jour automatiques sont pratiques mais peuvent interférer avec le fonctionnement de votre nœud, il peut donc être préférable de les exécuter manuellement.
Dans tous les cas, **vous devez vous assurer que votre machine est régulièrement corrigée !**

::: tip NOTE
La plupart du temps, la mise à jour ne nécessitera pas que votre système soit hors ligne pendant plus de quelques minutes.
Vous pourriez craindre qu'un tel temps d'arrêt affecte négativement votre solde sur la Beacon Chain.
Soyez rassuré, la pénalité pour être hors ligne pendant une si courte période est **complètement négligeable**.

Chaque attestation que vous manquez vous pénalisera d'un peu moins que le montant que vous auriez gagné avec une attestation réussie.
En règle générale, si vous êtes hors ligne pendant une heure, vous récupérerez tout après avoir été en ligne pendant une heure de plus.

Notez également qu'il n'y a **absolument aucune chance** que vous soyez _slashé_ en étant hors ligne pendant une courte période.
Le slashing ne se produit que si vous attaquez le réseau, et être hors ligne pour maintenance ne compte pas comme une attaque du réseau.

**Veuillez garder vos systèmes à jour - ne vous inquiétez pas des pénalités de temps d'arrêt !**
:::

## Mise à jour de votre système d'exploitation

Vous devriez fréquemment vérifier le gestionnaire de packages ou le service de mise à jour de votre système d'exploitation pour vous assurer d'appliquer rapidement tout nouveau correctif de sécurité important.
Les instructions exactes varient pour chaque système d'exploitation et peuvent être trouvées dans la documentation de votre système, mais voici quelques exemples.

<div className="p-3">
  <Tabs>
    <Tab label="Ubuntu">
      Dans un terminal, tapez ce qui suit :

      ```shell
      sudo apt update
      ```

      Cela accédera aux serveurs de packages et vérifiera si l'un de vos packages installés a de nouvelles versions disponibles.
      Si des mises à jour sont disponibles, la sortie ressemblera à ceci :

      ```
      Fetched 3974 kB in 2s (1641 kB/s)
      Reading package lists... Done
      Building dependency tree
      Reading state information... Done
      12 packages can be upgraded. Run 'apt list --upgradable' to see them.
      ```

      Vous pouvez installer les mises à jour avec la commande suivante :

      ```shell
      sudo apt dist-upgrade
      ```

      Cela vous montrera la liste des packages sur le point d'être mis à jour, et si la taille totale d'installation est suffisamment grande, cela vous montrera la taille et vous demandera de confirmer que vous acceptez :

      ```
      12 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
      Need to get 51.3 MB of archives.
      After this operation, 52.2 kB of additional disk space will be used.
      Do you want to continue? [Y/n]
      ```

      Assurez-vous d'avoir suffisamment d'espace disponible pour cela, puis appuyez sur `y` et `Entrée` pour commencer le processus de mise à jour.

      Une fois que la barre de progression est terminée et que vous êtes revenu à l'invite du terminal, exécutez la commande suivante pour nettoyer les anciennes versions des packages qui viennent d'être remplacés :

      ```shell
      sudo apt autoremove
      ```

      Ensuite, vérifiez si votre système doit être redémarré :

      ```shell
      cat /var/run/reboot-required
      ```

      Si la commande ci-dessus affiche `No such file or directory`, alors le redémarrage n'est pas nécessaire et vous pouvez ignorer l'étape ci-dessous.

      Cependant, si la commande affiche `*** System restart required ***`, alors vous devriez redémarrer votre machine pour terminer l'application des mises à jour lorsque vous le pouvez :

      ```shell
      sudo reboot
      ```

      Rocket Pool s'arrêtera gracieusement et redémarrera automatiquement avec le système une fois qu'il aura redémarré.
    </Tab>
    <Tab label="MacOS">
      Pour mettre à jour les packages du système d'exploitation, utilisez l'interface utilisateur pour sélectionner `Apple -> Mise à jour logicielle`.

      Pour mettre à jour les packages eux-mêmes, le moyen le plus simple est via `homebrew` dans le terminal :

      ```shell
      brew update && brew upgrade
      ```
    </Tab>

  </Tabs>
</div>

## Mise à jour de la pile Smartnode

Occasionnellement, Rocket Pool publiera une nouvelle version de la pile Smartnode.
Les mises à jour peuvent contenir de nouvelles versions de la CLI ou des conteneurs Docker Rocket Pool, ainsi que de nouvelles versions des clients d'exécution et de consensus.

Le moyen le plus cohérent de se tenir informé des nouvelles versions est de s'abonner au serveur Discord de Rocket Pool ; elles seront toujours publiées dans le canal Releases et vous recevrez une notification.

::: warning NOTE
Notez que l'exécution de `apt update` ne mettra pas à jour le logiciel du nœud.
Cela doit être fait manuellement en utilisant les étapes ci-dessous.
:::

::: tip ASTUCE
Lorsque vous avez terminé la mise à niveau du Smartnode, le tableau de bord Grafana indiquera toujours qu'une mise à jour est disponible.
Il se mettra automatiquement à jour dans un délai d'un jour lorsque le système vérifiera automatiquement les mises à jour.

Si vous souhaitez l'effacer immédiatement après la mise à jour, exécutez simplement :
`sudo apt update`
:::

::: tip ASTUCE
Si vous ne connaissez pas l'architecture de votre CPU, vous pouvez exécuter la commande suivante pour la trouver :

```shell
uname -m
```

La sortie de cette commande affichera votre architecture.
**Notez que `x86_64` est la même chose que `x64` et `amd64`.**
**Notez que `aarch64` est la même chose que `arm64`.**
:::

Les étapes de mise à niveau dépendent du mode utilisé par votre nœud. Sélectionnez parmi les options ci-dessous :

<div className="p-3">
  <Tabs>
    <Tab label="Linux (Mode Docker ou Hybride)">
      Arrêtez les services Rocket Pool :

      ```shell
      rocketpool service stop
      ```

      Téléchargez la nouvelle CLI Smartnode :

      Pour les systèmes `x64` (la plupart des machines normales) :

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O ~/bin/rocketpool
      ```

      Pour les systèmes `arm64` :

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O ~/bin/rocketpool
      ```

      Maintenant, exécutez la commande d'installation :

      ```shell
      rocketpool service install -d
      ```

      Le drapeau `-d` lui indique d'ignorer les dépendances système comme Docker, puisque vous les avez déjà.

      Si vous souhaitez voir ce qui a changé, ouvrez le gestionnaire de paramètres - la page de révision vous montrera les nouveautés :

      ```shell
      rocketpool service config
      ```

      Lorsque vous avez terminé, redémarrez Rocket Pool :

      ```shell
      rocketpool service start
      ```

      Enfin, vérifiez la version pour vous assurer que la CLI et la pile Smartnode sont toutes les deux à jour :

      ```shell
      rocketpool service version
      ```

      La sortie devrait ressembler à ceci :

      ```
      Your Smartnode is currently using the Hoodi Test Network.

      Rocket Pool client version: 1.5.0
      Rocket Pool service version: 1.5.0
      Selected Eth 1.0 client: Geth (Locally managed)
      Image: ethereum/client-go:v1.10.21
      Selected Eth 2.0 client: Lighthouse (Locally managed)
      Image: rocketpool/lighthouse:mevboost-5ee3bc5
      ```

      Le client et le service doivent tous deux correspondre à la nouvelle version de publication.
    </Tab>
    <Tab label="Linux (Mode natif)">
      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        Cela ne mettra à jour que la pile Smartnode elle-même - cela **ne mettra pas** à jour vos clients d'exécution ou de consensus.
        Vous devrez le faire manuellement (voir la section suivante ci-dessous).
      </p>

      Arrêtez les services Rocket Pool :

      ```shell
      sudo systemctl stop rp-node rp-watchtower
      ```

      Téléchargez la nouvelle CLI Smartnode et sauvegardez les anciens binaires CLI et daemon au cas où vous auriez besoin de les rétablir :

      Pour les systèmes `x64` (la plupart des machines normales) :

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-amd64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-amd64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Pour les systèmes `arm64` :

      ```shell
      sudo mv /usr/local/bin/rocketpool /usr/local/bin/rocketpool_bak

      sudo mv /usr/local/bin/rocketpoold /usr/local/bin/rocketpoold_bak

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-linux-arm64 -O /usr/local/bin/rocketpool

      sudo wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-daemon-linux-arm64 -O /usr/local/bin/rocketpoold

      sudo chmod +x /usr/local/bin/rocketpool /usr/local/bin/rocketpoold
      ```

      Si vous souhaitez voir ce qui a changé, ouvrez le gestionnaire de paramètres - la page de révision vous montrera les nouveautés :

      ```shell
      rp service config
      ```

      Lorsque vous avez terminé, redémarrez Rocket Pool :

      ```shell
      sudo systemctl start rp-node rp-watchtower
      ```

      Enfin, vérifiez la version pour vous assurer que la CLI et la pile Smartnode sont toutes les deux à jour :

      ```
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      Le client et le service doivent tous deux correspondre à la nouvelle version de publication.
    </Tab>
    <Tab label="macOS (Mode Docker ou Hybride)">
      Arrêtez les services Rocket Pool :

      ```shell
      rocketpool service stop
      ```

      Téléchargez la nouvelle CLI Smartnode :

      Pour les systèmes `x64` (la plupart des Macs) :

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-amd64 -O /usr/local/bin/rocketpool
      ```

      Pour les systèmes `arm64`, tels que le Mac mini avec M1 :

      ```shell
      wget https://github.com/rocket-pool/smartnode/releases/latest/download/rocketpool-cli-darwin-arm64 -O /opt/homebrew/bin/rocketpool
      ```

      Maintenant, exécutez la commande d'installation :

      ```shell
      rocketpool service install -d
      ```

      Le drapeau `-d` lui indique d'ignorer les dépendances système comme Docker, puisque vous les avez déjà.

      Si vous souhaitez voir ce qui a changé, ouvrez le gestionnaire de paramètres - la page de révision vous montrera les nouveautés :

      ```shell
      rocketpool service config
      ```

      Lorsque vous avez terminé, redémarrez Rocket Pool :

      ```shell
      rocketpool service start
      ```

      Enfin, vérifiez la version pour vous assurer que la CLI et la pile Smartnode sont toutes les deux à jour :

      ```shell
      rocketpool service version

      Rocket Pool client version: 1.0.0-rc3
      Rocket Pool service version: 1.0.0-rc3
      Selected Eth 1.0 client: Geth (rocketpool/client-go:v1.10.4)
      Selected Eth 2.0 client: Nimbus (statusim/nimbus:v1.4.0)
      ```

      Le client et le service doivent tous deux correspondre à la nouvelle version de publication.

    </Tab>

  </Tabs>
</div>

## Mise à jour manuelle du client d'exécution ou de consensus

Chaque nouvelle version de la pile Smartnode sera livrée avec des références mises à jour vers les dernières versions compatibles des conteneurs Docker d'exécution et de consensus.
Dans certains cas, cependant, vous pourriez vouloir mettre à niveau l'un de ces clients _avant_ d'attendre une nouvelle version de la pile Smartnode.
Cette section vous montrera comment faire exactement cela.

<div className="p-3">
  <Tabs>
    <Tab label="Mode Docker">
      La mise à jour vers de nouvelles versions de clients est facile en mode Docker.

      Commencez par ouvrir le gestionnaire de paramètres :

      ```shell
      rocketpool service config
      ```

      Pour modifier la version du client d'exécution, allez dans la catégorie **Client d'exécution**.
      Modifiez le paramètre **Container Tag** :

      <img src={tuiEcContainerTag} width="100%" height="auto"/>

      Pour modifier la version du client de consensus, allez dans la catégorie **Client de consensus**.
      Modifiez le paramètre **Beacon Node Container Tag** :

      <img src={tuiCcContainerTag} width="100%" height="auto"/>

      Lorsque vous êtes satisfait de vos modifications, enregistrez et quittez comme d'habitude.
      Le Smartnode proposera de redémarrer automatiquement tous les conteneurs affectés.
    </Tab>
    <Tab label="Mode natif">
      Tout d'abord, arrêtez votre client d'exécution, votre nœud Beacon et/ou votre service de client validateur en fonction de ce que vous souhaitez mettre à jour.
      Par exemple, arrêt de Geth :

      ```shell
      sudo systemctl stop geth
      ```

      Ensuite, téléchargez la dernière version binaire du fournisseur de votre client (ou compilez-la à partir du code source) et remplacez l'ancien binaire par le nouveau.
      Nous vous recommandons de **déplacer l'ancien binaire vers un emplacement de sauvegarde** au lieu de l'écraser, au cas où le nouveau client aurait des problèmes.

      Enfin, redémarrez le service client - par exemple, démarrage de Geth :

      ```shell
      sudo systemctl start geth
      ```

      Vous devriez suivre de près les scripts de journalisation après la mise à niveau pour vous assurer que le nouveau client fonctionne comme prévu.
    </Tab>

  </Tabs>
</div>
