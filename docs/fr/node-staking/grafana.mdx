import { Tab, Tabs } from "@rspress/core/theme";

# Configuration du tableau de bord Grafana

Maintenant que votre nœud est opérationnel, vous voudrez probablement avoir un moyen pratique de surveiller tout ce qui le concerne d'un coup d'œil pour vous assurer qu'il fonctionne correctement (et quel type de revenus il génère pour vous).

Il existe de nombreux outils qui font ce travail.
L'un des plus populaires s'appelle [Grafana](https://grafana.com/) - un système de tableau de bord général facile à utiliser auquel vous pouvez accéder avec un navigateur.

Rocket Pool est livré avec un support intégré pour Grafana et ses dépendances ; il est même livré avec un tableau de bord pré-construit pour chacun des clients de consensus.
Par exemple, voici un instantané de ce à quoi ressemble le tableau de bord sur le réseau de test Hoodi :

![](./images/grafana-1.3.jpg)

Le tableau de bord standard comprend les informations suivantes toutes dans un format pratique :

- **En haut à gauche :** quelques statistiques importantes sur la santé et les performances de votre machine, et toutes les mises à jour système en attente
- **En haut à droite :** l'activité et les performances de vos validateurs sur la Beacon Chain, ainsi que quelques statistiques des clients d'exécution et de consensus
- **En bas à gauche :** détails sur l'ensemble du réseau Rocket Pool, pour référence
- **En bas à droite :** détails sur vos récompenses de staking, ETH et RPL

Dans ce guide, nous vous montrerons comment activer le système de métriques de Rocket Pool afin que vous puissiez utiliser ce tableau de bord - ou même construire le vôtre !

## Vue d'ensemble de la pile de métriques Rocket Pool

Si vous choisissez d'activer les métriques pendant le processus de configuration Smartnode, votre nœud ajoutera les processus suivants :

- [Prometheus](https://prometheus.io/) - un système de collecte, de stockage et de reporting de données qui capture toutes les métriques que vous voyez ci-dessus (et bien d'autres) et les stocke, afin qu'elles puissent être consultées au fil du temps
- Le [Node Exporter](https://github.com/prometheus/node_exporter) de Prometheus - un service qui collecte des informations sur la santé de votre machine (telles que l'utilisation du CPU, l'utilisation de la RAM, l'espace disque libre et l'espace swap, etc.) et les rapporte à Prometheus
- Grafana, l'outil qui expose les données de Prometheus via un site Web pratique hébergé sur votre nœud
- Un ensemble optionnel de scripts personnalisés qui signalera toutes les mises à jour disponibles du système d'exploitation à Prometheus, afin que vous sachiez si votre système doit être corrigé

La configuration par défaut créera des conteneurs Docker avec tous ces services qui vivent aux côtés du reste des conteneurs Docker du Smartnode.
Il ouvrira un port sur votre machine de nœud pour Grafana, afin que vous puissiez accéder à son tableau de bord depuis n'importe quelle machine de votre réseau local avec un navigateur.

## Activation du serveur de métriques

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Activer les métriques en mode Docker est le plus facile de tous.

      Commencez par exécuter à nouveau la commande de configuration Smartnode :

      ```shell
      rocketpool service config
      ```

      Accédez à la section `Monitoring / Metrics` et cochez la case `Enable Metrics`.

      Pour ceux qui préfèrent affiner leurs paramètres de port, vous pouvez le faire ici.
      Notez que tous ces ports sont limités au réseau interne de Docker à l'exception du port Grafana - celui-ci sera ouvert sur votre machine (afin que vous puissiez y accéder via un navigateur depuis d'autres machines, telles que votre ordinateur de bureau ou votre téléphone), vous voudrez donc peut-être le changer si le port par défaut entre en conflit avec quelque chose que vous avez déjà.

      Enregistrez et quittez, et smartnode démarrera les conteneurs Docker Prometheus, Node Exporter et Grafana pour vous.

      Il modifiera également vos clients de consensus et de validateur afin qu'ils exposent leurs propres métriques à Prometheus.

      Le tracker de mises à jour du système d'exploitation et de Rocket Pool n'est **pas installé par défaut** pour une flexibilité maximale, mais le processus est simple.
      Si vous souhaitez l'installer afin que votre tableau de bord vous montre combien de mises à jour sont disponibles pour votre système, vous pouvez le faire avec cette commande :

      ```shell
      rocketpool service install-update-tracker
      ```

      Sous le capot, cela installera un service qui se connecte au gestionnaire de paquets de votre système d'exploitation, vérifie périodiquement les mises à jour et envoie ces informations à Prometheus.
      Ce service est différent pour chaque système d'exploitation, mais il a été confirmé qu'il fonctionne sur les suivants :

      - Ubuntu 20.04+
      - Debian 9 et 10
      - CentOS 7 et 8
      - Fedora 34


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        L'activation automatique du service est incompatible avec SELinux.
        Si votre système a SELinux activé par défaut (comme c'est le cas avec CentOS et Fedora), la commande d'installation vous mènera _presque jusqu'au bout_ mais vous donnera également des instructions sur la façon de terminer le processus manuellement à la fin.
      </p>


      Pendant cette vérification, il comparera également votre version installée de Rocket Pool Smartnode avec la dernière version, et vous informera s'il y a une nouvelle version disponible.

      Si vous avez activé le tracker de mise à jour, la dernière étape consiste à redémarrer le Node Exporter avec la commande suivante :

      ```shell
      docker restart rocketpool_exporter
      ```

      Après cela, vous devriez être prêt.
    </Tab>
    <Tab label="Hybrid">
      Le mode hybride fonctionne de manière similaire au mode Docker ; la seule différence est que vous devez ajouter manuellement les indicateurs de ligne de commande appropriés pour activer les métriques dans la définition du service de votre client d'exécution et de consensus.

      Tout d'abord, nous mettrons à jour votre client d'exécution.
      Ouvrez le fichier d'unité `systemd` que vous avez créé lors de l'installation de votre client d'exécution et assurez-vous qu'il contient les indicateurs corrects, en fonction du client que vous utilisez :

      <div className="p-3">
        <Tabs>
          <Tab label="Geth">
            ```
            --metrics --metrics.addr 0.0.0.0 --metrics.port 9105
            ```
          </Tab>
          <Tab label="Nethermind">
            ```
            --Metrics.Enabled true --Metrics.ExposePort 9105
            ```
          </Tab>
          <Tab label="Besu">
            ```
            --metrics-enabled --metrics-host=0.0.0.0 --metrics-port=9105
            ```
          </Tab>
        </Tabs>
      </div>

      Ensuite, nous mettrons à jour votre client de consensus.
      Ouvrez le fichier d'unité `systemd` que vous avez créé lors de l'installation de votre client de consensus et assurez-vous qu'il contient les indicateurs corrects, en fonction du client que vous utilisez :

      <div className="p-3">
        <Tabs>
          <Tab label="Lighthouse">
            ```
            --metrics --metrics-address 0.0.0.0 --metrics-port 9100 --validator-monitor-auto
            ```
          </Tab>
          <Tab label="Lodestar">
            ```
            --metrics --metrics.address 0.0.0.0 --metrics.port 9100
            ```
          </Tab>
          <Tab label="Nimbus">
            ```
            --metrics --metrics-address=0.0.0.0 --metrics-port=9100
            ```
          </Tab>
          <Tab label="Prysm">
            ```
            --monitoring-host 0.0.0.0 --monitoring-port 9100
            ```

            Si vous voyez l'indicateur `--disable-monitoring`, supprimez-le.
          </Tab>
          <Tab label="Teku">
            ```
            --metrics-enabled=true --metrics-interface=0.0.0.0 --metrics-port=9100 --metrics-host-allowlist=*
            ```
          </Tab>

        </Tabs>
      </div>

      Si vous avez déjà ces indicateurs définis et que vous utilisez des ports différents pour votre surveillance de validateur solo, laissez-les tels quels et notez quels ports vous utilisez.

      Maintenant, faites défiler vers le haut et suivez les instructions dans l'onglet `Docker` de cette section pour terminer le processus - en gardant à l'esprit que vous devez remplacer les ports listés là par tous les ports personnalisés que vous utilisez lorsque vous exécutez `rocketpool service config`.

    </Tab>
    <Tab label="Native">
      L'installation native de Grafana et Prometheus est recommandée pour les utilisateurs avancés uniquement. Elle nécessite des compétences d'administration Linux telles que `systemd`, les permissions de fichiers, les utilisateurs et la gestion du réseau.

      Tout d'abord, assurez-vous que votre client d'exécution et votre client de consensus ont les métriques activées. Référez-vous à l'onglet 'Hybrid' pour plus de détails.

      Ensuite, vérifiez les paquets prometheus et node_exporter pré-construits sur [la page de téléchargement officielle](https://prometheus.io/download/).
      Choisissez des paquets avec l'architecture appropriée pour votre plateforme (amd64 ou arm64).
      La version LTS (Long Time Support) la plus récente de Prometheus est recommandée.

      Par exemple, pour télécharger prometheus v2.45.3 LTS et node_exporter v1.7.0 pour Linux amd64 avec `wget`, faites :

      ```shell
      wget https://github.com/prometheus/prometheus/releases/download/v2.45.3/prometheus-2.45.3.linux-amd64.tar.gz
      wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
      wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
      ```

      Extrayez les exécutables prometheus et node_exporter des archives téléchargées.

      ```shell
      sudo tar -zxvf prometheus-2.45.3.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/prometheus' --strip-components=1
      sudo tar -zxvf node_exporter-1.7.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/node_exporter' --strip-components=1
      sudo tar -zxvf alertmanager-0.26.0.linux-amd64.tar.gz -C /usr/local/bin --wildcards '*/alertmanager' --strip-components=1
      ```

      Créez des répertoires pour les configurations prometheus et alertmanager.

      ```shell
      sudo mkdir /etc/prometheus
      sudo mkdir /etc/alertmanager
      sudo mkdir /var/lib/prometheus
      sudo mkdir /var/lib/alertmanager
      ```

      Créez le fichier `/etc/prometheus/prometheus.yml` avec le contenu suivant :

      ```yaml
      global:
      scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
      scrape_timeout: 12s # Timeout must be shorter than the interval
      evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.

      scrape_configs:
      - job_name: "prometheus"
      static_configs:
      - targets: ["localhost:9091"]

      - job_name: "node"
      static_configs:
      - targets: ["localhost:9103"]
      #     - targets: ['localhost:9103', 'node_hostname:9103']
      - job_name: "eth1"
      static_configs:
      - targets: ["localhost:9105"]
      # Uncomment the line below if you are using geth as Execution Client
      #metrics_path: /debug/metrics/prometheus

      - job_name: "eth2"
      static_configs:
      - targets: ["localhost:9100"]

      - job_name: "validator"
      static_configs:
      - targets: ["validator:9101"]

      - job_name: "rocketpool"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["node:9102"]

      - job_name: "watchtower"
      scrape_interval: 5m
      scrape_timeout: 5m
      static_configs:
      - targets: ["watchtower:9104"]

      alerting:
      alertmanagers:
      - static_configs:
      - targets: ["localhost:9093"]
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        Modifiez les numéros de port pour le client d'exécution et le client de consensus si nécessaire.

        Vous pouvez exécuter votre nœud sur un hôte différent de l'hôte exécutant prometheus. Dans ce cas,
        installez node_exporter sur votre hôte de nœud rocketpool et mettez à jour les `targets` du travail `node` pour inclure toutes les machines que vous souhaitez surveiller.
        Ajustez également `metrics_path` si votre client d'exécution est geth - il expose un point de terminaison non standard pour les métriques.
      </p>

      Créez le fichier `/etc/alertmanager/alertmanager.yml` avec le contenu suivant :

      ```yaml
      global:
      # ResolveTimeout is the default value used by alertmanager if the alert does
      # not include EndsAt, after this time passes it can declare the alert as resolved if it has not been updated.
      # This has no impact on alerts from Prometheus, as they always include EndsAt.
      # default = 5m
      resolve_timeout: 5m

      route:
      # The labels by which incoming alerts are grouped together.
      group_by: ["alertname"]
      # How long to initially wait to send a notification for a group
      # of alerts. Allows to wait for an inhibiting alert to arrive or collect
      # more initial alerts for the same group.
      group_wait: 30s
      # How long to wait before sending a notification about new alerts that
      # are added to a group of alerts for which an initial notification has
      # already been sent. (Usually ~5m or more.)
      group_interval: 5m
      # How long to wait before sending a notification again if it has already been sent successfully for an alert.
      repeat_interval: 4h
      routes:
      # severity=info: Don't send the follow-up resolved notification.
      - match:
      severity: info
      continue: false
      # The notification destination
      receiver: "node_operator_no_resolved"
      # all other alerts get sent notifications for the initial firing _and_ resolved notifications.
      - receiver: "node_operator_default"
      #match: We want this to match all alerts (severity=info is first though so it will stop)

      # The notification destination
      receiver: "node_operator_default"

      receivers:
      - name: "node_operator_default"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"

      - name: "node_operator_no_resolved"
      discord_configs:
      - webhook_url: "https://discord.com/api/webhooks/1206697259694170212/_Pk1eVVgXFLdwU1k0rfwehSvNLiAQJytVV_Ze8QYOhupHnhiB5c8awPBTfuw41lN9GJk"
      send_resolved: false

      inhibit_rules:
      # Inhibit rules mute a new alert (target) that matches an existing alert (source).
      - source_match:
      # if the existing alert (source) is severity=critical
      severity: "critical"
      target_match:
      # and the new alert (target) is severity=warning
      severity: "warning"
      # and the alertname, job, and instance labels have the same value
      equal: ["alertname", "job", "instance"]
      ```

      Créez un utilisateur système pour prometheus et alertmanager.

      ```shell
      sudo useradd -r -s /sbin/nologin prometheus
      sudo useradd -r -s /sbin/nologin alertmanager
      ```

      Modifiez la propriété et les permissions des fichiers prometheus/alertmanager.

      ```shell
      sudo chown prometheus:prometheus /usr/local/bin/prometheus
      sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
      sudo chown prometheus:prometheus /usr/local/bin/node_exporter
      sudo chown -R prometheus:prometheus /etc/prometheus
      sudo chown -R alertmanager:alertmanager /etc/alertmanager
      sudo chown -R prometheus:prometheus /var/lib/prometheus
      sudo chown -R alertmanager:alertmanager /var/lib/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/prometheus
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/alertmanager
      sudo chmod u+sx,g+sx,o-wx /usr/local/bin/node_exporter
      ```

      Créez le fichier `/lib/systemd/system/node-exporter.service` pour la configuration du service node_exporter.

      ```
      [Unit]
      Description=Node metrics exporter for Prometheus
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=node-exporter
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9103

      [Install]
      WantedBy=multi-user.target
      ```


      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        Si vous souhaitez modifier le port sur lequel node_exporter s'exécute, modifiez la commande au paramètre `ExecStart`. Le port par défaut est 9100.
      </p>

      Créez le fichier `/lib/systemd/system/prometheus.service` pour la configuration du service prometheus.

      ```
      [Unit]
      Description=Prometheus instance
      Documentation=https://prometheus.io/docs/introduction/overview
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/prometheus
      RuntimeDirectory=prometheus
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --web.listen-address=:9091

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        Si vous souhaitez modifier le port sur lequel prometheus s'exécute, modifiez la commande au paramètre `ExecStart`. Le port par défaut est 9090.
      </p>

      Créez le fichier `/lib/systemd/system/alertmanager.service` pour la configuration du service alertmanager.

      ```
      [Unit]
      Description=Alertmanager instance
      Documentation=https://prometheus.io/docs/alerting/latest/alertmanager/
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=alertmanager
      Group=alertmanager
      Type=simple
      Restart=on-failure
      WorkingDirectory=/var/lib/alertmanager
      RuntimeDirectory=alertmanager
      RuntimeDirectoryMode=0750
      ExecStart=/usr/local/bin/alertmanager --config.file /etc/alertmanager/alertmanager.yml --web.listen-address=:9093

      [Install]
      WantedBy=multi-user.target
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        Si vous souhaitez modifier le port sur lequel alertmanager s'exécute, modifiez la commande au paramètre `ExecStart`. Le port par défaut est 9093.
      </p>

      Informez `systemd` des nouveaux services.

      ```shell
      sudo systemctl daemon-reload
      ```

      Activez et démarrez le service node-exporter.

      ```shell
      sudo systemctl enable node-exporter
      sudo systemctl start node-exporter
      ```

      Vérifiez l'état du service pour vous assurer qu'il fonctionne.

      ```shell
      sudo systemctl status node-exporter
      ```

      Activez et démarrez le service prometheus.

      ```shell
      sudo systemctl enable prometheus
      sudo systemctl start prometheus
      ```

      Activez et démarrez le service alertmanager.

      ```shell
      sudo systemctl enable alertmanager
      sudo systemctl start alertmanager
      ```

      Vérifiez l'état du service pour vous assurer qu'il fonctionne.

      ```shell
      sudo systemctl status prometheus
      sudo systemctl status alertmanager
      ```

      Configurez le référentiel de paquets pour Grafana.

      ```shell
      sudo apt-get update
      sudo apt-get install -y apt-transport-https software-properties-common
      sudo mkdir -p /etc/apt/keyrings/
      wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg > /dev/null
      echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
      ```

      Installez Grafana.

      ```shell
      sudo apt-get update
      sudo apt-get install grafana
      ```

      Vérifiez les paramètres dans `/etc/grafana/grafana.ini`. Changez le `http_port` à 3100 pour être en ligne avec les autres sections fournies dans ce document.

      Configurez la source de données pour visualiser les métriques de Prometheus dans Grafana. Créez le fichier `/etc/grafana/provisioning/datasources/prometheus.yml`.

      ```yaml
      apiVersion: 1

      deleteDatasources:
      - name: Prometheus
      orgId: 1

      datasources:
      - name: Prometheus
      type: prometheus
      access: proxy
      orgId: 1
      url: http://localhost:9091
      basicAuth: false
      isDefault: true
      version: 1
      editable: true
      ```

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">NOTE</p>
        Modifiez `url` si vous avez changé le port d'écoute de Prometheus.
      </p>

      Activez et démarrez le service pour Grafana.

      ```shell
      sudo systemctl daemon-reload
      sudo systemctl enable grafana-server
      sudo systemctl start grafana-server
      ```

      Vérifiez si Grafana est opérationnel.

      ```shell
      sudo systemctl status grafana-server
      ```

      C'est à peu près tout.
    </Tab>

  </Tabs>
</div>

## Configurer le pare-feu pour autoriser les connexions de surveillance

::: warning NOTE
Si vous avez UFW activé comme référencé dans la section [Sécuriser votre nœud](./securing-your-node), vous devrez ouvrir quelques ports afin d'autoriser les connexions locales entre Prometheus et vos clients d'exécution/consensus. Suivez les étapes ci-dessous.
:::

<div className="p-3">
  <Tabs>
    <Tab label="Docker">
      Exécutez ce qui suit, et remplacez les ports si nécessaire :

      ```shell
      RP_NET=$(docker inspect rocketpool_net | grep -Po "(?<=\"Subnet\": \")[0-9./]+")
      sudo ufw allow from $RP_NET to any port 9105 comment "Allow Prometheus access to Execution Client"
      sudo ufw allow from $RP_NET to any port 9100 comment "Allow Prometheus access to Consensus Client"
      sudo ufw allow from $RP_NET to any port 9103 comment "Allow Prometheus access to Exporter"
      ```
    </Tab>
    <Tab label="Native">
      Si votre nœud RocketPool et Prometheus résident sur des hôtes différents, vous devez configurer le pare-feu sur votre hôte de nœud pour autoriser le trafic entrant
      depuis l'IP de l'hôte Prometheus vers les ports de surveillance du nœud.
      Vous devez également configurer UFW sur la machine Prometheus pour autoriser le trafic sortant depuis l'hôte Prometheus vers l'hôte du nœud RocketPool.

      Ayant l'IP de l'hôte du nœud `192.168.1.5` et l'IP de l'hôte Prometheus `192.168.1.6`, les règles UFW pour le nœud seront :

      ```shell
      sudo ufw allow from 192.168.1.6 to any port 9100:9105 proto tcp comment 'Allow Prometheus host to scrape metrics of this host'
      ```

      Et pour l'hôte Prometheus :

      ```shell
      sudo ufw allow out from any to 192.168.1.5 port 9100:9105 proto tcp comment 'Allow this host to scrape node metrics'
      ```

      En supposant que votre port d'écoute Grafana est 3100, continuez à lire pour découvrir comment exposer Grafana sur votre réseau.
    </Tab>

  </Tabs>
</div>

Vous pouvez ensuite ouvrir le pare-feu pour permettre aux appareils externes d'accéder à votre tableau de bord Grafana.

<div className="p-3">
  <Tabs>
    <Tab label="Network">
      Utilisez ceci si vous souhaitez accéder à Grafana depuis n'importe quelle machine de votre réseau local, mais refuser l'accès partout ailleurs.
      Ce sera le cas d'utilisation le plus courant.

      Veuillez d'abord vérifier si votre réseau local utilise la structure `192.168.1.xxx`.
      Vous devrez peut-être modifier la commande ci-dessous pour correspondre à la configuration de votre réseau local s'il utilise une structure d'adresse différente (par exemple `192.168.99.xxx`).

      ```shell
      # This assumes your local IP structure is 192.168.1.xxx
      sudo ufw allow from 192.168.1.0/24 proto tcp to any port 3100 comment 'Allow grafana from local network'
      ```

    </Tab>
    <Tab label="Subnet">
      Utilisez ceci si votre nœud Rocket Pool n'est pas connecté au même sous-réseau que l'appareil à partir duquel vous visualisez Grafana. Cela peut se produire lorsque votre nœud est connecté directement au modem de votre FAI et que l'appareil que vous utilisez pour afficher Grafana est connecté à un routeur secondaire.

      Veuillez d'abord vérifier si votre réseau local utilise la structure `192.168.1.xxx`.
      Vous devrez peut-être modifier la commande ci-dessous pour correspondre à la configuration de votre réseau local s'il utilise une structure d'adresse différente (par exemple `192.168.99.xxx`).

      ```shell
      # To allow any devices in the broader subnet
      # for example allowing 192.168.2.20 to access
      # grafana on 192.168.1.20
      sudo ufw allow from 192.168.1.0/16 proto tcp to any port 3100 comment 'Allow grafana from local subnets'
      ```
    </Tab>
    <Tab label="Anywhere">
      Cela vous permettra d'accéder à Grafana de n'importe où.
      Si vous souhaitez y accéder depuis l'extérieur de votre réseau local, vous devrez toujours transférer le port Grafana (par défaut 3100) dans les paramètres de votre routeur.

      ```shell
      # Allow any IP to connect to Grafana
      sudo ufw allow 3100/tcp comment 'Allow grafana from anywhere'
      ```
    </Tab>

  </Tabs>
</div>

## Configuration de Grafana

Maintenant que le serveur de métriques est prêt, vous pouvez y accéder avec n'importe quel navigateur sur votre réseau local.

Référez-vous aux onglets ci-dessous pour votre mode d'installation Smartnode.

Accédez à l'URL suivante, en remplaçant les variables par votre configuration si nécessaire :

```
http://<votre IP de nœud>:<port grafana>
```

Par exemple, si l'IP de votre nœud était `192.168.1.5` et que vous avez utilisé le port Grafana par défaut de `3100`, vous iriez à cette URL dans votre navigateur :

```
http://192.168.1.5:3100
```

Vous verrez un écran de connexion comme celui-ci :

<img src="./images/grafana-login.png" width="100%" height="auto" />

Les informations Grafana par défaut sont :

```
Nom d'utilisateur: admin
Mot de passe: admin
```

Vous serez ensuite invité à modifier le mot de passe par défaut du compte `admin`.
Choisissez quelque chose de fort et ne l'oubliez pas !

::: tip Astuce
Si vous perdez le mot de passe admin, vous pouvez le réinitialiser en utilisant la commande suivante sur votre nœud :

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker exec -it rocketpool_grafana grafana-cli admin reset-admin-password admin
      ```

    </Tab>
    <Tab label="Native">
      ```shell
      sudo grafana-cli admin reset-admin-password admin
      ```
    </Tab>

  </Tabs>
</div>

Vous pourrez vous connecter à Grafana en utilisant à nouveau les identifiants `admin` par défaut, puis vous serez invité à modifier le mot de passe du compte `admin`.
:::

Grâce au travail du membre de la communauté **tedsteen**, Grafana se connectera automatiquement à votre instance Prometheus afin qu'elle ait accès aux métriques qu'elle collecte.
Tout ce que vous avez à faire est de récupérer le tableau de bord !

## Importation du tableau de bord Rocket Pool

Maintenant que vous avez connecté Grafana à Prometheus, vous pouvez importer le tableau de bord standard (ou créer le vôtre en utilisant les métriques qu'il fournit, si vous êtes familier avec ce processus).

Commencez par aller dans le menu **Create** (l'icône plus dans la barre latérale droite) et cliquez sur **Import** :

<img src="./images/grafana-import.png" width="100%" height="auto" />

Lorsqu'on vous demande l'ID du tableau de bord dans la boîte **Import via grafana.com**, entrez `21863` ou utilisez l'URL complète ([(https://grafana.com/grafana/dashboards/24900-rocket-pool-dashboard-v1-4-0/](https://grafana.com/grafana/dashboards/24900-rocket-pool-dashboard-v1-4-0/)) et appuyez sur le bouton **Load**.

Vous serez invité avec quelques informations sur le tableau de bord ici, telles que son nom et où vous souhaitez le stocker (le dossier **General** par défaut convient à moins que vous n'utilisiez beaucoup de tableaux de bord et que vous souhaitiez les organiser).

Sous le menu déroulant **Prometheus** en bas, vous ne devriez avoir qu'une seule option étiquetée **Prometheus (default)**.
Sélectionnez cette option.

Votre écran devrait ressembler à ceci :

<img src="./images/grafana-import2.png" width="100%" height="auto" />

Si le vôtre correspond, cliquez sur le bouton **Import** et vous serez immédiatement dirigé vers votre nouveau tableau de bord.

Au premier coup d'œil, vous devriez voir beaucoup d'informations sur votre nœud et vos validateurs.
Chaque boîte est livrée avec une info-bulle pratique dans le coin supérieur gauche (l'icône `i`) sur laquelle vous pouvez survoler pour en savoir plus.
Par exemple, voici l'info-bulle pour la boîte **Your Validator Share** :

<img src="./images/tooltip.png" width="100%" height="auto" />

Cependant, nous n'avons pas encore fini de tout configurer - il y a encore un peu plus de configuration à faire.

::: warning NOTE
Certaines des boîtes (notamment celles d'APR) ont été temporairement désactivées en raison de la façon dont Shapella fournit les récompenses écrémées.

Elles seront réactivées dans une future version du Smartnode qui pourra suivre correctement les récompenses historiques.
:::

## Adapter le moniteur matériel à votre système

Maintenant que le tableau de bord est opérationnel, vous remarquerez peut-être que quelques boîtes sont vides telles que **SSD Latency** et **Network Usage**.
Nous devons adapter le tableau de bord à votre matériel spécifique afin qu'il sache comment capturer ces éléments.

### CPU Temp

Pour mettre à jour votre jauge de température CPU, cliquez sur le titre de la boîte **CPU Temp** et sélectionnez **Edit** dans le menu déroulant.
Votre écran ressemblera maintenant à quelque chose comme ceci :

<img src="./images/cpu-temp.png" width="100%" height="auto" />

Ceci est le mode d'édition de Grafana, où vous pouvez modifier ce qui est affiché et comment cela est affiché.
Nous nous intéressons à la boîte de requête mise en évidence en rouge, à droite du bouton **Metrics browser**.

Par défaut, cette boîte contient ceci :

```
node_hwmon_temp_celsius{job="node", chip="", sensor=""}
```

Il y a deux champs dans ce texte qui sont actuellement vides : `chip` et `sensor`.
Ceux-ci sont uniques à chaque machine, vous devrez donc les remplir en fonction de ce que votre machine fournit.

Pour ce faire, suivez ces étapes :

1. Supprimez la portion `, sensor=""` afin qu'elle se termine par `chip=""}`. Pour plus de clarté, le tout devrait maintenant être `node_hwmon_temp_celsius{job="node", chip=""}`.
2. Placez votre curseur entre les guillemets de `chip=""` et appuyez sur `Ctrl+Espace`. Cela fera apparaître une boîte de saisie semi-automatique avec les options disponibles, qui ressemble à ceci :

<img src="./images/grafana-autocomplete.png" width="100%" height="auto" />

3. Sélectionnez l'option qui correspond au CPU de votre système.
4. Une fois cela sélectionné, rajoutez `, sensor=""` dans la chaîne. Placez votre curseur entre les guillemets de `sensor=""` et appuyez sur `Ctrl+Espace` pour obtenir un autre menu de saisie semi-automatique. Sélectionnez le capteur que vous souhaitez surveiller.

::: tip Astuce
Si vous ne savez pas quelle `chip` ou quel `sensor` est correct, vous devrez tous les essayer jusqu'à ce que vous trouviez celui qui semble correct. Pour vous aider, installez le paquet `lm-sensors` (par exemple, `sudo apt install lm-sensors` sur Debian / Ubuntu) et exécutez la commande `sensors -u` pour fournir les capteurs dont votre ordinateur dispose. Vous pouvez essayer de corréler un ID de puce de la liste de Grafana avec ce que vous voyez ici en fonction de leurs noms et ID.

Par exemple, voici l'une des sorties de notre commande `sensors -u` :

```
k10temp-pci-00c3
Tctl:
  temp1_input: 33.500
Tdie:
  temp2_input: 33.500
```

Dans notre cas, la puce correspondante dans Grafana est `pci0000:00_0000:00:18_3` et le capteur correspondant est `temp1`.
:::

Une fois que vous êtes satisfait de vos sélections, cliquez sur le bouton bleu **Apply** dans le coin supérieur droit de l'écran pour enregistrer les paramètres.

::: warning NOTE
Tous les systèmes n'exposent pas d'informations sur la température du CPU - notamment les machines virtuelles ou les systèmes basés sur le cloud.
Si le vôtre n'a rien dans le champ de saisie semi-automatique pour `chip`, c'est probablement le cas et vous ne pourrez pas surveiller la température de votre CPU.
:::

### SSD Latency

Le graphique **SSD Latency** suit combien de temps prennent les opérations de lecture/écriture.
Ceci est utile pour évaluer la rapidité de votre SSD, afin que vous sachiez s'il devient un goulot d'étranglement si votre validateur souffre de mauvaises performances.
Pour mettre à jour le SSD que vous souhaitez suivre dans le graphique, cliquez sur le titre **SSD Latency** et sélectionnez **Edit**.

Ce graphique a quatre champs de requête (quatre zones de texte) avec huit portions `device=""` au total.
Vous devrez mettre à jour les quatre premières de ces portions avec l'appareil que vous souhaitez suivre.

Placez simplement votre curseur entre les guillemets et appuyez sur `Ctrl+Espace` pour obtenir la liste de saisie semi-automatique de Grafana, et sélectionnez l'option correcte à partir de là pour chacune des portions `device=""`.
**Vous voulez commencer par le paramètre vide le plus à gauche en premier, sinon la liste de saisie semi-automatique peut ne pas apparaître.**

::: tip Astuce
Si vous ne savez pas quel appareil suivre, exécutez la commande suivante :

```
lsblk
```

Cela affichera un arbre montrant votre liste d'appareils et de partitions, par exemple :

```
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
...
loop25        7:25   0   132K  1 loop /snap/gtk2-common-themes/9
loop26        7:26   0  65,1M  1 loop /snap/gtk-common-themes/1515
nvme0n1     259:0    0 238,5G  0 disk
├─nvme0n1p1 259:1    0   512M  0 part /boot/efi
├─nvme0n1p2 259:2    0 150,1G  0 part /
├─nvme0n1p3 259:3    0  87,4G  0 part
└─nvme0n1p4 259:4    0   527M  0 part
```

Si vous n'avez pas modifié l'emplacement par défaut de Docker sur un autre disque lors de l'installation de votre Smartnode, alors le disque que vous voulez suivre sera celui sur lequel votre système d'exploitation est installé.
Regardez dans la colonne `MOUNTPOINT` pour une entrée simplement étiquetée `/`, puis remontez jusqu'à son appareil parent (celui avec `disk` dans la colonne `TYPE`).

Typiquement, ce sera `sda` pour les disques SATA ou `nvme0n1` pour les disques NVMe.

Si vous _avez_ modifié l'emplacement par défaut de Docker sur un autre disque, ou si vous exécutez une configuration hybride/native, vous devriez pouvoir utiliser la même technique de "suivre le point de montage" pour déterminer sur quel appareil résident vos données de chaîne.
:::

En option, vous pouvez également suivre la latence d'un deuxième disque sur votre système.
Ceci est destiné aux personnes qui conservent leur système d'exploitation et leurs données de chaîne sur des disques séparés.
Pour configurer cela, suivez simplement les instructions ci-dessus pour les deux derniers champs de requête, en substituant les valeurs de portion `device=""` par celles du disque que vous souhaitez suivre.

Une fois que vous êtes satisfait de vos sélections, cliquez sur le bouton bleu **Apply** dans le coin supérieur droit de l'écran pour enregistrer les paramètres.

### Network Usage

Ce graphique suit la quantité de données que vous envoyez et recevez sur une connexion réseau particulière.
Comme vous pouvez vous y attendre, le tableau de bord doit savoir quel réseau vous souhaitez qu'il suive.

Pour le modifier, cliquez sur le titre **Network Usage** et sélectionnez **Edit**.

Ce graphique a deux champs de requête avec deux portions `device=""` au total.
Vous devrez les mettre à jour avec le réseau que vous souhaitez suivre.

Placez votre curseur entre les guillemets et appuyez sur `Ctrl+Espace` pour obtenir la liste de saisie semi-automatique de Grafana, et sélectionnez l'option correcte à partir de là pour chacune des portions `device=""`.

::: tip Astuce
Si vous ne savez pas quel appareil suivre, exécutez la commande suivante :

```shell
sudo route
```

La sortie ressemblera à quelque chose comme ceci :

```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
```

Regardez dans la colonne `Destination` pour la ligne avec la valeur de `default`.
Suivez cette ligne jusqu'à la colonne `Iface`.
L'appareil listé là est celui que vous voulez utiliser - dans cet exemple, `eth0`.
:::

Une fois que vous êtes satisfait de vos sélections, cliquez sur le bouton bleu **Apply** dans le coin supérieur droit de l'écran pour enregistrer les paramètres.

### Total Net I/O

Cela suit la quantité totale de données que vous avez envoyées et reçues.
Vous pourriez le trouver utile à surveiller si, par exemple, votre FAI vous limite à une certaine quantité de données par mois.

La configuration est identique à la boîte **Network Usage** ci-dessus, suivez donc simplement ces instructions pour cette boîte également.

### Disk Space Used

Cela garde un œil sur la saturation de votre disque de système d'exploitation, afin que vous sachiez quand il est temps de nettoyer (et si vos données de chaîne vivent sur le même disque, il est temps d'[élaguer Geth ou Nethermind](./pruning)).

Les étapes sont les mêmes que pour la boîte **SSD Latency** ci-dessus, suivez donc simplement ces instructions pour cette boîte également.
Pour rappel, vous voulez le disque qui héberge la partition qui a `/` dans la colonne `MOUNTPOINT` pour celui-ci car ce sera votre disque de système d'exploitation.
Remplissez ceci dans le premier champ de requête.

En option, vous pouvez également suivre l'espace libre d'un deuxième disque sur votre système.
Ceci est destiné aux personnes qui conservent leur système d'exploitation et leurs données de chaîne sur des disques séparés.
Configurez cela en suivant le même processus, mais au lieu de regarder quelle partition a `/` dans la colonne `MOUNTPOINT`, vous voulez chercher celle qui a le point de montage de votre deuxième disque.
Mettez à jour le deuxième champ de requête avec le disque associé à cette partition.

### Disk Temp

Cela suit la température actuelle de votre disque de système d'exploitation. Les étapes sont les mêmes que pour la boîte **CPU Temp** ci-dessus, suivez donc simplement ces instructions pour cette boîte également, en substituant les valeurs de puce et de capteur du CPU par celles de votre disque de système d'exploitation. Remplissez ces valeurs dans le premier champ de requête.

En option, vous pouvez également suivre la température actuelle d'un deuxième disque sur votre système. Configurez cela en suivant le même processus, en substituant les valeurs de puce et de capteur par celles de votre deuxième disque. Remplissez ces valeurs dans le deuxième champ de requête.

## Personnalisation du tableau de bord

Bien que le tableau de bord standard essaie de bien capturer tout ce que vous voudriez voir d'un coup d'œil, il est assez facile de personnaliser un tableau de bord Grafana comme vous le souhaitez.
Vous pouvez ajouter de nouveaux graphiques, modifier l'apparence des graphiques, déplacer des éléments, et bien plus encore !

Jetez un œil à la page [Tutoriels Grafana](https://grafana.com/tutorials/) pour apprendre comment jouer avec et le configurer à votre guise.

## Personnalisation de la pile de métriques

Les outils utilisés dans la pile de métriques Rocket Pool offrent un large éventail d'options de configuration au-delà de ce qui est inclus dans l'installation Rocket Pool par défaut. Cette section comprend des exemples de configuration pour différents cas d'utilisation.

En général, les [options de configuration Grafana](https://grafana.com/docs/grafana/latest/administration/configuration/) doivent être transmises en utilisant des variables d'environnement dans `override/grafana.yml`. Toute option de configuration peut être convertie en variable d'environnement en utilisant la syntaxe suivante :

```
GF_<SectionName>_<KeyName>
```

### Paramètres SMTP Grafana pour l'envoi d'e-mails

Pour envoyer des e-mails depuis Grafana, par exemple pour les alertes ou pour inviter d'autres utilisateurs, les paramètres SMTP doivent être configurés dans la pile de métriques Rocket Pool.
Voir la page [Configuration SMTP Grafana](https://grafana.com/docs/grafana/latest/administration/configuration/#smtp) pour référence.

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      Ouvrez `~/.rocketpool/override/grafana.yml` dans un éditeur de texte.
      Ajoutez une section `environment` sous la ligne `x-rp-comment: Add your customizations below this line`, en remplaçant les valeurs ci-dessous par celles de votre fournisseur SMTP.

      ```yaml
      version: "3.7"
      services:
      grafana:
      x-rp-comment: Add your customizations below this line
      environment:
      ## SMTP settings start, replace values with those of your SMTP provider
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      - GF_SMTP_USER=admin@example.com
      - GF_SMTP_PASSWORD=password
      - GF_SMTP_FROM_ADDRESS=admin@example.com
      - GF_SMTP_FROM_NAME="Rocketpool Grafana Admin"
      ## SMTP server settings end
      ```
    </Tab>
    <Tab label="Native">
      Ouvrez `/etc/grafana/grafana.ini` dans un éditeur de texte. Recherchez la section `[smtp]` et mettez-la à jour, en remplaçant les valeurs ci-dessous par celles de votre fournisseur SMTP.

      ```
      [smtp]
      enabled = true
      host = mail.example.com:`port` # Gmail users should use smtp.gmail.com:587
      user = admin@example.com
      # If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
      password = """passw0rd"""
      from_address = admin@example.com
      from_name = "Rocketpool Grafana Admin"
      ```
    </Tab>

  </Tabs>
</div>

::: tip Astuce
Si vous utilisez Gmail et que la [vérification en deux étapes](https://support.google.com/accounts/answer/185839) est activée, créez un [mot de passe d'application](https://support.google.com/mail/answer/185833?hl=fr) pour ce service.
:::

Après avoir effectué ces modifications, **exécutez ce qui suit pour appliquer les modifications** :

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      ```shell
      docker stop rocketpool_grafana

      rocketpool service start
      ```
    </Tab>
    <Tab label="Native">
      ```shell
      sudo systemctl restart grafana-server
      ```
    </Tab>

  </Tabs>
</div>

Pour tester les paramètres SMTP, allez dans le menu **Alerting** et cliquez sur **Contact points**.

<img src="./images/grafana-contact-points.png" width="100%" height="auto" />

Cliquez sur **New contact point** et sélectionnez **Email** comme type de point de contact.
Entrez une adresse e-mail dans la section **Addresses** et cliquez sur **Test**.

<img src="./images/grafana-new-contact-point.png" width="100%" height="auto" />

Vérifiez que l'e-mail de test a été reçu.
Cliquez sur **Save contact point\*** lorsque vous avez terminé.
