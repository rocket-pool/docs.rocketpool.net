import { Tab, Tabs } from "@rspress/core/theme";

# Élagage du client d'exécution

::: tip NOTE
Ceci est destiné aux utilisateurs de `geth` et `nethermind`.
Besu n'a _pas_ besoin d'être élagué.
:::

Si vous utilisez `geth` ou `nethermind` comme client d'exécution principal, vous remarquerez probablement que l'espace disque libre de votre nœud diminue lentement au fil du temps.
Le client d'exécution est de loin le plus grand contributeur à cela ; selon la quantité de RAM que vous avez allouée à son cache lors de `rocketpool service config`, il peut croître à un rythme de plusieurs gigaoctets par jour !

Pour gérer cela, les clients d'exécution fournissent une fonction spéciale appelée **élagage** qui leur permet d'analyser et de nettoyer leur base de données en toute sécurité pour récupérer de l'espace libre.
Chaque opérateur de nœud utilisant Geth ou Nethermind devra l'élaguer éventuellement.

Si vous avez un SSD de 2 To, vous pouvez généralement passer des mois entre les cycles d'élagage.
Pour les utilisateurs de SSD de 1 To, vous devrez élaguer plus fréquemment.

Si vous avez [le tableau de bord Grafana](./grafana) activé, une bonne règle générale est de commencer à penser à élaguer votre client d'exécution lorsque l'espace disque utilisé de votre nœud dépasse 80 %.

Lorsque vous décidez qu'il est temps, le Smartnode est livré avec la capacité de l'élaguer pour vous sur demande.
Lisez ci-dessous pour savoir comment cela fonctionne et à quoi vous attendre.

::: warning NOTE
L'élagage de votre client d'exécution n'est possible qu'en Docker Mode.

Si vous utilisez votre propre client d'exécution, comme un client externe en mode Hybrid ou en mode Native, vous ne pouvez pas utiliser le Smartnode pour élaguer le client d'exécution.
Vous devrez le faire manuellement.
Veuillez vous référer à la documentation de votre client d'exécution pour apprendre comment l'élaguer.
:::

## Prérequis

Sélectionnez le client que vous utilisez dans les onglets ci-dessous.

<div className="p-3">
  <Tabs>
    <Tab label="Geth">
      L'élagage de Geth signifie mettre le client d'exécution principal hors ligne afin qu'il puisse se nettoyer.
      Lorsque cela se produit, le Smartnode (et votre client de consensus) aura besoin d'une autre façon d'accéder à la chaîne ETH1 pour fonctionner correctement.

      Le moyen le plus simple de fournir cela est avec un **nœud de secours**.
      Si vous [avez configuré un nœud de secours](./fallback) en utilisant `rocketpool service config` déjà, alors le Smartnode basculera automatiquement vers celui-ci lorsque votre conteneur Geth sera arrêté pour maintenance.
      Il informera également votre client de consensus d'utiliser le secours également.

      <p className="rspress-directive warning">
        <p className="rspress-directive-title">WARNING</p>
        Si vous n'avez pas de nœud de secours configuré, votre nœud cessera de valider pendant le processus d'élagage.
        Il manquera toutes les attestations et propositions de blocs jusqu'à ce qu'il soit terminé et qu'il se soit resynchronisé avec le réseau.
        **Vous perdrez de l'ETH en raison de validations manquées pendant ce temps !**
      </p>

      En gardant cela à l'esprit, les deux conditions suivantes sont requises pour élaguer Geth avec succès :

      - Un nœud de secours fonctionnel configuré
      - Au moins **50 Go** d'espace libre restant sur votre SSD
    </Tab>
    <Tab label="Nethermind">
      Nethermind est capable de rester en ligne pendant qu'il élague, ce qui signifie que vous n'avez pas besoin d'un nœud de secours pour continuer à attester.
      Notez, cependant, que l'élagage est **une tâche extrêmement intensive en ressources** et vous pouvez voir une augmentation de la distance d'inclusion de vos attestations et des attestations manquées pendant celle-ci.

      Nethermind ne nécessite aucun prérequis spécial ; vous pouvez l'élaguer à tout moment.
    </Tab>

  </Tabs>
</div>

## Démarrer un élagage

Sélectionnez le client que vous utilisez dans les onglets ci-dessous.

<div className="p-3">
  <Tabs>
    <Tab label="Geth">
      Lorsque vous souhaitez élaguer Geth, exécutez simplement cette commande :

      ```shell
      rocketpool service prune-eth1
      ```

      Si vous n'avez pas de paire de clients de secours activée, vous recevrez l'avertissement suivant :

      ```
      This will shut down your main execution client and prune its database, freeing up disk space.
      Once pruning is complete, your execution client will restart automatically.

      You do not have a fallback execution client configured.
      Your node will no longer be able to perform any validation duties (attesting or proposing blocks) until Geth is done pruning and has synced again.
      Please configure a fallback client with `rocketpool service config` before running this.
      Are you sure you want to prune your main execution client? [y/n]
      ```

      Si vous en avez un activé, vous verrez l'invite suivante à la place :

      ```
      This will shut down your main execution client and prune its database, freeing up disk space.
      Once pruning is complete, your execution client will restart automatically.

      You have fallback clients enabled. Rocket Pool (and your consensus client) will use that while the main client is pruning.
      Are you sure you want to prune your main execution client? [y/n]
      ```

      Si vous acceptez, vous verrez quelques détails pendant que le Smartnode prépare les choses ; cela devrait se terminer par un message de succès :

      ```
      Are you sure you want to prune your main ETH1 client? [y/n]
      y

      Your disk has 303 GiB free, which is enough to prune.
      Stopping rocketpool_eth1...
      Provisioning pruning on volume rocketpool_eth1clientdata...
      Restarting rocketpool_eth1...

      Done! Your main ETH1 client is now pruning. You can follow its progress with `rocketpool service logs eth1`.
      Once it's done, it will restart automatically and resume normal operation.
      NOTE: While pruning, you **cannot** interrupt the client (e.g. by restarting) or you risk corrupting the database!
      You must let it run to completion!
      ```

      Avec cela, Geth élague maintenant et vous êtes tous prêts !
      Vous pouvez suivre sa progression avec :

      ```shell
      rocketpool service logs eth1
      ```

      Une fois l'élagage terminé, il redémarrera automatiquement et le Smartnode recommencera à l'utiliser au lieu de votre secours.
    </Tab>
    <Tab label="Nethermind">
      Lorsque vous souhaitez élaguer Nethermind, exécutez simplement cette commande :

      ```shell
      rocketpool service prune-eth1
      ```

      Vous verrez l'invite suivante :

      ```
      This will shut down your main execution client and prune its database, freeing up disk space.
      Once pruning is complete, your execution client will restart automatically.

      Are you sure you want to prune your main execution client? [y/n]
      ```

      Si vous acceptez, vous verrez quelques messages similaires à ce qui suit :

      ```
      Your disk has 790 GiB free, which is enough to prune.
      Stopping rocketpool_eth1...
      Provisioning pruning on volume rocketpool_eth1clientdata...
      Restarting rocketpool_eth1...
      Error requesting prune: AggregateException - One or more errors occurred. (Connection refused (127.0.0.1:7434))
      Trying again in 3 seconds... (1/100)
      ...
      Trying again in 3 seconds... (10/100)
      Success: Pruning is now "Starting"

      Done! Your main execution client is now pruning. You can follow its progress with `rocketpool service logs eth1`.
      Once it's done, it will restart automatically and resume normal operation.
      NOTE: While pruning, you **cannot** interrupt the client (e.g. by restarting) or you risk corrupting the database!
      You must let it run to completion!
      ```

      Avec cela, Nethermind élague maintenant et vous êtes tous prêts !
      Vous pouvez suivre sa progression avec :

      ```shell
      rocketpool service logs eth1
      ```

      Une fois l'élagage terminé, il redémarrera automatiquement.
    </Tab>

  </Tabs>
</div>
