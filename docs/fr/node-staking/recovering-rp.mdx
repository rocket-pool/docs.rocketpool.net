import { Tab, Tabs } from "@rspress/core/theme";

# Importation / Récupération d'un Portefeuille Existant

Si vous avez déjà un portefeuille que vous souhaitez utiliser pour votre nœud, ou si vous récupérez un portefeuille que vous avez créé précédemment avec le Smartnode, ce guide vous aidera dans le processus d'importation / récupération.

Veuillez sélectionner l'option appropriée dans les sections ci-dessous.

## Récupération d'un Portefeuille Smartnode

Si vous avez généré votre portefeuille de nœud en utilisant le Smartnode et que vous le récupérez simplement sur une nouvelle machine, le processus est assez simple.
Assurez-vous d'avoir déjà installé le logiciel Smartnode, puis exécutez simplement la commande suivante une fois qu'il est installé :

```shell
rocketpool wallet recover
```

::: warning REMARQUE
Si, pour une raison quelconque, vous souhaitez récupérer le portefeuille mais _pas_ les clés de validateur attachées aux minipools de votre nœud, vous pouvez spécifier le drapeau `-k` pour ignorer le processus de reconstruction :

```shell
rocketpool wallet recover -k
```

Si vous ne spécifiez pas ce drapeau, le Smartnode tentera de récupérer les clés de validateur pour vos minipools ; cependant, notez que cela ne fonctionnera pas tant que votre client d'exécution n'aura pas terminé la synchronisation.
Veuillez surveiller son fichier journal pour voir quand c'est terminé ; une fois que c'est le cas, vous pouvez exécuter cette étape.
:::

Cela vous demandera d'abord un mot de passe que vous souhaitez utiliser pour chiffrer votre portefeuille.
Après cela, il vous demandera votre **phrase mnémonique de récupération de 24 mots**.
Entrez-la soigneusement - elle ne sera pas affichée à l'écran pour des raisons de sécurité, et il est très facile de faire une erreur en la tapant, alors prenez votre temps.

Lorsque vous avez terminé, vous devriez voir une sortie similaire à celle-ci :

```shell
$ rocketpool wallet recover

Please enter a password to secure your wallet with:

Please confirm your password:

Please enter your recovery mnemonic phrase:

Recovering node wallet...
The node wallet was successfully recovered.
Node account: <your wallet address>
No validator keys were found.
```

Si vous ne voyez aucune erreur, alors votre portefeuille et vos validateurs seront récupérés.

Une fois que vous avez terminé, assurez-vous de redémarrer le client Validator avec la commande suivante pour les utilisateurs Docker et en mode Hybride :

```shell
docker restart rocketpool_validator
```

Les utilisateurs du **mode Natif** devront simplement redémarrer leur processus de conteneur Validator.

Cela garantira que le VC récupère toutes les clés de validateur nouvellement restaurées.

## Importation d'une Adresse Existante comme Portefeuille de Nœud

Si vous avez une adresse que vous souhaitez utiliser pour un nœud, mais que vous ne l'avez _pas_ créée avec le Smartnode (par exemple, vous l'avez créée avec MetaMask ou un portefeuille matériel), alors c'est la section à suivre.

::: danger AVERTISSEMENT
En faisant cela, votre adresse deviendra un **portefeuille chaud**.
La clé privée sera stockée sur votre machine de nœud.

Si vous importez une adresse qui est un portefeuille froid, comme un portefeuille matériel, sachez que **la protection fournie par le portefeuille matériel n'existera plus !**

Si vous utilisez ce portefeuille pour _toute autre activité de cryptomonnaie_, **vous devez migrer tous ses fonds vers une adresse séparée (par exemple, un autre portefeuille matériel) avant de l'importer dans votre nœud ! Ne laissez suffisamment d'ETH sur cette adresse que pour les coûts de gaz de votre nœud (généralement 0,5 ETH est suffisant).**

Veuillez vous assurer d'avoir sécurisé votre machine autant que possible en suivant les étapes du guide [Sécurisation de votre Nœud](./securing-your-node) avant d'importer votre adresse comme portefeuille de nœud.
:::

Cette capacité n'est disponible qu'avec Smartnode **v1.4.3 ou supérieur**.
Si vous avez une version inférieure, vous devrez d'abord effectuer une mise à niveau.

C'est un processus en plusieurs étapes, alors suivez attentivement les sections ci-dessous.

### Étape 1 : Ajouter des Clés de Validateur Générées Externement

**Si vous n'avez pas de minipools existants attachés à l'adresse que vous importez, vous pouvez ignorer cette étape.**

Si votre adresse a déjà été enregistrée comme portefeuille de nœud Rocket Pool (par exemple via un service comme **Allnodes**) et a déjà des minipools actifs, et que vous souhaitez les importer dans la pile Smartnode avec votre adresse, vous devrez fournir les fichiers de keystore privés pour chacun de leurs validateurs correspondants.
Ces fichiers seront chiffrés avec un mot de passe de votre choix, donc vous aurez besoin de ce mot de passe pour chaque fichier.

Vous devez obtenir ces fichiers du service qui exécute actuellement votre nœud afin de l'importer.
Certains fournisseurs de services peuvent être en mesure de récupérer ces fichiers sur demande.
Si vous utilisez Allnodes, vous pouvez obtenir ces fichiers lors de votre processus de configuration initial mais **ne pourrez pas les récupérer à l'avenir à moins de les avoir sauvegardés lors de la création du minipool.**

Sélectionnez votre mode d'installation et suivez les étapes ci-dessous.

<div className="p-3">
  <Tabs>
    <Tab label="Docker et Mode Hybride">
      Tout d'abord, assurez-vous d'avoir démarré le Smartnode avec `rocketpool service start`.
      Cela créera un dossier spécial qui peut être utilisé pour contenir les fichiers de keystore chiffrés pour vos validateurs.

      Par défaut, le dossier est situé dans `~/.rocketpool/data/custom-keys`.
      Si vous avez personnalisé votre installation ou vos répertoires de données, substituez de manière appropriée pour trouver le dossier `custom-keys`.

      Vérifiez avec un explorateur de fichiers ou la commande `ls` pour vous assurer que ce dossier existe.
      Sinon, pas de souci - créez simplement le dossier avec la commande suivante :

      ```shell
      mkdir ~/.rocketpool/data/custom-keys
      ```
    </Tab>
    <Tab label="Mode Natif">
      Créez un dossier appelé `custom-keys` à l'intérieur du dossier `data` de votre Smartnode (par exemple, `/srv/rocketpool/data/custom-keys`).
    </Tab>

  </Tabs>
</div>

Ensuite, placez chacun des fichiers de keystore de validateur dans ce dossier.
Les noms des fichiers n'ont pas d'importance, mais ils doivent être des fichiers JSON conformes au format [EIP-2335](https://eips.ethereum.org/EIPS/eip-2335#scrypt-test-vector).

Le Smartnode recherchera dans ce répertoire tous les fichiers de keystore que vous avez placés ici dans les prochaines étapes.

::: warning REMARQUE
Le processus d'importation recherchera _uniquement_ les clés de validateur attachées aux minipools enregistrés à l'adresse que vous importez.
Vous **ne pouvez pas** utiliser ce processus pour importer d'autres clés de validateur, comme pour les validateurs de staking solo, dans le client Validator géré par la pile Smartnode.

Veuillez consulter la documentation pour l'exécution en [Mode Hybride Inverse](./advanced-config#allowing-external-validator-clients-to-connect-to-the-smartnode) si vous êtes intéressé par cela.
:::

### Étape 2 (Facultatif) : Tester l'Importation de l'Adresse

Si vous souhaitez tester le processus de récupération pour vous assurer d'avoir le mnémonique et les mots de passe corrects **sans réellement régénérer la clé privée de votre portefeuille de nœud ou importer vos clés de validateur**, vous pouvez le faire avec la commande suivante :

```shell
rocketpool wallet test-recovery -a 0x1234abcd...
```

Où `0x1234abcd...` est l'adresse que vous souhaitez importer, commençant par le préfixe `0x`.
**Vous aurez besoin de votre phrase mnémonique pour importer la clé privée de votre adresse.**

::: tip ASTUCE
Si, pour une raison quelconque, vous souhaitez récupérer le portefeuille mais _pas_ les clés de validateur pour vos minipools, vous pouvez spécifier le drapeau `-k` pour ignorer le processus de récupération des clés de validateur.
Par exemple :

```shell
rocketpool wallet test-recovery -a 0x1234abcd... -k
```

:::

Le Smartnode recherchera automatiquement dans les chemins de dérivation les plus populaires (par exemple ceux utilisés par Ledger Live, MyEtherWallet, Trezor et la pile Smartnode) et les indices d'adresse pour trouver les paramètres qui correspondent à l'adresse que vous avez fournie.

::: tip ASTUCE
Si vous avez un chemin de dérivation personnalisé, utilisez le drapeau `-d` pour le spécifier.
Par exemple :

```shell
rocketpool wallet test-recovery -d "m/44'/60'/0'/%d"
```

Utilisez `%d` pour la partie du chemin qui peut être itérée pour utiliser différents indices.

Si vous avez un indice d'adresse personnalisé, utilisez le drapeau `-i` pour le spécifier.
Par exemple, si votre adresse était la 6ème sur le chemin de dérivation standard, vous pourriez utiliser :

```shell
rocketpool wallet test-recovery -i 5
```

Vous pouvez utiliser les drapeaux `-d` et `-i` en même temps si nécessaire.
:::

Tout d'abord, vous serez invité à entrer la phrase mnémonique de votre adresse :

```
Please enter the number of words in your mnemonic phrase (24 by default):
24

Enter Word Number 1 of your mnemonic:
```

Entrez-la soigneusement, et le Smartnode commencera à rechercher dans toutes les options standard pour la trouver (sauf si vous les avez explicitement spécifiées en utilisant les drapeaux `-d` et/ou `-i`).

Ensuite, si vous avez des fichiers de keystore privés à importer de l'étape 1, vous serez invité à entrer les mots de passe pour chacun de ces fichiers de keystore :

```
It looks like you have some custom keystores for your minipool's validators.
You will be prompted for the passwords each one was encrypted with, so they can be loaded into the Validator Client that Rocket Pool manages for you.

Please enter the password that the keystore for <validator pubkey> was encrypted with:
```

Ils seront organisés par liste de **pubkey**, **pas par noms de fichiers**.
Assurez-vous de savoir quel fichier correspond à quelle clé publique de validateur afin d'entrer les mots de passe corrects.

Une fois que vous avez fait cela, le processus de test de récupération se poursuivra et signalera s'il a réussi ou échoué :

```
Searching for the derivation path and index for wallet 0x1234abcd...
NOTE: this may take several minutes depending on how large your wallet's index is.
The node wallet was successfully recovered.
Derivation path: m/44'/60'/0'/0/%d
Wallet index:    0
Node account:    0x1234abcd...
Validator keys:
<validator pubkey>
```

Ce qui précède indique un test de récupération réussi.

### Étape 3 : Importer l'Adresse

::: danger AVERTISSEMENT
Si votre adresse est un nœud Rocket Pool qui n'est _pas_ géré par votre propre Smartnode auto-hébergé (par exemple hébergé par un service externe comme **Allnodes**), **IL EST CRITIQUE** que vous coordonniez avec le service qui exécute votre nœud **avant de commencer ce processus d'importation** et que vous les informiez que vous souhaitez migrer vers votre propre système auto-hébergé.

Vous **DEVEZ CONFIRMER** qu'ils ont arrêté la validation pour votre nœud et **ne la reprendront JAMAIS**, et confirmer manuellement que vos validateurs n'attestent plus en utilisant un explorateur de blockchain tel que [https://beaconcha.in](https://beaconcha.in).
Vous devez confirmer que chaque validateur a manqué **AU MOINS 2 ATTESTATIONS** pour vous assurer que vous pouvez migrer en toute sécurité.
Sinon, vous attesterez tous les deux en même temps et **VOS MINIPOOLS SERONT SLASHÉS !**

Le Smartnode vous demandera de confirmer que vous avez fait cela avant de vous permettre de continuer le processus d'importation.
:::

Si le test de récupération a réussi, ou si vous l'avez ignoré, vous importerez ensuite le portefeuille et régénérerez tous ses fichiers de clés associés.
Le processus est exactement le même que ci-dessus, mais utilisez la commande `recover` au lieu de la commande `test-recovery` :

```shell
rocketpool wallet recover -a 0x1234abcd...
```

Lorsque vous exécutez cette commande, vous serez d'abord invité à entrer un mot de passe pour chiffrer votre portefeuille de nœud importé.

```
Please enter a password to secure your wallet with:

Please confirm your password:
```

Après cela, les invites de phrase mnémonique et de mot de passe de keystore de validateur personnalisé se poursuivront comme auparavant.

Une fois que vous avez entré toutes ces informations, le Smartnode récupérera votre adresse et (si non désactivé) les clés de validateur personnalisées pour vos minipools :

```
Searching for the derivation path and index for wallet 0x1234abcd...
NOTE: this may take several minutes depending on how large your wallet's index is.
The node wallet was successfully recovered.
Derivation path: m/44'/60'/0'/0/%d
Wallet index:    0
Node account:    0x1234abcd...
Validator keys:
<validator pubkey>
```

La clé privée de votre adresse sera maintenant stockée dans le fichier `data/wallet` (par exemple `~/.rocketpool/data/wallet`), et le mot de passe pour celui-ci sera stocké dans le fichier `data/password` (par exemple `~/.rocketpool/data/password`).

Les clés privées pour chacun de vos validateurs seront stockées dans les dossiers `data/validators` pour chacun des clients Consensus que le Smartnode prend en charge.

::: danger REMARQUE
En important une adresse de cette manière, les clés de validateur n'ont **pas** été dérivées de votre portefeuille de nœud, et donc elles **ne peuvent pas** être récupérées ultérieurement en exécutant simplement `rocketpool wallet recover` comme avec un portefeuille de nœud normal.

Si vous devez un jour récupérer ou importer à nouveau ce portefeuille, vous devrez suivre ce même processus, ce qui signifie que **vous devrez avoir ces keystores privés de validateur et leurs mots de passe sauvegardés quelque part en sécurité.**

Si vous les perdez un jour, **vous ne pourrez plus récupérer ces clés de validateur !**
:::

### Étape 4 : Nettoyage

À ce stade, vous pouvez maintenant supprimer tous les fichiers de keystore privés dans le répertoire `data/custom-keys`.
Le Smartnode les aura déjà importés et leur aura attribué des mots de passe aléatoires, donc ces fichiers de keystore ne sont plus nécessaires.

Enfin, assurez-vous qu'il n'y a **pas** de fichier nommé `custom-key-passwords` dans votre répertoire `data` (par exemple `~/.rocketpool/data/custom-key-passwords`).
Le Smartnode créera ce fichier temporaire uniquement pendant le processus de récupération et le supprimera automatiquement, que le processus de récupération ait réussi ou non ; si pour une raison quelconque il n'a pas réussi à le supprimer, il vous alertera dans la sortie de la console.
Cependant, il ne fait jamais de mal d'être trop prudent.

## Prochaines Étapes

Une fois que vous avez importé ou récupéré votre portefeuille de nœud, suivez les prochaines étapes du guide [Introduction à l'Interface en Ligne de Commande](./cli-intro).
