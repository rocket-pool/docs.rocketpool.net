import { Tab, Tabs } from "@rspress/core/theme";

::: danger AVERTISSEMENT
Les dépôts de minipool sont actuellement désactivés en préparation de Saturn 1.
:::

# Migrer un minipool de 16 ETH vers 8 ETH

Les opérateurs de nœud ont la possibilité de **migrer directement** leurs minipools de 16 ETH existants en minipools de 8 ETH.
Ce faisant, 8 ETH seront ajoutés à leurs [soldes de crédit de dépôt](./credit) qui peuvent être utilisés pour **créer des minipools supplémentaires sans nécessiter d'ETH de la part des opérateurs de nœud**.

En effet, ce processus permet à un opérateur de nœud de **convertir un minipool de 16 ETH en deux minipools de 8 ETH gratuitement** (_bien qu'il nécessite toujours de l'ETH pour le gaz et suffisamment de garantie RPL pour gérer les deux minipools_).

Migrer un minipool de 16 ETH existant vers un de 8 ETH est formellement appelé **réduction de caution**.
C'est un processus en deux étapes qui implique une validation par l'Oracle DAO.
Nous vous guiderons à travers tout le processus dans les sections ci-dessous.

### Règles de réduction de caution

Une réduction de caution implique les étapes suivantes :

1. Démarrer la réduction de caution, effectuée par l'opérateur de nœud.
2. Une période d'attente (le "contrôle de nettoyage de réduction de caution"), permettant à l'Oracle DAO de vérifier que la réduction de caution est légale et d'annuler toute réduction de caution qui viole les règles.
3. Terminer la réduction de caution, effectuée par l'opérateur de nœud.

Pour effectuer une réduction de caution réussie sans être annulée, le minipool doit suivre ces règles :

1. Le minipool doit être mis à niveau vers le [délégué Atlas](./minipools/delegates) ; l'ancien délégué Redstone ne peut pas être utilisé.
1. Le validateur du minipool sur la Beacon Chain doit être **en attente ou en train de staker activement**. Il ne peut pas être slashé, en cours de sortie / sorti, ou retirable / retiré.
1. Le solde du validateur du minipool sur la Beacon Chain doit être **d'au moins 31,99 ETH** (32 ETH avec une petite marge pour les complications mal synchronisées entraînant des attestations manquées après un écrémage de récompenses).

Le minipool doit respecter ces conditions pendant **toute la durée** du contrôle de nettoyage, période pendant laquelle l'Oracle DAO le surveillera pour garantir le respect des conditions ci-dessus.

Si, à tout moment pendant le contrôle de nettoyage, un minipool est trouvé en violation de ces conditions, la réduction de caution sera **annulée**.
Le minipool lui-même ne sera pas affecté ; il continuera de vivre heureux en tant que minipool de 16 ETH, validant et agissant comme si tout le processus de réduction de caution ne s'était jamais produit.
Cependant, **il ne sera plus éligible aux réductions de caution**.
Une fois qu'une réduction de caution d'un minipool est annulée, elle ne peut jamais être tentée à nouveau.

::: warning REMARQUE
Lors d'une réduction de caution réussie, le montant de la caution du minipool sera réduit de 16 ETH à 8 ETH et **la commission du minipool sera réinitialisée à la valeur réseau actuelle**.

Si vous réduisez un minipool de 16 ETH avec une commission de 20%, **vous ne conserverez pas cette commission de 20%**.
Elle sera réduite à la valeur réseau (**actuellement fixée à 14%**).

Notez que comme le démontre la section [calculs d'exemple](./create-validator.mdx#rewards), un minipool de 8 ETH à 14% est _toujours plus rentable_ qu'un minipool de 16 ETH à 20%, donc conserver un taux de commission élevé n'est pas une raison impérieuse de garder une caution de 16 ETH.
:::

### Étape 1 : Commencer la réduction de caution

Pour commencer le processus de réduction de caution, entrez la commande suivante :

```shell
rocketpool minipool begin-bond-reduction
```

Cela commencera par fournir un bref aperçu du processus (bien que, si vous avez lu ce guide, tout devrait déjà vous être familier).
Une fois que vous avez confirmé que vous comprenez le processus, il vous montrera quels minipools ont actuellement une caution qui peut être réduite, ainsi que leur caution et commission actuelles :

```
Please select a minipool to begin the ETH bond reduction for:
1: All available minipools
2: 0x7E5703fdA638CD86c316B9EbAF76927fF695ADC5 (Current bond: 16 ETH, commission: 15.00%)
3: 0x7E5704aD2a63eb90880426Dcd4a3811246dF3cB0 (Current bond: 16 ETH, commission: 15.00%)
4: 0x7E5705c149D11efc951fFc20349D7A96bc6b819C (Current bond: 16 ETH, commission: 15.00%)
5: 0x7E570625cE8F586c90ACa7fe8792EeAA79751778 (Current bond: 16 ETH, commission: 15.00%)

```

Une fois que vous avez sélectionné un ou plusieurs minipools à réduire, le Smartnode vérifiera si ces minipools sont éligibles à la réduction de caution.

Pour être éligible, ces conditions doivent être satisfaites :

- Le minipool a été mis à niveau pour utiliser le [contrat délégué de minipool Atlas](./minipools/delegates).
- Le validateur du minipool doit avoir un solde de Beacon Chain d'au moins 32 ETH.
- Le validateur du minipool doit être en attente ou actif.
- Vous avez suffisamment de RPL staké pour supporter le niveau minimum de garantie RPL qui serait requis _après_ la réduction de caution.

Si ce n'est pas le cas, il affichera une erreur d'avertissement expliquant ce qui doit être fait en premier ; par exemple :

```
Please select a minipool to begin the ETH bond reduction for:
1: All available minipools
2: 0x7E5703fdA638CD86c316B9EbAF76927fF695ADC5 (Current bond: 16 ETH, commission: 15.00%)
3: 0x7E5704aD2a63eb90880426Dcd4a3811246dF3cB0 (Current bond: 16 ETH, commission: 15.00%)
4: 0x7E5705c149D11efc951fFc20349D7A96bc6b819C (Current bond: 16 ETH, commission: 15.00%)
5: 0x7E570625cE8F586c90ACa7fe8792EeAA79751778 (Current bond: 16 ETH, commission: 15.00%)
2

Cannot reduce bond for minipool 0x7E5703fdA638CD86c316B9EbAF76927fF695ADC5:
The minipool version is too low. It must be upgraded first using `rocketpool minipool delegate-upgrade`.
You do not have enough RPL staked to support this bond reduction; it would bring you below the minimum RPL staking requirement. You will have to stake more RPL first.
```

Cela montre que le minipool sélectionné nécessite une mise à niveau du délégué et que le nœud a besoin de plus de RPL staké pour réduire la caution de ce minipool.

Lorsque vous avez satisfait les préconditions, sélectionner un minipool dans cette commande vous demandera simplement de choisir votre prix de gaz pour la transaction et de confirmer l'action.
Après avoir accepté la confirmation, la réduction de caution du minipool commencera.

### Surveiller le minuteur de contrôle de nettoyage

Une fois que vous avez commencé une réduction de caution, vous pouvez voir combien de temps il reste avant qu'elle puisse être terminée dans vos logs du daemon `node` :

<div className="p-3">
  <Tabs>
    <Tab label="Docker and Hybrid Mode">
      Pour les utilisateurs en **mode Docker** et **mode hybride**, cela peut être fait avec la commande suivante :

      ```shell
      rocketpool service logs node
      ```
    </Tab>
    <Tab label="Native Mode">
      Consultez le script que vous utilisez pour consulter les logs système de votre daemon de nœud.
    </Tab>

  </Tabs>
</div>

Vous verrez une nouvelle entrée indiquant combien de temps il reste avant que le contrôle de nettoyage de votre réduction de caution soit terminé :

```
rocketpool_node  | 2023/02/25 09:04:21 Checking for minipool bonds to reduce...
rocketpool_node  | 2023/02/25 09:04:21 Minipool 0x7E5703fdA638CD86c316B9EbAF76927fF695ADC5 has 12m0s left until it can have its bond reduced.
```

Une fois que ce minuteur atteint zéro et n'apparaît plus dans ces logs, vous pouvez terminer la réduction de caution.

### Étape 2 : Terminer la réduction de caution

Lorsque le minuteur de nettoyage s'est terminé avec succès, il y a deux façons de terminer la réduction de caution de votre minipool :

1. Laissez le daemon `node` s'en occuper pour vous ; il le fait pendant le contrôle de routine qu'il effectue toutes les cinq minutes (le même qui affiche la ligne de temps restant dans le log ci-dessus). S'il remarque que vous avez une réduction de caution éligible, **il terminera la réduction automatiquement** - tout comme il le fait avec le staking des minipools en attente et la vérification de votre destinataire de frais. Vous verrez une sortie dans le log `node` montrant quand il a détecté, et terminé, une réduction de caution.
2. Terminer la réduction de caution manuellement en utilisant la commande suivante :
   ```shell
   rocketpool minipool reduce-bond
   ```
   La commande est simple ; suivez les instructions pour terminer le processus une fois que votre minipool est éligible à la réduction de caution.

Pendant la réduction de caution, Rocket Pool **distribue le solde existant de votre minipool** en utilisant la caution et la commission pré-réduction de caution du minipool pour garantir que vous et les stakers rETH obtenez votre juste part du solde existant, et que la réduction de caution ne change pas les récompenses que chaque partie _aurait_ obtenues sur ce solde.

### Les résultats d'une caution réduite

Vous pouvez vérifier la réduction de caution réussie en utilisant `rocketpool minipool status`.

**Avant** la réduction de caution, pour le minipool d'exemple que nous avons suivi, cette commande produirait la sortie suivante :

```
Address:              0x7E5703fdA638CD86c316B9EbAF76927fF695ADC5
...
Node fee:             15.000000%
Node deposit:         16.000000 ETH
RP ETH assigned:       2023-02-08, 06:13 +0000 UTC
RP deposit:            16.000000 ETH
Minipool Balance (EL): 0.150713 ETH
Your portion:          0.086660 ETH
Available refund:      0.000000 ETH
Total EL rewards:      0.086660 ETH
...
Beacon balance (CL):   32.000152 ETH
Your portion:          16.000087 ETH
...
```

**Après** la réduction de caution, la commande retournerait cette sortie :

```
Address:              0x7E5703fdA638CD86c316B9EbAF76927fF695ADC5
...
Node fee:             14.000000%
Node deposit:         8.000000 ETH
RP ETH assigned:       2023-02-08, 06:13 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 0.086769 ETH
Your portion:          0.000000 ETH
Available refund:      0.086769 ETH
Total EL rewards:      0.086769 ETH
...
Beacon balance (CL):   32.000037 ETH
Your portion:          8.000013 ETH
...
```

Notez comment les choses ont changé :

- `Node fee` (commission) est passé de 15% à 14%
- `Node deposit` (votre caution) est passé de 16 ETH à 8 ETH
- `RP deposit` (le montant que vous avez emprunté) est passé de 16 ETH à 24 ETH
- `Minipool Balance (EL)` est passé de 0,150713 ETH à 0,086769 ETH
- `Your portion (EL)` est passé de 0,086660 ETH à 0 ETH
- `Available refund` est passé de 0 ETH à 0,086769 ETH
- `Your portion (CL)` est passé de 16,000087 ETH à 8,000013 ETH

Les changements de `Node fee`, `Node deposit`, `RP deposit`, et `Your portion (CL)` indiquent que la caution a été réduite avec succès.

Les changements de `Minipool Balance (EL)`, `Your portion (EL)`, et `Available refund` indiquent les résultats de la **distribution du solde du minipool** qui s'est produite dans le cadre du processus de réduction de caution.
Pour clarifier comment interpréter ces résultats :

- Si vous regardez [la transaction](https://zhejiang.beaconcha.in/tx/0xf02f6b1a4ea68f356909e6f1974dc3c24d301ba115b97f3013c3c829ba2ca57c), vous verrez également qu'elle a envoyé 0,06413383 ETH du minipool au pool de staking.
- Dans l'exemple "avant", la part du pool de staking est le solde du minipool moins la portion de l'opérateur de nœud, soit `0,150713 - 0,086660 = 0,064053` qui est le montant transféré au pool de staking pendant la réduction de caution (plus un petit montant d'un écrémage de récompenses qui s'est produit pendant le contrôle de nettoyage).
- La part de _l'opérateur de nœud_, en revanche, n'est pas envoyée à l'adresse de retrait de l'opérateur de nœud. Elle est plutôt marquée comme **remboursement disponible**, c'est pourquoi le montant du remboursement est passé de 0 ETH à ce qui était précédemment le montant "your portion" du solde du minipool sur l'EL.
  - Vous pouvez réclamer ce remboursement à tout moment en utilisant la commande suivante :
    ```shell
    rocketpool minipool refund
    ```

Il y a un autre résultat important de la réduction de caution, qui peut être observé en utilisant `rocketpool node status` :

```
Your Smartnode is currently using the Zhejiang Test Network.

=== Account and Balances ===
The node 0x9BA1401Eb7D779eC51f910B066e9C4351cD28911 has a balance of 347.796908 ETH and 16799.835547 RPL.
The node has 8.000000 ETH in its credit balance, which can be used to make new minipools.
```

Le processus de réduction de caution a **augmenté le** [solde de crédit de dépôt](./credit) **du nœud** de 8 ETH.
Ce crédit peut être utilisé pour [créer un autre minipool de 8 ETH](./create-validator.mdx#depositing-eth-and-creating-a-minipool) gratuitement (aucun ETH requis du portefeuille du nœud, sauf pour le gaz) !
