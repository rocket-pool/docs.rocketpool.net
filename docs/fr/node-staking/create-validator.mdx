import { Tab, Tabs } from "@rspress/core/theme";

::: danger AVERTISSEMENT
Les dépôts de minipool sont actuellement désactivés en préparation de Saturn 1.
:::

# Créer un Nouveau Minipool (Validateur)

Pour rappel, un `minipool` dans les termes de Rocket Pool fait référence à une instance de contrat intelligent unique sur la couche d'exécution que votre nœud gère.
Le minipool gère une portion de votre ETH, connue sous le nom de **montant de caution**, et une portion d'ETH provenant du pool de staking rETH, connue sous le nom de **montant emprunté**.
Il les fusionne pour former 32 ETH au total, qui sont ensuite envoyés au contrat de dépôt de la Beacon Chain pour créer un nouveau validateur.
Ainsi, pour créer un validateur en utilisant Rocket Pool, vous devez **créer un minipool**.

::: danger AVERTISSEMENT
La création de minipool est régie par deux files d'attente.

La première est la file d'attente de dépôt Rocket Pool, qui est gérée par le protocole Rocket Pool et détermine quand votre minipool recevra ses ETH empruntés. Il doit y avoir des ETH disponibles dans le pool de dépôt pour associer vos 8 ETH avec 24 ETH dans le pool de dépôt et créer le minipool.

La seconde est la file d'attente de la Beacon Chain, qui est gérée par la Beacon Chain Ethereum et détermine quand votre validateur deviendra actif.

Veuillez noter que le temps nécessaire pour que votre minipool devienne actif peut varier considérablement selon votre position dans chaque file d'attente et l'état actuel du réseau.
:::

::: tip REMARQUE
Les temps d'activation (et de sortie) de la file d'attente des validateurs de la Beacon Chain peuvent varier considérablement selon l'état actuel du réseau.

Ceci est indépendant du contrôle de Rocket Pool et est une fonction de la Beacon Chain elle-même.

L'outil suivant fournit une bonne estimation du temps d'attente que vous pouvez prévoir :
[https://www.validatorqueue.com/](https://www.validatorqueue.com/)

Veuillez consulter cet outil pour avoir une idée du temps d'attente que vous pouvez prévoir avant que votre validateur ne devienne actif.
:::

### Staker du RPL via le Site Web

La façon la plus simple et la plus sûre de staker du RPL pour votre nœud est d'utiliser la fonctionnalité **Stake-on-Behalf** du protocole, qui a été
réintroduite avec la mise à niveau Atlas. De cette façon, vous pouvez staker du RPL pour votre nœud tandis que le RPL est toujours dans le portefeuille
que vous avez utilisé pour l'acquérir. En d'autres termes, vous **n'avez pas besoin d'envoyer de RPL au portefeuille chaud de votre nœud** pour le staker.

#### Mettre en liste blanche une adresse pour staker au nom de

Pour staker au nom de votre nœud, une adresse doit être mise en liste blanche. Votre adresse de retrait est toujours en liste blanche,
et vous pouvez sauter cette étape si votre RPL est détenu par votre adresse de retrait. Vous n'avez besoin de mettre une adresse en liste blanche qu'une seule fois
pour staker depuis celle-ci. Vous pouvez le faire via la commande Smartnode suivante :

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

Où `address-or-ens` est l'adresse ou le nom ENS qui résout à votre adresse souhaitée. Il vous sera demandé de
confirmer l'ajout à la liste blanche et après confirmation de la transaction, vous pourrez ensuite naviguer vers la page pertinente ci-dessous.

#### Staker du RPL au nom de

Sélectionnez le réseau que vous utilisez dans les onglets ci-dessous pour y accéder :

<div className="p-3">
  <Tabs>
    <Tab label="Mainnet">[https://node.rocketpool.net/stake-rpl-on-behalf-of-node](https://node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
    <Tab label="Hoodi Testnet">[https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node](https://testnet.node.rocketpool.net/stake-rpl-on-behalf-of-node)</Tab>
  </Tabs>
</div>

Commencez par connecter votre portefeuille au site Web en utilisant MetaMask, WalletConnect, ou toute autre méthode prise en charge par le site Web.
Il vous sera ensuite présenté cette boîte de dialogue pour rechercher l'adresse de votre nœud.

Entrez l'adresse de votre nœud et cliquez sur "Lookup".

**Assurez-vous d'avoir la bonne adresse de nœud avant de faire cela !**
Si vous devez confirmer l'adresse de votre nœud, vous pouvez rapidement la récupérer via la CLI en utilisant la commande `rocketpool node status`.

Cela vérifiera que l'adresse est un nœud enregistré et que le nœud a mis en liste blanche le portefeuille connecté. Les adresses de retrait sont en liste blanche par défaut, cependant si vous souhaitez autoriser d'autres adresses, vous devrez les mettre en liste blanche via la commande suivante sur votre nœud.

```shell
rocketpool node add-address-to-stake-rpl-whitelist address-or-ens
```

C'est un processus en deux étapes.

Tout d'abord, entrez le montant de RPL que vous souhaitez staker et cliquez sur `Approve` - cela **approuvera** le contrat de staking à accéder à cette quantité de RPL dans votre portefeuille, mais **pas plus que ce montant**.

::: tip ASTUCE
Vous pouvez approuver plus que le montant que vous avez l'intention de staker si vous faites confiance au contrat de staking Rocket Pool, et ne voulez pas effectuer cette transaction Approve supplémentaire à chaque fois que vous voulez staker plus de RPL.
:::

Une fois le RPL approuvé, vous pourrez staker au nom d'un nœud.

Entrez le montant de RPL que vous souhaitez staker dans la case `Stake RPL`, et entrez l'adresse de votre nœud dans la case `on behalf of Node Address`.

Lorsque vous avez entré ces informations, appuyez sur le bouton `Stake` et approuvez la transaction.

<video controls="controls" src="https://cdn-rocketpool.s3.us-west-2.amazonaws.com/stake_behalf.mp4" />

Elle sera envoyée au réseau Ethereum, et une fois incluse dans un bloc, vous êtes prêt !

Si vous exécutez `rocketpool node status`, vous devriez voir votre RPL staké apparaître sous la section `=== RPL Stake ===`.

#### Retirer une adresse de la liste blanche de stake

Si vous souhaitez retirer une adresse de votre liste blanche stake-on-behalf, vous pouvez le faire avec la commande Smartnode suivante :

```shell
rocketpool node remove-address-from-stake-rpl-whitelist address-or-ens
```

Où `address-or-ens` est l'adresse ou un nom ENS résolvant à l'adresse que vous voulez retirer de la liste blanche.

### Staker via la CLI du Nœud

Si vous ne pouvez pas (ou ne voulez pas) utiliser le site Web pour staker votre RPL, vous pouvez également le staker directement via la CLI du nœud.

Tout d'abord, transférez votre RPL du portefeuille avec lequel vous l'avez acquis vers l'adresse de votre nœud.

::: danger AVERTISSEMENT
**Veuillez faire cela avec précaution et assurez-vous d'envoyer le RPL à l'adresse de votre nœud - les transferts sur Ethereum ne peuvent pas être annulés !**
**L'envoi de RPL à la mauvaise adresse entraînera la perte de votre RPL.**

Utilisez la commande `rocketpool node status` pour vérifier l'adresse de votre nœud si vous n'êtes pas sûr de ce qu'elle est.
:::

Exécutez la commande suivante :

```
rocketpool node stake-rpl
```

Voici la sortie :

```
Please choose an amount of RPL to stake:
1: Your entire RPL balance (1440.000000 RPL)?
2: A custom amount
```

Sélectionnez combien vous souhaitez staker, puis confirmez l'opération.

La première fois que vous exécutez cette commande, elle impliquera deux transactions - une pour **approuver** le contrat de staking Rocket Pool à accéder à votre RPL, et une pour **staker** votre RPL avec lui.
Les exécutions suivantes ne nécessiteront que la transaction **stake**, puisque le token a déjà été approuvé.

Une fois les deux transactions terminées, vous pouvez vérifier votre montant de RPL staké avec `rocketpool node status`.
La partie suivante de la sortie est ce que vous voulez vérifier :

```
The node has a total stake of 300.000000 RPL.
This is currently 29.76% of its borrowed ETH and 89.29% of its bonded ETH.
It can earn max apy on up to 151.209677 RPL (15% of borrowed ETH), and still earn at lower APY with more RPL.
```

Cela vous montrera combien de minipools vous pouvez créer de chaque taille de caution en fonction de votre collatéral RPL.

## (Optionnel) Trouver une Adresse Vanity Personnalisée pour votre Minipool

Par défaut, lorsque vous créez un nouveau minipool, Rocket Pool générera une adresse unique aléatoire pour celui-ci.
Cependant, le Smartnode offre la possibilité de rechercher une **adresse vanity** personnalisée pour le minipool.

Une adresse vanity est une adresse où vous choisissez personnellement les caractères par lesquels l'adresse commence.
Il s'agit d'un exercice purement cosmétique qui n'aura aucun impact pratique sur le fonctionnement de votre minipool.
Comme les adresses Ethereum sont en hexadécimal, les caractères suivants sont légaux :

```
0 1 2 3 4 5 6 7 8 9 a b c d e f
```

À titre d'exemples, vous pourriez faire commencer l'adresse de votre minipool par un tas de zéros (`0x000000...`), `0x600d` (hex pour "good") ou `0xa77e57ed` (hex pour "attested", un préfixe approprié pour un minipool).

Pour trouver une telle adresse vanity, vous devrez **la rechercher**.
Ce processus de recherche implique de choisir un nombre, de l'appliquer comme "salt" à l'algorithme de hachage, et de comparer les résultats avec ce que vous recherchez.
Les résultats sont effectivement aléatoires (bien que tout salt donné produise toujours le même résultat), donc la seule façon de trouver une adresse avec le préfixe que vous voulez est d'en essayer beaucoup jusqu'à ce que vous trouviez un salt qui fonctionne.

Si vous souhaitez une adresse vanity personnalisée à utiliser pour votre minipool lorsque vous le créez, vous pouvez utiliser la commande suivante pour en rechercher une :

```
rocketpool minipool find-vanity-address
```

Cela vous demandera le préfixe que vous souhaitez rechercher, et demandera quel type de dépôt vous allez faire (un dépôt de 16 ETH ou un dépôt de 32 ETH - voir ci-dessous pour plus d'informations sur ces types).
Une fois que vous aurez entré ces informations, il commencera à essayer beaucoup de salts jusqu'à ce qu'il en trouve un qui produise votre préfixe souhaité !

Voici un exemple complet du processus :

```
$ rocketpool minipool find-vanity-address
Please specify the address prefix you would like to search for (must start with 0x):
0xa77e57
Running with 12 threads.
Found on thread 3: salt 0x5cd7fb = 0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD
Finished in 1.91145873s
```

Dans ce cas, nous avons recherché `0xa77e57` comme préfixe et avons trouvé le salt `0x5cd7fb` qui pouvait le générer.
Dans l'étape suivante, lorsque nous créons un minipool, nous pouvons spécifier ce salt comme argument optionnel pour créer le nouveau minipool à l'adresse associée au salt (`0xA77E57c892C9e98B0B81289e4AfdA62fb59c5DDD` comme indiqué ci-dessus).

En général, chaque caractère supplémentaire que vous recherchez multipliera le temps de recherche par environ 16.
Pour cette raison, **nous vous recommandons de ne rechercher que des préfixes de 7 ou 8 caractères maximum sauf si vous avez une machine très puissante avec de nombreux cœurs CPU**.
Sinon, cela pourrait prendre un temps prohibitif pour trouver un salt qui produit le préfixe que vous voulez.

Par exemple, un AMD 5600x avec 6 cœurs (12 threads) à 4,8 GHz peut rechercher environ 3,2 millions de salts par seconde.
En moyenne, il faudra quelques secondes pour trouver un préfixe de 6 caractères, quelques minutes pour trouver un préfixe de 7 caractères, et quelques heures pour trouver un préfixe de 8 caractères.

::: tip REMARQUE
Le salt qui est généré est spécifique aux variables suivantes :

- Le réseau que vous utilisez (soit le Hoodi Testnet ou le Mainnet)
- L'adresse du nœud
- Le montant de la caution
- Le salt

Si vous modifiez l'une de ces variables, l'adresse du minipool pour un salt donné changera également.
:::

Pour une utilisation plus avancée (comme rechercher une adresse de nœud différente ou changer le nombre de cœurs CPU utilisés pour la recherche), consultez le texte d'aide avec `rocketpool minipool find-vanity-address --help`.

## Déposer de l'ETH et Créer un Minipool

::: tip ASTUCE
Si la valeur marchande du rETH est supérieure à sa couverture en ETH (c'est-à-dire que le rETH est à prime sur le marché), il y a une opportunité d'arbitrer la différence lors de la création d'un minipool.
La valeur de l'arbitrage est égale au montant d'ETH du protocole dans le minipool multiplié par la prime (moins une petite quantité de gaz).
Par exemple, si vous créez un minipool lorsqu'il y a une prime de 2,5% : `16 ETH * .025 = 0,4 ETH`.
En d'autres termes, vous pourriez recevoir 0,4 ETH en retour dans ces conditions juste pour avoir créé un minipool !

Si vous êtes intéressé par cette opportunité, envisagez d'utiliser l'outil développé par la communauté [rocketarb](https://github.com/xrchz/rocketarb#readme) pour capturer le profit de l'opportunité d'arbitrage MEV rETH que le lancement de votre minipool crée.

Pour en savoir plus sur rocketarb, n'hésitez pas à vous renseigner à ce sujet sur le [serveur discord RP](https://discord.gg/rocketpool).
:::

Après tout ce que vous avez fait jusqu'à présent, vous êtes enfin prêt à déposer votre ETH, créer un nouveau minipool, et créer un validateur Beacon Chain.
Cela se fait avec la commande suivante :

```shell
rocketpool node deposit
```

::: danger AVERTISSEMENT

Bien que la CLI automatise beaucoup des prochaines étapes pour vous, nous recommandons <strong>fortement</strong> de surveiller votre nœud et vos transactions pour assurer une transition réussie de `prelaunch` à `staking`.

Les transactions échouées (en raison de paramètres de gaz ajustés ou d'ETH insuffisant) pourraient faire passer votre minipool à l'état `dissolved`, ce que vous voulez éviter.

[En savoir plus sur la façon de confirmer un stake réussi](./create-validator#confirming-a-successful-stake)

:::

::: tip REMARQUE
Si vous voulez utiliser un salt pour une adresse vanity que vous avez trouvée en utilisant le processus ci-dessus, exécutez plutôt la commande suivante :

```shell
rocketpool node deposit --salt <votre salt, par ex. 0x1234abcd>
```

:::

Vous verrez d'abord une note indiquant que le dépôt d'un nouveau minipool **distribuera automatiquement** tout solde dans le contrat [fee distributor](./fee-distrib-sp) de votre nœud (utilisé pour capturer les récompenses MEV si vous n'avez pas opté pour le [Smoothing Pool](./fee-distrib-sp#the-smoothing-pool)) :

```
Your eth2 client is on the correct network.
NOTE: by creating a new minipool, your node will automatically claim and distribute any balance you have in your fee distributor contract. If you don't want to claim your balance at this time, you should not create a new minipool.
Would you like to continue? [y/n]
```

Si vous avez déjà des minipools et un solde dans votre fee distributor, vous pourriez décider de ne pas créer un autre minipool si la distribution de ce solde cause un événement imposable dans votre juridiction.

Après cela, vous serez informé de votre taux de commission pour le nouveau minipool, et une note indiquant si le [solde de crédit](./credit) de votre nœud peut être utilisé pour couvrir le coût de la caution du minipool pour vous :

```
Your minipool will use the current fixed commission rate of 5.00%.
If you participate in the smoothing pool, your minipool will receive at least a 5% commission boost, and up to a 9% commission boost based on RPL stake.
You currently have 8.00 ETH in your credit balance.
This deposit will use 8.000000 ETH from your credit balance and will not require any ETH from your node.
```

Vous serez ensuite invité avec les recommandations actuelles de coûts de gaz du réseau ; confirmez votre sélection de prix de gaz et suivez le reste des invites.

```
Your consensus client is synced, you may safely create a minipool.
+============== Suggested Gas Prices ==============+
| Avg Wait Time |  Max Fee  |    Total Gas Cost    |
| 15 Seconds    | 15 gwei   | 0.0244 to 0.0366 ETH |
| 1 Minute      | 10 gwei   | 0.0157 to 0.0235 ETH |
| 3 Minutes     | 7 gwei    | 0.0100 to 0.0150 ETH |
| >10 Minutes   | 6 gwei    | 0.0080 to 0.0120 ETH |
+==================================================+
These prices include a maximum priority fee of 2.00 gwei.
Please enter your max fee (including the priority fee) or leave blank for the default of 10 gwei:
Using a max fee of 10.00 gwei and a priority fee of 2.00 gwei.
You are about to deposit 8.000000 ETH to create a minipool with a minimum possible commission rate of 14.000000%.
ARE YOU SURE YOU WANT TO DO THIS? Exiting this minipool and retrieving your capital cannot be done until:
- Your minipool has been *active* on the Beacon Chain for 256 epochs (approx. 27 hours)
- The Shapella upgrade of the Ethereum network has been deployed
- The Atlas upgrade of the Rocket Pool protocol has been deployed
- Your minipool has been upgraded to use the Atlas delegate
 [y/n]
y
Creating minipool...
Transaction has been submitted with hash <transaction hash>.
You may follow its progress by visiting:
<link to transaction>
Waiting for the transaction to be included in a block... you may wait here for it, or press CTRL+C to exit and return to the terminal.
The node deposit of 8.000000 ETH was made successfully!
Your new minipool's address is: <new minipool address>
The validator pubkey is: <new validator public key>
Your minipool is now in Initialized status.
Once the remaining ETH has been assigned to your minipool from the staking pool, it will move to Prelaunch status.
After that, it will move to Staking status once 1h0m0s have passed.
You can watch its progress using `rocketpool service logs node`.
```

Notez que la création d'un minipool **est une transaction coûteuse** !
Portez une attention particulière au coût total et assurez-vous de l'accepter.

Si vous acceptez, la création de votre minipool sera déclenchée.
Une fois la transaction terminée, vous recevrez l'adresse de votre nouveau contrat minipool sur la couche d'exécution et sa clé publique de validateur correspondante sur la Beacon Chain.
Vous pouvez les visiter avec n'importe quel explorateur de blocs si vous le souhaitez.

## Confirmer un Stake Réussi

Lors de la création, votre minipool sera mis dans l'état `initialized`.
Il restera ici jusqu'à ce que ce soit votre tour dans la file d'attente Rocket Pool pour recevoir 24 ETH du pool de staking afin que vous puissiez staker votre nouveau validateur sur la Beacon Chain.

Une fois que cela se produit, votre minipool passera à l'état `prelaunch` pour une certaine période de temps (actuellement 12 heures).
Votre dépôt de 8 ETH sera transféré à la Beacon Chain, et l'Oracle DAO [vérifiera que tout est correct](https://github.com/rocket-pool/rocketpool-research/blob/master/Reports/withdrawal-creds-exploit.md).
Pendant ce temps, vous pouvez observer le validateur en recherchant sa clé publique de validateur avec un explorateur Beacon Chain tel que [https://beaconcha.in](https://beaconcha.in) (ou [https://hoodi.beaconcha.in](https://hoodi.beaconcha.in) pour le Hoodi Testnet).

Vous pouvez vérifier le statut du nouveau minipool avec la commande `rocketpool minipool status`.
Par exemple, lorsqu'il est passé à `prelaunch`, vous verrez probablement quelque chose comme ceci :

```
1 Prelaunch minipool(s):
--------------------
Address:              <your minipool address>
Penalties:             0
Status updated:        2024-10-31, 04:51 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 31.000000 ETH
Your portion:          7.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      7.000000 ETH
Validator pubkey:      <your validator public key>
Validator index:       0
Validator seen:        no
Use latest delegate:   no
Delegate address:      <your delegate address>
Rollback delegate:     <none>
Effective delegate:    <your delegate address>
0 finalized minipool(s):
```

Après cette période de prelaunch, votre minipool entrera dans le statut `staking` et enverra l'ETH supplémentaire du pool de staking au contrat de dépôt.
Cela sera fait par le conteneur Docker `rocketpool_node` (ou le service `rp-node` si vous avez utilisé la configuration Native) - si, pour une raison quelconque, vous prenez anormalement de temps pour entrer dans le statut `staking`, consulter les logs de ce conteneur / service vous dira probablement ce qui ne va pas.
Vous pouvez vérifier ces logs avec la commande `rocketpool service logs node` (ou `/srv/rocketpool/node_log.sh` sur les configurations en mode Native).

L'exécution de `rocketpool minipool status` affichera ensuite quelque chose comme ceci :

```
$ rocketpool minipool status
1 Staking minipool(s):
--------------------
Address:              <your validator address>
Penalties:             0
RP ETH assigned:       2024-10-31, 05:53 +0000 UTC
Node fee:              5.000000%
Node deposit:          8.000000 ETH
RP ETH assigned:       2024-10-31, 04:51 +0000 UTC
RP deposit:            24.000000 ETH
Minipool Balance (EL): 0.000000 ETH
Your portion:          0.000000 ETH
Available refund:      0.000000 ETH
Total EL rewards:      0.000000 ETH
Validator pubkey:     <your validator public key>
Validator index:      <your validator index number>
Validator active:     yes
Validator balance:    32.018460 ETH
Expected rewards:     16.010614 ETH
Use latest delegate:  no
Delegate address:     <your delegate address>
Rollback delegate:    <none>
Effective delegate:   <your delegate address>
0 finalized minipool(s):
```

::: warning REMARQUE
La transaction pour migrer de `prelaunch` à `staking` est soumise automatiquement par votre nœud et est soumise aux paramètres de gaz dans `rocketpool service config`.
Si les paramètres de gaz empêchent le nœud de soumettre la transaction, ou s'il n'y a pas assez d'ETH dans le portefeuille du nœud pour payer la transaction, le minipool deviendra `dissolved` deux semaines après son entrée en `prelaunch`.
Si cela se produit, la récupération du solde est un processus coûteux et long, alors assurez-vous de surveiller votre minipool de près jusqu'à ce qu'il atteigne le statut `staking` !
:::

Une fois que la Beacon Chain accepte les deux dépôts (un de vous et un du pool de staking), votre validateur entrera dans la file d'attente de la Beacon Chain où il attendra son tour pour être activé et commencer à staker.

À ce stade, vous avez terminé !
Félicitations !
Vous avez officiellement créé un validateur avec Rocket Pool !

Consultez les sections suivantes sur la surveillance et la maintenance pour apprendre à surveiller les performances et la santé de votre validateur au fil du temps.

## Créer Plusieurs Minipools

Heureusement, votre nœud Rocket Pool est capable d'héberger autant de minipools que vous le souhaitez.
Vous **n'avez pas** besoin de créer un nouveau nœud pour chaque minipool.

Si vous souhaitez créer un deuxième (ou troisième, ou quatrième...) minipool pour votre nœud, tout ce que vous avez à faire est d'exécuter `rocketpool node deposit` à nouveau.
De plus, vous ne pourrez pas réutiliser un ancien salt d'adresse vanity - vous devrez en rechercher un autre unique pour chacun de vos minipools.

## Prochaines Étapes

Maintenant que vous avez un minipool opérationnel, les prochaines étapes vous guideront sur la façon de surveiller la santé de votre nœud, vérifier et appliquer les mises à jour, et le maintenir tout au long de sa vie.

**Veuillez lire la section `Surveillance et Maintenance` ensuite pour en savoir plus sur ces sujets.**
